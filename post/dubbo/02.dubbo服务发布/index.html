<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>dubbo服务发布 - BirdGod 技术分享</title>
    <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="BirdGod" /><meta name="description" content="一、dubbo整体架构 1.先看看架构图 分层架构，一目了然，每一层处理相应的业务逻辑； 官方文档写很棒； 2.在 Dubbo 的核心领域模型中： Protocol 是服务域，它" /><meta name="keywords" content="Java" />






<meta name="generator" content="Hugo 0.74.0-DEV with even 4.0.0" />


<link rel="canonical" href="https://birdgodtech.github.io/post/dubbo/02.dubbo%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/" />
<link href="/post/dubbo/02.dubbo%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/" rel="alternate" type="application/rss+xml" title="BirdGod 技术分享" />
<link href="/post/dubbo/02.dubbo%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/" rel="feed" type="application/rss+xml" title="BirdGod 技术分享" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.06658218.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/reset-even.css">


<meta property="og:title" content="dubbo服务发布" />
<meta property="og:description" content="一、dubbo整体架构 1.先看看架构图 分层架构，一目了然，每一层处理相应的业务逻辑； 官方文档写很棒； 2.在 Dubbo 的核心领域模型中： Protocol 是服务域，它" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://birdgodtech.github.io/post/dubbo/02.dubbo%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/" />
<meta property="article:published_time" content="2018-12-10T20:18:08+00:00" />
<meta property="article:modified_time" content="2018-12-10T20:18:08+00:00" />
<meta itemprop="name" content="dubbo服务发布">
<meta itemprop="description" content="一、dubbo整体架构 1.先看看架构图 分层架构，一目了然，每一层处理相应的业务逻辑； 官方文档写很棒； 2.在 Dubbo 的核心领域模型中： Protocol 是服务域，它">
<meta itemprop="datePublished" content="2018-12-10T20:18:08&#43;00:00" />
<meta itemprop="dateModified" content="2018-12-10T20:18:08&#43;00:00" />
<meta itemprop="wordCount" content="10221">



<meta itemprop="keywords" content="dubbo," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="dubbo服务发布"/>
<meta name="twitter:description" content="一、dubbo整体架构 1.先看看架构图 分层架构，一目了然，每一层处理相应的业务逻辑； 官方文档写很棒； 2.在 Dubbo 的核心领域模型中： Protocol 是服务域，它"/>

</head>
<body>
<div id="mobile-navbar" class="mobile-navbar">
    <div class="mobile-header-logo">
        <a href="/" class="logo">BirdGod 技术分享</a>
    </div>
    <div class="mobile-navbar-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
    <ul class="mobile-menu-list">
        <a href="/">
            <li class="mobile-menu-item" title="首页">首页</li>
        </a>
        <a href="/post/">
            <li class="mobile-menu-item" title="归档">归档</li>
        </a>
        <a href="/categories/">
            <li class="mobile-menu-item" title="分类">分类</li>
        </a>
        <a href="/tags/">
            <li class="mobile-menu-item" title="标签">标签</li>
        </a>
        <a href="/about/">
            <li class="mobile-menu-item" title="关于我">关于我</li>
        </a>
        
    </ul>
</nav>

<div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
    <a href="/" class="logo">BirdGod 技术分享</a>
</div>

<nav class="site-navbar">
    <ul id="menu" class="menu" data-sum="0">
        
        <li class="menu-item menu-item-home">
            <a class="menu-item-link" href="/" title="首页">首页</a>
        </li>
        
        <li class="menu-item menu-item-archives">
            <a class="menu-item-link" href="/post/" title="归档">归档</a>
        </li>
        
        <li class="menu-item menu-item-categories">
            <a class="menu-item-link" href="/categories/" title="分类">分类</a>
        </li>
        
        <li class="menu-item menu-item-tags">
            <a class="menu-item-link" href="/tags/" title="标签">标签</a>
        </li>
        
        <li class="menu-item menu-item-about">
            <a class="menu-item-link" href="/about/" title="关于我">关于我</a>
        </li>
        
    </ul>
</nav>

    </header>


    <main id="main" class="main">
        <div class="content-wrapper">
            <div id="content" class="content">
                <article class="post">
  
  <header class="post-header">
    <h1 class="post-title">dubbo服务发布</h1>

    <div class="post-meta">
      <span class="post-time"> 2018-12-10 20:18 </span>
      <div class="post-category">
        <a href="/categories/dubbo/"> dubbo </a>
        </div>
      <span class="more-meta"> 约 10221 字 </span>
      <span class="more-meta"> 预计阅读 21 分钟 </span>
      <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
    </div>
  </header>

  <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1先看看架构图">1.先看看架构图</a></li>
    <li><a href="#2在-dubbo-的核心领域模型中">2.在 Dubbo 的核心领域模型中：</a>
      <ul>
        <li><a href="#a领域模型类图">a.领域模型类图</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#1springafterpropertiesset执行方法发布服务">1.Spring#afterPropertiesSet()执行方法发布服务</a></li>
    <li><a href="#2serviceconfig中定义常量static-finalprotocol和proxyfactory的适配器类从extensionloader获取">2.ServiceConfig中定义常量(static final)Protocol和ProxyFactory的适配器类，从ExtensionLoader获取；</a>
      <ul>
        <li><a href="#1extensionloader自动生成protocol生成protocoladaptive类看看结构跟extensionloader分析是不是一样">(1).ExtensionLoader自动生成Protocol生成Protocol$Adaptive类，看看结构，跟ExtensionLoader分析是不是一样；</a></li>
        <li><a href="#2protocol的spi实现">(2).Protocol的SPI实现</a></li>
        <li><a href="#3proxyfactory的spi实现动态代理">(3).ProxyFactory的SPI实现动态代理</a></li>
      </ul>
    </li>
    <li><a href="#3serviceconfigdoexporturlsfor1protocol部分代码">3.ServiceConfig#doExportUrlsFor1Protocol部分代码</a></li>
    <li><a href="#4-exportlocal-发布本地">4. exportLocal 发布本地</a></li>
    <li><a href="#5-发布注册中心">5. 发布注册中心</a>
      <ul>
        <li><a href="#1-protocolfilterwrapperexporter">(1). ProtocolFilterWrapper#exporter</a></li>
        <li><a href="#2-protocollistenerwrapperexporter">(2). ProtocolListenerWrapper#exporter</a></li>
        <li><a href="#3-registryprotocolexporter">(3). RegistryProtocol#exporter</a></li>
        <li><a href="#4-dubboprotocolexporter">(4). DubboProtocol#exporter</a></li>
      </ul>
    </li>
    <li><a href="#6registry-注册中心">6.Registry 注册中心</a>
      <ul>
        <li><a href="#1实现类">(1).实现类</a></li>
        <li><a href="#2abstractregistry抽象类">(2).AbstractRegistry抽象类</a></li>
        <li><a href="#3failbackregistry容错处理">(3).FailbackRegistry容错处理</a></li>
        <li><a href="#4zookeeperregistry">(4).ZookeeperRegistry</a></li>
        <li><a href="#2redisregistry">(2).RedisRegistry</a></li>
      </ul>
    </li>
    <li><a href="#7nettyserver-源码分析">7.NettyServer 源码分析</a>
      <ul>
        <li><a href="#1构造">(1).构造</a></li>
        <li><a href="#2channelhandler-channel处理">(2).ChannelHandler Channel处理</a></li>
        <li><a href="#3dispatcher线程派发器">(3).Dispatcher线程派发器</a></li>
        <li><a href="#4doopen-start-server">(4).doOpen start Server</a></li>
        <li><a href="#5nettyserver实现channelhandler接口">(5).NettyServer实现ChannelHandler接口</a></li>
      </ul>
    </li>
    <li><a href="#7filter">7.Filter</a>
      <ul>
        <li><a href="#1executelimitfilter用于提供者限制并发数量">1.ExecuteLimitFilter用于提供者限制并发数量</a></li>
        <li><a href="#2activelimitfilter用于消费者限制并发数量">2.ActiveLimitFilter用于消费者限制并发数量</a></li>
        <li><a href="#3genericfilter用于泛化提供者实现">3.GenericFilter用于泛化提供者实现</a></li>
        <li><a href="#4genericimplfilter用于泛化消费者实现">4.GenericImplFilter用于泛化消费者实现</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="hint">
      <p>【注意】最后更新于 <span class="timeago" datetime="2018-12-10T20:18:08" title="December 10, 2018">December 10, 2018</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
  <div class="post-content">
    <h1 id="一dubbo整体架构">一、dubbo整体架构</h1>
<h2 id="1先看看架构图">1.先看看架构图</h2>
<p><img src="/duboo/dubbo-framework.jpg" alt=""></p>
<p>分层架构，一目了然，每一层处理相应的业务逻辑；</p>
<p><a href="http://dubbo.apache.org/zh-cn/docs/dev/design.html">官方文档</a>写很棒；</p>
<h2 id="2在-dubbo-的核心领域模型中">2.在 Dubbo 的核心领域模型中：</h2>
<ul>
<li>
<p>Protocol 是服务域，它是 Invoker 暴露和引用的主功能入口，它负责 Invoker 的生命周期管理。</p>
</li>
<li>
<p>Invoker 是实体域，它是 Dubbo 的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可向它发起 invoke 调用，它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现。</p>
</li>
<li>
<p>Invocation 是会话域，它持有调用过程中的变量，比如方法名，参数等。</p>
</li>
<li>
<p>基本设计原则</p>
</li>
<li>
<p>采用 Microkernel + Plugin 模式，Microkernel 只负责组装 Plugin，Dubbo 自身的功能也是通过扩展点实现的，也就是 Dubbo 的所有功能点都可被用户自定义扩展所替换。</p>
</li>
<li>
<p>采用 URL 作为配置信息的统一格式，所有扩展点都通过传递 URL 携带配置信息。</p>
<ul>
<li>例如:registry://192.168.1.7:9090/com.alibaba.service1?param1=value1&amp;param2=value2</li>
</ul>
</li>
</ul>
<h3 id="a领域模型类图">a.领域模型类图</h3>
<p><img src="/duboo/dubbo16.png" alt=""></p>
<h1 id="二dubbo发布服务">二、dubbo发布服务</h1>
<h2 id="1springafterpropertiesset执行方法发布服务">1.Spring#afterPropertiesSet()执行方法发布服务</h2>
<p>执行方法顺序：</p>
<p>ServiceBean.afterPropertiesSet()-&gt;ServiceConfig.export()-&gt;doExport()-&gt;doExportUrls()
-&gt;doExportUrlsFor1Protocol()</p>
<h2 id="2serviceconfig中定义常量static-finalprotocol和proxyfactory的适配器类从extensionloader获取">2.ServiceConfig中定义常量(static final)Protocol和ProxyFactory的适配器类，从ExtensionLoader获取；</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Protocol</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">Protocol</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getAdaptiveExtension</span><span class="o">();</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ProxyFactory</span> <span class="n">proxyFactory</span> <span class="o">=</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">ProxyFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getAdaptiveExtension</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="1extensionloader自动生成protocol生成protocoladaptive类看看结构跟extensionloader分析是不是一样">(1).ExtensionLoader自动生成Protocol生成Protocol$Adaptive类，看看结构，跟ExtensionLoader分析是不是一样；</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.alibaba.dubbo.common.extension.ExtensionLoader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Protocol$Adaptive</span> <span class="kd">implements</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Protocol</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">(</span><span class="s">&#34;method public abstract void com.alibaba.dubbo.rpc.Protocol.destroy() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getDefaultPort</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">(</span><span class="s">&#34;method public abstract int com.alibaba.dubbo.rpc.Protocol.getDefaultPort() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Exporter</span> <span class="nf">export</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Invoker</span> <span class="n">arg0</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">RpcException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">arg0</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;com.alibaba.dubbo.rpc.Invoker argument == null&#34;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">arg0</span><span class="o">.</span><span class="na">getUrl</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;com.alibaba.dubbo.rpc.Invoker argument getUrl() == null&#34;</span><span class="o">);</span>
        <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">.</span><span class="na">getUrl</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">extName</span> <span class="o">=</span> <span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getProtocol</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&#34;dubbo&#34;</span> <span class="o">:</span> <span class="n">url</span><span class="o">.</span><span class="na">getProtocol</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">extName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(&#34;</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;) use keys([protocol])&#34;</span><span class="o">);</span>
        <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Protocol</span> <span class="n">extension</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Protocol</span><span class="o">)</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Protocol</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getExtension</span><span class="o">(</span><span class="n">extName</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">extension</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">arg0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Invoker</span> <span class="nf">refer</span><span class="o">(</span><span class="n">Class</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">arg1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">RpcException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">arg1</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;url == null&#34;</span><span class="o">);</span>
        <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">arg1</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">extName</span> <span class="o">=</span> <span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getProtocol</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&#34;dubbo&#34;</span> <span class="o">:</span> <span class="n">url</span><span class="o">.</span><span class="na">getProtocol</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">extName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(&#34;</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;) use keys([protocol])&#34;</span><span class="o">);</span>
        <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Protocol</span> <span class="n">extension</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Protocol</span><span class="o">)</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">Protocol</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getExtension</span><span class="o">(</span><span class="n">extName</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">extension</span><span class="o">.</span><span class="na">refer</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="2protocol的spi实现">(2).Protocol的SPI实现</h3>
<p><img src="/duboo/dubbo02.png" alt=""></p>
<p>创建对象被ProtocolFilterWrapper和ProtocolListenerWrapper一起包装</p>
<h3 id="3proxyfactory的spi实现动态代理">(3).ProxyFactory的SPI实现动态代理</h3>
<h4 id="a接口类图">a.接口类图</h4>
<p><img src="/duboo/dubbo17.png" alt=""></p>
<ul>
<li>getProxy这个用于消费端实现接口创建代理</li>
<li>getInvoker作用于的服务端创建Invoker代理
<ul>
<li>创建AbstractProxyInvoker抽象类进行代理</li>
</ul>
</li>
</ul>
<h4 id="bspi实现类">b.SPI实现类</h4>
<p><img src="/duboo/dubbo01.png" alt=""></p>
<p>默认情况javassist动态代理，创建实例对象时，对象都被StubProxyFactoryWrapper包装；
具体不做分析，在SPI机制中说明；</p>
<h4 id="cjavassistproxyfactory-代理动态代理创建代码编译class减少用反射提高性能">c.JavassistProxyFactory 代理动态代理，创建代码，编译class,减少用反射，提高性能</h4>
<h4 id="dstubproxyfactorywrapper用于dubbo的本地存根消费端先调用本地的实现类逻辑处理">d.StubProxyFactoryWrapper用于Dubbo的本地存根,消费端先调用本地的实现类逻辑处理;</h4>
<h2 id="3serviceconfigdoexporturlsfor1protocol部分代码">3.ServiceConfig#doExportUrlsFor1Protocol部分代码</h2>
<ul>
<li>注册registryURLs
<ul>
<li>registry://localhost:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&amp;dubbo=2.6.0&amp;pid=28302&amp;registry=zookeeper&amp;timestamp=1593676329574</li>
</ul>
</li>
<li>dubbo://192.168.31.122:20881/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;bind.ip=192.168.31.122&amp;bind.port=20881&amp;dubbo=2.6.0&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=28302&amp;server=netty4&amp;side=provider&amp;timestamp=1593676329586</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">      <span class="c1">// 创建url,name默认dubbo
</span><span class="c1"></span>      <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="o">(</span><span class="n">contextPath</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">contextPath</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span> <span class="o">?</span> <span class="s">&#34;&#34;</span> <span class="o">:</span> <span class="n">contextPath</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="n">path</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
      <span class="c1">// 配置 
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">ConfiguratorFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
              <span class="o">.</span><span class="na">hasExtension</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getProtocol</span><span class="o">()))</span> <span class="o">{</span>
          <span class="n">url</span> <span class="o">=</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">ConfiguratorFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getProtocol</span><span class="o">()).</span><span class="na">getConfigurator</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">configure</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
      <span class="o">}</span>
       <span class="c1">//配置为none不暴露
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">Constants</span><span class="o">.</span><span class="na">SCOPE_NONE</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">scope</span><span class="o">))</span> <span class="o">{</span>

            <span class="c1">//配置不是remote的情况下做本地暴露 (配置为remote，则表示只暴露远程服务)
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">Constants</span><span class="o">.</span><span class="na">SCOPE_REMOTE</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">scope</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">exportLocal</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">//如果配置不是local则暴露为远程服务.(配置为local，则表示只暴露本地服务)
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">Constants</span><span class="o">.</span><span class="na">SCOPE_LOCAL</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">scope</span><span class="o">))</span> <span class="o">{</span>
                <span class="o">...</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">registryURLs</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">registryURLs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span>
                        <span class="o">&amp;&amp;</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;register&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">URL</span> <span class="n">registryURL</span> <span class="o">:</span> <span class="n">registryURLs</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">addParameterIfAbsent</span><span class="o">(</span><span class="s">&#34;dynamic&#34;</span><span class="o">,</span> <span class="n">registryURL</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;dynamic&#34;</span><span class="o">));</span>
                        <span class="n">URL</span> <span class="n">monitorUrl</span> <span class="o">=</span> <span class="n">loadMonitor</span><span class="o">(</span><span class="n">registryURL</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">monitorUrl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">addParameterAndEncoded</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">MONITOR_KEY</span><span class="o">,</span> <span class="n">monitorUrl</span><span class="o">.</span><span class="na">toFullString</span><span class="o">());</span>
                        <span class="o">}</span>
                        <span class="o">...</span>
                        <span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">invoker</span> <span class="o">=</span> <span class="n">proxyFactory</span><span class="o">.</span><span class="na">getInvoker</span><span class="o">(</span><span class="n">ref</span><span class="o">,</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span> <span class="n">interfaceClass</span><span class="o">,</span> <span class="n">registryURL</span><span class="o">.</span><span class="na">addParameterAndEncoded</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">EXPORT_KEY</span><span class="o">,</span> <span class="n">url</span><span class="o">.</span><span class="na">toFullString</span><span class="o">()));</span>
                        <span class="n">Exporter</span><span class="o">&lt;?&gt;</span> <span class="n">exporter</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">invoker</span><span class="o">);</span><span class="c1">//调用ProtocolFilterWrapper-&gt;ProtocolListenerWrapper-&gt;RegistryProtocol
</span><span class="c1"></span>                        <span class="n">exporters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">exporter</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">invoker</span> <span class="o">=</span> <span class="n">proxyFactory</span><span class="o">.</span><span class="na">getInvoker</span><span class="o">(</span><span class="n">ref</span><span class="o">,</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span> <span class="n">interfaceClass</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
                    <span class="n">Exporter</span><span class="o">&lt;?&gt;</span> <span class="n">exporter</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">invoker</span><span class="o">);</span><span class="c1">//调用ProtocolFilterWrapper-&gt;ProtocolListenerWrapper-&gt;RegistryProtocol
</span><span class="c1"></span>                    <span class="n">exporters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">exporter</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">urls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="4-exportlocal-发布本地">4. exportLocal 发布本地</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">exportLocal</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">Constants</span><span class="o">.</span><span class="na">LOCAL_PROTOCOL</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getProtocol</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">URL</span> <span class="n">local</span> <span class="o">=</span> <span class="n">URL</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">toFullString</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">setProtocol</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">LOCAL_PROTOCOL</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="n">LOCALHOST</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
                <span class="n">ServiceClassHolder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">pushServiceClass</span><span class="o">(</span><span class="n">getServiceClass</span><span class="o">(</span><span class="n">ref</span><span class="o">));</span>
                <span class="n">Exporter</span><span class="o">&lt;?&gt;</span> <span class="n">exporter</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span>                   <span class="c1">//调用ProtocolFilterWrapper-&gt;ProtocolListenerWrapper-&gt;InjvmProtocol-&gt;InjvmExporter
</span><span class="c1"></span>                        <span class="n">proxyFactory</span><span class="o">.</span><span class="na">getInvoker</span><span class="o">(</span><span class="n">ref</span><span class="o">,</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span> <span class="n">interfaceClass</span><span class="o">,</span> <span class="n">local</span><span class="o">));</span><span class="c1">//调用StubProxyFactoryWrapper-&gt;JavassistProxyFactory动态创建代理对象
</span><span class="c1"></span>                <span class="n">exporters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">exporter</span><span class="o">);</span>
                <span class="o">...</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="5-发布注册中心">5. 发布注册中心</h2>
<p>ProtocolFilterWrapper-&gt;ProtocolListenerWrapper-&gt;RegistryProtocol</p>
<h3 id="1-protocolfilterwrapperexporter">(1). ProtocolFilterWrapper#exporter</h3>
<ul>
<li>URL是registry注册协议。不封装Filter链的Invoker</li>
<li>Invoker封装构成Filter连图；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Exporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">export</span><span class="o">(</span><span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">invoker</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">REGISTRY_PROTOCOL</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">().</span><span class="na">getProtocol</span><span class="o">()))</span> <span class="o">{</span><span class="c1">//URL是registry注册协议。不封装Filter链的Invoker
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">invoker</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">buildInvokerChain</span><span class="o">(</span><span class="n">invoker</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">SERVICE_FILTER_KEY</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">PROVIDER</span><span class="o">));</span>
    <span class="o">}</span>
    
    
   <span class="c1">// 实现Filter的Invoker封装链处理
</span><span class="c1"></span>   <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">buildInvokerChain</span><span class="o">(</span><span class="kd">final</span> <span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">invoker</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">last</span> <span class="o">=</span> <span class="n">invoker</span><span class="o">;</span>
       <span class="n">List</span><span class="o">&lt;</span><span class="n">Filter</span><span class="o">&gt;</span> <span class="n">filters</span> <span class="o">=</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">Filter</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getActivateExtension</span><span class="o">(</span><span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span> <span class="n">key</span><span class="o">,</span> <span class="n">group</span><span class="o">);</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">filters</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
               <span class="kd">final</span> <span class="n">Filter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
               <span class="kd">final</span> <span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
               <span class="n">last</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;()</span> <span class="o">{</span>

                   <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getInterface</span><span class="o">()</span> <span class="o">{</span>
                       <span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">getInterface</span><span class="o">();</span>
                   <span class="o">}</span>

                   <span class="kd">public</span> <span class="n">URL</span> <span class="nf">getUrl</span><span class="o">()</span> <span class="o">{</span>
                       <span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">();</span>
                   <span class="o">}</span>

                   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAvailable</span><span class="o">()</span> <span class="o">{</span>
                       <span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">isAvailable</span><span class="o">();</span>
                   <span class="o">}</span>

                   <span class="kd">public</span> <span class="n">Result</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Invocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span> <span class="o">{</span>
                       <span class="k">return</span> <span class="n">filter</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">invocation</span><span class="o">);</span>
                   <span class="o">}</span>

                   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
                       <span class="n">invoker</span><span class="o">.</span><span class="na">destroy</span><span class="o">();</span>
                   <span class="o">}</span>

                   <span class="nd">@Override</span>
                   <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
                       <span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                   <span class="o">}</span>
               <span class="o">};</span>
           <span class="o">}</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="n">last</span><span class="o">;</span>
   <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>getActivateExtension获取实现Filter接口注解@Activate对象；@Activate按group，value做筛选；</p>
<p>key:Constants.SERVICE_FILTER_KEY, group:Constants.PROVIDER</p>
<p><img src="/duboo/dubbo04.png" alt=""></p>
<p>GenericFilter处理Dubbo的泛化；</p>
<p>TimeoutFilter只是超时日志打印处理；</p>
<h4 id="afilter的spi实现">a.Filter的SPI实现</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
<span class="cm">/**
</span><span class="cm">* Filter. (SPI, Singleton, ThreadSafe)
</span><span class="cm">*/</span>
<span class="nd">@SPI</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Filter</span> <span class="o">{</span>

  <span class="cm">/**
</span><span class="cm">   * do invoke filter.
</span><span class="cm">   * &lt;p&gt;
</span><span class="cm">   * &lt;code&gt;
</span><span class="cm">   * // before filter
</span><span class="cm">   * Result result = invoker.invoke(invocation);
</span><span class="cm">   * // after filter
</span><span class="cm">   * return result;
</span><span class="cm">   * &lt;/code&gt;
</span><span class="cm">   *
</span><span class="cm">   * @param invoker    service
</span><span class="cm">   * @param invocation invocation.
</span><span class="cm">   * @return invoke result.
</span><span class="cm">   * @throws RpcException
</span><span class="cm">   * @see com.alibaba.dubbo.rpc.Invoker#invoke(Invocation)
</span><span class="cm">   */</span>
  <span class="n">Result</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">invoker</span><span class="o">,</span> <span class="n">Invocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span><span class="o">;</span>


</code></pre></td></tr></table>
</div>
</div><p><img src="/duboo/dubbo03.png" alt=""></p>
<h3 id="2-protocollistenerwrapperexporter">(2). ProtocolListenerWrapper#exporter</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Exporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">export</span><span class="o">(</span><span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">invoker</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">REGISTRY_PROTOCOL</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">().</span><span class="na">getProtocol</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">invoker</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ListenerExporterWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">invoker</span><span class="o">),</span>
                <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">ExporterListener</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">getActivateExtension</span><span class="o">(</span><span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span> <span class="n">Constants</span><span class="o">.</span><span class="na">EXPORTER_LISTENER_KEY</span><span class="o">)));</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExporterListener 未做实现</p>
<h4 id="aexporterlistener的spi实现">a).ExporterListener的SPI实现</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * ExporterListener. (SPI, Singleton, ThreadSafe)
</span><span class="cm"> */</span>
<span class="nd">@SPI</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExporterListener</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * The exporter exported.
</span><span class="cm">     *
</span><span class="cm">     * @param exporter
</span><span class="cm">     * @throws RpcException
</span><span class="cm">     * @see com.alibaba.dubbo.rpc.Protocol#export(Invoker)
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">exported</span><span class="o">(</span><span class="n">Exporter</span><span class="o">&lt;?&gt;</span> <span class="n">exporter</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * The exporter unexported.
</span><span class="cm">     *
</span><span class="cm">     * @param exporter
</span><span class="cm">     * @throws RpcException
</span><span class="cm">     * @see com.alibaba.dubbo.rpc.Exporter#unexport()
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">unexported</span><span class="o">(</span><span class="n">Exporter</span><span class="o">&lt;?&gt;</span> <span class="n">exporter</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="3-registryprotocolexporter">(3). RegistryProtocol#exporter</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Exporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">export</span><span class="o">(</span><span class="kd">final</span> <span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">originInvoker</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span> <span class="o">{</span>
        <span class="c1">//export invoker
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">ExporterChangeableWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">exporter</span> <span class="o">=</span> <span class="n">doLocalExport</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">);</span>

        <span class="n">URL</span> <span class="n">registryUrl</span> <span class="o">=</span> <span class="n">getRegistryUrl</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">);</span>

        <span class="c1">//registry provider
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">Registry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">getRegistry</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">URL</span> <span class="n">registedProviderUrl</span> <span class="o">=</span> <span class="n">getRegistedProviderUrl</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">);</span>

        <span class="c1">//to judge to delay publish whether or not
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="n">register</span> <span class="o">=</span> <span class="n">registedProviderUrl</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;register&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

        <span class="n">ProviderConsumerRegTable</span><span class="o">.</span><span class="na">registerProvider</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">,</span> <span class="n">registryUrl</span><span class="o">,</span> <span class="n">registedProviderUrl</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">register</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">register</span><span class="o">(</span><span class="n">registryUrl</span><span class="o">,</span> <span class="n">registedProviderUrl</span><span class="o">);</span>
            <span class="n">ProviderConsumerRegTable</span><span class="o">.</span><span class="na">getProviderWrapper</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">).</span><span class="na">setReg</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Subscribe the override data
</span><span class="c1"></span>        <span class="c1">// FIXME When the provider subscribes, it will affect the scene : a certain JVM exposes the service and call the same service. Because the subscribed is cached key with the name of the service, it causes the subscription information to cover.
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">URL</span> <span class="n">overrideSubscribeUrl</span> <span class="o">=</span> <span class="n">getSubscribedOverrideUrl</span><span class="o">(</span><span class="n">registedProviderUrl</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">OverrideListener</span> <span class="n">overrideSubscribeListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OverrideListener</span><span class="o">(</span><span class="n">overrideSubscribeUrl</span><span class="o">,</span> <span class="n">originInvoker</span><span class="o">);</span>
        <span class="n">overrideListeners</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">overrideSubscribeUrl</span><span class="o">,</span> <span class="n">overrideSubscribeListener</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">overrideSubscribeUrl</span><span class="o">,</span> <span class="n">overrideSubscribeListener</span><span class="o">);</span>
        <span class="c1">//Ensure that a new exporter instance is returned every time export
</span><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">Exporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getInvoker</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">exporter</span><span class="o">.</span><span class="na">getInvoker</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unexport</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">exporter</span><span class="o">.</span><span class="na">unexport</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">t</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">registry</span><span class="o">.</span><span class="na">unregister</span><span class="o">(</span><span class="n">registedProviderUrl</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">t</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">overrideListeners</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">overrideSubscribeUrl</span><span class="o">);</span>
                    <span class="n">registry</span><span class="o">.</span><span class="na">unsubscribe</span><span class="o">(</span><span class="n">overrideSubscribeUrl</span><span class="o">,</span> <span class="n">overrideSubscribeListener</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">t</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="adolocalexport处理dubboprotocol">a).doLocalExport处理DubboProtocol</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ExporterChangeableWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">doLocalExport</span><span class="o">(</span><span class="kd">final</span> <span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">originInvoker</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">getCacheKey</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">);</span>
        <span class="n">ExporterChangeableWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">exporter</span> <span class="o">=</span> <span class="o">(</span><span class="n">ExporterChangeableWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span> <span class="n">bounds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">exporter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">bounds</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">exporter</span> <span class="o">=</span> <span class="o">(</span><span class="n">ExporterChangeableWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span> <span class="n">bounds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">exporter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">invokerDelegete</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerDelegete</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">originInvoker</span><span class="o">,</span> <span class="n">getProviderUrl</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">));</span>
                    <span class="n">exporter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExporterChangeableWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;((</span><span class="n">Exporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">invokerDelegete</span><span class="o">),</span> <span class="n">originInvoker</span><span class="o">);</span>
                    <span class="n">bounds</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">exporter</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">exporter</span><span class="o">;</span>
    <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="bgetregistry-链接注册中心">b).getRegistry 链接注册中心</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Get an instance of registry based on the address of invoker
</span><span class="cm">     *
</span><span class="cm">     * @param originInvoker
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Registry</span> <span class="nf">getRegistry</span><span class="o">(</span><span class="kd">final</span> <span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">originInvoker</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">URL</span> <span class="n">registryUrl</span> <span class="o">=</span> <span class="n">getRegistryUrl</span><span class="o">(</span><span class="n">originInvoker</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">registryFactory</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">(</span><span class="n">registryUrl</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="i-registryfactory的spi实现">i. RegistryFactory的SPI实现</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * RegistryFactory. (SPI, Singleton, ThreadSafe)
</span><span class="cm"> *
</span><span class="cm"> * @author william.liangf
</span><span class="cm"> * @see com.alibaba.dubbo.registry.support.AbstractRegistryFactory
</span><span class="cm"> */</span>
<span class="nd">@SPI</span><span class="o">(</span><span class="s">&#34;dubbo&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RegistryFactory</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 连接注册中心.
</span><span class="cm">     * &lt;p&gt;
</span><span class="cm">     * 连接注册中心需处理契约：&lt;br&gt;
</span><span class="cm">     * 1. 当设置check=false时表示不检查连接，否则在连接不上时抛出异常。&lt;br&gt;
</span><span class="cm">     * 2. 支持URL上的username:password权限认证。&lt;br&gt;
</span><span class="cm">     * 3. 支持backup=10.20.153.10备选注册中心集群地址。&lt;br&gt;
</span><span class="cm">     * 4. 支持file=registry.cache本地磁盘文件缓存。&lt;br&gt;
</span><span class="cm">     * 5. 支持timeout=1000请求超时设置。&lt;br&gt;
</span><span class="cm">     * 6. 支持session=60000会话超时或过期设置。&lt;br&gt;
</span><span class="cm">     *
</span><span class="cm">     * @param url 注册中心地址，不允许为空
</span><span class="cm">     * @return 注册中心引用，总不返回空
</span><span class="cm">     */</span>
    <span class="nd">@Adaptive</span><span class="o">({</span><span class="s">&#34;protocol&#34;</span><span class="o">})</span>
    <span class="n">Registry</span> <span class="nf">getRegistry</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/duboo/dubbo05.png" alt=""></p>
<h4 id="cregister-提供服务注册到注册中心">c).register 提供服务注册到注册中心</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">URL</span> <span class="n">registryUrl</span><span class="o">,</span> <span class="n">URL</span> <span class="n">registedProviderUrl</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Registry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">registryFactory</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">(</span><span class="n">registryUrl</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">registedProviderUrl</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>例如 Zookeeper注册地址：<br>
/dubbo/com.alibaba.dubbo.demo.DemoService/providers/dubbo%3A%2F%2F192.168.31.12&hellip;.</p>
<h4 id="d订阅constantsconfigurators_category路径配置信息">d).订阅Constants.CONFIGURATORS_CATEGORY路径配置信息</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  
     <span class="n">registry</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">overrideSubscribeUrl</span><span class="o">,</span> <span class="n">overrideSubscribeListener</span><span class="o">);</span>

    <span class="kd">private</span> <span class="n">URL</span> <span class="nf">getSubscribedOverrideUrl</span><span class="o">(</span><span class="n">URL</span> <span class="n">registedProviderUrl</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">registedProviderUrl</span><span class="o">.</span><span class="na">setProtocol</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">PROVIDER_PROTOCOL</span><span class="o">)</span>
                <span class="o">.</span><span class="na">addParameters</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">CATEGORY_KEY</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">CONFIGURATORS_CATEGORY</span><span class="o">,</span>
                        <span class="n">Constants</span><span class="o">.</span><span class="na">CHECK_KEY</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="4-dubboprotocolexporter">(4). DubboProtocol#exporter</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Exporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">export</span><span class="o">(</span><span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">invoker</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span> <span class="o">{</span>
        <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">();</span>

        <span class="c1">// export service.
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">serviceKey</span><span class="o">(</span><span class="n">url</span><span class="o">);</span><span class="c1">//例如：group/com.alibaba.dubbo.demo.DemoService:version:20881
</span><span class="c1"></span>        <span class="n">DubboExporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">exporter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DubboExporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">invoker</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">exporterMap</span><span class="o">);</span> <span class="c1">//创建DubboExporter
</span><span class="c1"></span>        <span class="n">exporterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">exporter</span><span class="o">);</span>

        <span class="c1">//export an stub service for dispatching event
</span><span class="c1"></span>        <span class="n">Boolean</span> <span class="n">isStubSupportEvent</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">STUB_EVENT_KEY</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">DEFAULT_STUB_EVENT</span><span class="o">);</span>
        <span class="n">Boolean</span> <span class="n">isCallbackservice</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">IS_CALLBACK_SERVICE</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isStubSupportEvent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isCallbackservice</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">stubServiceMethods</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">STUB_EVENT_METHODS_KEY</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">stubServiceMethods</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">stubServiceMethods</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">...</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">stubServiceMethodsMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getServiceKey</span><span class="o">(),</span> <span class="n">stubServiceMethods</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">openServer</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
        <span class="n">optimizeSerialization</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">exporter</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="a-openserver-开启netty服务">(a). openServer 开启Netty服务</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">openServer</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// find server.
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
        <span class="c1">//isserver 属性允许客服端调用
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="n">isServer</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">IS_SERVER_KEY</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isServer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ExchangeServer</span> <span class="n">server</span> <span class="o">=</span> <span class="n">serverMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">server</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serverMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">createServer</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">//重置服务配置
</span><span class="c1"></span>                <span class="n">server</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//创建ExchangeServer
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">ExchangeServer</span> <span class="nf">createServer</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//服务器关闭时发送只读事件，默认情况下启用
</span><span class="c1"></span>        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">addParameterIfAbsent</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">CHANNEL_READONLYEVENT_SENT_KEY</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="c1">//心跳配置
</span><span class="c1"></span>        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">addParameterIfAbsent</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">HEARTBEAT_KEY</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">DEFAULT_HEARTBEAT</span><span class="o">));</span>
        <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">SERVER_KEY</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">DEFAULT_REMOTING_SERVER</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">CODEC_KEY</span><span class="o">,</span> <span class="n">DubboCodec</span><span class="o">.</span><span class="na">NAME</span><span class="o">);</span>
        <span class="n">ExchangeServer</span> <span class="n">server</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//ExtensionLoader.getExtensionLoader(Exchanger.class).getExtension(type).bind()
</span><span class="c1"></span>            <span class="n">server</span> <span class="o">=</span> <span class="n">Exchangers</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">requestHandler</span><span class="o">);</span>
        <span class="o">}...</span>
        <span class="n">str</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">CLIENT_KEY</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">str</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">supportedTypes</span> <span class="o">=</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">Transporter</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getSupportedExtensions</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">supportedTypes</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">str</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RpcException</span><span class="o">(</span><span class="s">&#34;Unsupported client type: &#34;</span> <span class="o">+</span> <span class="n">str</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">server</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="b-exchangers">(b). Exchangers</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@SPI</span><span class="o">(</span><span class="n">HeaderExchanger</span><span class="o">.</span><span class="na">NAME</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Exchanger</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * bind.
</span><span class="cm">     *  exchanger
</span><span class="cm">     * @param url
</span><span class="cm">     * @param handler
</span><span class="cm">     * @return message server
</span><span class="cm">     */</span>
    <span class="nd">@Adaptive</span><span class="o">({</span><span class="n">Constants</span><span class="o">.</span><span class="na">EXCHANGER_KEY</span><span class="o">})</span>
    <span class="n">ExchangeServer</span> <span class="nf">bind</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ExchangeHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * connect.
</span><span class="cm">     *
</span><span class="cm">     * @param url
</span><span class="cm">     * @param handler
</span><span class="cm">     * @return message channel
</span><span class="cm">     */</span>
    <span class="nd">@Adaptive</span><span class="o">({</span><span class="n">Constants</span><span class="o">.</span><span class="na">EXCHANGER_KEY</span><span class="o">})</span>
    <span class="n">ExchangeClient</span> <span class="nf">connect</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ExchangeHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/duboo/dubbo06.png" alt=""></p>
<p>就一个类HeaderExchanger</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * DefaultMessenger
</span><span class="cm"> *
</span><span class="cm"> *
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HeaderExchanger</span> <span class="kd">implements</span> <span class="n">Exchanger</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">NAME</span> <span class="o">=</span> <span class="s">&#34;header&#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">ExchangeClient</span> <span class="nf">connect</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ExchangeHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
        <span class="c1">//Transporters.connect=ExtensionLoader.getExtensionLoader(Transporter.class).getAdaptiveExtension().connect
</span><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">HeaderExchangeClient</span><span class="o">(</span><span class="n">Transporters</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="k">new</span> <span class="n">DecodeHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">HeaderExchangeHandler</span><span class="o">(</span><span class="n">handler</span><span class="o">))),</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">ExchangeServer</span> <span class="nf">bind</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ExchangeHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
         <span class="c1">//Transporters.bind=ExtensionLoader.getExtensionLoader(Transporter.class).getAdaptiveExtension().bind
</span><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">HeaderExchangeServer</span><span class="o">(</span><span class="n">Transporters</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="k">new</span> <span class="n">DecodeHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">HeaderExchangeHandler</span><span class="o">(</span><span class="n">handler</span><span class="o">))));</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="iheaderexchangeserver处理心跳">i.HeaderExchangeServer处理心跳</h5>
<h5 id="iidecodehandler包装--headerexchangehandler包装-exchangehandler">ii.DecodeHandler包装&ndash;&gt;HeaderExchangeHandler包装-&gt;ExchangeHandler</h5>
<h4 id="cheaderexchangehandlerreceived-接受">(c).HeaderExchangeHandler#received 接受</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">    public void received(Channel channel, Object message) throws RemotingException {
        channel.setAttribute(KEY_READ_TIMESTAMP, System.currentTimeMillis());
        ExchangeChannel exchangeChannel = HeaderExchangeChannel.getOrAddChannel(channel);
        try {
            if (message instanceof Request) {
                // handle request.
                Request request = (Request) message;
                if (request.isEvent()) {
                    handlerEvent(channel, request);
                } else {
                    if (request.isTwoWay()) {
                        Response response = handleRequest(exchangeChannel, request);
                        channel.send(response);
                    } else {
                        handler.received(exchangeChannel, request.getData());
                    }
                }
            } else if (message instanceof Response) {
                //DefaultFuture.received(channel, response);
                handleResponse(channel, (Response) message);
            }...
            } else {
                handler.received(exchangeChannel, message);
            }
        } finally {
            HeaderExchangeChannel.removeChannelIfDisconnected(channel);
        }
    }
</code></pre></td></tr></table>
</div>
</div><h5 id="irequest和response">i.Request和Response</h5>
<p><img src="/duboo/dubbo23.jpg" alt="">
<img src="/duboo/dubbo24.jpg" alt=""></p>
<h5 id="iirequest">ii.Request</h5>
<h4 id="dheaderexchangehandlerrequest请求">(d).HeaderExchangeHandler#request请求</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">    public ResponseFuture request(Object request, int timeout) throws RemotingException {
        if (closed) {
            throw new RemotingException(this.getLocalAddress(), null, &#34;Failed to send request &#34; + request + &#34;, cause: The channel &#34; + this + &#34; is closed!&#34;);
        }
        // create request.
        Request req = new Request();
        req.setVersion(&#34;2.0.0&#34;);
        req.setTwoWay(true);
        req.setData(request);
        DefaultFuture future = new DefaultFuture(channel, req, timeout);
        try {
            channel.send(req);
        } catch (RemotingException e) {
            future.cancel();
            throw e;
        }
        return future;
    }
</code></pre></td></tr></table>
</div>
</div><h5 id="idefaultfuture实现future模式等待response结果">i.DefaultFuture实现Future模式，等待Response结果</h5>
<ul>
<li>缓存等待DefaultFuture</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">    private static final Map&lt;Long, Channel&gt; CHANNELS = new ConcurrentHashMap&lt;Long, Channel&gt;();

    private static final Map&lt;Long, DefaultFuture&gt; FUTURES = new ConcurrentHashMap&lt;Long, DefaultFuture&gt;();

</code></pre></td></tr></table>
</div>
</div><ul>
<li>创建DefaultFuture，添加到缓存中</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   public DefaultFuture(Channel channel, Request request, int timeout) {
       this.channel = channel;
       this.request = request;
       this.id = request.getId();
       this.timeout = timeout &gt; 0 ? timeout : channel.getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
       // put into waiting map.
       FUTURES.put(id, this);
       CHANNELS.put(id, channel);
   } 
</code></pre></td></tr></table>
</div>
</div><ul>
<li>开启一个线程处理超时DefaultFuture的RemotingInvocationTimeoutScan</li>
</ul>
<h4 id="erequesthandler--客服端请求最终调用方法">(e).requestHandler  客服端请求最终调用方法</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="kd">private</span> <span class="n">ExchangeHandler</span> <span class="n">requestHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExchangeHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">reply</span><span class="o">(</span><span class="n">ExchangeChannel</span> <span class="n">channel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="n">Invocation</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Invocation</span> <span class="n">inv</span> <span class="o">=</span> <span class="o">(</span><span class="n">Invocation</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
                <span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">invoker</span> <span class="o">=</span> <span class="n">getInvoker</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">inv</span><span class="o">);</span> <span class="c1">//exporterMap获取DubboExporter.getInvoker
</span><span class="c1"></span>                <span class="c1">// need to consider backward-compatibility if it&#39;s a callback
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">inv</span><span class="o">.</span><span class="na">getAttachments</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">IS_CALLBACK_SERVICE_INVOKE</span><span class="o">)))</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">methodsStr</span> <span class="o">=</span> <span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">().</span><span class="na">getParameters</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;methods&#34;</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">hasMethod</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">methodsStr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">methodsStr</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">hasMethod</span> <span class="o">=</span> <span class="n">inv</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">methodsStr</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">String</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">methodsStr</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">);</span>
                        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">inv</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
                                <span class="n">hasMethod</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">hasMethod</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;The methodName &#34;</span> <span class="o">+</span> <span class="n">inv</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; not found in callback service interface ,invoke will be ignored. please update the api interface. url is:&#34;</span> <span class="o">+</span> <span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">())</span> <span class="o">+</span> <span class="s">&#34; ,invocation is :&#34;</span> <span class="o">+</span> <span class="n">inv</span><span class="o">);</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">RpcContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setRemoteAddress</span><span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">());</span>
               <span class="c1">//最终调用
</span><span class="c1"></span>               <span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">inv</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RemotingException</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="s">&#34;Unsupported request: &#34;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;, channel: consumer: &#34;</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; --&gt; provider: &#34;</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">getLocalAddress</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">received</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="n">Invocation</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">reply</span><span class="o">((</span><span class="n">ExchangeChannel</span><span class="o">)</span> <span class="n">channel</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">received</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connected</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
            <span class="n">invoke</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">ON_CONNECT_KEY</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disconnected</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="n">invoke</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">ON_DISCONNECT_KEY</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="n">String</span> <span class="n">methodKey</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Invocation</span> <span class="n">invocation</span> <span class="o">=</span> <span class="n">createInvocation</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">channel</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span> <span class="n">methodKey</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">invocation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">received</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">invocation</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to invoke event method &#34;</span> <span class="o">+</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;(), cause: &#34;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">t</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="n">Invocation</span> <span class="nf">createInvocation</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">methodKey</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">methodKey</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">method</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">method</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">RpcInvocation</span> <span class="n">invocation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RpcInvocation</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[</span><span class="n">0</span><span class="o">],</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
            <span class="n">invocation</span><span class="o">.</span><span class="na">setAttachment</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">PATH_KEY</span><span class="o">,</span> <span class="n">url</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
            <span class="n">invocation</span><span class="o">.</span><span class="na">setAttachment</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">GROUP_KEY</span><span class="o">,</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">GROUP_KEY</span><span class="o">));</span>
            <span class="n">invocation</span><span class="o">.</span><span class="na">setAttachment</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">INTERFACE_KEY</span><span class="o">,</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">INTERFACE_KEY</span><span class="o">));</span>
            <span class="n">invocation</span><span class="o">.</span><span class="na">setAttachment</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">VERSION_KEY</span><span class="o">,</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">VERSION_KEY</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">STUB_EVENT_KEY</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">invocation</span><span class="o">.</span><span class="na">setAttachment</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">STUB_EVENT_KEY</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">invocation</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="ftransporter">(f).Transporter</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@SPI</span><span class="o">(</span><span class="s">&#34;netty&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Transporter</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * Bind a server.
</span><span class="cm">     *
</span><span class="cm">     * @param url     server url
</span><span class="cm">     * @param handler
</span><span class="cm">     * @return server
</span><span class="cm">     * @throws RemotingException
</span><span class="cm">     * @see com.alibaba.dubbo.remoting.Transporters#bind(URL, Receiver, ChannelHandler)
</span><span class="cm">     */</span>
    <span class="nd">@Adaptive</span><span class="o">({</span><span class="n">Constants</span><span class="o">.</span><span class="na">SERVER_KEY</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">TRANSPORTER_KEY</span><span class="o">})</span>
    <span class="n">Server</span> <span class="nf">bind</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Connect to a server.
</span><span class="cm">     *
</span><span class="cm">     * @param url     server url
</span><span class="cm">     * @param handler
</span><span class="cm">     * @return client
</span><span class="cm">     * @throws RemotingException
</span><span class="cm">     * @see com.alibaba.dubbo.remoting.Transporters#connect(URL, Receiver, ChannelListener)
</span><span class="cm">     */</span>
    <span class="nd">@Adaptive</span><span class="o">({</span><span class="n">Constants</span><span class="o">.</span><span class="na">CLIENT_KEY</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">TRANSPORTER_KEY</span><span class="o">})</span>
    <span class="n">Client</span> <span class="nf">connect</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/duboo/dubbo07.png" alt=""></p>
<p>NettyTransporter  源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyTransporter</span> <span class="kd">implements</span> <span class="n">Transporter</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">NAME</span> <span class="o">=</span> <span class="s">&#34;netty&#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Server</span> <span class="nf">bind</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">NettyServer</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span><span class="c1">//开启Netty服务
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Client</span> <span class="nf">connect</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">NettyClient</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span><span class="c1">////开启Netty客服端
</span><span class="c1"></span>    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="6registry-注册中心">6.Registry 注册中心</h2>
<p>看看接口类图</p>
<p>![image/dubbo25.jpg]</p>
<h3 id="1实现类">(1).实现类</h3>
<p>![image/dubbo26.jpg]</p>
<ul>
<li>FailbackRegistry故障处理</li>
<li>ZookeeperRegistry Zookeeper注册中心</li>
<li>RedisRegistry redis注册中心</li>
</ul>
<h3 id="2abstractregistry抽象类">(2).AbstractRegistry抽象类</h3>
<h4 id="a构造">a.构造</h4>
<ul>
<li>&ldquo;/.dubbo/dubbo-registry-&rdquo; + APPLICATION + &ldquo;-&rdquo; + Addres + &ldquo;.cache&quot;缓存文件path</li>
<li>文件不存在就创建，加载到缓存properties中</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">    public AbstractRegistry(URL url) {
        setUrl(url);
        // Start file save timer
        syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, false);
        String filename = url.getParameter(Constants.FILE_KEY, System.getProperty(&#34;user.home&#34;) + &#34;/.dubbo/dubbo-registry-&#34; + url.getParameter(Constants.APPLICATION_KEY) + &#34;-&#34; + url.getAddress() + &#34;.cache&#34;);
        File file = null;
        if (ConfigUtils.isNotEmpty(filename)) {
            file = new File(filename);
            if (!file.exists() &amp;&amp; file.getParentFile() != null &amp;&amp; !file.getParentFile().exists()) {
                if (!file.getParentFile().mkdirs()) {
                    throw new IllegalArgumentException(&#34;Invalid registry store file &#34; + file + &#34;, cause: Failed to create directory &#34; + file.getParentFile() + &#34;!&#34;);
                }
            }
        }
        this.file = file;
        loadProperties();
        notify(url.getBackupUrls());
    }
</code></pre></td></tr></table>
</div>
</div><h4 id="b数据结构">b.数据结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   private final Set&lt;URL&gt; registered = new ConcurrentHashSet&lt;URL&gt;();
   private final ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = new ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();
   private final ConcurrentMap&lt;URL, Map&lt;String, List&lt;URL&gt;&gt;&gt; notified = new ConcurrentHashMap&lt;URL, Map&lt;String, List&lt;URL&gt;&gt;&gt;();
</code></pre></td></tr></table>
</div>
</div><p>从这个数据结构中，一目了然注册和监听都是ConcurrentMap控制，这里具体不说了</p>
<h4 id="cnotify配置信息有变动实时触发">c.notify配置信息有变动实时触发</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   protected void notify(URL url, NotifyListener listener, List&lt;URL&gt; urls) {
       ...
       Map&lt;String, List&lt;URL&gt;&gt; result = new HashMap&lt;String, List&lt;URL&gt;&gt;();
       //把url进行分组操作    
       for (URL u : urls) {
           if (UrlUtils.isMatch(url, u)) {
               String category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
               List&lt;URL&gt; categoryList = result.get(category);
               if (categoryList == null) {
                   categoryList = new ArrayList&lt;URL&gt;();
                   result.put(category, categoryList);
               }
               categoryList.add(u);
           }
       }
       if (result.size() == 0) {
           return;
       }
       //缓存到notified
       //在持久化文件
       //触发NotifyListener#notify
       Map&lt;String, List&lt;URL&gt;&gt; categoryNotified = notified.get(url);
       if (categoryNotified == null) {
           notified.putIfAbsent(url, new ConcurrentHashMap&lt;String, List&lt;URL&gt;&gt;());
           categoryNotified = notified.get(url);
       }
       for (Map.Entry&lt;String, List&lt;URL&gt;&gt; entry : result.entrySet()) {
           String category = entry.getKey();
           List&lt;URL&gt; categoryList = entry.getValue();
           categoryNotified.put(category, categoryList);
           saveProperties(url);
           listener.notify(categoryList);
       }
   } 
</code></pre></td></tr></table>
</div>
</div><h3 id="3failbackregistry容错处理">(3).FailbackRegistry容错处理</h3>
<p>例如注册失败或者订阅失败等错误是怎么处理呢？？</p>
<h4 id="a看看数据结构">a.看看数据结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   private final Set&lt;URL&gt; failedRegistered = new ConcurrentHashSet&lt;URL&gt;();

   private final Set&lt;URL&gt; failedUnregistered = new ConcurrentHashSet&lt;URL&gt;();

   private final ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; failedSubscribed = new ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();

   private final ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; failedUnsubscribed = new ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();

   private final ConcurrentMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt; failedNotified = new ConcurrentHashMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt;(); 
</code></pre></td></tr></table>
</div>
</div><p>记录错误操作对应相应操作</p>
<h4 id="b构造器">b.构造器</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   public FailbackRegistry(URL url) {
       super(url);
       // 默认每5秒执行
       int retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);
       this.retryFuture = retryExecutor.scheduleWithFixedDelay(new Runnable() {
           public void run() {
               // Check and connect to the registry
               try {
                   retry();
               } catch (Throwable t) { // Defensive fault tolerance
                   logger.error(&#34;Unexpected error occur at failed retry, cause: &#34; + t.getMessage(), t);
               }
           }
       }, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);
   }
</code></pre></td></tr></table>
</div>
</div><p>原理就是线程池每5秒触发一次，重试操作；是不是很简单</p>
<h3 id="4zookeeperregistry">(4).ZookeeperRegistry</h3>
<h4 id="a构造方法">a.构造方法</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   public ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) {
       super(url);
       if (url.isAnyHost()) {
           throw new IllegalStateException(&#34;registry address == null&#34;);
       }
       String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT);
       if (!group.startsWith(Constants.PATH_SEPARATOR)) {
           group = Constants.PATH_SEPARATOR + group;
       }
       this.root = group;
       zkClient = zookeeperTransporter.connect(url);
       zkClient.addStateListener(new StateListener() {
           public void stateChanged(int state) {
               if (state == RECONNECTED) {
                   try {
                       //重新链接进行重新注册以及订阅操作
                       recover();
                   }...
               }
           }
       });
   } 
</code></pre></td></tr></table>
</div>
</div><ul>
<li>ZookeeperTransporter接口创建不同的zookeeper客户端；用户自己选择</li>
<li>这里不具体分析ZookeeperTransporter</li>
</ul>
<h4 id="bdoregister-注册服务">b.doRegister 注册服务</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   protected void doRegister(URL url) {
       try {
           zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, true));
       } catch (Throwable e) {
           throw new RpcException(&#34;Failed to register &#34; + url + &#34; to zookeeper &#34; + getUrl() + &#34;, cause: &#34; + e.getMessage(), e);
       }
   } 
</code></pre></td></tr></table>
</div>
</div><p>toUrlPath： dubbo+/+ServiceInterface+/+CATEGORY_KEY+/+Url</p>
<h4 id="cdosubscrib订阅">c.doSubscrib订阅</h4>
<ul>
<li>ServiceInterface为*时，订阅dubbo下路径</li>
<li>为正式服务名时，监听服务路径通知this.notify方法</li>
</ul>
<h3 id="2redisregistry">(2).RedisRegistry</h3>
<p>链接Redis工具包JedisPool；看看注册服务和订阅是怎么实现</p>
<h4 id="adoregister注册服务">a.doRegister注册服务</h4>
<ul>
<li>hset(key, value, expire)</li>
<li>publish(key, Constants.REGISTER); 命令用于将信息发送到指定的频道。</li>
<li>expire过期时间，注册服务过期怎么处理呢？
<ul>
<li>expirePeriod默认60秒</li>
<li>调度线程每expirePeriod/2;重新hset和publish命令</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">    @Override
    public void doRegister(URL url) {
        String key = toCategoryPath(url);
        String value = url.toFullString();
        String expire = String.valueOf(System.currentTimeMillis() + expirePeriod);
        boolean success = false;
        RpcException exception = null;
        for (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {
            JedisPool jedisPool = entry.getValue();
            try {
                Jedis jedis = jedisPool.getResource();
                try {
                    jedis.hset(key, value, expire);
                    jedis.publish(key, Constants.REGISTER);
                    success = true;
                    if (!replicate) {
                        break; //  If the server side has synchronized data, just write a single machine
                    }
                } finally {
                    jedisPool.returnResource(jedis);
                }
            }...
        }
        ...
    }
</code></pre></td></tr></table>
</div>
</div><h4 id="bdosubscribe订阅">b.doSubscribe订阅</h4>
<ul>
<li>开启Notifier线程，用命令psubscribe订阅操作</li>
</ul>
<h2 id="7nettyserver-源码分析">7.NettyServer 源码分析</h2>
<h3 id="1构造">(1).构造</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
   <span class="kd">public</span> <span class="nf">NettyServer</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span> <span class="o">{</span>
      <span class="c1">//new MultiMessageHandler(new HeartbeatHandler(ExtensionLoader.getExtensionLoader(Dispatcher.class)
</span><span class="c1"></span>      <span class="c1">//                 .getAdaptiveExtension().dispatch(handler, url))
</span><span class="c1"></span>        <span class="kd">super</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">ChannelHandlers</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">handler</span><span class="o">,</span> <span class="n">ExecutorUtil</span><span class="o">.</span><span class="na">setThreadName</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">SERVER_THREAD_POOL_NAME</span><span class="o">)));</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>MultiMessageHandler处理多个消息</li>
<li>HeartbeatHandler心跳处理</li>
<li>形成ChannelHandler连
<ul>
<li>MultiMessageHandler -&gt; HeartbeatHandler -&gt; XXXChannelHandler(Dispatcher) -&gt; DecodeHandler&ndash;&gt;HeaderExchangeHandler-&gt;ExchangeHandle</li>
</ul>
</li>
</ul>
<h3 id="2channelhandler-channel处理">(2).ChannelHandler Channel处理</h3>
<p><img src="/duboo/dubbo20.png" alt=""></p>
<p>顾名思义知道方法意思</p>
<h3 id="3dispatcher线程派发器">(3).Dispatcher线程派发器</h3>
<p>通道信息派发器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@SPI</span><span class="o">(</span><span class="n">AllDispatcher</span><span class="o">.</span><span class="na">NAME</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Dispatcher</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * dispatch the message to threadpool.
</span><span class="cm">     *
</span><span class="cm">     * @param handler
</span><span class="cm">     * @param url
</span><span class="cm">     * @return channel handler
</span><span class="cm">     */</span>
    <span class="nd">@Adaptive</span><span class="o">({</span><span class="n">Constants</span><span class="o">.</span><span class="na">DISPATCHER_KEY</span><span class="o">,</span> <span class="s">&#34;dispather&#34;</span><span class="o">,</span> <span class="s">&#34;channel.handler&#34;</span><span class="o">})</span>
    <span class="c1">// The last two parameters are reserved for compatibility with the old configuration
</span><span class="c1"></span>    <span class="n">ChannelHandler</span> <span class="nf">dispatch</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="n">URL</span> <span class="n">url</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/duboo/dubbo08.png" alt=""></p>
<ul>
<li>all:所有消息都派发到线程池，包括请求、响应、连接事件、断开事件、心跳等。</li>
<li>direct:所有消息都不派发到线程池，全部在IO线程上直接执行。</li>
<li>message:只有请求响应消息派发到线程池，其他连接断开事件、心跳等消息，直接在IO线程上执行。</li>
<li>execution:只请求消息派发到线程池，不含响应，响应和其他连接断开事件、心跳等消息，直接在IO线程上执行。</li>
<li>connection:创建单个线程池，将连接断开事件放入队列，有序逐个执行，其他消息派发到线程池。</li>
</ul>
<h4 id="aalldispatcher源码分析">a.AllDispatcher源码分析</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * default thread pool configure
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllDispatcher</span> <span class="kd">implements</span> <span class="n">Dispatcher</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">NAME</span> <span class="o">=</span> <span class="s">&#34;all&#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">ChannelHandler</span> <span class="nf">dispatch</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="n">URL</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">AllChannelHandler</span><span class="o">(</span><span class="n">handler</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="ballchannelhandler线程池执行客户端请求">b.AllChannelHandler线程池执行客户端请求</h4>
<p>AllChannelHandler继续WrappedChannelHandler抽象方法</p>
<h5 id="iwrappedchannelhandler构造方法创建业务线程池">i.WrappedChannelHandler#构造方法创建业务线程池</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="nf">WrappedChannelHandler</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="n">URL</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">;</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="o">(</span><span class="n">ExecutorService</span><span class="o">)</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">ThreadPool</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getAdaptiveExtension</span><span class="o">().</span><span class="na">getExecutor</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">componentKey</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="na">EXECUTOR_SERVICE_COMPONENT_KEY</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">CONSUMER_SIDE</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">SIDE_KEY</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">componentKey</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="na">CONSUMER_SIDE</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">DataStore</span> <span class="n">dataStore</span> <span class="o">=</span> <span class="n">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">DataStore</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getDefaultExtension</span><span class="o">();</span>
        <span class="n">dataStore</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">componentKey</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getPort</span><span class="o">()),</span> <span class="n">executor</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="iiwrappedchannelhandler往线程池中添加channeleventrunnable任务">ii.WrappedChannelHandler往线程池中添加ChannelEventRunnable任务</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">  public void connected(Channel channel) throws RemotingException {
       ExecutorService cexecutor = getExecutorService();
       try {
           cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.CONNECTED));
       }...
   }

   public void disconnected(Channel channel) throws RemotingException {
       ExecutorService cexecutor = getExecutorService();
       try {
           cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.DISCONNECTED));
       }...
   }

   public void received(Channel channel, Object message) throws RemotingException {
       ExecutorService cexecutor = getExecutorService();
       try {
           cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.RECEIVED, message));
       }...
   }

   public void caught(Channel channel, Throwable exception) throws RemotingException {
       ExecutorService cexecutor = getExecutorService();
       try {
           cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.CAUGHT, exception));
       }...
   } 
</code></pre></td></tr></table>
</div>
</div><h4 id="c-threadpool的spi实现">c. ThreadPool的SPI实现</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * ThreadPool
</span><span class="cm"> */</span>
<span class="nd">@SPI</span><span class="o">(</span><span class="s">&#34;fixed&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ThreadPool</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * Thread pool
</span><span class="cm">     *
</span><span class="cm">     * @param url URL contains thread parameter
</span><span class="cm">     * @return thread pool
</span><span class="cm">     */</span>
    <span class="nd">@Adaptive</span><span class="o">({</span><span class="n">Constants</span><span class="o">.</span><span class="na">THREADPOOL_KEY</span><span class="o">})</span>
    <span class="n">Executor</span> <span class="nf">getExecutor</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/duboo/dubbo09.png" alt=""></p>
<ul>
<li>fixed:固定大小线程池，启动时建立线程，不关闭，一直持有。</li>
<li>cached: 缓存线程池，空闲一分钟自动删除，需要时重建。</li>
<li>limited:可伸缩线程池，但池中的线程只会增长不会收缩。</li>
</ul>
<h4 id="d-datastore的spi实现">d. DataStore的SPI实现</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@SPI</span><span class="o">(</span><span class="s">&#34;simple&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DataStore</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * return a snapshot value of componentName
</span><span class="cm">     */</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">componentName</span><span class="o">);</span>

    <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">componentName</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="n">String</span> <span class="n">componentName</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">componentName</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/duboo/dubbo10.png" alt=""></p>
<ul>
<li>SimpleDataStore
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">    // &lt;component name or id, &lt;data-name, data-value&gt;&gt;
    private ConcurrentMap&lt;String, ConcurrentMap&lt;String, Object&gt;&gt; data =
            new ConcurrentHashMap&lt;String, ConcurrentMap&lt;String, Object&gt;&gt;();
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="dchanneleventrunnablerun业务线程池任务处理">d.ChannelEventRunnable#run业务线程池任务处理</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"> public void run() {
     switch (state) {
         case CONNECTED:
             try {
                 handler.connected(channel);
             }...
             break;
         case DISCONNECTED:
             try {
                 handler.disconnected(channel);
             }...
             break;
         case SENT:
             try {
                 handler.sent(channel, message);
             }...
             break;
         case RECEIVED:
             try {
                 handler.received(channel, message);
             }...
             break;
         case CAUGHT:
             try {
                 handler.caught(channel, exception);
             }...
             break;
         default:
             logger.warn(&#34;unknown state: &#34; + state + &#34;, message is &#34; + message);
     }
 }   
</code></pre></td></tr></table>
</div>
</div><h3 id="4doopen-start-server">(4).doOpen start Server</h3>
<p>Netty4启动服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   @Override
   protected void doOpen() throws Throwable {
       NettyHelper.setNettyLoggerFactory();

       bootstrap = new ServerBootstrap();

       bossGroup = new NioEventLoopGroup(1, new DefaultThreadFactory(&#34;NettyServerBoss&#34;, true));
       workerGroup = new NioEventLoopGroup(getUrl().getPositiveParameter(Constants.IO_THREADS_KEY, Constants.DEFAULT_IO_THREADS),
               new DefaultThreadFactory(&#34;NettyServerWorker&#34;, true));

       final NettyServerHandler nettyServerHandler = new NettyServerHandler(getUrl(), this);
       channels = nettyServerHandler.getChannels();

       bootstrap.group(bossGroup, workerGroup)
               .channel(NioServerSocketChannel.class)
               .childOption(ChannelOption.TCP_NODELAY, Boolean.TRUE)
               .childOption(ChannelOption.SO_REUSEADDR, Boolean.TRUE)
               .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)
               .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() {
                   @Override
                   protected void initChannel(NioSocketChannel ch) throws Exception {
                       NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyServer.this);
                       ch.pipeline()//.addLast(&#34;logging&#34;,new LoggingHandler(LogLevel.INFO))//for debug
                               .addLast(&#34;decoder&#34;, adapter.getDecoder()) 
                               .addLast(&#34;encoder&#34;, adapter.getEncoder())
                               .addLast(&#34;handler&#34;, nettyServerHandler);
                   }
               });
       // bind
       ChannelFuture channelFuture = bootstrap.bind(getBindAddress());
       channelFuture.syncUninterruptibly();
       channel = channelFuture.channel();

   } 
</code></pre></td></tr></table>
</div>
</div><h4 id="anettycodecadapter编解码器适配器">a.NettyCodecAdapter编解码器适配器</h4>
<h5 id="iencode编码最终调用codecencode">i.encode编码，最终调用codec.encode</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   private class InternalEncoder extends MessageToByteEncoder {

       protected void encode(ChannelHandlerContext ctx, Object msg, ByteBuf out) throws Exception {
           com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = new NettyBackedChannelBuffer(out);
           Channel ch = ctx.channel();
           NettyChannel channel = NettyChannel.getOrAddChannel(ch, url, handler);
           try {
               codec.encode(channel, buffer, msg);
           } finally {
               NettyChannel.removeChannelIfDisconnected(ch);
           }
       }
   } 
</code></pre></td></tr></table>
</div>
</div><h5 id="iidecode解码最终调用codecdecode">ii.decode解码，最终调用codec.decode</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">private class InternalDecoder extends ByteToMessageDecoder {

        protected void decode(ChannelHandlerContext ctx, ByteBuf input, List&lt;Object&gt; out) throws Exception {

            ChannelBuffer message = new NettyBackedChannelBuffer(input);

            NettyChannel channel = NettyChannel.getOrAddChannel(ctx.channel(), url, handler);

            Object msg;

            int saveReaderIndex;

            try {
                // decode object.
                do {
                    saveReaderIndex = message.readerIndex();
                    try {
                        msg = codec.decode(channel, message);
                    } catch (IOException e) {
                        throw e;
                    }
                    if (msg == Codec2.DecodeResult.NEED_MORE_INPUT) {
                        message.readerIndex(saveReaderIndex);
                        break;
                    } else {
                        //is it possible to go here ?
                        if (saveReaderIndex == message.readerIndex()) {
                            throw new IOException(&#34;Decode without read data.&#34;);
                        }
                        if (msg != null) {
                            out.add(msg);
                        }
                    }
                } while (message.readable());
            } finally {
                NettyChannel.removeChannelIfDisconnected(ctx.channel());
            }
        }
</code></pre></td></tr></table>
</div>
</div><h4 id="bcodec2编解码器">b.Codec2编解码器</h4>
<p><img src="/duboo/dubbo22.jpg" alt=""></p>
<h5 id="1dubbocodec默认编解码器继承exchangecodecexchangecodec最终进行编解码器">(1).DubboCodec默认编解码器,继承ExchangeCodec,ExchangeCodec最终进行编解码器</h5>
<p>ExchangeCodec源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   public void encode(Channel channel, ChannelBuffer buffer, Object msg) throws IOException {
        if (msg instanceof Request) {
            encodeRequest(channel, buffer, (Request) msg);
        } else if (msg instanceof Response) {
            encodeResponse(channel, buffer, (Response) msg);
        } else {
            super.encode(channel, buffer, msg);
        }
    }

    public Object decode(Channel channel, ChannelBuffer buffer) throws IOException {
        int readable = buffer.readableBytes();
        byte[] header = new byte[Math.min(readable, HEADER_LENGTH)];
        buffer.readBytes(header);
        return decode(channel, buffer, readable, header);
    }
</code></pre></td></tr></table>
</div>
</div><h5 id="2exchangecodecencoderequest">(2).ExchangeCodec#encodeRequest</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   protected void encodeRequest(Channel channel, ChannelBuffer buffer, Request req) throws IOException {
       //获取Serialization
       Serialization serialization = getSerialization(channel);
       // 16
       byte[] header = new byte[HEADER_LENGTH];
       // 魔数占有2个字节，0xdabb
       Bytes.short2bytes(MAGIC, header);

       // 设置数据包类型（Request/Response）和序列化器编号
       // byte FLAG_REQUEST = (byte) 0x80;
       // byte FLAG_TWOWAY = (byte) 0x40;
       // byte FLAG_EVENT = (byte) 0x20;
       // int SERIALIZATION_MASK = 0x1f;
       header[2] = (byte) (FLAG_REQUEST | serialization.getContentTypeId());

       if (req.isTwoWay()) header[2] |= FLAG_TWOWAY;
       if (req.isEvent()) header[2] |= FLAG_EVENT;

       // request id 4个字节
       Bytes.long2bytes(req.getId(), header, 4);

       // encode request data.
       int savedWriteIndex = buffer.writerIndex();
       buffer.writerIndex(savedWriteIndex + HEADER_LENGTH);
       ChannelBufferOutputStream bos = new ChannelBufferOutputStream(buffer);
       ObjectOutput out = serialization.serialize(channel.getUrl(), bos);
       if (req.isEvent()) {
           encodeEventData(channel, out, req.getData());
       } else {
           encodeRequestData(channel, out, req.getData());
       }
       out.flushBuffer();
       if (out instanceof Cleanable) {
           ((Cleanable) out).cleanup();
       }
       bos.flush();
       bos.close();
       int len = bos.writtenBytes();
       checkPayload(channel, len);
       Bytes.int2bytes(len, header, 12);

       // write
       buffer.writerIndex(savedWriteIndex);
       buffer.writeBytes(header); // write header.
       buffer.writerIndex(savedWriteIndex + HEADER_LENGTH + len);
   } 
</code></pre></td></tr></table>
</div>
</div><h5 id="3dubbocodecencoderequestdata">(3).DubboCodec#encodeRequestData</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">   @Override
   protected void encodeRequestData(Channel channel, ObjectOutput out, Object data) throws IOException {
       RpcInvocation inv = (RpcInvocation) data;

       out.writeUTF(inv.getAttachment(Constants.DUBBO_VERSION_KEY, DUBBO_VERSION));
       out.writeUTF(inv.getAttachment(Constants.PATH_KEY));
       out.writeUTF(inv.getAttachment(Constants.VERSION_KEY));

       out.writeUTF(inv.getMethodName());
       out.writeUTF(ReflectUtils.getDesc(inv.getParameterTypes()));
       Object[] args = inv.getArguments();
       if (args != null)
           for (int i = 0; i &lt; args.length; i++) {
               out.writeObject(encodeInvocationArgument(channel, inv, i));
           }
       out.writeObject(inv.getAttachments());
   } 
</code></pre></td></tr></table>
</div>
</div><h5 id="4exchangecodecencoderesponse">(4).ExchangeCodec#encodeResponse</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">protected void encodeResponse(Channel channel, ChannelBuffer buffer, Response res) throws IOException {
       int savedWriteIndex = buffer.writerIndex();
       try {
           Serialization serialization = getSerialization(channel);
           // header.
           byte[] header = new byte[HEADER_LENGTH];
           // set magic number.
           Bytes.short2bytes(MAGIC, header);
           // set request and serialization flag.
           header[2] = serialization.getContentTypeId();
           if (res.isHeartbeat()) header[2] |= FLAG_EVENT;
           // set response status.
           byte status = res.getStatus();
           header[3] = status;
           // set request id.
           Bytes.long2bytes(res.getId(), header, 4);

           buffer.writerIndex(savedWriteIndex + HEADER_LENGTH);
           ChannelBufferOutputStream bos = new ChannelBufferOutputStream(buffer);
           ObjectOutput out = serialization.serialize(channel.getUrl(), bos);
           // encode response data or error message.
           if (status == Response.OK) {
               if (res.isHeartbeat()) {
                   encodeHeartbeatData(channel, out, res.getResult());
               } else {
                   encodeResponseData(channel, out, res.getResult());
               }
           } else out.writeUTF(res.getErrorMessage());
           out.flushBuffer();
           if (out instanceof Cleanable) {
               ((Cleanable) out).cleanup();
           }
           bos.flush();
           bos.close();

           int len = bos.writtenBytes();
           checkPayload(channel, len);
           Bytes.int2bytes(len, header, 12);
           // write
           buffer.writerIndex(savedWriteIndex);
           buffer.writeBytes(header); // write header.
           buffer.writerIndex(savedWriteIndex + HEADER_LENGTH + len);
       } catch (Throwable t) {
           // clear buffer
           buffer.writerIndex(savedWriteIndex);
           // send error message to Consumer, otherwise, Consumer will wait till timeout.
           if (!res.isEvent() &amp;&amp; res.getStatus() != Response.BAD_RESPONSE) {
               Response r = new Response(res.getId(), res.getVersion());
               r.setStatus(Response.BAD_RESPONSE);

               if (t instanceof ExceedPayloadLimitException) {
                   logger.warn(t.getMessage(), t);
                   try {
                       r.setErrorMessage(t.getMessage());
                       channel.send(r);
                       return;
                   }...
               } else {
                   // FIXME log error message in Codec and handle in caught() of IoHanndler?
                   logger.warn(&#34;Fail to encode response: &#34; + res + &#34;, send bad_response info instead, cause: &#34; + t.getMessage(), t);
                   try {
                       r.setErrorMessage(&#34;Failed to send response: &#34; + res + &#34;, cause: &#34; + StringUtils.toString(t));
                       channel.send(r);
                       return;
                   }...
               }
           }
           ....
       }
   } 
</code></pre></td></tr></table>
</div>
</div><h5 id="5dubbocodecdecodebody">(5).DubboCodec#decodeBody</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">    protected Object decodeBody(Channel channel, InputStream is, byte[] header) throws IOException {
        byte flag = header[2], proto = (byte) (flag &amp; SERIALIZATION_MASK);
        Serialization s = CodecSupport.getSerialization(channel.getUrl(), proto);
        // get request id.
        long id = Bytes.bytes2long(header, 4);
        if ((flag &amp; FLAG_REQUEST) == 0) {
            // decode response.
            Response res = new Response(id);
            if ((flag &amp; FLAG_EVENT) != 0) {
                res.setEvent(Response.HEARTBEAT_EVENT);
            }
            // get status.
            byte status = header[3];
            res.setStatus(status);
            if (status == Response.OK) {
                try {
                    Object data;
                    if (res.isHeartbeat()) {
                        data = decodeHeartbeatData(channel, deserialize(s, channel.getUrl(), is));
                    } else if (res.isEvent()) {
                        data = decodeEventData(channel, deserialize(s, channel.getUrl(), is));
                    } else {
                        DecodeableRpcResult result;
                        if (channel.getUrl().getParameter(
                                Constants.DECODE_IN_IO_THREAD_KEY,
                                Constants.DEFAULT_DECODE_IN_IO_THREAD)) {
                            result = new DecodeableRpcResult(channel, res, is,
                                    (Invocation) getRequestData(id), proto);
                            result.decode();
                        } else {
                            result = new DecodeableRpcResult(channel, res,
                                    new UnsafeByteArrayInputStream(readMessageData(is)),
                                    (Invocation) getRequestData(id), proto);
                        }
                        data = result;
                    }
                    res.setResult(data);
                } ...
            } ...
            return res;
        } else {
            // decode request.
            Request req = new Request(id);
            req.setVersion(&#34;2.0.0&#34;);
            req.setTwoWay((flag &amp; FLAG_TWOWAY) != 0);
            if ((flag &amp; FLAG_EVENT) != 0) {
                req.setEvent(Request.HEARTBEAT_EVENT);
            }
            try {
                Object data;
                if (req.isHeartbeat()) {
                    data = decodeHeartbeatData(channel, deserialize(s, channel.getUrl(), is));
                } else if (req.isEvent()) {
                    data = decodeEventData(channel, deserialize(s, channel.getUrl(), is));
                } else {
                    DecodeableRpcInvocation inv;
                    if (channel.getUrl().getParameter(
                            Constants.DECODE_IN_IO_THREAD_KEY,
                            Constants.DEFAULT_DECODE_IN_IO_THREAD)) {
                        inv = new DecodeableRpcInvocation(channel, req, is, proto);
                        inv.decode();
                    } else {
                        inv = new DecodeableRpcInvocation(channel, req,
                                new UnsafeByteArrayInputStream(readMessageData(is)), proto);
                    }
                    data = inv;
                }
                req.setData(data);
            }...
            return req;
        }
    }
</code></pre></td></tr></table>
</div>
</div><h4 id="cnettyserverhandler">c.NettyServerHandler</h4>
<ul>
<li>channelActive调用ChannelHandler.connected</li>
<li>channelInactive调用ChannelHandler.connected</li>
<li>channelRead调用ChannelHandler.received</li>
<li>write调用ChannelHandler.sent</li>
<li>exceptionCaughtd调用ChannelHandler.caught</li>
<li>NettyChannel缓存上下文</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">  @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelActive();
         
        NettyChannel channel = NettyChannel.getOrAddChannel(ctx.channel(), url, handler);
        try {
            if (channel != null) {
                channels.put(NetUtils.toAddressString((InetSocketAddress) ctx.channel().remoteAddress()), channel);
            }
            handler.connected(channel);
        } finally {
            NettyChannel.removeChannelIfDisconnected(ctx.channel());
        }
    }
</code></pre></td></tr></table>
</div>
</div><h3 id="5nettyserver实现channelhandler接口">(5).NettyServer实现ChannelHandler接口</h3>
<h2 id="7filter">7.Filter</h2>
<h3 id="1executelimitfilter用于提供者限制并发数量">1.ExecuteLimitFilter用于提供者限制并发数量</h3>
<ul>
<li>方法+executes 配置并发数量</li>
<li>Semaphore控制</li>
</ul>
<h3 id="2activelimitfilter用于消费者限制并发数量">2.ActiveLimitFilter用于消费者限制并发数量</h3>
<ul>
<li>方法+actives配置并发数量</li>
<li>方法+timeout设置等待</li>
<li>AtomicInteger控制数量</li>
<li>RpcStatus做统计</li>
</ul>
<h3 id="3genericfilter用于泛化提供者实现">3.GenericFilter用于泛化提供者实现</h3>
<ul>
<li>方法名称：$invoke</li>
<li>参数包含generic</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">  public Result invoke(Invoker&lt;?&gt; invoker, Invocation inv) throws RpcException {
      if (inv.getMethodName().equals(Constants.$INVOKE)
              &amp;&amp; inv.getArguments() != null
              &amp;&amp; inv.getArguments().length == 3
              &amp;&amp; !ProtocolUtils.isGeneric(invoker.getUrl().getParameter(Constants.GENERIC_KEY))) {
          String name = ((String) inv.getArguments()[0]).trim();
          String[] types = (String[]) inv.getArguments()[1];
          Object[] args = (Object[]) inv.getArguments()[2];
          try {
              Method method = ReflectUtils.findMethodByMethodSignature(invoker.getInterface(), name, types);
              Class&lt;?&gt;[] params = method.getParameterTypes();
              if (args == null) {
                  args = new Object[params.length];
              }
              String generic = inv.getAttachment(Constants.GENERIC_KEY);
              //通用序列号，true
              if (StringUtils.isEmpty(generic)
                      || ProtocolUtils.isDefaultGenericSerialization(generic)) {
                  //反射处理
                  args = PojoUtils.realize(args, params, method.getGenericParameterTypes());
              } else if (ProtocolUtils.isJavaGenericSerialization(generic)) { //nativejava
                  for (int i = 0; i &lt; args.length; i++) {
                      if (byte[].class == args[i].getClass()) {
                          try {
                             //NativeJavaSerialization反序列化操作
                              UnsafeByteArrayInputStream is = new UnsafeByteArrayInputStream((byte[]) args[i]);
                              args[i] = ExtensionLoader.getExtensionLoader(Serialization.class)
                                      .getExtension(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
                                      .deserialize(null, is).readObject();
                          }...
                      }...
                  }
              } else if (ProtocolUtils.isBeanGenericSerialization(generic)) {
                  for (int i = 0; i &lt; args.length; i++) {
                      //bean反序列化操作
                      if (args[i] instanceof JavaBeanDescriptor) {
                          args[i] = JavaBeanSerializeUtil.deserialize((JavaBeanDescriptor) args[i]);
                      }...
                  }
              }
              Result result = invoker.invoke(new RpcInvocation(method, args, inv.getAttachments()));
              if (result.hasException()
                      &amp;&amp; !(result.getException() instanceof GenericException)) {
                  return new RpcResult(new GenericException(result.getException()));
              }
              if (ProtocolUtils.isJavaGenericSerialization(generic)) {
                  try {
                      //nativejava进行相应序列化
                      UnsafeByteArrayOutputStream os = new UnsafeByteArrayOutputStream(512);
                      ExtensionLoader.getExtensionLoader(Serialization.class)
                              .getExtension(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
                              .serialize(null, os).writeObject(result.getValue());
                      return new RpcResult(os.toByteArray());
                  }...
              }...
          }...
      }
      return invoker.invoke(inv);
  }  
</code></pre></td></tr></table>
</div>
</div><h3 id="4genericimplfilter用于泛化消费者实现">4.GenericImplFilter用于泛化消费者实现</h3>
<ul>
<li>URL参数包含generic就可以进行泛化</li>
<li>按参数内容进行序列化操作</li>
<li>GenericService进行调用</li>
</ul>

  </div>

  <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">BirdGod</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2018-12-10 20:18
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/birdgodtech/blog/master/LICENSE">MIT</a></span>
  </p>
</div>
<footer class="post-footer">
    <div class="post-tags">
      <a href="/tags/dubbo/">dubbo</a>
      </div>
    <nav class="post-nav" style="height: 27px">
      <a class="prev" href="/post/dubbo/03.dubbo%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">dubbo引用服务</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
      <a class="next" href="/post/dubbo/01.dubbo%E4%B8%AD%E7%9A%84SPI%E6%9C%BA%E5%88%B6/">
        <span class="next-text nav-default">dubbo中的SPI机制</span>
        <span class="next-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav>
  </footer>
  <script src="https://utteranc.es/client.js"
          repo="birdgodtech/birdgodtech.github.io"
          issue-term="pathname"
          theme="github-light"
          crossorigin="anonymous"
          async>
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterance.</a></noscript>
</article>
            </div>
            

        </div>
    </main>

    <footer id="footer" class="footer">
        <div class="social-links">
  <a href="mailto:birdgodtech@163.com" class="iconfont icon-email" title="email" rel="noopener" target="_blank" data-title="email"> </a>
  <a href="https://github.com/birdgodtech" class="iconfont icon-github" title="github" rel="noopener" target="_blank" data-title="github"> </a>
  <a href="https://birdgodtech.github.io/index.xml" type="application/rss+xml" rel="noopener" target="_blank" class="iconfont icon-rss" title="rss"></a>


</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy;
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">BirdGod</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.47f727f4.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-84813914-2', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
