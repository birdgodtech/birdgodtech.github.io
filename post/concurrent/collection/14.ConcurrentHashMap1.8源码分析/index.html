<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ConcurrentHashMap1.8 - BirdGod 技术分享</title>
    <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="BirdGod" /><meta name="description" content="ConcurrentHashMap1.8源码分析 简介 改进一：取消segments字段，直接采用transient volatile HashEntry&amp;lt;K,V&amp;gt;[] table保存数据，采用" /><meta name="keywords" content="Java" />






<meta name="generator" content="Hugo 0.74.0-DEV with even 4.0.0" />


<link rel="canonical" href="https://birdgodtech.github.io/post/concurrent/collection/14.ConcurrentHashMap1.8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<link href="/post/concurrent/collection/14.ConcurrentHashMap1.8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="alternate" type="application/rss+xml" title="BirdGod 技术分享" />
<link href="/post/concurrent/collection/14.ConcurrentHashMap1.8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="feed" type="application/rss+xml" title="BirdGod 技术分享" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.06658218.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/reset-even.css">


<meta property="og:title" content="ConcurrentHashMap1.8" />
<meta property="og:description" content="ConcurrentHashMap1.8源码分析 简介 改进一：取消segments字段，直接采用transient volatile HashEntry&lt;K,V&gt;[] table保存数据，采用" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://birdgodtech.github.io/post/concurrent/collection/14.ConcurrentHashMap1.8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2017-08-18T21:18:08+00:00" />
<meta property="article:modified_time" content="2017-08-18T21:18:08+00:00" />
<meta itemprop="name" content="ConcurrentHashMap1.8">
<meta itemprop="description" content="ConcurrentHashMap1.8源码分析 简介 改进一：取消segments字段，直接采用transient volatile HashEntry&lt;K,V&gt;[] table保存数据，采用">
<meta itemprop="datePublished" content="2017-08-18T21:18:08&#43;00:00" />
<meta itemprop="dateModified" content="2017-08-18T21:18:08&#43;00:00" />
<meta itemprop="wordCount" content="11548">



<meta itemprop="keywords" content="ConcurrentHashMap1.8," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ConcurrentHashMap1.8"/>
<meta name="twitter:description" content="ConcurrentHashMap1.8源码分析 简介 改进一：取消segments字段，直接采用transient volatile HashEntry&lt;K,V&gt;[] table保存数据，采用"/>

</head>
<body>
<div id="mobile-navbar" class="mobile-navbar">
    <div class="mobile-header-logo">
        <a href="/" class="logo">BirdGod 技术分享</a>
    </div>
    <div class="mobile-navbar-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
    <ul class="mobile-menu-list">
        <a href="/">
            <li class="mobile-menu-item" title="首页">首页</li>
        </a>
        <a href="/post/">
            <li class="mobile-menu-item" title="归档">归档</li>
        </a>
        <a href="/categories/">
            <li class="mobile-menu-item" title="分类">分类</li>
        </a>
        <a href="/tags/">
            <li class="mobile-menu-item" title="标签">标签</li>
        </a>
        <a href="/about/">
            <li class="mobile-menu-item" title="关于我">关于我</li>
        </a>
        
    </ul>
</nav>

<div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
    <a href="/" class="logo">BirdGod 技术分享</a>
</div>

<nav class="site-navbar">
    <ul id="menu" class="menu" data-sum="0">
        
        <li class="menu-item menu-item-home">
            <a class="menu-item-link" href="/" title="首页">首页</a>
        </li>
        
        <li class="menu-item menu-item-archives">
            <a class="menu-item-link" href="/post/" title="归档">归档</a>
        </li>
        
        <li class="menu-item menu-item-categories">
            <a class="menu-item-link" href="/categories/" title="分类">分类</a>
        </li>
        
        <li class="menu-item menu-item-tags">
            <a class="menu-item-link" href="/tags/" title="标签">标签</a>
        </li>
        
        <li class="menu-item menu-item-about">
            <a class="menu-item-link" href="/about/" title="关于我">关于我</a>
        </li>
        
    </ul>
</nav>

    </header>


    <main id="main" class="main">
        <div class="content-wrapper">
            <div id="content" class="content">
                <article class="post">
  
  <header class="post-header">
    <h1 class="post-title">ConcurrentHashMap1.8</h1>

    <div class="post-meta">
      <span class="post-time"> 2017-08-18 21:18 </span>
      <div class="post-category">
        <a href="/categories/%E5%B9%B6%E5%8F%91/"> 并发 </a>
        </div>
      <span class="more-meta"> 约 11548 字 </span>
      <span class="more-meta"> 预计阅读 24 分钟 </span>
      <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
    </div>
  </header>

  <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#一concurrenthashmap-内部数据结构">一、ConcurrentHashMap 内部数据结构</a>
      <ul>
        <li><a href="#1-node">1. Node</a></li>
        <li><a href="#2-treebins保存treenodes集合的根红黑树实现">2. TreeBins保存TreeNodes集合的根；红黑树实现</a></li>
        <li><a href="#3-forwardingnode在调整大小的过程中已把旧数组迁移到新数组中把旧数组设置forwardingnode">3. ForwardingNode在调整大小的过程中，已把旧数组迁移到新数组中，把旧数组设置ForwardingNode。</a></li>
        <li><a href="#3数据结构">3.数据结构</a></li>
      </ul>
    </li>
    <li><a href="#二put-添加key-value">二、put 添加KEY-VALUE</a>
      <ul>
        <li><a href="#1-hash计算">1. hash计算</a></li>
        <li><a href="#2-初始化数组inittable">2. 初始化数组initTable</a></li>
        <li><a href="#3helptransfer-扩容时帮助迁移数组数据">3.helpTransfer 扩容时，帮助迁移数组数据。</a></li>
        <li><a href="#4treeifybin转化为黑红树结构">4.treeifyBin转化为黑红树结构</a></li>
        <li><a href="#5trypresize-尝试调整表的大小以容纳给定数量的元素">5.tryPresize 尝试调整表的大小以容纳给定数量的元素。</a></li>
        <li><a href="#6addcount-添加元素大小运用longadder逻辑操作">6.addCount 添加元素大小,运用LongAdder逻辑操作</a></li>
        <li><a href="#7longadder逻辑实现">7.LongAdder逻辑实现</a></li>
        <li><a href="#8transfer-迁移数据">8.transfer 迁移数据</a></li>
        <li><a href="#9untreeify-红黑树节点改成普通节点">9.untreeify 红黑树节点改成普通节点</a></li>
      </ul>
    </li>
    <li><a href="#二compute">二、compute</a></li>
    <li><a href="#三-merge">三、 merge</a></li>
    <li><a href="#四-get">四、 get</a></li>
    <li><a href="#五replace-顾名思义做替换">五、replace 顾名思义做替换</a></li>
    <li><a href="#六总结">六、总结</a></li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>【注意】最后更新于 <span class="timeago" datetime="2017-08-18T21:18:08" title="August 18, 2017">August 18, 2017</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
  <div class="post-content">
    <h1 id="concurrenthashmap18源码分析">ConcurrentHashMap1.8源码分析</h1>
<h2 id="简介">简介</h2>
<ul>
<li>
<p>改进一：取消segments字段，直接采用transient volatile HashEntry&lt;K,V&gt;[] table保存数据，采用table数组元素作为锁，
从而实现了对每一行数据进行加锁，进一步减少并发冲突的概率。</p>
</li>
<li>
<p>改进二：将原先table数组＋单向链表的数据结构，变更为table数组＋单向链表＋红黑树的结构。对于hash表来说，
最核心的能力在于将key hash之后能均匀的分布在数组中。如果hash之后散列的很均匀，那么table数组中的每个队列长度主要为0或者1。
但实际情况并非总是如此理想，虽然ConcurrentHashMap类默认的加载因子为0.75，但是在数据量过大或者运气不佳的情况下，
还是会存在一些队列长度过长的情况，如果还是采用单向列表方式，那么查询某个节点的时间复杂度为O(n)；
因此，对于个数超过8(默认值)的列表，jdk1.8中采用了红黑树的结构，那么查询的时间复杂度可以降低到O(logN)，可以改进性能</p>
</li>
<li>
<p>jdk1.8.0_91分析源码</p>
</li>
</ul>
<h2 id="一concurrenthashmap-内部数据结构">一、ConcurrentHashMap 内部数据结构</h2>
<p>ConcurrentHashMap继承ConcurrentMap接口，这里不做具体说明。</p>
<p>几个实现Node节点实现类说明：</p>
<ul>
<li>Node 实现Map.Entry接口。</li>
<li>TreeNodes继承Node,实现黑红树。</li>
<li>TreeBins保存TreeNodes集合的根；</li>
<li>ForwardingNode在调整大小的过程中，已把旧数组迁移到新数组中，把旧数组设置ForwardingNode。</li>
<li>ReservationNodes用作占位符，同时在computeIfAbsent和相关方法中建立值。</li>
</ul>
<p>hash发生碰撞,Node单链表结构保存，链表节点数量达到8变成黑红树结构，查询时间复杂度O(logN)</p>
<h3 id="1-node">1. Node</h3>
<h4 id="1数据结构">(1).数据结构</h4>
<ul>
<li>单链表结构</li>
<li>hash发生碰撞，单链表解决碰撞</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">K</span> <span class="n">key</span><span class="o">;</span>
        <span class="kd">volatile</span> <span class="n">V</span> <span class="n">val</span><span class="o">;</span>
        <span class="kd">volatile</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>

        <span class="n">Node</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">val</span><span class="o">,</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="2find-单链表查询">(2).find 单链表查询</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="n">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">do</span> <span class="o">{</span>
                      <span class="n">K</span> <span class="n">ek</span><span class="o">;</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                          <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span>
                          <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
                  <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="2-treebins保存treenodes集合的根红黑树实现">2. TreeBins保存TreeNodes集合的根；红黑树实现</h3>
<p><strong>红黑树的特性</strong> :</p>
<ul>
<li>（1）每个节点或者是黑色，或者是红色。</li>
<li>（2）根节点是黑色。</li>
<li>（3）每个叶子节点（NIL）是黑色。 [注意：这里叶子节点，是指为空(NIL或NULL)的叶子节点！]</li>
<li>（4）如果一个节点是红色的，则它的子节点必须是黑色的。</li>
<li>（5）从一个节点到该节点的子孙节点的所有路径上包含相同数目的黑节点。</li>
</ul>
<p>看看红黑树结构图</p>
<p><img src="/collection/RBTree01.jpg" alt=""></p>
<h4 id="1-treenode-红黑树节点">(1). TreeNode 红黑树节点</h4>
<h5 id="atreenode的数据结构树链表结构">a.TreeNode的数据结构，树链表结构；</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">;</span>  <span class="c1">// red-black tree links
</span><span class="c1"></span>        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">left</span><span class="o">;</span>
        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">right</span><span class="o">;</span>
        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>    <span class="c1">// needed to unlink next upon deletion  需要在删除后取消链接。
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="n">red</span><span class="o">;</span>

        <span class="n">TreeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">val</span><span class="o">,</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">,</span>
                 <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="b-find-查询节点">b. find 查询节点</h5>
<ul>
<li>根据hash值比较大小</li>
<li>在根据key是否实现Comparable接口做比较(compareTo)</li>
<li>没有实现Comparable接口，跟链表查找一样，先右节点查找，在左节点查询；</li>
</ul>
<p>一般情况hash值相同几率很小；</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="kd">final</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">findTreeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="n">Object</span> <span class="n">k</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">kc</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
                  <span class="k">do</span>  <span class="o">{</span>
                      <span class="kt">int</span> <span class="n">ph</span><span class="o">,</span> <span class="n">dir</span><span class="o">;</span> <span class="n">K</span> <span class="n">pk</span><span class="o">;</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">q</span><span class="o">;</span>
                      <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                      <span class="k">if</span> <span class="o">((</span><span class="n">ph</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">)</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">;</span>
                      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ph</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">)</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="n">pr</span><span class="o">;</span>
                      <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">pk</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pk</span><span class="o">)))</span>
                          <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
                      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="n">pr</span><span class="o">;</span>
                      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">;</span>
                      <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">kc</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||(</span><span class="n">kc</span> <span class="o">=</span> <span class="n">comparableClassFor</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="c1">//判断是否实现Comparable接口
</span><span class="c1"></span>                               <span class="o">(</span><span class="n">dir</span> <span class="o">=</span> <span class="n">compareComparables</span><span class="o">(</span><span class="n">kc</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">pl</span> <span class="o">:</span> <span class="n">pr</span><span class="o">;</span>
                      <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">q</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">kc</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                          <span class="k">return</span> <span class="n">q</span><span class="o">;</span>
                      <span class="k">else</span>
                          <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">;</span> <span class="c1">//赋值左节点查找
</span><span class="c1"></span>                  <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span> 
</code></pre></td></tr></table>
</div>
</div><h4 id="2treebins的数据结构">(2).TreeBins的数据结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
      <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">;</span>
      <span class="kd">volatile</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">first</span><span class="o">;</span>
      <span class="kd">volatile</span> <span class="n">Thread</span> <span class="n">waiter</span><span class="o">;</span>  
      <span class="c1">//Unsafe更新节点
</span><span class="c1"></span>      <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">lockState</span><span class="o">;</span>   <span class="c1">//锁的状态
</span><span class="c1"></span>      <span class="c1">// values for lockState  锁状态值
</span><span class="c1"></span>      <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WRITER</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="c1">// set while holding write lock    在保持写锁的同时设置
</span><span class="c1"></span>      <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WAITER</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span> <span class="c1">// set when waiting for write lock  在等待写锁时设置。
</span><span class="c1"></span>      <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">READER</span> <span class="o">=</span> <span class="n">4</span><span class="o">;</span> <span class="c1">// increment value for setting read lock  设置读锁的增量值。
</span></code></pre></td></tr></table>
</div>
</div><h4 id="3红黑树旋转">(3).红黑树旋转</h4>
<p>旋转图形结构</p>
<p><img src="/collection/RBTree02.jpg" alt=""></p>
<h5 id="a左旋转">a.左旋转</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">static</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">rotateLeft</span><span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                              <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">pp</span><span class="o">,</span> <span class="n">rl</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//p的右节点，肯定不能为空，为空旋转啥；把p的右节点保存r临时值
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">rl</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// r的左节点赋值给p的右节点 现在p的右节点根r断开关系
</span><span class="c1"></span>                    <span class="n">rl</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>                   <span class="c1">// r的左节点前提不能为空，p赋值给r的左节点父节点，现在r的左节点断开关系
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">//p的父节点赋值给[r的父节点] 现在p的父节点根p断开关系
</span><span class="c1"></span>                    <span class="o">(</span><span class="n">root</span> <span class="o">=</span> <span class="n">r</span><span class="o">).</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>             <span class="c1">//p是根节点，r为根节点，以及设置为黑节点，红黑树的特性
</span><span class="c1"></span>                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>                <span class="c1">// r的父节点的左节点等于p
</span><span class="c1"></span>                    <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>                      <span class="c1">//  是：r赋值给[p的父节点的左节] 
</span><span class="c1"></span>                <span class="k">else</span>                                  <span class="c1">//  否：r赋值给[p的父节点的右节] 
</span><span class="c1"></span>                    <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="n">r</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>                           <span class="c1">// p节点赋值[r的左节点]
</span><span class="c1"></span>                <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>                         <span class="c1">// r赋值给[p节点的父节点]
</span><span class="c1"></span>            <span class="o">}</span>
            <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="b右旋转">b.右旋转</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="kd">static</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">rotateRight</span><span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                               <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">l</span><span class="o">,</span> <span class="n">pp</span><span class="o">,</span> <span class="n">lr</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">//p的左节点，肯定不能为空，为空旋转啥；把p的左节点保存l临时值
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">lr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>    <span class="c1">//l的右节点赋值给p的左节点,现在p的左节点根l断开关系
</span><span class="c1"></span>                    <span class="n">lr</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>                      <span class="c1">// l的右节不为空前提，把p赋值给l的右节点的父节点，现在l根l的右节点断开关系
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">//p的父节点赋值给l的父节点,现在p的父节点根p断开关系
</span><span class="c1"></span>                    <span class="o">(</span><span class="n">root</span> <span class="o">=</span> <span class="n">l</span><span class="o">).</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>             <span class="c1">//p为根节点，l为根节点，l设置为黑节点
</span><span class="c1"></span>                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>                 <span class="c1">// l的父节点的右节点等于p
</span><span class="c1"></span>                    <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>                       <span class="c1">// 是 l赋值给【l的父节点右节点】
</span><span class="c1"></span>                <span class="k">else</span>                                    <span class="c1">// 否 l赋值给【l的父节点左节点】 
</span><span class="c1"></span>                    <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>
                <span class="n">l</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>                            <span class="c1">//p赋值给l的右节点
</span><span class="c1"></span>                <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>                           <span class="c1">//l节点赋值给p的父节点
</span><span class="c1"></span>            <span class="o">}</span>
            <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
        <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="4红黑树添加">(4).红黑树添加</h4>
<p>这个就是规则，原理性东西；</p>
<p>插入一个节点时默认红色，父节点也是红色，这样一来可能违背红黑树特性4(如果一个节点是红色的，则它的子节点必须是黑色的。)，
现在有三个场景修复红黑树特性：</p>
<ul>
<li>场景1:当前节点的父节点是红色，且当前节点的祖父节点的另一个子节点（叔叔节点）也是红色。
<ul>
<li>(1). 将&quot;父节点&quot;设为黑色。</li>
<li>(2). 将&quot;叔叔节点&quot;设为黑色。</li>
<li>(3). 将&quot;祖父节点&quot;设为&quot;红色&rdquo;。</li>
<li>(4). 将&quot;祖父节点&quot;设为&quot;当前节点&rdquo;(红色节点)；即，之后继续对&quot;当前节点&quot;进行操作。</li>
</ul>
</li>
<li>场景2:当前节点的父节点是红色，叔叔节点是黑色，且当前节点是其父节点的右孩子。
<ul>
<li>(1). 将&quot;父节点&quot;作为&quot;新的当前节点&rdquo;。</li>
<li>(2). 以&quot;新的当前节点&quot;为支点进行左旋。</li>
</ul>
</li>
<li>场景3:当前节点的父节点是红色，叔叔节点是黑色，且当前节点是其父节点的左孩子。
<ul>
<li>(1). 将&quot;父节点&quot;设为&quot;黑色&rdquo;。</li>
<li>(2). 将&quot;祖父节点&quot;设为&quot;红色&rdquo;。</li>
<li>(3). 以&quot;祖父节点&quot;为支点进行右旋。</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
      <span class="kd">static</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">balanceInsertion</span><span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                                  <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="k">for</span> <span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">xp</span><span class="o">,</span> <span class="n">xpp</span><span class="o">,</span> <span class="n">xppl</span><span class="o">,</span> <span class="n">xppr</span><span class="o">;;)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">((</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>          <span class="c1">//x的父节点为空，添加第一个元素。
</span><span class="c1"></span>                  <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                  <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">||</span> <span class="o">(</span><span class="n">xpp</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>    <span class="c1">//x的父节点为黑，没有破坏红黑树特性。或者x的祖父节点为空
</span><span class="c1"></span>                  <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">==</span> <span class="o">(</span><span class="n">xppl</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">left</span><span class="o">))</span> <span class="o">{</span>                   <span class="c1">//x的父节点是祖父的左节点
</span><span class="c1"></span>                  <span class="k">if</span> <span class="o">((</span><span class="n">xppr</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">xppr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//          场景1:x的父节点为红色，且x的叔叔节点为红色；
</span><span class="c1"></span>                      <span class="n">xppr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                         <span class="c1">//               x的叔叔节点设置黑色
</span><span class="c1"></span>                      <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                           <span class="c1">//               x的父节点设置黑色
</span><span class="c1"></span>                      <span class="n">xpp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>                           <span class="c1">//               x的祖父节点设置红色
</span><span class="c1"></span>                      <span class="n">x</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">;</span>                                  <span class="c1">//               把祖父设置当前节点
</span><span class="c1"></span>                  <span class="o">}</span>
                  <span class="k">else</span> <span class="o">{</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">xp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">{</span>                                <span class="c1">//场景2：x的父节点为红色，x的叔叔节点为黑色，且x节点是父节点右孩子；
</span><span class="c1"></span>                          <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">);</span>                <span class="c1">//      把父节点设置当前节点，x进行左旋转
</span><span class="c1"></span>                          <span class="n">xpp</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span><span class="c1">//     重新设置父节点，重新设置祖父节点
</span><span class="c1"></span>                      <span class="o">}</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>                                    <span class="c1">//场景3：x的父节点为红色，x的叔叔节点为黑色，且x节点是父节点左孩子
</span><span class="c1"></span>                          <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                                  <span class="c1">//      父节点设置黑色
</span><span class="c1"></span>                          <span class="k">if</span> <span class="o">(</span><span class="n">xpp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>                               <span class="c1">//      祖父节点不为空情况：
</span><span class="c1"></span>                              <span class="n">xpp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>                              <span class="c1">//            祖父节点设置红色
</span><span class="c1"></span>                              <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpp</span><span class="o">);</span>               <span class="c1">//            祖父节点进行右旋转
</span><span class="c1"></span>                          <span class="o">}</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
              <span class="o">}</span>
              <span class="k">else</span> <span class="o">{</span>                       <span class="c1">//树对称，操作也是对称的！
</span><span class="c1"></span>                  <span class="k">if</span> <span class="o">(</span><span class="n">xppl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">xppl</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">xppl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                      <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                      <span class="n">xpp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                      <span class="n">x</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">;</span>
                  <span class="o">}</span>
                  <span class="k">else</span> <span class="o">{</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">xp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">{</span>                               <span class="c1">//判断x节点是父节点左孩子；
</span><span class="c1"></span>                          <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">);</span>             <span class="c1">//进行右旋转
</span><span class="c1"></span>                          <span class="n">xpp</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                      <span class="o">}</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                          <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">(</span><span class="n">xpp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                              <span class="n">xpp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                              <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpp</span><span class="o">);</span>             <span class="c1">//进行左旋转
</span><span class="c1"></span>                          <span class="o">}</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">}</span>
      <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="5红黑树删除">(5).红黑树删除</h4>
<p>这个就是规则，原理性东西；</p>
<p>删除节点的关键是如果删除的是红色节点,不破坏性质;如果删除的是黑色节点, 那么这个路径上就会少一个黑色节点,破坏黑红树特性5。</p>
<p>删除元素有四个场景修复红黑树特性：</p>
<ul>
<li>场景1:x是&quot;黑+黑&quot;节点，x的兄弟节点是红色。(此时x的父节点和x的兄弟节点的子节点都是黑节点)。
<ul>
<li>(1).将x的兄弟节点设为&quot;黑色&rdquo;。</li>
<li>(2).将x的父节点设为&quot;红色&rdquo;。</li>
<li>(3).对x的父节点进行左旋。</li>
<li>(4).左旋后，重新设置x的兄弟节点。</li>
</ul>
</li>
<li>场景2:x是&quot;黑+黑&quot;节点，x的兄弟节点是黑色，x的兄弟节点的两个孩子都是黑色。
<ul>
<li>(1).将x的兄弟节点设为&quot;红色&rdquo;。</li>
<li>(2).设置&quot;x的父节点&quot;为&quot;新的x节点&rdquo;。</li>
</ul>
</li>
<li>场景3:x是&quot;黑+黑&quot;节点，x的兄弟节点是黑色；x的兄弟节点的左孩子是红色，右孩子是黑色的。
<ul>
<li>(1). 将x兄弟节点的左孩子设为&quot;黑色&rdquo;。</li>
<li>(2). 将x兄弟节点设为&quot;红色&rdquo;。</li>
<li>(3). 对x的兄弟节点进行右旋。</li>
<li>(4). 右旋后，重新设置x的兄弟节点。</li>
</ul>
</li>
<li>场景4:x是&quot;黑+黑&quot;节点，x的兄弟节点是黑色；x的兄弟节点的右孩子是红色的，x的兄弟节点的左孩子任意颜色。
<ul>
<li>(1). 将x父节点颜色 赋值给 x的兄弟节点。</li>
<li>(2). 将x父节点设为&quot;黑色&rdquo;。</li>
<li>(3). 将x兄弟节点的右子节设为&quot;黑色&rdquo;。</li>
<li>(4). 对x的父节点进行左旋。</li>
<li>(5). 设置&quot;x&quot;为&quot;根节点&rdquo;。</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">static</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">balanceDeletion</span><span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                                   <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">xp</span><span class="o">,</span> <span class="n">xpl</span><span class="o">,</span> <span class="n">xpr</span><span class="o">;;)</span>  <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">x</span> <span class="o">==</span> <span class="n">root</span><span class="o">)</span>          
                    <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>                               <span class="c1">//x节点为红色，没有破坏红黑树特性
</span><span class="c1"></span>                    <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">xpl</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">==</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>                  <span class="c1">//x是父节点左孩子
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">((</span><span class="n">xpr</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">xpr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>            <span class="c1">//场景1:x的兄弟节点为红色，
</span><span class="c1"></span>                        <span class="n">xpr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                                  <span class="c1">//     x的兄弟节点设置黑色
</span><span class="c1"></span>                        <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>                                    <span class="c1">//     x的父节点设置红色  
</span><span class="c1"></span>                        <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>                      <span class="c1">//     x的父节点进行左旋转
</span><span class="c1"></span>                        <span class="n">xpr</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>  <span class="c1">//     重新设置父节点和兄弟节点
</span><span class="c1"></span>                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">xpr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>                                      <span class="c1">//x的兄弟节点为空，把父节点设置当前节点
</span><span class="c1"></span>                        <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">sl</span> <span class="o">=</span> <span class="n">xpr</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">xpr</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">sl</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sl</span><span class="o">.</span><span class="na">red</span><span class="o">))</span> <span class="o">{</span>                   <span class="c1">//场景2: x的兄弟节点为黑，且x的兄弟节点的两个孩子都是黑色
</span><span class="c1"></span>                            <span class="n">xpr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>                              <span class="c1">//      x的兄弟节点设置为红色
</span><span class="c1"></span>                            <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>                                      <span class="c1">//      把父节点设置为当前节点
</span><span class="c1"></span>                        <span class="o">}</span>
                        <span class="k">else</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">sr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">//场景3: x的兄弟节点为黑，且x的兄弟节点的右孩子都是黑色，左孩子都是红色
</span><span class="c1"></span>                                <span class="k">if</span> <span class="o">(</span><span class="n">sl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>                         <span class="c1">//      x的兄弟节点的左孩子不为空，设置为黑色
</span><span class="c1"></span>                                    <span class="n">sl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="n">xpr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>                         <span class="c1">//      x的兄弟节点设置为红色
</span><span class="c1"></span>                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpr</span><span class="o">);</span>          <span class="c1">//      x的兄弟节点进行右旋转
</span><span class="c1"></span>                                <span class="n">xpr</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>         <span class="c1">//      重新设置父节点和兄弟节点
</span><span class="c1"></span>                                    <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xpr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>                          <span class="c1">//场景3: x的兄弟节点为黑，且x的兄弟节点的右孩子都是红色，左孩子任意颜色
</span><span class="c1"></span>                                <span class="n">xpr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">red</span><span class="o">;</span><span class="c1">//      将x父节点颜色 赋值给 x的兄弟节点。         
</span><span class="c1"></span>                                <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">xpr</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>           <span class="c1">//      x的兄弟节点的右孩子不为空，设置为黑色
</span><span class="c1"></span>                                    <span class="n">sr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>        
                                <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                        <span class="c1">//       x的父节点设置为黑色
</span><span class="c1"></span>                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>           <span class="c1">//       x的父节点进行左旋转
</span><span class="c1"></span>                            <span class="o">}</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span>                                 <span class="c1">//        把根节点设置为当前节点
</span><span class="c1"></span>                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="o">{</span> <span class="c1">// symmetric  对称
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">xpl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">xpl</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">xpl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>                <span class="c1">//x的父节点进行左旋转
</span><span class="c1"></span>                        <span class="n">xpl</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">xpl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">sl</span> <span class="o">=</span> <span class="n">xpl</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">xpl</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sl</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sl</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">sr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sr</span><span class="o">.</span><span class="na">red</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">xpl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">else</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">sl</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sl</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>       <span class="c1">//判断x的兄弟节点的左孩子都是黑色
</span><span class="c1"></span>                                <span class="k">if</span> <span class="o">(</span><span class="n">sr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">sr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="n">xpl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpl</span><span class="o">);</span>   <span class="c1">//左旋转
</span><span class="c1"></span>                                <span class="n">xpl</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
                                    <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xpl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">xpl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">red</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">sl</span> <span class="o">=</span> <span class="n">xpl</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">sl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>    <span class="c1">//右旋转
</span><span class="c1"></span>                            <span class="o">}</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="6构造">(6).构造</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="n">TreeBin</span><span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">TREEBIN</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
            <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">,</span> <span class="n">next</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">x</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">//赋值根节点
</span><span class="c1"></span>                    <span class="n">x</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="n">K</span> <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">hash</span><span class="o">;</span>
                    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">kc</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">;;)</span> <span class="o">{</span> <span class="c1">//二分查找，查找到插入位置
</span><span class="c1"></span>                        <span class="kt">int</span> <span class="n">dir</span><span class="o">,</span> <span class="n">ph</span><span class="o">;</span>
                        <span class="n">K</span> <span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">ph</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">)</span>
                            <span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ph</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">)</span>
                            <span class="n">dir</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">kc</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                  <span class="o">(</span><span class="n">kc</span> <span class="o">=</span> <span class="n">comparableClassFor</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span>
                                 <span class="o">(</span><span class="n">dir</span> <span class="o">=</span> <span class="n">compareComparables</span><span class="o">(</span><span class="n">kc</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">))</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="c1">//是否实现Comparable
</span><span class="c1"></span>                            <span class="n">dir</span> <span class="o">=</span> <span class="n">tieBreakOrder</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">);</span>
                            <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">xp</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">:</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">x</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                                <span class="n">xp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">xp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">balanceInsertion</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">x</span><span class="o">);</span> <span class="c1">//红黑树插入
</span><span class="c1"></span>                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">this</span><span class="o">.</span><span class="na">root</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
            <span class="k">assert</span> <span class="n">checkInvariants</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="7puttreeval-添加节点">(7).putTreeVal 添加节点</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="kd">final</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">putTreeVal</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="n">K</span> <span class="n">k</span><span class="o">,</span> <span class="n">V</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">kc</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="kt">boolean</span> <span class="n">searched</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">root</span><span class="o">;;)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">dir</span><span class="o">,</span> <span class="n">ph</span><span class="o">;</span> <span class="n">K</span> <span class="n">pk</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">root</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">ph</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">)</span>
                    <span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ph</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">)</span>
                    <span class="n">dir</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">pk</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pk</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">kc</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                          <span class="o">(</span><span class="n">kc</span> <span class="o">=</span> <span class="n">comparableClassFor</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span>
                         <span class="o">(</span><span class="n">dir</span> <span class="o">=</span> <span class="n">compareComparables</span><span class="o">(</span><span class="n">kc</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">))</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">searched</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">q</span><span class="o">,</span> <span class="n">ch</span><span class="o">;</span>
                        <span class="n">searched</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                             <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">kc</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span>
                            <span class="o">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                             <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">kc</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span>
                            <span class="k">return</span> <span class="n">q</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">//根Class名称比较，在System.identityHashCode比较，总之比较出大小
</span><span class="c1"></span>                    <span class="n">dir</span> <span class="o">=</span> <span class="n">tieBreakOrder</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">xp</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">:</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">xp</span><span class="o">.</span><span class="na">red</span><span class="o">)</span>
                        <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="n">lockRoot</span><span class="o">();</span><span class="c1">//弄一个锁，为查询了
</span><span class="c1"></span>                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">root</span> <span class="o">=</span> <span class="n">balanceInsertion</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">x</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="n">unlockRoot</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="o">...</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        
</code></pre></td></tr></table>
</div>
</div><h4 id="8查询节点">(8).查询节点</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="kd">final</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="n">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">s</span><span class="o">;</span> <span class="n">K</span> <span class="n">ek</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">lockState</span><span class="o">)</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">WAITER</span><span class="o">|</span><span class="n">WRITER</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>  
                        <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                            <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span>
                            <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">LOCKSTATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span>
                                                 <span class="n">s</span> <span class="o">+</span> <span class="n">READER</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">root</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
                                 <span class="n">r</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="n">Thread</span> <span class="n">w</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">getAndAddInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">LOCKSTATE</span><span class="o">,</span> <span class="o">-</span><span class="n">READER</span><span class="o">)</span> <span class="o">==</span>
                                <span class="o">(</span><span class="n">READER</span><span class="o">|</span><span class="n">WAITER</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">waiter</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="8删除节点">(8).删除节点</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">           <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">removeTreeNode</span><span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                  <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>  <span class="c1">// unlink traversal pointers
</span><span class="c1"></span>                  <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">rl</span><span class="o">;</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                      <span class="n">first</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                  <span class="k">else</span>
                      <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                      <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">root</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                  <span class="o">}</span>
                  <span class="k">if</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">root</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="na">right</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="c1">// too small
</span><span class="c1"></span>                      <span class="o">(</span><span class="n">rl</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">rl</span><span class="o">.</span><span class="na">left</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                  <span class="n">lockRoot</span><span class="o">();</span>
                  <span class="k">try</span> <span class="o">{</span>
                      <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">replacement</span><span class="o">;</span>
                      <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
                      <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">pl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                          <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">pr</span><span class="o">,</span> <span class="n">sl</span><span class="o">;</span>
                          <span class="k">while</span> <span class="o">((</span><span class="n">sl</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// find successor
</span><span class="c1"></span>                              <span class="n">s</span> <span class="o">=</span> <span class="n">sl</span><span class="o">;</span>
                          <span class="kt">boolean</span> <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">red</span><span class="o">;</span> <span class="n">s</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">red</span><span class="o">;</span> <span class="n">p</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span> <span class="c1">// swap colors
</span><span class="c1"></span>                          <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                          <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">pr</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// p was s&#39;s direct parent
</span><span class="c1"></span>                              <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                              <span class="n">s</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                          <span class="o">}</span>
                          <span class="k">else</span> <span class="o">{</span>
                              <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                              <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">sp</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                  <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span>
                                      <span class="n">sp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                  <span class="k">else</span>
                                      <span class="n">sp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                              <span class="o">}</span>
                              <span class="k">if</span> <span class="o">((</span><span class="n">s</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">pr</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                  <span class="n">pr</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                          <span class="o">}</span>
                          <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">sr</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                              <span class="n">sr</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">((</span><span class="n">s</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">pl</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                              <span class="n">pl</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">((</span><span class="n">s</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">pp</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                              <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                          <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span>
                              <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                          <span class="k">else</span>
                              <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">(</span><span class="n">sr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                              <span class="n">replacement</span> <span class="o">=</span> <span class="n">sr</span><span class="o">;</span>
                          <span class="k">else</span>
                              <span class="n">replacement</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                      <span class="o">}</span>
                      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                          <span class="n">replacement</span> <span class="o">=</span> <span class="n">pl</span><span class="o">;</span>
                      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                          <span class="n">replacement</span> <span class="o">=</span> <span class="n">pr</span><span class="o">;</span>
                      <span class="k">else</span>
                          <span class="n">replacement</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">replacement</span> <span class="o">!=</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
                          <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">(</span><span class="n">pp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                              <span class="n">r</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">;</span>
                          <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span>
                              <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">;</span>
                          <span class="k">else</span>
                              <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">;</span>
                          <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                      <span class="o">}</span>
      
                      <span class="n">root</span> <span class="o">=</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="n">balanceDeletion</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">replacement</span><span class="o">);</span>
      
                      <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">replacement</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// detach pointers
</span><span class="c1"></span>                          <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">pp</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                              <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span>
                                  <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                              <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span>
                                  <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                              <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                          <span class="o">}</span>
                      <span class="o">}</span>
                  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                      <span class="n">unlockRoot</span><span class="o">();</span>
                  <span class="o">}</span>
                  <span class="k">assert</span> <span class="n">checkInvariants</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
                  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
              <span class="o">}</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="3-forwardingnode在调整大小的过程中已把旧数组迁移到新数组中把旧数组设置forwardingnode">3. ForwardingNode在调整大小的过程中，已把旧数组迁移到新数组中，把旧数组设置ForwardingNode。</h3>
<h4 id="aforwardingnode数据结构">a.ForwardingNode数据结构</h4>
<ul>
<li>保存新扩容的数组</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForwardingNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
          <span class="kd">final</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">nextTable</span><span class="o">;</span>
          <span class="n">ForwardingNode</span><span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">)</span> <span class="o">{</span>
              <span class="kd">super</span><span class="o">(</span><span class="n">MOVED</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
              <span class="k">this</span><span class="o">.</span><span class="na">nextTable</span> <span class="o">=</span> <span class="n">tab</span><span class="o">;</span>
          <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="bfind">b.find</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">    Node&lt;K,V&gt; find(int h, Object k) {
             // loop to avoid arbitrarily deep recursion on forwarding nodes
             outer: for (Node&lt;K,V&gt;[] tab = nextTable;;) {
                 Node&lt;K,V&gt; e; int n;
                 if (k == null || tab == null || (n = tab.length) == 0 ||
                     (e = tabAt(tab, (n - 1) &amp; h)) == null)
                     return null;
                 for (;;) {
                     int eh; K ek;
                     if ((eh = e.hash) == h &amp;&amp;
                         ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek))))
                         return e;
                     if (eh &lt; 0) {
                         if (e instanceof ForwardingNode) {
                             tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;
                             continue outer;
                         }
                         else
                             return e.find(h, k);
                     }
                     if ((e = e.next) == null)
                         return null;
                 }
             }
         } 
</code></pre></td></tr></table>
</div>
</div><h3 id="3数据结构">3.数据结构</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">       

    <span class="cm">/**
</span><span class="cm">     * 最大可能的表容量。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAXIMUM_CAPACITY</span> <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">30</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 默认的初始表容量。必须是2(i)的幂
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_CAPACITY</span> <span class="o">=</span> <span class="n">16</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 最大可能的(非幂两)数组大小。需要的阵列和相关的方法。
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_ARRAY_SIZE</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="n">8</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 负载因子。在构造函数中重写此值只会影响初始表的容量。实际浮点值通常不被使用 - 
</span><span class="cm">     * 使用诸如{@code n - （n &gt;&gt;&gt; 2 }之类的表达式可以更简单地实现关联的调整大小阈值。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="n">LOAD_FACTOR</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">75f</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 节点数量大于8，转化为红黑树结构
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="n">8</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 节点数量小于6，转化为链表结构
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">UNTREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="n">6</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MIN_TREEIFY_CAPACITY</span> <span class="o">=</span> <span class="n">64</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Minimum number of rebinnings per transfer step. Ranges are
</span><span class="cm">     * subdivided to allow multiple resizer threads.  This value
</span><span class="cm">     * serves as a lower bound to avoid resizers encountering
</span><span class="cm">     * excessive memory contention.  The value should be at least
</span><span class="cm">     * DEFAULT_CAPACITY.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MIN_TRANSFER_STRIDE</span> <span class="o">=</span> <span class="n">16</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * sizeCtl中用于生成stamp的位数。  32位数组必须至少为6
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">RESIZE_STAMP_BITS</span> <span class="o">=</span> <span class="n">16</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 可以帮助调整大小的最大线程数。必须适合32 - RESIZE_STAMP_BITS位。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_RESIZERS</span> <span class="o">=</span> <span class="o">(</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="o">(</span><span class="n">32</span> <span class="o">-</span> <span class="n">RESIZE_STAMP_BITS</span><span class="o">))</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * sizeCtl中记录尺寸的位变换。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RESIZE_STAMP_SHIFT</span> <span class="o">=</span> <span class="n">32</span> <span class="o">-</span> <span class="n">RESIZE_STAMP_BITS</span><span class="o">;</span>

    <span class="cm">/*
</span><span class="cm">     * Encodings for Node hash fields. See above for explanation.
</span><span class="cm">     * 为节点哈希字段编码
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MOVED</span>     <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span> <span class="c1">// hash for forwarding nodes  hash值是-1，表示这是一个forwardNode节点
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TREEBIN</span>   <span class="o">=</span> <span class="o">-</span><span class="n">2</span><span class="o">;</span> <span class="c1">// hash for roots of trees    hash值是-2 表示这时一个TreeBin节点
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RESERVED</span>  <span class="o">=</span> <span class="o">-</span><span class="n">3</span><span class="o">;</span> <span class="c1">// hash for transient reservations hash值是-3  ReservationNode节点
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HASH_BITS</span> <span class="o">=</span> <span class="n">0x7fffffff</span><span class="o">;</span> <span class="c1">// usable bits of normal node hash 
</span><span class="c1"></span>
    <span class="cm">/** Number of CPUS, to place bounds on some sizings */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NCPU</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">
</span><span class="cm">     * 数组
</span><span class="cm">     */</span>
    <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">table</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * rehash扩容时用到的新键值对数组
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">nextTable</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 记录当前键值对总数，通过CAS更新，对所有线程可见
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">baseCount</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 当`sizeCtl` &lt; 0时，表示多个线程在等待扩容；
</span><span class="cm">     * 当`sizeCtl` = 0时，默认值；
</span><span class="cm">     * 当`sizeCtl` &gt; 0时，表示扩容的阈值；初始化数组以前代表创建数组大小。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">sizeCtl</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 下表索引(+ 1)在调整大小时进行拆分。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">transferIndex</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 自旋锁
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">cellsBusy</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * counter cell表，长度总为2的幂次；
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">CounterCell</span><span class="o">[]</span> <span class="n">counterCells</span><span class="o">;</span>
<span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><h2 id="二put-添加key-value">二、put 添加KEY-VALUE</h2>
<ul>
<li>key和value不能空，为空throw NPE异常</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">V</span> <span class="nf">put</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">putVal</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">V</span> <span class="nf">putVal</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyIfAbsent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span> 
        <span class="c1">//XOR计算
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;;)</span> <span class="o">{</span>
            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fh</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>                 <span class="c1">//初始化数组大小
</span><span class="c1"></span>                <span class="n">tab</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">();</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">//【(n - 1) &amp; hash】获取数组下标，获取元素为空，CAS更新数组值
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">casTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                             <span class="k">new</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">)))</span>
                    <span class="k">break</span><span class="o">;</span>                   <span class="c1">// no lock when adding to empty bin
</span><span class="c1"></span>            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="n">MOVED</span><span class="o">)</span>                         <span class="c1">// 正在扩容中，以前旧数组中，获取元素为空，保存ForwardingNode对象，hash==MOVED
</span><span class="c1"></span>                <span class="n">tab</span> <span class="o">=</span> <span class="n">helpTransfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>                          <span class="c1">// 获取新数组。协助迁移数组数据
</span><span class="c1"></span>            <span class="k">else</span> <span class="o">{</span>
                <span class="n">V</span> <span class="n">oldVal</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>                                   <span class="c1">//同步锁，锁定数组下标对象值
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>                        <span class="c1">//二次判断
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>                               <span class="c1">//hash大于零是普通节点           
</span><span class="c1"></span>                            <span class="n">binCount</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">f</span><span class="o">;;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">K</span> <span class="n">ek</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                                    <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                                     <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span> <span class="o">{</span>
                                    <span class="n">oldVal</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                    <span class="k">if</span> <span class="o">(!</span><span class="n">onlyIfAbsent</span><span class="o">)</span>
                                        <span class="n">e</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span>
                                                              <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="n">TreeBin</span><span class="o">)</span> <span class="o">{</span>               <span class="c1">//黑红树节点
</span><span class="c1"></span>                            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="o">((</span><span class="n">TreeBin</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">f</span><span class="o">).</span><span class="na">putTreeVal</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span>
                                                           <span class="n">value</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">oldVal</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(!</span><span class="n">onlyIfAbsent</span><span class="o">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">&gt;=</span> <span class="n">TREEIFY_THRESHOLD</span><span class="o">)</span>  <span class="c1">//普通节点数大于TREEIFY_THRESHOLD(8)转化为黑红树
</span><span class="c1"></span>                        <span class="n">treeifyBin</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">oldVal</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">return</span> <span class="n">oldVal</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">addCount</span><span class="o">(</span><span class="n">1L</span><span class="o">,</span> <span class="n">binCount</span><span class="o">);</span> <span class="c1">//添加数量
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="1-hash计算">1. hash计算</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">spread</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">h</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">16</span><span class="o">))</span> <span class="o">&amp;</span> <span class="n">HASH_BITS</span><span class="o">;</span> <span class="c1">//HASH_BITS = 0x7fffffff;Integer.MAX_VALUE
</span><span class="c1"></span>    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="2-初始化数组inittable">2. 初始化数组initTable</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
   <span class="cm">/**
</span><span class="cm">    * Initializes table, using the size recorded in sizeCtl.
</span><span class="cm">    */</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="nf">initTable</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="kt">int</span> <span class="n">sc</span><span class="o">;</span>
       <span class="k">while</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
               <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span> 
           <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">))</span> <span class="o">{</span>  <span class="c1">// CAS 修改sizeCtl为-1
</span><span class="c1"></span>               <span class="k">try</span> <span class="o">{</span>
                   <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                       <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">sc</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">sc</span> <span class="o">:</span> <span class="n">DEFAULT_CAPACITY</span><span class="o">;</span>
                       <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
                       <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">nt</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[])</span><span class="k">new</span> <span class="n">Node</span><span class="o">&lt;?,?&gt;[</span><span class="n">n</span><span class="o">];</span>
                       <span class="n">table</span> <span class="o">=</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">nt</span><span class="o">;</span>
                       <span class="n">sc</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">2</span><span class="o">);</span> <span class="c1">// sc=(3/4)*n 扩容阈值
</span><span class="c1"></span>                   <span class="o">}</span>
               <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                   <span class="n">sizeCtl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
               <span class="o">}</span>
               <span class="k">break</span><span class="o">;</span>
           <span class="o">}</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="n">tab</span><span class="o">;</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="3helptransfer-扩容时帮助迁移数组数据">3.helpTransfer 扩容时，帮助迁移数组数据。</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">   <span class="cm">/**
</span><span class="cm">     * Helps transfer if a resize is in progress.
</span><span class="cm">     * 如果调整了大小，可以帮助转移。
</span><span class="cm">     */</span>
    <span class="kd">final</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="nf">helpTransfer</span><span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">nextTab</span><span class="o">;</span> <span class="kt">int</span> <span class="n">sc</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="n">ForwardingNode</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">(</span><span class="n">nextTab</span> <span class="o">=</span> <span class="o">((</span><span class="n">ForwardingNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">f</span><span class="o">).</span><span class="na">nextTable</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">resizeStamp</span><span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>                             
            <span class="k">while</span> <span class="o">(</span><span class="n">nextTab</span> <span class="o">==</span> <span class="n">nextTable</span> <span class="o">&amp;&amp;</span> <span class="n">table</span> <span class="o">==</span> <span class="n">tab</span> <span class="o">&amp;&amp;</span>
                   <span class="o">(</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>                  <span class="c1">//sizeCtl 小于零时候，在扩容数组
</span><span class="c1"></span>                   <span class="c1">//判断是否协助扩容时迁移旧数组数据。RESIZE_STAMP_SHIFT=16
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span> <span class="o">||</span> <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">1</span> <span class="o">||</span>
                    <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">MAX_RESIZERS</span> <span class="o">||</span> <span class="n">transferIndex</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="n">sc</span> <span class="o">+</span> <span class="n">1</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">nextTab</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">nextTab</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">;</span>
    <span class="o">}</span>
   <span class="cm">/**
</span><span class="cm">     * 返回用于调整大小为n的table的标记位。向左移动RESIZE_STAMP_SHIFT时必须为负值。
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">resizeStamp</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//RESIZE_STAMP_BITS=16
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">numberOfLeadingZeros</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="o">(</span><span class="n">RESIZE_STAMP_BITS</span> <span class="o">-</span> <span class="n">1</span><span class="o">));</span>
    <span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><p>判断是否协助扩容时迁移旧数组数据几种情况？</p>
<ul>
<li>(resizeStamp(n) &raquo;&gt; RESIZE_STAMP_SHIFT) != rs
在扩容时，CAS修改sizeCtl字段为(resizeStamp(n) &laquo; RESIZE_STAMP_SHIFT) +
2)，只要sizeCtl往右移动RESIZE_STAMP_SHIFT就得到resizeStamp(n)值。这个判断相等，说明协助迁移旧数组数据；CAS修改sizeCtl字段递增加1；
这个判断不想等，说明协助线程达到指定值，累计到（1&laquo;
RESIZE_STAMP_SHIFT）-1值，主要原因改变RESIZE_STAMP_SHIFT前面位数。</li>
<li>sc == rs + 1 || sc == rs + MAX_RESIZERS 这块没搞懂，我个人认为，sc == rs
+ 1 改成sc == rs &laquo; RESIZE_STAMP_SHIFT + 1 说明迁移数据已完成； sc == rs
+ MAX_RESIZERS 改成 sc == rs &laquo; RESIZE_STAMP_SHIFT +
MAX_RESIZERS，说明协助线程达到最大值。</li>
<li>transferIndex &lt;= 0 在扩容时，transferIndex字段只做拆分下标定位。</li>
</ul>
<h3 id="4treeifybin转化为黑红树结构">4.treeifyBin转化为黑红树结构</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">treeifyBin</span><span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">sc</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">MIN_TREEIFY_CAPACITY</span><span class="o">)</span> <span class="c1">//数组大小与MIN_TREEIFY_CAPACITY(64)，尝试扩容
</span><span class="c1"></span>                <span class="n">tryPresize</span><span class="o">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">);</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="o">.</span><span class="na">hash</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">)</span> <span class="o">==</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">hd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span>
                                <span class="k">new</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">,</span>
                                                  <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">tl</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">hd</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">tl</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                            <span class="n">tl</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="k">new</span> <span class="n">TreeBin</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">hd</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="5trypresize-尝试调整表的大小以容纳给定数量的元素">5.tryPresize 尝试调整表的大小以容纳给定数量的元素。</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">tryPresize</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="n">MAXIMUM_CAPACITY</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">1</span><span class="o">))</span> <span class="o">?</span> <span class="n">MAXIMUM_CAPACITY</span> <span class="o">:</span>
            <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">sc</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">sc</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">?</span> <span class="n">sc</span> <span class="o">:</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">table</span> <span class="o">==</span> <span class="n">tab</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
                            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">nt</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[])</span><span class="k">new</span> <span class="n">Node</span><span class="o">&lt;?,?&gt;[</span><span class="n">n</span><span class="o">];</span>
                            <span class="n">table</span> <span class="o">=</span> <span class="n">nt</span><span class="o">;</span>
                            <span class="n">sc</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">2</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">sizeCtl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="n">sc</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="n">table</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">resizeStamp</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">nt</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span> <span class="o">||</span> <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">1</span> <span class="o">||</span>
                        <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">MAX_RESIZERS</span> <span class="o">||</span> <span class="o">(</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nextTable</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                        <span class="n">transferIndex</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="n">sc</span> <span class="o">+</span> <span class="n">1</span><span class="o">))</span>
                        <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">nt</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span>
                                             <span class="o">(</span><span class="n">rs</span> <span class="o">&lt;&lt;</span> <span class="n">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">2</span><span class="o">))</span>
                    <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="6addcount-添加元素大小运用longadder逻辑操作">6.addCount 添加元素大小,运用LongAdder逻辑操作</h3>
<ul>
<li>进行扩容</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">addCount</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">check</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">CounterCell</span><span class="o">[]</span> <span class="n">as</span><span class="o">;</span> <span class="kt">long</span> <span class="n">b</span><span class="o">,</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">as</span> <span class="o">=</span> <span class="n">counterCells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
            <span class="o">!</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">BASECOUNT</span><span class="o">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">baseCount</span><span class="o">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">CounterCell</span> <span class="n">a</span><span class="o">;</span> <span class="kt">long</span> <span class="n">v</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">;</span>
            <span class="kt">boolean</span> <span class="n">uncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">as</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
                <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">getProbe</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                <span class="o">!(</span><span class="n">uncontended</span> <span class="o">=</span>
                  <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">CELLVALUE</span><span class="o">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span><span class="o">)))</span> <span class="o">{</span>
                <span class="n">fullAddCount</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">uncontended</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">check</span> <span class="o">&lt;=</span> <span class="n">1</span><span class="o">)</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sumCount</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">check</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="n">nt</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">sc</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)(</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                   <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">resizeStamp</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span> <span class="o">||</span> <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">1</span> <span class="o">||</span>
                        <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">MAX_RESIZERS</span> <span class="o">||</span> <span class="o">(</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nextTable</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                        <span class="n">transferIndex</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="n">sc</span> <span class="o">+</span> <span class="n">1</span><span class="o">))</span>
                        <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">nt</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span>
                                             <span class="o">(</span><span class="n">rs</span> <span class="o">&lt;&lt;</span> <span class="n">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">2</span><span class="o">))</span> 
                    <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span><span class="c1">//进行扩容操作
</span><span class="c1"></span>                <span class="n">s</span> <span class="o">=</span> <span class="n">sumCount</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="7longadder逻辑实现">7.LongAdder逻辑实现</h3>
<h4 id="acountercell数据结构">a.CounterCell数据结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
   <span class="cm">/* ---------------- Counter support -------------- */</span>

   <span class="cm">/**
</span><span class="cm">    * A padded cell for distributing counts.  Adapted from LongAdder
</span><span class="cm">    * and Striped64.  See their internal docs for explanation.
</span><span class="cm">    */</span>
   <span class="nd">@sun.misc.Contended</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CounterCell</span> <span class="o">{</span>
       <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">value</span><span class="o">;</span>
       <span class="n">CounterCell</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">value</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="o">}</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="bsumcount-统计">b.sumCount 统计</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
   <span class="kd">final</span> <span class="kt">long</span> <span class="nf">sumCount</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">CounterCell</span><span class="o">[]</span> <span class="n">as</span> <span class="o">=</span> <span class="n">counterCells</span><span class="o">;</span> <span class="n">CounterCell</span> <span class="n">a</span><span class="o">;</span>
       <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">baseCount</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">as</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                   <span class="n">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
           <span class="o">}</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="cfulladdcount-有关说明请参见longadder版本">c.fullAddCount 有关说明，请参见LongAdder版本</h4>
<p>具体不用说</p>
<h3 id="8transfer-迁移数据">8.transfer 迁移数据</h3>
<ul>
<li>这个方法最复杂</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">nextTab</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">stride</span><span class="o">;</span>
        <span class="c1">// stride(步长)作用用于多线程并发处理迁移数据。分段处理机制，每个线程可以去负责每段数据处理。用于CPU数量大于1情况；
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">stride</span> <span class="o">=</span> <span class="o">(</span><span class="n">NCPU</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">?</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">3</span><span class="o">)</span> <span class="o">/</span> <span class="n">NCPU</span> <span class="o">:</span> <span class="n">n</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">MIN_TRANSFER_STRIDE</span><span class="o">)</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="n">MIN_TRANSFER_STRIDE</span><span class="o">;</span> <span class="c1">// subdivide range
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">nextTab</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>            <span class="c1">// initiating
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
                <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">nt</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[])</span><span class="k">new</span> <span class="n">Node</span><span class="o">&lt;?,?&gt;[</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">];</span> <span class="c1">//2倍扩容
</span><span class="c1"></span>                <span class="n">nextTab</span> <span class="o">=</span> <span class="n">nt</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>      <span class="c1">// try to cope with OOME
</span><span class="c1"></span>                <span class="n">sizeCtl</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">nextTable</span> <span class="o">=</span> <span class="n">nextTab</span><span class="o">;</span>
            <span class="n">transferIndex</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>  <span class="c1">//分段处理下标标示，从高到低处理；
</span><span class="c1"></span>        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">nextn</span> <span class="o">=</span> <span class="n">nextTab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="n">ForwardingNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">fwd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForwardingNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">nextTab</span><span class="o">);</span><span class="c1">//用于旧数组迁移到新数组，把旧数组中数据修改成ForwardingNode对象；
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">finishing</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// to ensure sweep before committing nextTab
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">bound</span> <span class="o">=</span> <span class="n">0</span><span class="o">;;)</span> <span class="o">{</span>  
            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span> <span class="kt">int</span> <span class="n">fh</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">advance</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">nextIndex</span><span class="o">,</span> <span class="n">nextBound</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">bound</span> <span class="o">||</span> <span class="n">finishing</span><span class="o">)</span>       <span class="c1">//递减分段下标索引
</span><span class="c1"></span>                    <span class="n">advance</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">nextIndex</span> <span class="o">=</span> <span class="n">transferIndex</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">//transferIndex小于零，说明已迁移完毕！
</span><span class="c1"></span>                    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
                    <span class="n">advance</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span>
                         <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">TRANSFERINDEX</span><span class="o">,</span> <span class="n">nextIndex</span><span class="o">,</span>
                          <span class="n">nextBound</span> <span class="o">=</span> <span class="o">(</span><span class="n">nextIndex</span> <span class="o">&gt;</span> <span class="n">stride</span> <span class="o">?</span>
                                       <span class="n">nextIndex</span> <span class="o">-</span> <span class="n">stride</span> <span class="o">:</span> <span class="n">0</span><span class="o">)))</span> <span class="o">{</span> <span class="c1">//CAS处理transferIndex属性，告诉其他线程已处理下标索引。
</span><span class="c1"></span>                    <span class="n">bound</span> <span class="o">=</span> <span class="n">nextBound</span><span class="o">;</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">nextIndex</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
                    <span class="n">advance</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span> <span class="o">||</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">nextn</span><span class="o">)</span> <span class="o">{</span> 
                <span class="kt">int</span> <span class="n">sc</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">finishing</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">nextTable</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">nextTab</span><span class="o">;</span>
                    <span class="n">sizeCtl</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">-</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">1</span><span class="o">);</span><span class="c1">//1.5倍扩容
</span><span class="c1"></span>                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SIZECTL</span><span class="o">,</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">,</span> <span class="n">sc</span> <span class="o">-</span> <span class="n">1</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">-</span> <span class="n">2</span><span class="o">)</span> <span class="o">!=</span> <span class="n">resizeStamp</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">RESIZE_STAMP_SHIFT</span><span class="o">)</span>  <span class="c1">//sc - 2?? 因为扩容时，CAS修改sizectl属性为(resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)+2，所以这里判断是不是最后一个线程处理。
</span><span class="c1"></span>                        <span class="k">return</span><span class="o">;</span>
                    <span class="n">finishing</span> <span class="o">=</span> <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span> <span class="c1">// recheck before commit
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">advance</span> <span class="o">=</span> <span class="n">casTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">fwd</span><span class="o">);</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="n">MOVED</span><span class="o">)</span>
                <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// already processed
</span><span class="c1"></span>            <span class="k">else</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">// 同步锁
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>     <span class="c1">//再次判断
</span><span class="c1"></span>                        <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">ln</span><span class="o">,</span> <span class="n">hn</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kt">int</span> <span class="n">runBit</span> <span class="o">=</span> <span class="n">fh</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">;</span>
                            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">lastRun</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">next</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                                <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">runBit</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">runBit</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
                                    <span class="n">lastRun</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">runBit</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">ln</span> <span class="o">=</span> <span class="n">lastRun</span><span class="o">;</span>
                                <span class="n">hn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">else</span> <span class="o">{</span>
                                <span class="n">hn</span> <span class="o">=</span> <span class="n">lastRun</span><span class="o">;</span>
                                <span class="n">ln</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">for</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">lastRun</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                                <span class="kt">int</span> <span class="n">ph</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">;</span> <span class="n">K</span> <span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span> <span class="n">V</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">ph</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
                                    <span class="n">ln</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">ph</span><span class="o">,</span> <span class="n">pk</span><span class="o">,</span> <span class="n">pv</span><span class="o">,</span> <span class="n">ln</span><span class="o">);</span>
                                <span class="k">else</span>
                                    <span class="n">hn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">ph</span><span class="o">,</span> <span class="n">pk</span><span class="o">,</span> <span class="n">pv</span><span class="o">,</span> <span class="n">hn</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">nextTab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">ln</span><span class="o">);</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">nextTab</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="o">,</span> <span class="n">hn</span><span class="o">);</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fwd</span><span class="o">);</span>
                            <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="n">TreeBin</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">TreeBin</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="n">TreeBin</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">f</span><span class="o">;</span>
                            <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">lo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">loTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">hi</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">hiTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="kt">int</span> <span class="n">lc</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">hc</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                                <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">hash</span><span class="o">;</span>
                                <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span>
                                    <span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">loTail</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">lo</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="k">else</span>
                                        <span class="n">loTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="n">loTail</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="o">++</span><span class="n">lc</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="k">else</span> <span class="o">{</span>
                                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">hiTail</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">hi</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="k">else</span>
                                        <span class="n">hiTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="n">hiTail</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="o">++</span><span class="n">hc</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                            <span class="n">ln</span> <span class="o">=</span> <span class="o">(</span><span class="n">lc</span> <span class="o">&lt;=</span> <span class="n">UNTREEIFY_THRESHOLD</span><span class="o">)</span> <span class="o">?</span> <span class="n">untreeify</span><span class="o">(</span><span class="n">lo</span><span class="o">)</span> <span class="o">:</span>  <span class="c1">//红黑树节点数量小于等于UNTREEIFY_THRESHOLD(6)改成普通节点
</span><span class="c1"></span>                                <span class="o">(</span><span class="n">hc</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="n">TreeBin</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">lo</span><span class="o">)</span> <span class="o">:</span> <span class="n">t</span><span class="o">;</span>
                            <span class="n">hn</span> <span class="o">=</span> <span class="o">(</span><span class="n">hc</span> <span class="o">&lt;=</span> <span class="n">UNTREEIFY_THRESHOLD</span><span class="o">)</span> <span class="o">?</span> <span class="n">untreeify</span><span class="o">(</span><span class="n">hi</span><span class="o">)</span> <span class="o">:</span>
                                <span class="o">(</span><span class="n">lc</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="n">TreeBin</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">hi</span><span class="o">)</span> <span class="o">:</span> <span class="n">t</span><span class="o">;</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">nextTab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">ln</span><span class="o">);</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">nextTab</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="o">,</span> <span class="n">hn</span><span class="o">);</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fwd</span><span class="o">);</span>
                            <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>多线程怎么分段复制数据？</p>
<ul>
<li>定义每个线程处理数据范围(stride)；
<ul>
<li>(NCPU &gt; 1) ? (n &raquo;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE</li>
<li>最小16</li>
</ul>
</li>
<li>transferIndex变量，CAS控制每个范围；
<ul>
<li>高低遍历</li>
</ul>
</li>
<li>sizeCtl标示控制只有一个线程处理后面事情；
<ul>
<li>if ((sc - 2) != resizeStamp(n) &laquo; RESIZE_STAMP_SHIFT)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>fh &amp; n==0？等于零还在以前i下标索引，不等于零在i+n下标索引；</p>
</li>
</ul>
<p>例如：长度n=128(0000 0000 1000 0000)，hash=160,32;i=6;</p>
<table>
<thead>
<tr>
<th align="left">hash</th>
<th align="left">二进制</th>
<th align="left">下标</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">160</td>
<td align="left">0000 0000 1010 0000</td>
<td align="left">32</td>
</tr>
<tr>
<td align="left">32</td>
<td align="left">0000 0000 0010 0000</td>
<td align="left">32</td>
</tr>
</tbody>
</table>
<p>n 改成 256(0000 0001 0000 0000)</p>
<table>
<thead>
<tr>
<th align="left">hash</th>
<th align="left">二进制</th>
<th align="left">下标</th>
<th align="left">fh &amp; n</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">160</td>
<td align="left">0000 0000 1010 0000</td>
<td align="left">160(n+i)</td>
<td align="left">128</td>
</tr>
<tr>
<td align="left">32</td>
<td align="left">0000 0000 0010 0000</td>
<td align="left">32（i）</td>
<td align="left">0</td>
</tr>
</tbody>
</table>
<p>fh &amp; n比较fh中n的最高1是否存在；</p>
<h3 id="9untreeify-红黑树节点改成普通节点">9.untreeify 红黑树节点改成普通节点</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">      <span class="cm">/**
</span><span class="cm">       * Returns a list on non-TreeNodes replacing those in given list.
</span><span class="cm">       */</span>
      <span class="kd">static</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">untreeify</span><span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">hd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="k">for</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span> <span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">q</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">tl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                  <span class="n">hd</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
              <span class="k">else</span>
                  <span class="n">tl</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
              <span class="n">tl</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">hd</span><span class="o">;</span>
      <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="二compute">二、compute</h2>
<ul>
<li>hash下标数组数据为空时，创建ReservationNode作为占位符作用，synchronized控制并发，锁住占位符对象，CAS数组，执行remappingFunction方法；</li>
<li>找到相同值，执行remappingFunction</li>
<li>逻辑根put一样滴</li>
</ul>
<h2 id="三-merge">三、 merge</h2>
<ul>
<li>相同值，调用remappingFunction函数</li>
</ul>
<h2 id="四-get">四、 get</h2>
<ul>
<li>直接遍历，未使用同步锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">V</span> <span class="nf">get</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">eh</span><span class="o">;</span> <span class="n">K</span> <span class="n">ek</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
            <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">eh</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">//普通节点
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">eh</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>          <span class="c1">//黑红树节点
</span><span class="c1"></span>                <span class="k">return</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//普通节点往下查找
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                    <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span>
                    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="五replace-顾名思义做替换">五、replace 顾名思义做替换</h2>
<ul>
<li>逻辑根put一样</li>
<li>vaule为null有删除效果</li>
<li>remove调用该方法</li>
</ul>
<h2 id="六总结">六、总结</h2>
<ul>
<li>数组中每个元素附有锁控制，锁对象该数组元素(Node,TreeNodes,ForwardingNode,ReservationNodes)，做增删改操作，利用分段锁控制;</li>
<li>数量大小运用LongAdder，更好并发效果</li>
<li>扩容这样，元素利用多线程，分段处理，提高性能</li>
<li>遇到碰撞时，节点数量小于8，都是单链表保存，大于8转化为红黑树，删除操作时，节点数量少于6，转变为单链表结构</li>
<li>为啥时6或者8这个数据转化呢？</li>
</ul>

  </div>

  <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">BirdGod</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2017-08-18 21:18
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/birdgodtech/blog/master/LICENSE">MIT</a></span>
  </p>
</div>
<footer class="post-footer">
    <div class="post-tags">
      <a href="/tags/ConcurrentHashMap1.8/">ConcurrentHashMap1.8</a>
      </div>
    <nav class="post-nav" style="height: 27px">
      <a class="prev" href="/post/concurrent/collection/11.ConcurrentHashMap1.7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">ConcurrentLinkedQueue</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
      <a class="next" href="/post/concurrent/collection/13.ConcurrentSkipListSet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
        <span class="next-text nav-default">ConcurrentSkipListSet</span>
        <span class="next-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav>
  </footer>
  <script src="https://utteranc.es/client.js"
          repo="birdgodtech/birdgodtech.github.io"
          issue-term="pathname"
          theme="github-light"
          crossorigin="anonymous"
          async>
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterance.</a></noscript>
</article>
            </div>
            

        </div>
    </main>

    <footer id="footer" class="footer">
        <div class="social-links">
  <a href="mailto:birdgodtech@163.com" class="iconfont icon-email" title="email" rel="noopener" target="_blank" data-title="email"> </a>
  <a href="https://github.com/birdgodtech" class="iconfont icon-github" title="github" rel="noopener" target="_blank" data-title="github"> </a>
  <a href="https://birdgodtech.github.io/index.xml" type="application/rss+xml" rel="noopener" target="_blank" class="iconfont icon-rss" title="rss"></a>


</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy;
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">BirdGod</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.47f727f4.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-84813914-2', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
