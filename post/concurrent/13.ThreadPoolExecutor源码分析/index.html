<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ThreadPoolExecutor - BirdGod 技术分享</title>
    <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="BirdGod" /><meta name="description" content="ThreadPoolExecutor源码分析 简介 ThreadPoolExecutor是java.util.concurrent包中提供的线程" /><meta name="keywords" content="Java" />






<meta name="generator" content="Hugo 0.74.0-DEV with even 4.0.0" />


<link rel="canonical" href="https://birdgodtech.github.io/post/concurrent/13.ThreadPoolExecutor%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<link href="/post/concurrent/13.ThreadPoolExecutor%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="alternate" type="application/rss+xml" title="BirdGod 技术分享" />
<link href="/post/concurrent/13.ThreadPoolExecutor%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="feed" type="application/rss+xml" title="BirdGod 技术分享" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.06658218.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/reset-even.css">


<meta property="og:title" content="ThreadPoolExecutor" />
<meta property="og:description" content="ThreadPoolExecutor源码分析 简介 ThreadPoolExecutor是java.util.concurrent包中提供的线程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://birdgodtech.github.io/post/concurrent/13.ThreadPoolExecutor%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2017-04-20T20:11:08+00:00" />
<meta property="article:modified_time" content="2017-04-20T20:11:08+00:00" />
<meta itemprop="name" content="ThreadPoolExecutor">
<meta itemprop="description" content="ThreadPoolExecutor源码分析 简介 ThreadPoolExecutor是java.util.concurrent包中提供的线程">
<meta itemprop="datePublished" content="2017-04-20T20:11:08&#43;00:00" />
<meta itemprop="dateModified" content="2017-04-20T20:11:08&#43;00:00" />
<meta itemprop="wordCount" content="16439">



<meta itemprop="keywords" content="ThreadPoolExecutor," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ThreadPoolExecutor"/>
<meta name="twitter:description" content="ThreadPoolExecutor源码分析 简介 ThreadPoolExecutor是java.util.concurrent包中提供的线程"/>

</head>
<body>
<div id="mobile-navbar" class="mobile-navbar">
    <div class="mobile-header-logo">
        <a href="/" class="logo">BirdGod 技术分享</a>
    </div>
    <div class="mobile-navbar-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
    <ul class="mobile-menu-list">
        <a href="/">
            <li class="mobile-menu-item" title="首页">首页</li>
        </a>
        <a href="/post/">
            <li class="mobile-menu-item" title="归档">归档</li>
        </a>
        <a href="/categories/">
            <li class="mobile-menu-item" title="分类">分类</li>
        </a>
        <a href="/tags/">
            <li class="mobile-menu-item" title="标签">标签</li>
        </a>
        <a href="/about/">
            <li class="mobile-menu-item" title="关于我">关于我</li>
        </a>
        
    </ul>
</nav>

<div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
    <a href="/" class="logo">BirdGod 技术分享</a>
</div>

<nav class="site-navbar">
    <ul id="menu" class="menu" data-sum="0">
        
        <li class="menu-item menu-item-home">
            <a class="menu-item-link" href="/" title="首页">首页</a>
        </li>
        
        <li class="menu-item menu-item-archives">
            <a class="menu-item-link" href="/post/" title="归档">归档</a>
        </li>
        
        <li class="menu-item menu-item-categories">
            <a class="menu-item-link" href="/categories/" title="分类">分类</a>
        </li>
        
        <li class="menu-item menu-item-tags">
            <a class="menu-item-link" href="/tags/" title="标签">标签</a>
        </li>
        
        <li class="menu-item menu-item-about">
            <a class="menu-item-link" href="/about/" title="关于我">关于我</a>
        </li>
        
    </ul>
</nav>

    </header>


    <main id="main" class="main">
        <div class="content-wrapper">
            <div id="content" class="content">
                <article class="post">
  
  <header class="post-header">
    <h1 class="post-title">ThreadPoolExecutor</h1>

    <div class="post-meta">
      <span class="post-time"> 2017-04-20 20:11 </span>
      <div class="post-category">
        <a href="/categories/%E5%B9%B6%E5%8F%91/"> 并发 </a>
        </div>
      <span class="more-meta"> 约 16439 字 </span>
      <span class="more-meta"> 预计阅读 33 分钟 </span>
      <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
    </div>
  </header>

  <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#一threadpoolexecutor-数据结构实现">一、ThreadPoolExecutor 数据结构实现</a>
      <ul>
        <li><a href="#1threadpoolexecutor-实现abstractexecutorservice抽象类">1.ThreadPoolExecutor 实现AbstractExecutorService抽象类</a></li>
        <li><a href="#2threadpoolexecutor-内部结构实现">2.ThreadPoolExecutor 内部结构实现</a></li>
      </ul>
    </li>
    <li><a href="#二-executerunnable-command-执行给定的任务">二 、execute(Runnable command) 执行给定的任务</a></li>
    <li><a href="#三-submit-提交指定的任务">三 、submit 提交指定的任务</a></li>
    <li><a href="#四-invokeall和invokeany执行批量任务">四 、invokeAll和invokeAny执行批量任务</a>
      <ul>
        <li><a href="#1-invokeall">1. invokeAll</a></li>
        <li><a href="#2-invokeany">2. invokeAny</a></li>
      </ul>
    </li>
    <li><a href="#停止任务-shutdown和shutdownnow">停止任务 shutdown和shutdownNow</a></li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>【注意】最后更新于 <span class="timeago" datetime="2017-04-20T20:11:08" title="April 20, 2017">April 20, 2017</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
  <div class="post-content">
    <h1 id="threadpoolexecutor源码分析">ThreadPoolExecutor源码分析</h1>
<h2 id="简介">简介</h2>
<p>　　ThreadPoolExecutor是java.util.concurrent包中提供的线程池。</p>
<h2 id="一threadpoolexecutor-数据结构实现">一、ThreadPoolExecutor 数据结构实现</h2>
<h3 id="1threadpoolexecutor-实现abstractexecutorservice抽象类">1.ThreadPoolExecutor 实现AbstractExecutorService抽象类</h3>
<p>依赖关系图如下:</p>
<p><img src="/concurrent//AbstractExecutorServiceImp.png" alt=""></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExecutorService</span> <span class="kd">extends</span> <span class="n">Executor</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * 关闭当前执行器，关闭之前提交的任务仍然会被执行，但不
</span><span class="cm">     * 会接收新的任务。如果当前执行服务已经关闭，那么调用这
</span><span class="cm">     * 个方法不会产生额外的影响。
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * 尝试停止所有正在执行的任务，停止处理正在等待的任务，
</span><span class="cm">     * 并返回等待执行任务列表。
</span><span class="cm">     *
</span><span class="cm">     * 并不能确保一定可以停止正在执行的任务。比如，通常的实现
</span><span class="cm">     * 方式是中断执行任务的线程，但如果任务执行过程中并不响应
</span><span class="cm">     * 中断，那就无法停止这个任务。
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="nf">shutdownNow</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * 判断当前执行器是否已经关闭。
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">isShutdown</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * 判断在执行器关闭后，是否所有的任务都执行完毕。
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">isTerminated</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * 在一个关闭请求后，阻塞等待，直到所有任务都执行完毕，或者
</span><span class="cm">     * 超时，或者当前线程被中断。
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">awaitTermination</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 提交一个有返回结果的任务，并返回一个Future。  
</span><span class="cm">     */</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">);</span>
    <span class="cm">/**
</span><span class="cm">     * 提交一个Runnable任务和返回结果，并返回一个Future。
</span><span class="cm">     */</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">,</span> <span class="n">T</span> <span class="n">result</span><span class="o">);</span>
    <span class="cm">/**
</span><span class="cm">     * 提交一个Runnable任务和返回结果，并返回一个Future。
</span><span class="cm">     * 如果任务执行完毕，调用Future的get方法返回null。
</span><span class="cm">     */</span>
    <span class="n">Future</span><span class="o">&lt;?&gt;</span> <span class="n">submit</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">);</span>
    <span class="cm">/**
</span><span class="cm">     * 执行一批任务，当所有任务都执行完毕后，以Future集合
</span><span class="cm">     * 集合的形式返回结果。
</span><span class="cm">     */</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">invokeAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 执行一批任务，当所有任务都执行完毕或者超时，以Future集合
</span><span class="cm">     * 集合的形式返回结果。注意如果超时的话，没有执行完的任务会
</span><span class="cm">     * 被取消。
</span><span class="cm">     */</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">invokeAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">,</span>
                                  <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 执行一批任务，如果其中有一个任务完成，就返回结果。
</span><span class="cm">     * 其他没有完成的任务会被取消。
</span><span class="cm">     */</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">invokeAny</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 执行一批任务，如果其中有一个任务完成或者超时，就返回结果。
</span><span class="cm">     * 其他没有完成的任务会被取消。
</span><span class="cm">     */</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">invokeAny</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">,</span>
                    <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">TimeoutException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="2threadpoolexecutor-内部结构实现">2.ThreadPoolExecutor 内部结构实现</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolExecutor</span> <span class="kd">extends</span> <span class="n">AbstractExecutorService</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * The main pool control state, ctl, is an atomic integer packing
</span><span class="cm">     * two conceptual fields
</span><span class="cm">     *   workerCount, indicating the effective number of threads
</span><span class="cm">     *   runState,    indicating whether running, shutting down etc
</span><span class="cm">     *  主池控制状态ctl是包含两个概念字段的原子整数：
</span><span class="cm">     *    workerCount，表示有效的线程数
</span><span class="cm">     *    runState，指示是否运行，关闭等
</span><span class="cm">     * In order to pack them into one int, we limit workerCount to
</span><span class="cm">     * (2^29)-1 (about 500 million) threads rather than (2^31)-1 (2
</span><span class="cm">     * billion) otherwise representable. If this is ever an issue in
</span><span class="cm">     * the future, the variable can be changed to be an AtomicLong,
</span><span class="cm">     * and the shift/mask constants below adjusted. But until the need
</span><span class="cm">     * arises, this code is a bit faster and simpler using an int.
</span><span class="cm">     * ctl控制状态是int，我们将workerCount限制为（2 ^ 29）-1（约5亿），而不是（2 ^ 31）-1（20亿）。
</span><span class="cm">     * 如果将来有这个问题，可以将变量改为AtomicLong，并调整下面的shift / mask常量。但是，直到需要出现，这个代码是更快，更简单的使用int
</span><span class="cm">     *
</span><span class="cm">     * The workerCount is the number of workers that have been
</span><span class="cm">     * permitted to start and not permitted to stop.  The value may be
</span><span class="cm">     * transiently different from the actual number of live threads,
</span><span class="cm">     * for example when a ThreadFactory fails to create a thread when
</span><span class="cm">     * asked, and when exiting threads are still performing
</span><span class="cm">     * bookkeeping before terminating. The user-visible pool size is
</span><span class="cm">     * reported as the current size of the workers set.
</span><span class="cm">     * 
</span><span class="cm">     * workerCount是已经被允许启动并且不被允许停止的工作线程的数量。该值可能与活动线程的实际数量暂时不同，
</span><span class="cm">     * 例如，当ThreadFactory在被询问时未能创建线程，以及退出线程在终止之前仍在执行簿记时。
</span><span class="cm">     * 用户可见的池大小被报告为工作者集合的当前大小。
</span><span class="cm">     *
</span><span class="cm">     * The runState provides the main lifecyle control, taking on values:
</span><span class="cm">     * 
</span><span class="cm">     *
</span><span class="cm">     *   RUNNING:  Accept new tasks and process queued tasks
</span><span class="cm">     *   SHUTDOWN: Don&#39;t accept new tasks, but process queued tasks
</span><span class="cm">     *   STOP:     Don&#39;t accept new tasks, don&#39;t process queued tasks,
</span><span class="cm">     *             and interrupt in-progress tasks
</span><span class="cm">     *   TIDYING:  All tasks have terminated, workerCount is zero,
</span><span class="cm">     *             the thread transitioning to state TIDYING
</span><span class="cm">     *             will run the terminated() hook method
</span><span class="cm">     *   TERMINATED: terminated() has completed
</span><span class="cm">     *   
</span><span class="cm">     * runState提供了主要的生命周期控制，取值为：
</span><span class="cm">     *   RUNNING: 接受新任务并处理排队的任务
</span><span class="cm">     *   SHUTDOWN: 不要接受新的任务，而是处理排队的任务
</span><span class="cm">     *   STOP:     不要接受新的任务，不要处理排队的任务，并中断正在进行的任务
</span><span class="cm">     *   TIDYING:  所有任务都已终止，workerCount为零，线程转换到状态TIDYING将运行terminate（）挂接方法
</span><span class="cm">     *   TERMINATED: terminated() 已经完成
</span><span class="cm">     *
</span><span class="cm">     * The numerical order among these values matters, to allow
</span><span class="cm">     * ordered comparisons. The runState monotonically increases over
</span><span class="cm">     * time, but need not hit each state. The transitions are:
</span><span class="cm">     *
</span><span class="cm">     * 这些值之间的数字顺序很重要，以允许有序的比较。 runState随着时间的推移单调增加，但不需要击中每个状态。转换是：
</span><span class="cm">     * 
</span><span class="cm">     * RUNNING -&gt; SHUTDOWN
</span><span class="cm">     *    On invocation of shutdown(), perhaps implicitly in finalize() 在调用shutdown（）时，可能会隐式地在finalize（）
</span><span class="cm">     * (RUNNING or SHUTDOWN) -&gt; STOP
</span><span class="cm">     *    On invocation of shutdownNow()  在调用shutdownNow（）
</span><span class="cm">     * SHUTDOWN -&gt; TIDYING
</span><span class="cm">     *    When both queue and pool are empty 当队列和池都为空时
</span><span class="cm">     * STOP -&gt; TIDYING
</span><span class="cm">     *    When pool is empty    池为空时
</span><span class="cm">     * TIDYING -&gt; TERMINATED
</span><span class="cm">     *    When the terminated() hook method has completed  当terminate（）钩子方法完成时
</span><span class="cm">     *
</span><span class="cm">     * Threads waiting in awaitTermination() will return when the
</span><span class="cm">     * state reaches TERMINATED.
</span><span class="cm">     * 
</span><span class="cm">     * 当状态达到TERMINATED时，在awaitTermination（）中等待的线程将返回。
</span><span class="cm">     *
</span><span class="cm">     * Detecting the transition from SHUTDOWN to TIDYING is less
</span><span class="cm">     * straightforward than you&#39;d like because the queue may become
</span><span class="cm">     * empty after non-empty and vice versa during SHUTDOWN state, but
</span><span class="cm">     * we can only terminate if, after seeing that it is empty, we see
</span><span class="cm">     * that workerCount is 0 (which sometimes entails a recheck -- see
</span><span class="cm">     * below).
</span><span class="cm">     * 检测从SHUTDOWN到TIDYING的转换并不像你希望的那样简单，
</span><span class="cm">     * 因为在SHUTDOWN状态下，非空或反过来，队列可能变空，但是只有在看到它为空时，
</span><span class="cm">     * 我们才能看到workerCount是0（这有时需要重新检查 - 见下文）。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">ctl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">ctlOf</span><span class="o">(</span><span class="n">RUNNING</span><span class="o">,</span> <span class="n">0</span><span class="o">));</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">COUNT_BITS</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">SIZE</span> <span class="o">-</span> <span class="n">3</span><span class="o">;</span> <span class="c1">//高29位以上代表runState
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CAPACITY</span>   <span class="o">=</span> <span class="o">(</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">)</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="c1">//workerCount最大容量(536870911) 0001 1111 1111 1111 1111 1111 1111 1111
</span><span class="c1"></span>
    <span class="c1">// runState is stored in the high-order bits
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RUNNING</span>    <span class="o">=</span> <span class="o">-</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span><span class="c1">//1110 0000 0000 0000 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SHUTDOWN</span>   <span class="o">=</span>  <span class="n">0</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span><span class="c1">//0000 0000 0000 0000 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STOP</span>       <span class="o">=</span>  <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span><span class="c1">//0010 0000 0000 0000 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TIDYING</span>    <span class="o">=</span>  <span class="n">2</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span><span class="c1">//0100 0000 0000 0000 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TERMINATED</span> <span class="o">=</span>  <span class="n">3</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span><span class="c1">//0110 0000 0000 0000 0000 0000 0000 0000 
</span><span class="c1"></span>
    <span class="c1">// Packing and unpacking ctl  包装和拆包 ctl
</span><span class="c1"></span>    <span class="c1">//获取 runState
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">runStateOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">)</span>     <span class="o">{</span> <span class="k">return</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CAPACITY</span><span class="o">;</span> <span class="o">}</span>
    <span class="c1">//获取 workerCount
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">workerCountOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">)</span>  <span class="o">{</span> <span class="k">return</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="n">CAPACITY</span><span class="o">;</span> <span class="o">}</span>
    <span class="c1">//两个数取或
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">ctlOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">wc</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">rs</span> <span class="o">|</span> <span class="n">wc</span><span class="o">;</span> <span class="o">}</span>

    <span class="cm">/*
</span><span class="cm">     * Bit field accessors that don&#39;t require unpacking ctl.
</span><span class="cm">     * These depend on the bit layout and on workerCount being never negative.
</span><span class="cm">     * 
</span><span class="cm">     */</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">runStateLessThan</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">,</span> <span class="kt">int</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">runStateAtLeast</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">,</span> <span class="kt">int</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isRunning</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">SHUTDOWN</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Attempt to CAS-increment the workerCount field of ctl.
</span><span class="cm">     * CAS 添加 workerCount
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">compareAndIncrementWorkerCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">expect</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ctl</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">expect</span><span class="o">,</span> <span class="n">expect</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Attempt to CAS-decrement the workerCount field of ctl.
</span><span class="cm">     * CAS 减少 workerCount
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">compareAndDecrementWorkerCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">expect</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ctl</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">expect</span><span class="o">,</span> <span class="n">expect</span> <span class="o">-</span> <span class="n">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Decrements the workerCount field of ctl. This is called only on
</span><span class="cm">     * abrupt termination of a thread (see processWorkerExit). Other
</span><span class="cm">     * decrements are performed within getTask.
</span><span class="cm">     *  while循环调用compareAndDecrementWorkerCount方法 主要减少workerCount数量
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">decrementWorkerCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">do</span> <span class="o">{}</span> <span class="k">while</span> <span class="o">(!</span> <span class="n">compareAndDecrementWorkerCount</span><span class="o">(</span><span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * The queue used for holding tasks and handing off to worker
</span><span class="cm">     * threads.  We do not require that workQueue.poll() returning
</span><span class="cm">     * null necessarily means that workQueue.isEmpty(), so rely
</span><span class="cm">     * solely on isEmpty to see if the queue is empty (which we must
</span><span class="cm">     * do for example when deciding whether to transition from
</span><span class="cm">     * SHUTDOWN to TIDYING).  This accommodates special-purpose
</span><span class="cm">     * queues such as DelayQueues for which poll() is allowed to
</span><span class="cm">     * return null even if it may later return non-null when delays
</span><span class="cm">     * expire.
</span><span class="cm">     * 任务队列，负责保存任务并将任务交给工作线程处理。我们不要求返回null的workQueue.poll（）必然意味着workQueue.isEmpty（），
</span><span class="cm">     * 因此完全依赖于isEmpty来查看队列是否为空（例如，在决定是否从SHUTDOWN转换为TIDYING时，我们必须执行此操作） 。
</span><span class="cm">     * 这容纳了特殊用途的队列，如DelayQueues，即使poll（）允许其返回null，即使延迟过期后可能会返回非null。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Lock held on access to workers set and related bookkeeping.
</span><span class="cm">     * While we could use a concurrent set of some sort, it turns out
</span><span class="cm">     * to be generally preferable to use a lock. Among the reasons is
</span><span class="cm">     * that this serializes interruptIdleWorkers, which avoids
</span><span class="cm">     * unnecessary interrupt storms, especially during shutdown.
</span><span class="cm">     * Otherwise exiting threads would concurrently interrupt those
</span><span class="cm">     * that have not yet interrupted. It also simplifies some of the
</span><span class="cm">     * associated statistics bookkeeping of largestPoolSize etc. We
</span><span class="cm">     * also hold mainLock on shutdown and shutdownNow, for the sake of
</span><span class="cm">     * ensuring workers set is stable while separately checking
</span><span class="cm">     * permission to interrupt and actually interrupting.
</span><span class="cm">     * 
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * Set containing all worker threads in pool. Accessed only when
</span><span class="cm">     * holding mainLock.
</span><span class="cm">     * 设置包含池中的所有工作线程。只有在保持mainLock的情况下才能访问。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;();</span>

    <span class="cm">/**
</span><span class="cm">     * Wait condition to support awaitTermination
</span><span class="cm">     * 等待状态支持等待终止
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Condition</span> <span class="n">termination</span> <span class="o">=</span> <span class="n">mainLock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * Tracks largest attained pool size. Accessed only under
</span><span class="cm">     * mainLock.
</span><span class="cm">     * 跟踪达到最大线程池大小。仅在mainLock下访问。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">largestPoolSize</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Counter for completed tasks. Updated only on termination of
</span><span class="cm">     * worker threads. Accessed only under mainLock.
</span><span class="cm">     * 完成任务的计数器。仅在工作线程终止时更新。仅在mainLock下访问。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">completedTaskCount</span><span class="o">;</span>

    <span class="cm">/*
</span><span class="cm">     * All user control parameters are declared as volatiles so that
</span><span class="cm">     * ongoing actions are based on freshest values, but without need
</span><span class="cm">     * for locking, since no internal invariants depend on them
</span><span class="cm">     * changing synchronously with respect to other actions.
</span><span class="cm">     */</span>

    <span class="cm">/**
</span><span class="cm">     * Factory for new threads. All threads are created using this
</span><span class="cm">     * factory (via method addWorker).  All callers must be prepared
</span><span class="cm">     * for addWorker to fail, which may reflect a system or user&#39;s
</span><span class="cm">     * policy limiting the number of threads.  Even though it is not
</span><span class="cm">     * treated as an error, failure to create threads may result in
</span><span class="cm">     * new tasks being rejected or existing ones remaining stuck in
</span><span class="cm">     * the queue.
</span><span class="cm">     * 
</span><span class="cm">     * 工厂创建新线程。所有的线程都是使用这个工厂创建的（通过方法addWorker）。
</span><span class="cm">     * 所有的调用者都必须准备好让addWorker失败，这可能反映了系统或用户的策略限制了线程的数量。
</span><span class="cm">     * 即使它不被视为错误，创建线程失败可能会导致新任务被拒绝或现有的任务仍然滞留在队列中。
</span><span class="cm">     * 
</span><span class="cm">     * We go further and preserve pool invariants even in the face of
</span><span class="cm">     * errors such as OutOfMemoryError, that might be thrown while
</span><span class="cm">     * trying to create threads.  Such errors are rather common due to
</span><span class="cm">     * the need to allocate a native stack in Thread#start, and users
</span><span class="cm">     * will want to perform clean pool shutdown to clean up.  There
</span><span class="cm">     * will likely be enough memory available for the cleanup code to
</span><span class="cm">     * complete without encountering yet another OutOfMemoryError.
</span><span class="cm">     * 
</span><span class="cm">     * 即使面对诸如OutOfMemoryError之类的错误，我们也可以更进一步并保持池不变量，这可能会在尝试创建线程时抛出。
</span><span class="cm">     * 这样的错误是相当普遍的，因为需要在Thread＃start中分配一个本地堆栈，并且用户需要执行清理池关闭来清理。
</span><span class="cm">     * 可能会有足够的内存用于清理代码，而不会遇到另一个OutOfMemoryError。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Handler called when saturated or shutdown in execute.
</span><span class="cm">     * 在执行时调用saturated or shutdown 时的处理程序。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Timeout in nanoseconds for idle threads waiting for work.
</span><span class="cm">     * Threads use this timeout when there are more than corePoolSize
</span><span class="cm">     * present or if allowCoreThreadTimeOut. Otherwise they wait
</span><span class="cm">     * forever for new work.
</span><span class="cm">     * 
</span><span class="cm">     * 空闲工作线程等待任务的超时时间，单位：纳秒。
</span><span class="cm">     * 当前线程数大于核心线程数时，超出的线程会使用这个超时时间。
</span><span class="cm">     * 如果设置了allowCoreThreadTimeOut，核心线程数也会使用这个
</span><span class="cm">    * 超时时间。否则，线程会一直等待新任务，不会超时。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * If false (default), core threads stay alive even when idle.
</span><span class="cm">     * If true, core threads use keepAliveTime to time out waiting
</span><span class="cm">     * for work.
</span><span class="cm">     * 如果为false(默认情况下)，核心线程就算空闲也会一直存活。
</span><span class="cm">     * 如果为true，等待任务的核心线程会使用keepAliveTime作为
</span><span class="cm">     * 超时时间，如果超时，线程被回收。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">allowCoreThreadTimeOut</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Core pool size is the minimum number of workers to keep alive
</span><span class="cm">     * (and not allow to time out etc) unless allowCoreThreadTimeOut
</span><span class="cm">     * is set, in which case the minimum is zero.
</span><span class="cm">     *  核心线程数量，只能在持有mainLock的情况下修改。
</span><span class="cm">     * volatile可以保证可见性。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Maximum pool size. Note that the actual maximum is internally
</span><span class="cm">     * bounded by CAPACITY.
</span><span class="cm">     * 最大线程数量。注意，实际的最大值是内部受CAPACITY限制的。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * The default rejected execution handler
</span><span class="cm">     * 默认的拒绝执行处理程序
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">RejectedExecutionHandler</span> <span class="n">defaultHandler</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">AbortPolicy</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * Permission required for callers of shutdown and shutdownNow.
</span><span class="cm">     * We additionally require (see checkShutdownAccess) that callers
</span><span class="cm">     * have permission to actually interrupt threads in the worker set
</span><span class="cm">     * (as governed by Thread.interrupt, which relies on
</span><span class="cm">     * ThreadGroup.checkAccess, which in turn relies on
</span><span class="cm">     * SecurityManager.checkAccess). Shutdowns are attempted only if
</span><span class="cm">     * these checks pass.
</span><span class="cm">     *  
</span><span class="cm">     *  对于调用线程池的shutdown(),shutdownNow()方法权限认证。
</span><span class="cm">     *  我们还需要（请参阅checkShutdownAccess）调用者有权实际中断工作集中的线程
</span><span class="cm">     *  （由Thread.interrupt控制，而ThreadGroup.checkAccess依赖于SecurityManager.checkAccess）。
</span><span class="cm">     *  仅当这些检查通过时才试图关机。
</span><span class="cm">     *  
</span><span class="cm">     * All actual invocations of Thread.interrupt (see
</span><span class="cm">     * interruptIdleWorkers and interruptWorkers) ignore
</span><span class="cm">     * SecurityExceptions, meaning that the attempted interrupts
</span><span class="cm">     * silently fail. In the case of shutdown, they should not fail
</span><span class="cm">     * unless the SecurityManager has inconsistent policies, sometimes
</span><span class="cm">     * allowing access to a thread and sometimes not. In such cases,
</span><span class="cm">     * failure to actually interrupt threads may disable or delay full
</span><span class="cm">     * termination. Other uses of interruptIdleWorkers are advisory,
</span><span class="cm">     * and failure to actually interrupt will merely delay response to
</span><span class="cm">     * configuration changes so is not handled exceptionally.
</span><span class="cm">     * 
</span><span class="cm">     * Thread.interrupt的所有实际调用（请参阅interruptIdleWorkers和interruptWorkers）都将忽略SecurityExceptions，
</span><span class="cm">     * 这意味着尝试的中断将以静默方式失败。在关闭的情况下，除非SecurityManager具有不一致的策略，否则不应该失败，
</span><span class="cm">     * 有时允许访问线程，有时不允许访问。在这种情况下，实际中断线程的失败可能会导致或终止完全中断。 
</span><span class="cm">     * interruptIdleWorkers的其他用途是建议性的，实际中断的失败只会延迟对配置更改的响应，因此不会异常处理。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">RuntimePermission</span> <span class="n">shutdownPerm</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">RuntimePermission</span><span class="o">(</span><span class="s">&#34;modifyThread&#34;</span><span class="o">);</span>

  <span class="cm">/**
</span><span class="cm">   * Creates a new {@code ThreadPoolExecutor} with the given initial
</span><span class="cm">   * parameters and default thread factory and rejected execution handler.
</span><span class="cm">   * It may be more convenient to use one of the {@link Executors} factory
</span><span class="cm">   * methods instead of this general purpose constructor.
</span><span class="cm">   *
</span><span class="cm">   * @param corePoolSize the number of threads to keep in the pool, even
</span><span class="cm">   *        if they are idle, unless {@code allowCoreThreadTimeOut} is set
</span><span class="cm">   * @param maximumPoolSize the maximum number of threads to allow in the
</span><span class="cm">   *        pool
</span><span class="cm">   * @param keepAliveTime when the number of threads is greater than
</span><span class="cm">   *        the core, this is the maximum time that excess idle threads
</span><span class="cm">   *        will wait for new tasks before terminating.
</span><span class="cm">   * @param unit the time unit for the {@code keepAliveTime} argument
</span><span class="cm">   * @param workQueue the queue to use for holding tasks before they are
</span><span class="cm">   *        executed.  This queue will hold only the {@code Runnable}
</span><span class="cm">   *        tasks submitted by the {@code execute} method.
</span><span class="cm">   * @throws IllegalArgumentException if one of the following holds:&lt;br&gt;
</span><span class="cm">   *         {@code corePoolSize &lt; 0}&lt;br&gt;
</span><span class="cm">   *         {@code keepAliveTime &lt; 0}&lt;br&gt;
</span><span class="cm">   *         {@code maximumPoolSize &lt;= 0}&lt;br&gt;
</span><span class="cm">   *         {@code maximumPoolSize &lt; corePoolSize}
</span><span class="cm">   * @throws NullPointerException if {@code workQueue} is null
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                            <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                            <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                            <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                            <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
           <span class="n">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span> <span class="n">defaultHandler</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
</span><span class="cm">   * Creates a new {@code ThreadPoolExecutor} with the given initial
</span><span class="cm">   * parameters and default rejected execution handler.
</span><span class="cm">   *
</span><span class="cm">   * @param corePoolSize the number of threads to keep in the pool, even
</span><span class="cm">   *        if they are idle, unless {@code allowCoreThreadTimeOut} is set
</span><span class="cm">   * @param maximumPoolSize the maximum number of threads to allow in the
</span><span class="cm">   *        pool
</span><span class="cm">   * @param keepAliveTime when the number of threads is greater than
</span><span class="cm">   *        the core, this is the maximum time that excess idle threads
</span><span class="cm">   *        will wait for new tasks before terminating.
</span><span class="cm">   * @param unit the time unit for the {@code keepAliveTime} argument
</span><span class="cm">   * @param workQueue the queue to use for holding tasks before they are
</span><span class="cm">   *        executed.  This queue will hold only the {@code Runnable}
</span><span class="cm">   *        tasks submitted by the {@code execute} method.
</span><span class="cm">   * @param threadFactory the factory to use when the executor
</span><span class="cm">   *        creates a new thread
</span><span class="cm">   * @throws IllegalArgumentException if one of the following holds:&lt;br&gt;
</span><span class="cm">   *         {@code corePoolSize &lt; 0}&lt;br&gt;
</span><span class="cm">   *         {@code keepAliveTime &lt; 0}&lt;br&gt;
</span><span class="cm">   *         {@code maximumPoolSize &lt;= 0}&lt;br&gt;
</span><span class="cm">   *         {@code maximumPoolSize &lt; corePoolSize}
</span><span class="cm">   * @throws NullPointerException if {@code workQueue}
</span><span class="cm">   *         or {@code threadFactory} is null
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                            <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                            <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                            <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                            <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                            <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
           <span class="n">threadFactory</span><span class="o">,</span> <span class="n">defaultHandler</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
</span><span class="cm">   * Creates a new {@code ThreadPoolExecutor} with the given initial
</span><span class="cm">   * parameters and default thread factory.
</span><span class="cm">   *
</span><span class="cm">   * @param corePoolSize the number of threads to keep in the pool, even
</span><span class="cm">   *        if they are idle, unless {@code allowCoreThreadTimeOut} is set
</span><span class="cm">   * @param maximumPoolSize the maximum number of threads to allow in the
</span><span class="cm">   *        pool
</span><span class="cm">   * @param keepAliveTime when the number of threads is greater than
</span><span class="cm">   *        the core, this is the maximum time that excess idle threads
</span><span class="cm">   *        will wait for new tasks before terminating.
</span><span class="cm">   * @param unit the time unit for the {@code keepAliveTime} argument
</span><span class="cm">   * @param workQueue the queue to use for holding tasks before they are
</span><span class="cm">   *        executed.  This queue will hold only the {@code Runnable}
</span><span class="cm">   *        tasks submitted by the {@code execute} method.
</span><span class="cm">   * @param handler the handler to use when execution is blocked
</span><span class="cm">   *        because the thread bounds and queue capacities are reached
</span><span class="cm">   * @throws IllegalArgumentException if one of the following holds:&lt;br&gt;
</span><span class="cm">   *         {@code corePoolSize &lt; 0}&lt;br&gt;
</span><span class="cm">   *         {@code keepAliveTime &lt; 0}&lt;br&gt;
</span><span class="cm">   *         {@code maximumPoolSize &lt;= 0}&lt;br&gt;
</span><span class="cm">   *         {@code maximumPoolSize &lt; corePoolSize}
</span><span class="cm">   * @throws NullPointerException if {@code workQueue}
</span><span class="cm">   *         or {@code handler} is null
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                            <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                            <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                            <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                            <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                            <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
           <span class="n">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span> <span class="n">handler</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
</span><span class="cm">   * Creates a new {@code ThreadPoolExecutor} with the given initial
</span><span class="cm">   * parameters.
</span><span class="cm">   *
</span><span class="cm">   * @param corePoolSize the number of threads to keep in the pool, even
</span><span class="cm">   *        if they are idle, unless {@code allowCoreThreadTimeOut} is set
</span><span class="cm">   * @param maximumPoolSize the maximum number of threads to allow in the
</span><span class="cm">   *        pool
</span><span class="cm">   * @param keepAliveTime when the number of threads is greater than
</span><span class="cm">   *        the core, this is the maximum time that excess idle threads
</span><span class="cm">   *        will wait for new tasks before terminating.
</span><span class="cm">   * @param unit the time unit for the {@code keepAliveTime} argument
</span><span class="cm">   * @param workQueue the queue to use for holding tasks before they are
</span><span class="cm">   *        executed.  This queue will hold only the {@code Runnable}
</span><span class="cm">   *        tasks submitted by the {@code execute} method.
</span><span class="cm">   * @param threadFactory the factory to use when the executor
</span><span class="cm">   *        creates a new thread
</span><span class="cm">   * @param handler the handler to use when execution is blocked
</span><span class="cm">   *        because the thread bounds and queue capacities are reached
</span><span class="cm">   * @throws IllegalArgumentException if one of the following holds:&lt;br&gt;
</span><span class="cm">   *         {@code corePoolSize &lt; 0}&lt;br&gt;
</span><span class="cm">   *         {@code keepAliveTime &lt; 0}&lt;br&gt;
</span><span class="cm">   *         {@code maximumPoolSize &lt;= 0}&lt;br&gt;
</span><span class="cm">   *         {@code maximumPoolSize &lt; corePoolSize}
</span><span class="cm">   * @throws NullPointerException if {@code workQueue}
</span><span class="cm">   *         or {@code threadFactory} or {@code handler} is null
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                            <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                            <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                            <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                            <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                            <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
                            <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">corePoolSize</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
          <span class="n">maximumPoolSize</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">||</span>
          <span class="n">maximumPoolSize</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span> <span class="o">||</span>
          <span class="n">keepAliveTime</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">workQueue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">threadFactory</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">corePoolSize</span> <span class="o">=</span> <span class="n">corePoolSize</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">maximumPoolSize</span> <span class="o">=</span> <span class="n">maximumPoolSize</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">workQueue</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">keepAliveTime</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">keepAliveTime</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">threadFactory</span> <span class="o">=</span> <span class="n">threadFactory</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="1构造threadpoolexecutorint-corepoolsizeint-maximumpoolsizelong-keepalivetimetimeunit-unitblockingqueuerunnable-workqueuethreadfactory-threadfactoryrejectedexecutionhandler-handler">(1).构造<code>ThreadPoolExecutor(int corePoolSize,int maximumPoolSize,long keepAliveTime,TimeUnit unit,BlockingQueue&lt;Runnable&gt; workQueue,ThreadFactory threadFactory,RejectedExecutionHandler handler)</code></h4>
<table>
<thead>
<tr>
<th align="center">参数名</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">corePoolSize</td>
<td align="center">核心线程池大小 　</td>
</tr>
<tr>
<td align="center">maximumPoolSize</td>
<td align="center">最大线程池大小 　</td>
</tr>
<tr>
<td align="center">keepAliveTime</td>
<td align="center">线程池中超过corePoolSize数目的空闲线程最大存活时间；可以allowCoreThreadTimeOut(true)使得核心线程有效时间</td>
</tr>
<tr>
<td align="center">TimeUnit</td>
<td align="center">keepAliveTime时间单位</td>
</tr>
<tr>
<td align="center">workQueue</td>
<td align="center">阻塞任务队列(ArrayBlockingQueue,LinkedBlockingQueue,PriorityBlockingQueue,DelayQueue,SynchronousQueue,LinkedTransferQueue和LinkedBlockingDeque等)</td>
</tr>
<tr>
<td align="center">threadFactory</td>
<td align="center">新建线程工厂(DefaultThreadFactory,PrivilegedThreadFactory)</td>
</tr>
<tr>
<td align="center">RejectedExecutionHandler</td>
<td align="center">当提交任务数超过maxmumPoolSize+workQueue之和时，任务会交给RejectedExecutionHandler来处理,AbortPolicy,CallerRunsPolicy,DiscardPolicy,DiscardOldestPolicy</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>corePoolSize，maximumPoolSize，workQueue之间关系。</p>
<ul>
<li>1.当线程池小于corePoolSize时，新提交任务将创建一个新线程执行任务，即使此时线程池中存在空闲线程。</li>
<li>2.当线程池达到corePoolSize时，新提交任务将被放入workQueue中，等待线程池中任务调度执行</li>
<li>3.当workQueue已满，且maximumPoolSize&gt;corePoolSize时，新提交任务会创建新线程执行任务</li>
<li>4.当提交任务数超过maximumPoolSize时，新提交任务由RejectedExecutionHandler处理</li>
<li>5.当线程池中超过corePoolSize线程，空闲时间达到keepAliveTime时，关闭空闲线程</li>
<li>6.当设置allowCoreThreadTimeOut(true)时，线程池中corePoolSize线程空闲时间达到keepAliveTime也将关闭</li>
</ul>
</li>
<li>
<p>RejectedExecutionHandler 四种拒绝策略说明</p>
<ul>
<li>1.AbortPolicy 抛出RejectedExecutionException的被拒绝任务的处理程序。</li>
<li>2.CallerRunsPolicy 直接在执行方法的调用线程中运行被拒绝的任务，除非执行程序已关闭，在这种情况下任务将被丢弃。</li>
<li>3.DiscardOledestPolicy  丢弃最旧的未处理的请求，然后重试{execute}，除非执行程序关闭，在这种情况下任务将被丢弃。</li>
<li>4.DiscardPolicy 默默的丢弃无法处理的任务，不予任何处理。</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">    * A handler for rejected tasks that runs the rejected task
</span><span class="cm">    * directly in the calling thread of the {@code execute} method,
</span><span class="cm">    * unless the executor has been shut down, in which case the task
</span><span class="cm">    * is discarded.
</span><span class="cm">    */</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CallerRunsPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
       <span class="cm">/**
</span><span class="cm">        * Creates a {@code CallerRunsPolicy}.
</span><span class="cm">        */</span>
       <span class="kd">public</span> <span class="nf">CallerRunsPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>

       <span class="cm">/**
</span><span class="cm">        * Executes task r in the caller&#39;s thread, unless the executor
</span><span class="cm">        * has been shut down, in which case the task is discarded.
</span><span class="cm">        *
</span><span class="cm">        * @param r the runnable task requested to be executed
</span><span class="cm">        * @param e the executor attempting to execute this task
</span><span class="cm">        */</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">}</span>

   <span class="cm">/**
</span><span class="cm">    * A handler for rejected tasks that throws a
</span><span class="cm">    * {@code RejectedExecutionException}.
</span><span class="cm">    */</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AbortPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
       <span class="cm">/**
</span><span class="cm">        * Creates an {@code AbortPolicy}.
</span><span class="cm">        */</span>
       <span class="kd">public</span> <span class="nf">AbortPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>

       <span class="cm">/**
</span><span class="cm">        * Always throws RejectedExecutionException.
</span><span class="cm">        *
</span><span class="cm">        * @param r the runnable task requested to be executed
</span><span class="cm">        * @param e the executor attempting to execute this task
</span><span class="cm">        * @throws RejectedExecutionException always.
</span><span class="cm">        */</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">RejectedExecutionException</span><span class="o">(</span><span class="s">&#34;Task &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span>
                                                <span class="s">&#34; rejected from &#34;</span> <span class="o">+</span>
                                                <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
       <span class="o">}</span>
   <span class="o">}</span>

   <span class="cm">/**
</span><span class="cm">    * A handler for rejected tasks that silently discards the
</span><span class="cm">    * rejected task.
</span><span class="cm">    */</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiscardPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
       <span class="cm">/**
</span><span class="cm">        * Creates a {@code DiscardPolicy}.
</span><span class="cm">        */</span>
       <span class="kd">public</span> <span class="nf">DiscardPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>

       <span class="cm">/**
</span><span class="cm">        * Does nothing, which has the effect of discarding task r.
</span><span class="cm">        *
</span><span class="cm">        * @param r the runnable task requested to be executed
</span><span class="cm">        * @param e the executor attempting to execute this task
</span><span class="cm">        */</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="o">}</span>
   <span class="o">}</span>

   <span class="cm">/**
</span><span class="cm">    * A handler for rejected tasks that discards the oldest unhandled
</span><span class="cm">    * request and then retries {@code execute}, unless the executor
</span><span class="cm">    * is shut down, in which case the task is discarded.
</span><span class="cm">    */</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiscardOldestPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
       <span class="cm">/**
</span><span class="cm">        * Creates a {@code DiscardOldestPolicy} for the given executor.
</span><span class="cm">        */</span>
       <span class="kd">public</span> <span class="nf">DiscardOldestPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>

       <span class="cm">/**
</span><span class="cm">        * Obtains and ignores the next task that the executor
</span><span class="cm">        * would otherwise execute, if one is immediately available,
</span><span class="cm">        * and then retries execution of task r, unless the executor
</span><span class="cm">        * is shut down, in which case task r is instead discarded.
</span><span class="cm">        *
</span><span class="cm">        * @param r the runnable task requested to be executed
</span><span class="cm">        * @param e the executor attempting to execute this task
</span><span class="cm">        */</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">e</span><span class="o">.</span><span class="na">getQueue</span><span class="o">().</span><span class="na">poll</span><span class="o">();</span>
               <span class="n">e</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>threadFactory 默认调用 Executors.defaultThreadFactory()
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * The default thread factory
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DefaultThreadFactory</span> <span class="kd">implements</span> <span class="n">ThreadFactory</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">poolNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">1</span><span class="o">);</span> <span class="c1">// 统计连接池数量
</span><span class="c1"></span>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ThreadGroup</span> <span class="n">group</span><span class="o">;</span>  
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">threadNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">1</span><span class="o">);</span> <span class="c1">//线程数量
</span><span class="c1"></span>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">namePrefix</span><span class="o">;</span>
    
        <span class="n">DefaultThreadFactory</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">SecurityManager</span> <span class="n">s</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
            <span class="n">group</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">()</span> <span class="o">:</span>
                                  <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getThreadGroup</span><span class="o">();</span>
            <span class="n">namePrefix</span> <span class="o">=</span> <span class="s">&#34;pool-&#34;</span> <span class="o">+</span>
                          <span class="n">poolNumber</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">+</span>
                         <span class="s">&#34;-thread-&#34;</span><span class="o">;</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="n">Thread</span> <span class="nf">newThread</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span>
                                  <span class="n">namePrefix</span> <span class="o">+</span> <span class="n">threadNumber</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(),</span>
                                  <span class="n">0</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">isDaemon</span><span class="o">())</span>
                <span class="n">t</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getPriority</span><span class="o">()</span> <span class="o">!=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span><span class="o">)</span>
                <span class="n">t</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="2worker-工作线程实现">(2).Worker 工作线程实现</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Class Worker mainly maintains interrupt control state for
</span><span class="cm">     * threads running tasks, along with other minor bookkeeping.
</span><span class="cm">     * This class opportunistically extends AbstractQueuedSynchronizer
</span><span class="cm">     * to simplify acquiring and releasing a lock surrounding each
</span><span class="cm">     * task execution.  This protects against interrupts that are
</span><span class="cm">     * intended to wake up a worker thread waiting for a task from
</span><span class="cm">     * instead interrupting a task being run.  We implement a simple
</span><span class="cm">     * non-reentrant mutual exclusion lock rather than use
</span><span class="cm">     * ReentrantLock because we do not want worker tasks to be able to
</span><span class="cm">     * reacquire the lock when they invoke pool control methods like
</span><span class="cm">     * setCorePoolSize.  Additionally, to suppress interrupts until
</span><span class="cm">     * the thread actually starts running tasks, we initialize lock
</span><span class="cm">     * state to a negative value, and clear it upon start (in
</span><span class="cm">     * runWorker).
</span><span class="cm">     * Class Worker主要维护执行任务的线程的中断控制状态，以及其他小规模的簿记。
</span><span class="cm">     * 该类机会性地扩展AbstractQueuedSynchronizer以简化每个任务执行周围的获取和释放锁。
</span><span class="cm">     * 这可以防止打算唤醒等待任务的工作线程的中断，而不是中断正在运行的任务。
</span><span class="cm">     * 我们实现了一个简单的非重入互斥锁，而不是使用ReentrantLock，
</span><span class="cm">     * 因为我们不希望工作任务在调用像setCorePoolSize这样的池控制方法时能够重新获取锁。
</span><span class="cm">     * 此外，为了抑制中断，直到线程真正开始运行任务，我们将锁定状态初始化为负值，并在启动时（在runWorker中）清除它。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Worker</span>
        <span class="kd">extends</span> <span class="n">AbstractQueuedSynchronizer</span>
        <span class="kd">implements</span> <span class="n">Runnable</span>
    <span class="o">{</span>
        <span class="cm">/**
</span><span class="cm">         * This class will never be serialized, but we provide a
</span><span class="cm">         * serialVersionUID to suppress a javac warning.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">6138294804551838833L</span><span class="o">;</span>

        <span class="cm">/** Thread this worker is running in.  Null if factory fails. */</span>
        <span class="c1">//运行当前worker的线程。只有线程在被创建时才能设置到这个域上，行为类似final域。
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">thread</span><span class="o">;</span>
        <span class="cm">/** Initial task to run.  Possibly null. */</span>
         <span class="c1">//在Worker进入主循环后首先要执行的初始任务，可能为null。
</span><span class="c1"></span>        <span class="n">Runnable</span> <span class="n">firstTask</span><span class="o">;</span>
        <span class="cm">/** Per-thread task counter */</span>
       <span class="c1">// 记录单个线程完成的任务数量，当前worker终止时会累计到线程池中的总完成任务数量上。
</span><span class="c1"></span>        <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">completedTasks</span><span class="o">;</span>

        <span class="cm">/**
</span><span class="cm">         * Creates with given first task and thread from ThreadFactory.
</span><span class="cm">         * @param firstTask the first task (null if none)
</span><span class="cm">         */</span>
        <span class="n">Worker</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">firstTask</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">setState</span><span class="o">(-</span><span class="n">1</span><span class="o">);</span> <span class="c1">// inhibit interrupts until runWorker
</span><span class="c1"></span>            <span class="k">this</span><span class="o">.</span><span class="na">firstTask</span> <span class="o">=</span> <span class="n">firstTask</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="n">getThreadFactory</span><span class="o">().</span><span class="na">newThread</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/** Delegates main run loop to outer runWorker  */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">runWorker</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Lock methods
</span><span class="c1"></span>        <span class="c1">//
</span><span class="c1"></span>        <span class="c1">// The value 0 represents the unlocked state.
</span><span class="c1"></span>        <span class="c1">// The value 1 represents the locked state.
</span><span class="c1"></span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isHeldExclusively</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">getState</span><span class="o">()</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryRelease</span><span class="o">(</span><span class="kt">int</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="n">setState</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span>        <span class="o">{</span> <span class="n">acquire</span><span class="o">(</span><span class="n">1</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">()</span>  <span class="o">{</span> <span class="k">return</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">1</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">()</span>      <span class="o">{</span> <span class="n">release</span><span class="o">(</span><span class="n">1</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isLocked</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">isHeldExclusively</span><span class="o">();</span> <span class="o">}</span>

        <span class="kt">void</span> <span class="nf">interruptIfStarted</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">Thread</span> <span class="n">t</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">getState</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">thread</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">t</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">t</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SecurityException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
    
   <span class="cm">/**
</span><span class="cm">     * Main worker run loop.  Repeatedly gets tasks from queue and
</span><span class="cm">     * executes them, while coping with a number of issues:
</span><span class="cm">     * 主要任务线程运行循环。反复从队列中获取任务并执行它们，同时处理一些问题：
</span><span class="cm">     * 
</span><span class="cm">     * 1. We may start out with an initial task, in which case we
</span><span class="cm">     * don&#39;t need to get the first one. Otherwise, as long as pool is
</span><span class="cm">     * running, we get tasks from getTask. If it returns null then the
</span><span class="cm">     * worker exits due to changed pool state or configuration
</span><span class="cm">     * parameters.  Other exits result from exception throws in
</span><span class="cm">     * external code, in which case completedAbruptly holds, which
</span><span class="cm">     * usually leads processWorkerExit to replace this thread.
</span><span class="cm">     * 我们可能会从最初的任务开始，在这种情况下，我们不需要获得第一个任务。
</span><span class="cm">     * 否则，只要池正在运行，我们就从getTask获得任务。
</span><span class="cm">     * 如果它返回null，则由于更改池状态或配置参数而导致worker退出。
</span><span class="cm">     * 其他退出的结果是在外部代码中抛出的异常，在这种情况下completeAbruptly成立，
</span><span class="cm">     * 这通常会导致processWorkerExit来取代这个线程。
</span><span class="cm">     *
</span><span class="cm">     * 2. Before running any task, the lock is acquired to prevent
</span><span class="cm">     * other pool interrupts while the task is executing, and
</span><span class="cm">     * clearInterruptsForTaskRun called to ensure that unless pool is
</span><span class="cm">     * stopping, this thread does not have its interrupt set.
</span><span class="cm">     * 在运行任何任务之前，获取锁以防止任务执行期间出现其他线程池中断，
</span><span class="cm">     * 并调用clearInterruptsForTaskRun确保除非线程池正在停止，否则此线程没有设置其中断。
</span><span class="cm">     *
</span><span class="cm">     * 3. Each task run is preceded by a call to beforeExecute, which
</span><span class="cm">     * might throw an exception, in which case we cause thread to die
</span><span class="cm">     * (breaking loop with completedAbruptly true) without processing
</span><span class="cm">     * the task.
</span><span class="cm">     * 每个任务运行之前都会调用beforeExecute，这可能会引发一个异常，
</span><span class="cm">     * 在这种情况下，我们会导致线程死亡（断开循环completeAbruptly为true），而不处理任务。
</span><span class="cm">     *
</span><span class="cm">     * 4. Assuming beforeExecute completes normally, we run the task,
</span><span class="cm">     * gathering any of its thrown exceptions to send to
</span><span class="cm">     * afterExecute. We separately handle RuntimeException, Error
</span><span class="cm">     * (both of which the specs guarantee that we trap) and arbitrary
</span><span class="cm">     * Throwables.  Because we cannot rethrow Throwables within
</span><span class="cm">     * Runnable.run, we wrap them within Errors on the way out (to the
</span><span class="cm">     * thread&#39;s UncaughtExceptionHandler).  Any thrown exception also
</span><span class="cm">     * conservatively causes thread to die.
</span><span class="cm">     * 假设beforeExecute正常完成，我们运行任务，收集任何抛出的异常发送到afterExecute。
</span><span class="cm">     * 我们分别处理RuntimeException，Error（这两个规范保证我们陷阱）和任意的Throwables。
</span><span class="cm">     * 因为我们不能在Runnable.run中重新抛出Throwables，所以我们把它们包裹在错误中（到线程的UncaughtExceptionHandler）。
</span><span class="cm">     * 任何抛出的异常也保守地导致线程死亡。
</span><span class="cm">     * 
</span><span class="cm">     * 5. After task.run completes, we call afterExecute, which may
</span><span class="cm">     * also throw an exception, which will also cause thread to
</span><span class="cm">     * die. According to JLS Sec 14.20, this exception is the one that
</span><span class="cm">     * will be in effect even if task.run throws.
</span><span class="cm">     * task.run完成后，我们调用afterExecute，这也可能会抛出一个异常，
</span><span class="cm">     * 这也会导致线程死亡。根据JLS Sec 14.20，即使task.run抛出，这个异常也是有效的。
</span><span class="cm">     * 
</span><span class="cm">     * The net effect of the exception mechanics is that afterExecute
</span><span class="cm">     * and the thread&#39;s UncaughtExceptionHandler have as accurate
</span><span class="cm">     * information as we can provide about any problems encountered by
</span><span class="cm">     * user code.
</span><span class="cm">     * 异常机制的最终效果是afterExecute和线程的UncaughtExceptionHandler拥有关于用户代码遇到的任何问题的准确信息。
</span><span class="cm">     *
</span><span class="cm">     * @param w the worker
</span><span class="cm">     */</span>
    <span class="kd">final</span> <span class="kt">void</span> <span class="nf">runWorker</span><span class="o">(</span><span class="n">Worker</span> <span class="n">w</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Thread</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">firstTask</span><span class="o">;</span>
        <span class="n">w</span><span class="o">.</span><span class="na">firstTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">w</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span> <span class="c1">// allow interrupts
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="n">completedAbruptly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">task</span> <span class="o">=</span> <span class="n">getTask</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">w</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="c1">// If pool is stopping, ensure thread is interrupted;
</span><span class="c1"></span>                <span class="c1">// if not, ensure thread is not interrupted.  This
</span><span class="c1"></span>                <span class="c1">// requires a recheck in second case to deal with
</span><span class="c1"></span>                <span class="c1">// shutdownNow race while clearing interrupt
</span><span class="c1"></span>                <span class="c1">//如果池停止，确保线程被中断;如果没有，确保线程没有被中断。
</span><span class="c1"></span>                <span class="c1">//这需要在第二种情况下进行重新检查，以便在清除中断时处理shutdownNow竞争
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">runStateAtLeast</span><span class="o">(</span><span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">STOP</span><span class="o">)</span> <span class="o">||</span>
                     <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
                      <span class="n">runStateAtLeast</span><span class="o">(</span><span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">STOP</span><span class="o">)))</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="n">wt</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">())</span>
                    <span class="n">wt</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">beforeExecute</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span><span class="c1">//执行前钩子
</span><span class="c1"></span>                    <span class="n">Throwable</span> <span class="n">thrown</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">thrown</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="k">throw</span> <span class="n">x</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Error</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">thrown</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="k">throw</span> <span class="n">x</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">thrown</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">afterExecute</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">thrown</span><span class="o">);</span> <span class="c1">//执行后钩子
</span><span class="c1"></span>                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">completedTasks</span><span class="o">++;</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">completedAbruptly</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">processWorkerExit</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">completedAbruptly</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
 <span class="cm">/**
</span><span class="cm">     * Performs blocking or timed wait for a task, depending on
</span><span class="cm">     * current configuration settings, or returns null if this worker
</span><span class="cm">     * must exit because of any of:
</span><span class="cm">     * 根据当前的配置设置，执行阻塞或定时等待任务，或者如果由于以下任一情况而必须退出，则返回null：
</span><span class="cm">     * 1. There are more than maximumPoolSize workers (due to
</span><span class="cm">     *    a call to setMaximumPoolSize).
</span><span class="cm">     *    有超过maximumPoolSize工作线程（由于调用setMaximumPoolSize）。
</span><span class="cm">     * 2. The pool is stopped.
</span><span class="cm">     *    线程池停止工作
</span><span class="cm">     * 3. The pool is shutdown and the queue is empty.
</span><span class="cm">     *    线程池是关闭的，队列是空的。
</span><span class="cm">     * 4. This worker timed out waiting for a task, and timed-out
</span><span class="cm">     *    workers are subject to termination (that is,
</span><span class="cm">     *    {@code allowCoreThreadTimeOut || workerCount &gt; corePoolSize})
</span><span class="cm">     *    both before and after the timed wait.
</span><span class="cm">     *    此工作者超时等待任务，超时工作线程在定时等待之前和之后都会被终止（即，allowCoreThreadTimeOut || workerCount&gt; corePoolSize}）。
</span><span class="cm">     *
</span><span class="cm">     * @return task, or null if the worker must exit, in which case
</span><span class="cm">     *         workerCount is decremented
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Runnable</span> <span class="nf">getTask</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">timedOut</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// Did the last poll() time out? 做最后一个 poll()超时？
</span><span class="c1"></span><span class="nl">
</span><span class="nl">        retry:</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span><span class="c1">//获取线程池 runState
</span><span class="c1"></span>
            <span class="c1">// Check if queue empty only if necessary.  检查队列是否为空
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&gt;=</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&gt;=</span> <span class="n">STOP</span> <span class="o">||</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">decrementWorkerCount</span><span class="o">();</span> <span class="c1">// ctl 减1
</span><span class="c1"></span>                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kt">boolean</span> <span class="n">timed</span><span class="o">;</span>      <span class="c1">// Are workers subject to culling? 工作线程会被淘汰吗?
</span><span class="c1"></span>
            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">wc</span> <span class="o">=</span> <span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="c1">// 获取线程池中正在运行线程数量
</span><span class="c1"></span>                <span class="n">timed</span> <span class="o">=</span> <span class="n">allowCoreThreadTimeOut</span> <span class="o">||</span> <span class="n">wc</span> <span class="o">&gt;</span> <span class="n">corePoolSize</span><span class="o">;</span> <span class="c1">// allowCoreThreadTimeOut 为false时 大于核心线程数量线程的空闲线程，超出设置keepAliveTime等待超时时间。线程被淘汰
</span><span class="c1"></span>                                                                     <span class="c1">// allowCoreThreadTimeOut 为true时 所有线程，超出设置等待超时时间，线程被淘汰。
</span><span class="c1"></span>
                <span class="k">if</span> <span class="o">(</span><span class="n">wc</span> <span class="o">&lt;=</span> <span class="n">maximumPoolSize</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="o">(</span><span class="n">timedOut</span> <span class="o">&amp;&amp;</span> <span class="n">timed</span><span class="o">))</span> <span class="c1">// 满足这个要求，就要获取任务
</span><span class="c1"></span>                    <span class="k">break</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">compareAndDecrementWorkerCount</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="c1">// 线程要被淘汰 CAS ctl减1 减少线程数量
</span><span class="c1"></span>                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  <span class="c1">// Re-read ctl 重新获取ctl值 在做判断，判断runStateOf 不一致，说明线程池runStateOf被修改，重新循环retry点
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span><span class="o">)</span> 
                    <span class="k">continue</span> <span class="n">retry</span><span class="o">;</span>
                <span class="c1">// else CAS failed due to workerCount change; retry inner loop
</span><span class="c1"></span>            <span class="o">}</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">timed</span> <span class="o">?</span>
                    <span class="n">workQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">)</span> <span class="o">:</span>
                    <span class="n">workQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span> <span class="c1">//获取任务
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
                <span class="n">timedOut</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">retry</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">timedOut</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>    
 
    <span class="cm">/**
</span><span class="cm">     * Performs cleanup and bookkeeping for a dying worker. Called
</span><span class="cm">     * only from worker threads. Unless completedAbruptly is set,
</span><span class="cm">     * assumes that workerCount has already been adjusted to account
</span><span class="cm">     * for exit.  This method removes thread from worker set, and
</span><span class="cm">     * possibly terminates the pool or replaces the worker if either
</span><span class="cm">     * it exited due to user task exception or if fewer than
</span><span class="cm">     * corePoolSize workers are running or queue is non-empty but
</span><span class="cm">     * there are no workers.
</span><span class="cm">     *  工作线程退出处理
</span><span class="cm">     * @param w the worker
</span><span class="cm">     * @param completedAbruptly if the worker died due to user exception
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processWorkerExit</span><span class="o">(</span><span class="n">Worker</span> <span class="n">w</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">completedAbruptly</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">completedAbruptly</span><span class="o">)</span> <span class="c1">// If abrupt, then workerCount wasn&#39;t adjusted
</span><span class="c1"></span>            <span class="n">decrementWorkerCount</span><span class="o">();</span>

        <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
        <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">completedTaskCount</span> <span class="o">+=</span> <span class="n">w</span><span class="o">.</span><span class="na">completedTasks</span><span class="o">;</span>
            <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">w</span><span class="o">);</span><span class="c1">// 工作线程集合删除
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">tryTerminate</span><span class="o">();</span>

        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">runStateLessThan</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">STOP</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">completedAbruptly</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">allowCoreThreadTimeOut</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">corePoolSize</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">min</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span>
                    <span class="n">min</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">min</span><span class="o">)</span>
                    <span class="k">return</span><span class="o">;</span> <span class="c1">// replacement not needed
</span><span class="c1"></span>            <span class="o">}</span>
            <span class="n">addWorker</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="cm">/**
</span><span class="cm">       * Transitions to TERMINATED state if either (SHUTDOWN and pool
</span><span class="cm">       * and queue empty) or (STOP and pool empty).  If otherwise
</span><span class="cm">       * eligible to terminate but workerCount is nonzero, interrupts an
</span><span class="cm">       * idle worker to ensure that shutdown signals propagate. This
</span><span class="cm">       * method must be called following any action that might make
</span><span class="cm">       * termination possible -- reducing worker count or removing tasks
</span><span class="cm">       * from the queue during shutdown. The method is non-private to
</span><span class="cm">       * allow access from ScheduledThreadPoolExecutor.
</span><span class="cm">       * 如果（SHUTDOWN和池和队列为空）或（STOP和池为空）转换到TERMINATED状态。
</span><span class="cm">       * 如果否则有资格终止，但workerCount不为零，将中断一个空闲的工作，以确保关闭信号传播。
</span><span class="cm">       * 必须在执行任何可能会终止的操作之后调用此方法 - 在关闭期间减少工作人员数量或从队列中删除任务。该方法是非专用的，
</span><span class="cm">       * 允许从ScheduledThreadPoolExecutor进行访问。
</span><span class="cm">       */</span>
      <span class="kd">final</span> <span class="kt">void</span> <span class="nf">tryTerminate</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
              <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">||</span>
                  <span class="n">runStateAtLeast</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">TIDYING</span><span class="o">)</span> <span class="o">||</span>
                  <span class="o">(</span><span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">==</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span>
                  <span class="k">return</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Eligible to terminate
</span><span class="c1"></span>                  <span class="n">interruptIdleWorkers</span><span class="o">(</span><span class="n">ONLY_ONE</span><span class="o">);</span>
                  <span class="k">return</span><span class="o">;</span>
              <span class="o">}</span>
  
              <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
              <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
              <span class="k">try</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">ctl</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">ctlOf</span><span class="o">(</span><span class="n">TIDYING</span><span class="o">,</span> <span class="n">0</span><span class="o">)))</span> <span class="o">{</span>
                      <span class="k">try</span> <span class="o">{</span>
                          <span class="n">terminated</span><span class="o">();</span>
                      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                          <span class="n">ctl</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">ctlOf</span><span class="o">(</span><span class="n">TERMINATED</span><span class="o">,</span> <span class="n">0</span><span class="o">));</span>
                          <span class="n">termination</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
                      <span class="o">}</span>
                      <span class="k">return</span><span class="o">;</span>
                  <span class="o">}</span>
              <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                  <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="c1">// else retry on failed CAS
</span><span class="c1"></span>          <span class="o">}</span>
      <span class="o">}</span>
      
 <span class="cm">/**
</span><span class="cm">      * Interrupts threads that might be waiting for tasks (as
</span><span class="cm">      * indicated by not being locked) so they can check for
</span><span class="cm">      * termination or configuration changes. Ignores
</span><span class="cm">      * SecurityExceptions (in which case some threads may remain
</span><span class="cm">      * uninterrupted).
</span><span class="cm">      *
</span><span class="cm">      * @param onlyOne If true, interrupt at most one worker. This is
</span><span class="cm">      * called only from tryTerminate when termination is otherwise
</span><span class="cm">      * enabled but there are still other workers.  In this case, at
</span><span class="cm">      * most one waiting worker is interrupted to propagate shutdown
</span><span class="cm">      * signals in case all threads are currently waiting.
</span><span class="cm">      * Interrupting any arbitrary thread ensures that newly arriving
</span><span class="cm">      * workers since shutdown began will also eventually exit.
</span><span class="cm">      * To guarantee eventual termination, it suffices to always
</span><span class="cm">      * interrupt only one idle worker, but shutdown() interrupts all
</span><span class="cm">      * idle workers so that redundant workers exit promptly, not
</span><span class="cm">      * waiting for a straggler task to finish.
</span><span class="cm">      */</span>
     <span class="kd">private</span> <span class="kt">void</span> <span class="nf">interruptIdleWorkers</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">onlyOne</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
         <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="k">for</span> <span class="o">(</span><span class="n">Worker</span> <span class="n">w</span> <span class="o">:</span> <span class="n">workers</span><span class="o">)</span> <span class="o">{</span>
                 <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">thread</span><span class="o">;</span>
                 <span class="k">if</span> <span class="o">(!</span><span class="n">t</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">.</span><span class="na">tryLock</span><span class="o">())</span> <span class="o">{</span>
                     <span class="k">try</span> <span class="o">{</span>
                         <span class="n">t</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
                     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SecurityException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
                     <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                         <span class="n">w</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                     <span class="o">}</span>
                 <span class="o">}</span>
                 <span class="k">if</span> <span class="o">(</span><span class="n">onlyOne</span><span class="o">)</span>
                     <span class="k">break</span><span class="o">;</span>
             <span class="o">}</span>
         <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
             <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
         <span class="o">}</span>
     <span class="o">}</span>
 
     <span class="cm">/**
</span><span class="cm">      * Common form of interruptIdleWorkers, to avoid having to
</span><span class="cm">      * remember what the boolean argument means.
</span><span class="cm">      */</span>
     <span class="kd">private</span> <span class="kt">void</span> <span class="nf">interruptIdleWorkers</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">interruptIdleWorkers</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
     <span class="o">}</span>
 
     <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ONLY_ONE</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>     
   
</code></pre></td></tr></table>
</div>
</div><h2 id="二-executerunnable-command-执行给定的任务">二 、execute(Runnable command) 执行给定的任务</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">     * Executes the given task sometime in the future.  The task
</span><span class="cm">     * may execute in a new thread or in an existing pooled thread.
</span><span class="cm">     *  在将来执行给定的任务。任务可以在新的线程或现有的池中执行。
</span><span class="cm">     * If the task cannot be submitted for execution, either because this
</span><span class="cm">     * executor has been shutdown or because its capacity has been reached,
</span><span class="cm">     * the task is handled by the current {@code RejectedExecutionHandler}.
</span><span class="cm">     * 如果任务不能被提交执行，或者因为这个执行器已经关闭或者因为它的容量已经到达，
</span><span class="cm">     * 那么任务由当前的RejectedExecutionHandler来处理。
</span><span class="cm">     *
</span><span class="cm">     * @param command the task to execute
</span><span class="cm">     * @throws RejectedExecutionException at discretion of
</span><span class="cm">     *         {@code RejectedExecutionHandler}, if the task
</span><span class="cm">     *         cannot be accepted for execution
</span><span class="cm">     * @throws NullPointerException if {@code command} is null
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
        <span class="cm">/*
</span><span class="cm">         * Proceed in 3 steps:
</span><span class="cm">         *
</span><span class="cm">         * 1. If fewer than corePoolSize threads are running, try to
</span><span class="cm">         * start a new thread with the given command as its first
</span><span class="cm">         * task.  The call to addWorker atomically checks runState and
</span><span class="cm">         * workerCount, and so prevents false alarms that would add
</span><span class="cm">         * threads when it shouldn&#39;t, by returning false.
</span><span class="cm">         *  
</span><span class="cm">         *  如果少于corePoolSize线程正在运行，请尝试使用给定命令启动一个新线程作为其第一个任务。
</span><span class="cm">         *  对addWorker的调用以原子方式检查runState和workerCount，从而防止在不应该的时候通过返回false来添加线程的错误警报。
</span><span class="cm">         *  
</span><span class="cm">         * 2. If a task can be successfully queued, then we still need
</span><span class="cm">         * to double-check whether we should have added a thread
</span><span class="cm">         * (because existing ones died since last checking) or that
</span><span class="cm">         * the pool shut down since entry into this method. So we
</span><span class="cm">         * recheck state and if necessary roll back the enqueuing if
</span><span class="cm">         * stopped, or start a new thread if there are none.
</span><span class="cm">         * 
</span><span class="cm">         *  如果一个任务可以成功排队，那么我们仍然需要仔细检查是否应该添加一个线程（因为现有的线程自上次检查以来已经死掉了）
</span><span class="cm">         *  或者在进入此方法后关闭了这个线程池。所以我们重新检查状态，如果有必要的话，退出排队，如果没有的话，开始一个新的线程。
</span><span class="cm">         *
</span><span class="cm">         * 3. If we cannot queue task, then we try to add a new
</span><span class="cm">         * thread.  If it fails, we know we are shut down or saturated
</span><span class="cm">         * and so reject the task.
</span><span class="cm">         * 
</span><span class="cm">         * 如果我们不能排队任务，那么我们尝试添加一个新的线程。
</span><span class="cm">         * 如果失败，我们知道我们正在关闭或饱和，所以拒绝任务。
</span><span class="cm">         */</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">command</span><span class="o">))</span> <span class="o">{</span><span class="c1">//offer不堵塞，
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">recheck</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span> <span class="n">isRunning</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">remove</span><span class="o">(</span><span class="n">command</span><span class="o">))</span> 
                <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>   <span class="c1">//拒绝任务
</span><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="c1">//分两种情况：1.未设置core线程数；2.设置core线程数，也是设置allowCoreThreadTimeOut为TURE
</span><span class="c1"></span>                <span class="n">addWorker</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>      <span class="c1">//创建工作线程
</span><span class="c1"></span>        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span>
            <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>            <span class="c1">// 拒绝任务
</span><span class="c1"></span>    <span class="o">}</span>
    

   <span class="cm">/**
</span><span class="cm">    * Checks if a new worker can be added with respect to current
</span><span class="cm">    * pool state and the given bound (either core or maximum). If so,
</span><span class="cm">    * the worker count is adjusted accordingly, and, if possible, a
</span><span class="cm">    * new worker is created and started, running firstTask as its
</span><span class="cm">    * first task. This method returns false if the pool is stopped or
</span><span class="cm">    * eligible to shut down. It also returns false if the thread
</span><span class="cm">    * factory fails to create a thread when asked.  If the thread
</span><span class="cm">    * creation fails, either due to the thread factory returning
</span><span class="cm">    * null, or due to an exception (typically OutOfMemoryError in
</span><span class="cm">    * Thread#start), we roll back cleanly.
</span><span class="cm">    * 
</span><span class="cm">    * 检查是否可以根据当前池状态和给定的界限（核心或最大）添加新的工作者。
</span><span class="cm">    * 如果是这样的话，工作线程数量会相应地调整，如果可能的话，创建一个新工作线程并开始运行第一个任务。
</span><span class="cm">    * 如果线程池停止或有资格关闭，则此方法返回false。
</span><span class="cm">    * 如果线程工厂在被询问时未能创建线程，它也返回false。如果线程创建失败，或者由于线程工厂返回null，或者由于异常
</span><span class="cm">    * （通常Thread＃start中的OutOfMemoryError），我们会回滚清楚干净。
</span><span class="cm">    *
</span><span class="cm">    *
</span><span class="cm">    * @param firstTask the task the new thread should run first (or
</span><span class="cm">    * null if none). Workers are created with an initial first task
</span><span class="cm">    * (in method execute()) to bypass queuing when there are fewer
</span><span class="cm">    * than corePoolSize threads (in which case we always start one),
</span><span class="cm">    * or when the queue is full (in which case we must bypass queue).
</span><span class="cm">    * Initially idle threads are usually created via
</span><span class="cm">    * prestartCoreThread or to replace other dying workers.
</span><span class="cm">    *
</span><span class="cm">    * @param core if true use corePoolSize as bound, else
</span><span class="cm">    * maximumPoolSize. (A boolean indicator is used here rather than a
</span><span class="cm">    * value to ensure reads of fresh values after checking other pool
</span><span class="cm">    * state).
</span><span class="cm">    * @return true if successful
</span><span class="cm">    */</span>
   <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">addWorker</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">firstTask</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">core</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">retry</span><span class="o">:</span>
       <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
           <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
           <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>

           <span class="c1">// Check if queue empty only if necessary. 检查队列是否为空。
</span><span class="c1"></span>           <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&gt;=</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span>
               <span class="o">!</span> <span class="o">(</span><span class="n">rs</span> <span class="o">==</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span>
                  <span class="n">firstTask</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                  <span class="o">!</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span>
               <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

           <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
               <span class="kt">int</span> <span class="n">wc</span> <span class="o">=</span> <span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="c1">// 获取工作线程数量
</span><span class="c1"></span>               <span class="k">if</span> <span class="o">(</span><span class="n">wc</span> <span class="o">&gt;=</span> <span class="n">CAPACITY</span> <span class="o">||</span>
                   <span class="n">wc</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="n">core</span> <span class="o">?</span> <span class="n">corePoolSize</span> <span class="o">:</span> <span class="n">maximumPoolSize</span><span class="o">))</span> <span class="c1">//工作线程数量大于最大容量，core为ture 判断核心线程 为false，判断设置最大线程数量
</span><span class="c1"></span>                   <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">compareAndIncrementWorkerCount</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>  <span class="c1">// 添加工作线程数量 CAS 添加成功终止for循环，失败，重新for循环
</span><span class="c1"></span>                   <span class="k">break</span> <span class="n">retry</span><span class="o">;</span>
               <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  <span class="c1">// Re-read ctl 
</span><span class="c1"></span>               <span class="k">if</span> <span class="o">(</span><span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span><span class="o">)</span> <span class="c1">// 判断线程池状态是否更改
</span><span class="c1"></span>                   <span class="k">continue</span> <span class="n">retry</span><span class="o">;</span>
               <span class="c1">// else CAS failed due to workerCount change; retry inner loop
</span><span class="c1"></span>           <span class="o">}</span>
       <span class="o">}</span>

       <span class="kt">boolean</span> <span class="n">workerStarted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
       <span class="kt">boolean</span> <span class="n">workerAdded</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
       <span class="n">Worker</span> <span class="n">w</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
       <span class="k">try</span> <span class="o">{</span>
           <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
           <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">(</span><span class="n">firstTask</span><span class="o">);</span>
           <span class="kd">final</span> <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">thread</span><span class="o">;</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
               <span class="k">try</span> <span class="o">{</span>
                   <span class="c1">// Recheck while holding lock.
</span><span class="c1"></span>                   <span class="c1">// Back out on ThreadFactory failure or if
</span><span class="c1"></span>                   <span class="c1">// shut down before lock acquired.
</span><span class="c1"></span>                   <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                   <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>

                   <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&lt;</span> <span class="n">SHUTDOWN</span> <span class="o">||</span>
                       <span class="o">(</span><span class="n">rs</span> <span class="o">==</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span> <span class="n">firstTask</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                       <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="c1">// precheck that t is startable
</span><span class="c1"></span>                           <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalThreadStateException</span><span class="o">();</span>
                       <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
                       <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                       <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">largestPoolSize</span><span class="o">)</span>
                           <span class="n">largestPoolSize</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                       <span class="n">workerAdded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                   <span class="o">}</span>
               <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                   <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
               <span class="o">}</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">workerAdded</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">//启动线程
</span><span class="c1"></span>                   <span class="n">workerStarted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
               <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(!</span> <span class="n">workerStarted</span><span class="o">)</span> <span class="c1">// 添加失败回滚工作线程创建
</span><span class="c1"></span>               <span class="n">addWorkerFailed</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="n">workerStarted</span><span class="o">;</span>
   <span class="o">}</span>     

   <span class="cm">/**
</span><span class="cm">    * Rolls back the worker thread creation.
</span><span class="cm">    * 回滚工作线程创建。
</span><span class="cm">    * - removes worker from workers, if present
</span><span class="cm">    * - decrements worker count
</span><span class="cm">    * - rechecks for termination, in case the existence of this
</span><span class="cm">    *   worker was holding up termination
</span><span class="cm">    */</span>
   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addWorkerFailed</span><span class="o">(</span><span class="n">Worker</span> <span class="n">w</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
       <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
       <span class="k">try</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
               <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
           <span class="n">decrementWorkerCount</span><span class="o">();</span>
           <span class="n">tryTerminate</span><span class="o">();</span>
       <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
           <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
       <span class="o">}</span>
   <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * Removes this task from the executor&#39;s internal queue if it is
</span><span class="cm">     * present, thus causing it not to be run if it has not already
</span><span class="cm">     * started.
</span><span class="cm">     *
</span><span class="cm">     * &lt;p&gt; This method may be useful as one part of a cancellation
</span><span class="cm">     * scheme.  It may fail to remove tasks that have been converted
</span><span class="cm">     * into other forms before being placed on the internal queue. For
</span><span class="cm">     * example, a task entered using {@code submit} might be
</span><span class="cm">     * converted into a form that maintains {@code Future} status.
</span><span class="cm">     * However, in such cases, method {@link #purge} may be used to
</span><span class="cm">     * remove those Futures that have been cancelled.
</span><span class="cm">     *
</span><span class="cm">     * @param task the task to remove
</span><span class="cm">     * @return true if the task was removed
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">removed</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="n">tryTerminate</span><span class="o">();</span> <span class="c1">// In case SHUTDOWN and now empty
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">removed</span><span class="o">;</span>
    <span class="o">}</span>   
</code></pre></td></tr></table>
</div>
</div><h2 id="三-submit-提交指定的任务">三 、submit 提交指定的任务</h2>
<p>提交任务有三个重载方法</p>
<ul>
<li><!-- raw HTML omitted --> Future<!-- raw HTML omitted --> submit(Runnable task, T result);  提交一个Runnable任务和返回结果，并返回一个Future。</li>
<li>Future&lt;?&gt; submit(Runnable task); 提交一个Runnable任务，并返回一个Future。</li>
<li><!-- raw HTML omitted --> Future<!-- raw HTML omitted --> submit(Callable<!-- raw HTML omitted --> task); 提交一个有返回结果的任务，并返回一个Future。</li>
</ul>
<p>这三个方法AbstractExecutorService抽象类实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="cm">/**
</span><span class="cm">     * @throws RejectedExecutionException {@inheritDoc}
</span><span class="cm">     * @throws NullPointerException       {@inheritDoc}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Future</span><span class="o">&lt;?&gt;</span> <span class="n">submit</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
        <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">ftask</span> <span class="o">=</span> <span class="n">newTaskFor</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">execute</span><span class="o">(</span><span class="n">ftask</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ftask</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * @throws RejectedExecutionException {@inheritDoc}
</span><span class="cm">     * @throws NullPointerException       {@inheritDoc}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">,</span> <span class="n">T</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
        <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ftask</span> <span class="o">=</span> <span class="n">newTaskFor</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="n">execute</span><span class="o">(</span><span class="n">ftask</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ftask</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * @throws RejectedExecutionException {@inheritDoc}
</span><span class="cm">     * @throws NullPointerException       {@inheritDoc}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
        <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ftask</span> <span class="o">=</span> <span class="n">newTaskFor</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="n">execute</span><span class="o">(</span><span class="n">ftask</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ftask</span><span class="o">;</span>
    <span class="o">}</span>
 <span class="cm">/**
</span><span class="cm">     * Returns a &lt;tt&gt;RunnableFuture&lt;/tt&gt; for the given runnable and default
</span><span class="cm">     * value.
</span><span class="cm">     *
</span><span class="cm">     * @param runnable the runnable task being wrapped
</span><span class="cm">     * @param value the default value for the returned future
</span><span class="cm">     * @return a &lt;tt&gt;RunnableFuture&lt;/tt&gt; which when run will run the
</span><span class="cm">     * underlying runnable and which, as a &lt;tt&gt;Future&lt;/tt&gt;, will yield
</span><span class="cm">     * the given value as its result and provide for cancellation of
</span><span class="cm">     * the underlying task.
</span><span class="cm">     * @since 1.6
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">newTaskFor</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">runnable</span><span class="o">,</span> <span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">runnable</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Returns a &lt;tt&gt;RunnableFuture&lt;/tt&gt; for the given callable task.
</span><span class="cm">     *
</span><span class="cm">     * @param callable the callable task being wrapped
</span><span class="cm">     * @return a &lt;tt&gt;RunnableFuture&lt;/tt&gt; which when run will call the
</span><span class="cm">     * underlying callable and which, as a &lt;tt&gt;Future&lt;/tt&gt;, will yield
</span><span class="cm">     * the callable&#39;s result as its result and provide for
</span><span class="cm">     * cancellation of the underlying task.
</span><span class="cm">     * @since 1.6
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">newTaskFor</span><span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">callable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">callable</span><span class="o">);</span>
    <span class="o">}</span>
   
</code></pre></td></tr></table>
</div>
</div><p>最终都是创建FutureTask，执行指定任务。</p>
<h2 id="四-invokeall和invokeany执行批量任务">四 、invokeAll和invokeAny执行批量任务</h2>
<p>invokeAll和invokeAny方法是由AbstractExecutorService抽象类实现</p>
<h3 id="1-invokeall">1. invokeAll</h3>
<ul>
<li><!-- raw HTML omitted --> List&lt;Future<!-- raw HTML omitted -->&gt; invokeAll(Collection&lt;? extends Callable<!-- raw HTML omitted -->&gt; tasks) 执行一批任务，当所有任务都执行完毕后，以Future集合 集合的形式返回结果。</li>
<li><!-- raw HTML omitted --> List&lt;Future<!-- raw HTML omitted -->&gt; invokeAll(Collection&lt;? extends Callable<!-- raw HTML omitted -->&gt; tasks,long timeout, TimeUnit unit) 执行一批任务，当所有任务都执行完毕或者超时，
以Future集合集合的形式返回结果。注意如果超时的话，没有执行完的任务会 被取消。</li>
</ul>
<p>AbstractExecutorService源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">invokeAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tasks</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;(</span><span class="n">tasks</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">:</span> <span class="n">tasks</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//循环处理submit 提交任务
</span><span class="c1"></span>                <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">newTaskFor</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
                <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
                <span class="n">execute</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">f</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="c1">// 一直等待处理
</span><span class="c1"></span>                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancellationException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">futures</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
   <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">invokeAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">,</span>
                                         <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tasks</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">unit</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;(</span><span class="n">tasks</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">:</span> <span class="n">tasks</span><span class="o">)</span>
                <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newTaskFor</span><span class="o">(</span><span class="n">t</span><span class="o">));</span>

            <span class="kt">long</span> <span class="n">lastTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>

            <span class="c1">// Interleave time checks and calls to execute in case
</span><span class="c1"></span>            <span class="c1">// executor doesn&#39;t have any/much parallelism.
</span><span class="c1"></span>            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">execute</span><span class="o">((</span><span class="n">Runnable</span><span class="o">)(</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">()));</span>
                <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="n">nanos</span> <span class="o">-=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">lastTime</span><span class="o">;</span>
                <span class="n">lastTime</span> <span class="o">=</span> <span class="n">now</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">futures</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">for</span> <span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">f</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                        <span class="k">return</span> <span class="n">futures</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">nanos</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span> <span class="c1">//设置超时处理
</span><span class="c1"></span>                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancellationException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">toe</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">futures</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                    <span class="n">nanos</span> <span class="o">-=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">lastTime</span><span class="o">;</span>
                    <span class="n">lastTime</span> <span class="o">=</span> <span class="n">now</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">futures</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><h3 id="2-invokeany">2. invokeAny</h3>
<ul>
<li><!-- raw HTML omitted --> T invokeAny(Collection&lt;? extends Callable<!-- raw HTML omitted -->&gt; tasks)  执行一批任务，如果其中有一个任务完成，就返回结果。 其他没有完成的任务会被取消。</li>
<li><!-- raw HTML omitted --> T invokeAny(Collection&lt;? extends Callable<!-- raw HTML omitted -->&gt; tasks,long timeout, TimeUnit unit) 执行一批任务，如果其中有一个任务完成或者超时，就返回结果。
其他没有完成的任务会被取消。</li>
</ul>
<p>AbstractExecutorService源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">invokeAny</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">doInvokeAny</span><span class="o">(</span><span class="n">tasks</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">cannotHappen</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">invokeAny</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">,</span>
                           <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">doInvokeAny</span><span class="o">(</span><span class="n">tasks</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">));</span>
    <span class="o">}</span>

 <span class="cm">/**
</span><span class="cm">  * the main mechanics of invokeAny.
</span><span class="cm">  */</span>
 <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">doInvokeAny</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">,</span>
                         <span class="kt">boolean</span> <span class="n">timed</span><span class="o">,</span> <span class="kt">long</span> <span class="n">nanos</span><span class="o">)</span>
     <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">tasks</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
     <span class="kt">int</span> <span class="n">ntasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">ntasks</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">();</span>
     <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">futures</span><span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;(</span><span class="n">ntasks</span><span class="o">);</span>
     <span class="n">ExecutorCompletionService</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ecs</span> <span class="o">=</span>
         <span class="k">new</span> <span class="n">ExecutorCompletionService</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">);</span>

     <span class="c1">// For efficiency, especially in executors with limited
</span><span class="c1"></span>     <span class="c1">// parallelism, check to see if previously submitted tasks are
</span><span class="c1"></span>     <span class="c1">// done before submitting more of them. This interleaving
</span><span class="c1"></span>     <span class="c1">// plus the exception mechanics account for messiness of main
</span><span class="c1"></span>     <span class="c1">// loop.
</span><span class="c1"></span>      <span class="c1">// 处于性能考虑，尤其在并行有限的情况下(比如单核处理器)，
</span><span class="c1"></span>     <span class="c1">// 下面的程序会放一个任务到ecs，然后查看这个任务是否完成，
</span><span class="c1"></span>     <span class="c1">// 如果没完成，再放一个。。。(而不是一起放进去)。
</span><span class="c1"></span>     <span class="c1">// 这个过程还会记录异常，如果都没有执行成功，会抛出最后
</span><span class="c1"></span>     <span class="c1">// 记录的异常。最后会把没执行完的任务取消掉。
</span><span class="c1"></span>
     <span class="k">try</span> <span class="o">{</span>
         <span class="c1">// Record exceptions so that if we fail to obtain any
</span><span class="c1"></span>         <span class="c1">// result, we can throw the last exception we got.
</span><span class="c1"></span>         <span class="n">ExecutionException</span> <span class="n">ee</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
         <span class="kt">long</span> <span class="n">lastTime</span> <span class="o">=</span> <span class="n">timed</span> <span class="o">?</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
         <span class="n">Iterator</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>

         <span class="c1">// Start one task for sure; the rest incrementally
</span><span class="c1"></span>         <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ecs</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">()));</span>
         <span class="o">--</span><span class="n">ntasks</span><span class="o">;</span>
         <span class="kt">int</span> <span class="n">active</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>

         <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
             <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">if</span> <span class="o">(</span><span class="n">ntasks</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                     <span class="o">--</span><span class="n">ntasks</span><span class="o">;</span>
                     <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ecs</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">()));</span>
                     <span class="o">++</span><span class="n">active</span><span class="o">;</span>
                 <span class="o">}</span>
                 <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">active</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
                     <span class="k">break</span><span class="o">;</span>
                 <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">timed</span><span class="o">)</span> <span class="o">{</span>
                     <span class="n">f</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">nanos</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>
                     <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                         <span class="k">throw</span> <span class="k">new</span> <span class="n">TimeoutException</span><span class="o">();</span>
                     <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                     <span class="n">nanos</span> <span class="o">-=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">lastTime</span><span class="o">;</span>
                     <span class="n">lastTime</span> <span class="o">=</span> <span class="n">now</span><span class="o">;</span>
                 <span class="o">}</span>
                 <span class="k">else</span>
                     <span class="n">f</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
             <span class="o">}</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="o">--</span><span class="n">active</span><span class="o">;</span>
                 <span class="k">try</span> <span class="o">{</span>
                     <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                 <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">eex</span><span class="o">)</span> <span class="o">{</span>
                     <span class="n">ee</span> <span class="o">=</span> <span class="n">eex</span><span class="o">;</span>
                 <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">rex</span><span class="o">)</span> <span class="o">{</span>
                     <span class="n">ee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExecutionException</span><span class="o">(</span><span class="n">rex</span><span class="o">);</span>
                 <span class="o">}</span>
             <span class="o">}</span>
         <span class="o">}</span>

         <span class="k">if</span> <span class="o">(</span><span class="n">ee</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
             <span class="n">ee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExecutionException</span><span class="o">();</span>
         <span class="k">throw</span> <span class="n">ee</span><span class="o">;</span>

     <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
         <span class="k">for</span> <span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span>
             <span class="n">f</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
     <span class="o">}</span>
 <span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><h2 id="停止任务-shutdown和shutdownnow">停止任务 shutdown和shutdownNow</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Initiates an orderly shutdown in which previously submitted
</span><span class="cm">     * tasks are executed, but no new tasks will be accepted.
</span><span class="cm">     * Invocation has no additional effect if already shut down.
</span><span class="cm">     *  启动先前提交的任务被执行的有序关闭，但不接受新的任务。如果已关闭，则调用没有其他影响。
</span><span class="cm">     * &lt;p&gt;This method does not wait for previously submitted tasks to
</span><span class="cm">     * complete execution.  Use {@link #awaitTermination awaitTermination}
</span><span class="cm">     * to do that.
</span><span class="cm">     *
</span><span class="cm">     * @throws SecurityException {@inheritDoc}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
        <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">checkShutdownAccess</span><span class="o">();</span>
            <span class="n">advanceRunState</span><span class="o">(</span><span class="n">SHUTDOWN</span><span class="o">);</span>
            <span class="n">interruptIdleWorkers</span><span class="o">();</span>
            <span class="n">onShutdown</span><span class="o">();</span> <span class="c1">// hook for ScheduledThreadPoolExecutor onShutdown钩子
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">tryTerminate</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * If there is a security manager, makes sure caller has
</span><span class="cm">     * permission to shut down threads in general (see shutdownPerm).
</span><span class="cm">     * If this passes, additionally makes sure the caller is allowed
</span><span class="cm">     * to interrupt each worker thread. This might not be true even if
</span><span class="cm">     * first check passed, if the SecurityManager treats some threads
</span><span class="cm">     * specially.
</span><span class="cm">     * 如果有安全管理器，请确保调用者有权关闭一般的线程（请参阅shutdownPerm）。
</span><span class="cm">     * 如果通过，另外确保调用者被允许中断每个工作者线程。即使第一次检查通过，这可能不是真的，如果SecurityManager专门处理一些线程。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkShutdownAccess</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">SecurityManager</span> <span class="n">security</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">security</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span><span class="n">shutdownPerm</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
            <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Worker</span> <span class="n">w</span> <span class="o">:</span> <span class="n">workers</span><span class="o">)</span>
                    <span class="n">security</span><span class="o">.</span><span class="na">checkAccess</span><span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">thread</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * Transitions runState to given target, or leaves it alone if
</span><span class="cm">     * already at least the given target.
</span><span class="cm">     *
</span><span class="cm">     * @param targetState the desired state, either SHUTDOWN or STOP
</span><span class="cm">     *        (but not TIDYING or TERMINATED -- use tryTerminate for that)
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">advanceRunState</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetState</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">runStateAtLeast</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">targetState</span><span class="o">)</span> <span class="o">||</span>
                <span class="n">ctl</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">ctlOf</span><span class="o">(</span><span class="n">targetState</span><span class="o">,</span> <span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">))))</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Attempts to stop all actively executing tasks, halts the
</span><span class="cm">     * processing of waiting tasks, and returns a list of the tasks
</span><span class="cm">     * that were awaiting execution. These tasks are drained (removed)
</span><span class="cm">     * from the task queue upon return from this method.
</span><span class="cm">     * 尝试停止所有正在执行的任务，停止等待任务的处理，并返回正在等待执行的任务的列表。从这个方法返回后，这些任务从任务队列中排出（移除）。
</span><span class="cm">     * &lt;p&gt;This method does not wait for actively executing tasks to
</span><span class="cm">     * terminate.  Use {@link #awaitTermination awaitTermination} to
</span><span class="cm">     * do that.
</span><span class="cm">     *
</span><span class="cm">     * &lt;p&gt;There are no guarantees beyond best-effort attempts to stop
</span><span class="cm">     * processing actively executing tasks.  This implementation
</span><span class="cm">     * cancels tasks via {@link Thread#interrupt}, so any task that
</span><span class="cm">     * fails to respond to interrupts may never terminate.
</span><span class="cm">     *
</span><span class="cm">     * @throws SecurityException {@inheritDoc}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="nf">shutdownNow</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">tasks</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
        <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">checkShutdownAccess</span><span class="o">();</span>
            <span class="n">advanceRunState</span><span class="o">(</span><span class="n">STOP</span><span class="o">);</span>
            <span class="n">interruptWorkers</span><span class="o">();</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">drainQueue</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">tryTerminate</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">tasks</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="cm">/**
</span><span class="cm">     * Interrupts all threads, even if active. Ignores SecurityExceptions
</span><span class="cm">     * (in which case some threads may remain uninterrupted).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">interruptWorkers</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
        <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Worker</span> <span class="n">w</span> <span class="o">:</span> <span class="n">workers</span><span class="o">)</span>
                <span class="n">w</span><span class="o">.</span><span class="na">interruptIfStarted</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>    
    <span class="cm">/**
</span><span class="cm">     * Drains the task queue into a new list, normally using
</span><span class="cm">     * drainTo. But if the queue is a DelayQueue or any other kind of
</span><span class="cm">     * queue for which poll or drainTo may fail to remove some
</span><span class="cm">     * elements, it deletes them one by one.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="nf">drainQueue</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">;</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">taskList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;();</span>
        <span class="n">q</span><span class="o">.</span><span class="na">drainTo</span><span class="o">(</span><span class="n">taskList</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">q</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span> <span class="o">:</span> <span class="n">q</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">[</span><span class="n">0</span><span class="o">]))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">r</span><span class="o">))</span>
                    <span class="n">taskList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">taskList</span><span class="o">;</span>
    <span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div>
  </div>

  <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">BirdGod</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2017-04-20 20:11
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/birdgodtech/blog/master/LICENSE">MIT</a></span>
  </p>
</div>
<footer class="post-footer">
    <div class="post-tags">
      <a href="/tags/ThreadPoolExecutor/">ThreadPoolExecutor</a>
      </div>
    <nav class="post-nav" style="height: 27px">
      <a class="prev" href="/post/concurrent/14.ScheduledThreadPoolExecutor%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">ThreadPoolExecutor</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
      <a class="next" href="/post/concurrent/12.FutureTask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
        <span class="next-text nav-default">FutureTask</span>
        <span class="next-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav>
  </footer>
  <script src="https://utteranc.es/client.js"
          repo="birdgodtech/birdgodtech.github.io"
          issue-term="pathname"
          theme="github-light"
          crossorigin="anonymous"
          async>
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterance.</a></noscript>
</article>
            </div>
            

        </div>
    </main>

    <footer id="footer" class="footer">
        <div class="social-links">
  <a href="mailto:birdgodtech@163.com" class="iconfont icon-email" title="email" rel="noopener" target="_blank" data-title="email"> </a>
  <a href="https://github.com/birdgodtech" class="iconfont icon-github" title="github" rel="noopener" target="_blank" data-title="github"> </a>
  <a href="https://birdgodtech.github.io/index.xml" type="application/rss+xml" rel="noopener" target="_blank" class="iconfont icon-rss" title="rss"></a>


</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy;
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">BirdGod</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.47f727f4.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-84813914-2', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
