<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ForkJoin1.8 模式分析 - BirdGod 技术分享</title>
    <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="BirdGod" /><meta name="description" content="ForkJoin模式分析 简介 Fork/Join框架介绍不错博客，阿里方腾飞写 Fork/Join使用两个类来完成以上两件事情： ForkJoin" /><meta name="keywords" content="Java" />






<meta name="generator" content="Hugo 0.74.0-DEV with even 4.0.0" />


<link rel="canonical" href="https://birdgodtech.github.io/post/concurrent/jdk1.8/ForkJoin1.8%E6%A8%A1%E5%BC%8F%E5%88%86%E6%9E%90/" />
<link href="/post/concurrent/jdk1.8/ForkJoin1.8%E6%A8%A1%E5%BC%8F%E5%88%86%E6%9E%90/" rel="alternate" type="application/rss+xml" title="BirdGod 技术分享" />
<link href="/post/concurrent/jdk1.8/ForkJoin1.8%E6%A8%A1%E5%BC%8F%E5%88%86%E6%9E%90/" rel="feed" type="application/rss+xml" title="BirdGod 技术分享" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.06658218.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/reset-even.css">


<meta property="og:title" content="ForkJoin1.8 模式分析" />
<meta property="og:description" content="ForkJoin模式分析 简介 Fork/Join框架介绍不错博客，阿里方腾飞写 Fork/Join使用两个类来完成以上两件事情： ForkJoin" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://birdgodtech.github.io/post/concurrent/jdk1.8/ForkJoin1.8%E6%A8%A1%E5%BC%8F%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2018-08-20T18:18:08+00:00" />
<meta property="article:modified_time" content="2018-08-20T18:18:08+00:00" />
<meta itemprop="name" content="ForkJoin1.8 模式分析">
<meta itemprop="description" content="ForkJoin模式分析 简介 Fork/Join框架介绍不错博客，阿里方腾飞写 Fork/Join使用两个类来完成以上两件事情： ForkJoin">
<meta itemprop="datePublished" content="2018-08-20T18:18:08&#43;00:00" />
<meta itemprop="dateModified" content="2018-08-20T18:18:08&#43;00:00" />
<meta itemprop="wordCount" content="26294">



<meta itemprop="keywords" content="disruptor," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ForkJoin1.8 模式分析"/>
<meta name="twitter:description" content="ForkJoin模式分析 简介 Fork/Join框架介绍不错博客，阿里方腾飞写 Fork/Join使用两个类来完成以上两件事情： ForkJoin"/>

</head>
<body>
<div id="mobile-navbar" class="mobile-navbar">
    <div class="mobile-header-logo">
        <a href="/" class="logo">BirdGod 技术分享</a>
    </div>
    <div class="mobile-navbar-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
    <ul class="mobile-menu-list">
        <a href="/">
            <li class="mobile-menu-item" title="首页">首页</li>
        </a>
        <a href="/post/">
            <li class="mobile-menu-item" title="归档">归档</li>
        </a>
        <a href="/categories/">
            <li class="mobile-menu-item" title="分类">分类</li>
        </a>
        <a href="/tags/">
            <li class="mobile-menu-item" title="标签">标签</li>
        </a>
        <a href="/about/">
            <li class="mobile-menu-item" title="关于我">关于我</li>
        </a>
        
    </ul>
</nav>

<div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
    <a href="/" class="logo">BirdGod 技术分享</a>
</div>

<nav class="site-navbar">
    <ul id="menu" class="menu" data-sum="0">
        
        <li class="menu-item menu-item-home">
            <a class="menu-item-link" href="/" title="首页">首页</a>
        </li>
        
        <li class="menu-item menu-item-archives">
            <a class="menu-item-link" href="/post/" title="归档">归档</a>
        </li>
        
        <li class="menu-item menu-item-categories">
            <a class="menu-item-link" href="/categories/" title="分类">分类</a>
        </li>
        
        <li class="menu-item menu-item-tags">
            <a class="menu-item-link" href="/tags/" title="标签">标签</a>
        </li>
        
        <li class="menu-item menu-item-about">
            <a class="menu-item-link" href="/about/" title="关于我">关于我</a>
        </li>
        
    </ul>
</nav>

    </header>


    <main id="main" class="main">
        <div class="content-wrapper">
            <div id="content" class="content">
                <article class="post">
  
  <header class="post-header">
    <h1 class="post-title">ForkJoin1.8 模式分析</h1>

    <div class="post-meta">
      <span class="post-time"> 2018-08-20 18:18 </span>
      <div class="post-category">
        <a href="/categories/%E5%B9%B6%E5%8F%91/"> 并发 </a>
        </div>
      <span class="more-meta"> 约 26294 字 </span>
      <span class="more-meta"> 预计阅读 53 分钟 </span>
      <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
    </div>
  </header>

  <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#一forkjoinpool概述">一、ForkJoinPool概述</a></li>
    <li><a href="#二workqueue分析">二、WorkQueue分析</a>
      <ul>
        <li><a href="#1workqueue构造">1.WorkQueue构造</a></li>
        <li><a href="#2push-添加任务">2.push 添加任务</a></li>
        <li><a href="#3growarray-扩容">3.growArray 扩容</a></li>
        <li><a href="#4pop-lifo">4.pop LIFO</a></li>
        <li><a href="#5poll-fifo">5.poll FIFO</a></li>
        <li><a href="#6runtask-执行窃取任务在执行本地线程中任务">6.runTask 执行窃取任务，在执行本地线程中任务</a></li>
        <li><a href="#7tryremoveandexec">7.tryRemoveAndExec</a></li>
      </ul>
    </li>
    <li><a href="#三forkjoinpool">三、ForkJoinPool</a>
      <ul>
        <li><a href="#1forkjoinpoolsh构造">1.ForkJoinPoolsh构造</a></li>
        <li><a href="#2runstate">2.runState</a></li>
        <li><a href="#3submit-提交任务">3.submit 提交任务</a></li>
        <li><a href="#4signalwork-唤醒工作线程">4.signalWork 唤醒工作线程</a></li>
        <li><a href="#5tryaddworker-创建工作线程">5.tryAddWorker 创建工作线程</a></li>
        <li><a href="#6deregisterworker-注销workqueue数组">6.deregisterWorker 注销WorkQueue数组</a></li>
        <li><a href="#7registerworker-注册workqueue数组">7.registerWorker 注册WorkQueue数组</a></li>
        <li><a href="#8runworker-执行工作线程">8.runWorker 执行工作线程</a></li>
        <li><a href="#9scan-扫描任务">9.scan 扫描任务</a></li>
        <li><a href="#10awaitwork-无任务等待">10.awaitWork 无任务等待</a></li>
        <li><a href="#11awaitjoin-join操作">11.awaitJoin join操作</a></li>
        <li><a href="#12shutdown">12.shutdown</a></li>
      </ul>
    </li>
    <li><a href="#四forkjoinworkerthread线程">四、ForkJoinWorkerThread线程</a>
      <ul>
        <li><a href="#1构造">1.构造</a></li>
        <li><a href="#2run">2.run</a></li>
      </ul>
    </li>
    <li><a href="#五forkjointask源码分析">五、ForkJoinTask源码分析</a>
      <ul>
        <li><a href="#1forkjointask构造">1.ForkJoinTask构造</a></li>
        <li><a href="#2-exceptionnode-异常节点">2. ExceptionNode 异常节点</a></li>
        <li><a href="#3-doexec-执行">3. doExec 执行</a></li>
        <li><a href="#4-setexceptionalcompletion-异常处理">4. setExceptionalCompletion 异常处理</a></li>
        <li><a href="#5-fork">5. fork</a></li>
        <li><a href="#6-join">6. join</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="hint">
      <p>【注意】最后更新于 <span class="timeago" datetime="2018-08-20T18:18:08" title="August 20, 2018">August 20, 2018</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
  <div class="post-content">
    <h1 id="forkjoin模式分析">ForkJoin模式分析</h1>
<h2 id="简介">简介</h2>
<p><a href="http://www.infoq.cn/articles/fork-join-introduction">Fork/Join框架介绍</a>不错博客，阿里<strong>方腾飞</strong>写</p>
<p>Fork/Join使用两个类来完成以上两件事情：</p>
<ul>
<li>
<p>ForkJoinTask：我们要使用ForkJoin框架，必须首先创建一个ForkJoin任务。它提供在任务中执行fork()和join()操作的机制，
通常情况下我们不需要直接继承ForkJoinTask类，而只需要继承它的子类，Fork/Join框架提供了以下两个子类：</p>
<ul>
<li>RecursiveAction：用于没有返回结果的任务。</li>
<li>RecursiveTask ：用于有返回结果的任务。</li>
</ul>
</li>
<li>
<p>ForkJoinPool ：ForkJoinTask需要通过ForkJoinPool来执行，任务分割出的子任务会添加到当前工作线程所维护的双端队列中，
进入队列的头部。当一个工作线程的队列里暂时没有任务时，它会随机从其他工作线程的队列的尾部获取一个任务。</p>
</li>
</ul>
<h2 id="一forkjoinpool概述">一、ForkJoinPool概述</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/*
</span><span class="cm">     * Implementation Overview
</span><span class="cm">     *
</span><span class="cm">     * This class and its nested classes provide the main
</span><span class="cm">     * functionality and control for a set of worker threads:
</span><span class="cm">     * Submissions from non-FJ threads enter into submission queues.
</span><span class="cm">     * Workers take these tasks and typically split them into subtasks
</span><span class="cm">     * that may be stolen by other workers.  Preference rules give
</span><span class="cm">     * first priority to processing tasks from their own queues (LIFO
</span><span class="cm">     * or FIFO, depending on mode), then to randomized FIFO steals of
</span><span class="cm">     * tasks in other queues.  This framework began as vehicle for
</span><span class="cm">     * supporting tree-structured parallelism using work-stealing.
</span><span class="cm">     * Over time, its scalability advantages led to extensions and
</span><span class="cm">     * changes to better support more diverse usage contexts.  Because
</span><span class="cm">     * most internal methods and nested classes are interrelated,
</span><span class="cm">     * their main rationale and descriptions are presented here;
</span><span class="cm">     * individual methods and nested classes contain only brief
</span><span class="cm">     * comments about details.
</span><span class="cm">     * 该类及其嵌套类为一组工作线程提供主要功能和控制：来自non-FJ线程的提交进入提交队列。工人们承担这些任务，
</span><span class="cm">     * 通常将他们分解成可能被其他工人窃取的子任务。优先规则优先处理来自其自己的队列（LIFO或FIFO，取决于模式）的任务，
</span><span class="cm">     * 然后是其他队列中任务的随机FIFO窃取。这个框架开始作为支持使用工作窃取的树形结构并行的工具。
</span><span class="cm">     * 随着时间的推移，其可扩展性的优势导致扩展和变化，以更好地支持更多不同的使用情况。因为大多数内部方法和嵌套类是相互关联的，
</span><span class="cm">     * 所以它们的主要基本原理和描述在这里给出;个别方法和嵌套类只包含关于细节的简短评论。
</span><span class="cm">     *
</span><span class="cm">     * WorkQueues 工作队列
</span><span class="cm">     * ==========
</span><span class="cm">     *
</span><span class="cm">     * Most operations occur within work-stealing queues (in nested
</span><span class="cm">     * class WorkQueue).  These are special forms of Deques that
</span><span class="cm">     * support only three of the four possible end-operations -- push,
</span><span class="cm">     * pop, and poll (aka steal), under the further constraints that
</span><span class="cm">     * push and pop are called only from the owning thread (or, as
</span><span class="cm">     * extended here, under a lock), while poll may be called from
</span><span class="cm">     * other threads.  (If you are unfamiliar with them, you probably
</span><span class="cm">     * want to read Herlihy and Shavit&#39;s book &#34;The Art of
</span><span class="cm">     * Multiprocessor programming&#34;, chapter 16 describing these in
</span><span class="cm">     * more detail before proceeding.)  The main work-stealing queue
</span><span class="cm">     * design is roughly similar to those in the papers &#34;Dynamic
</span><span class="cm">     * Circular Work-Stealing Deque&#34; by Chase and Lev, SPAA 2005
</span><span class="cm">     * (http://research.sun.com/scalable/pubs/index.html) and
</span><span class="cm">     * &#34;Idempotent work stealing&#34; by Michael, Saraswat, and Vechev,
</span><span class="cm">     * PPoPP 2009 (http://portal.acm.org/citation.cfm?id=1504186).
</span><span class="cm">     * The main differences ultimately stem from GC requirements that
</span><span class="cm">     * we null out taken slots as soon as we can, to maintain as small
</span><span class="cm">     * a footprint as possible even in programs generating huge
</span><span class="cm">     * numbers of tasks. To accomplish this, we shift the CAS
</span><span class="cm">     * arbitrating pop vs poll (steal) from being on the indices
</span><span class="cm">     * (&#34;base&#34; and &#34;top&#34;) to the slots themselves.
</span><span class="cm">     * 
</span><span class="cm">     * 大多数操作发生在工作窃取队列中（在嵌套的类WorkQueue中）。
</span><span class="cm">     * 这些是Deques的特殊形式，它只支持四种可能的最终操作中的三种 - push，pop和poll（又名steal），
</span><span class="cm">     * 在进一步的约束条件下push和pop只能从拥有的线程中调用（或者像扩展这里，在一个锁）下，而轮询可能会从其他线程调用。 
</span><span class="cm">     * （如果你不熟悉它们，你可能要阅读Herlihy和Shavit的书&#34;多处理器编程的艺术&#34;，第16章在进行更详细的描述之前）。
</span><span class="cm">     * 主要的工作队列设计大致类似于Chase和Lev撰写的&#34;Dynamic Circular Work-Stealing Deque&#34;，SPAA 2005（http://research.sun.com/scalable/pubs/index.html）
</span><span class="cm">     * 和Michael，Saraswat和Vechev的&#34;幂等工作窃取&#34;PPoPP 2009（http://portal.acm.org/citation.cfm?id=1504186）。
</span><span class="cm">     * 主要的差异最终来自GC的要求，我们尽可能地将其空缺，尽可能保持尽可能小的占用空间，即使在产生大量任务的程序中也是如此。
</span><span class="cm">     * 为了实现这一点，我们将CAS仲裁pop与poll（steal）从指标（&#34;base&#34;和&#34;top&#34;）转移到角色本身。
</span><span class="cm">     *
</span><span class="cm">     * Adding tasks then takes the form of a classic array push(task): 然后添加任务，然后采取经典数组push(task)的形式:
</span><span class="cm">     *    q.array[q.top] = task; ++q.top;
</span><span class="cm">     *
</span><span class="cm">     * (The actual code needs to null-check and size-check the array,
</span><span class="cm">     * properly fence the accesses, and possibly signal waiting
</span><span class="cm">     * workers to start scanning -- see below.)  Both a successful pop
</span><span class="cm">     * and poll mainly entail a CAS of a slot from non-null to null.
</span><span class="cm">     * （实际的代码需要对数组进行空值检查和大小检查，对访问进行适当的隔离，并可能发出信号等待工作人员开始扫描 - 见下文）。
</span><span class="cm">     *  成功的pop和poll主要是由 non-null 到null的槽的CAS.
</span><span class="cm">     *
</span><span class="cm">     * The pop operation (always performed by owner) is:
</span><span class="cm">     *   if ((base != top) and
</span><span class="cm">     *        (the task at top slot is not null) and
</span><span class="cm">     *        (CAS slot to null))
</span><span class="cm">     *           decrement top and return task;
</span><span class="cm">     *
</span><span class="cm">     * And the poll operation (usually by a stealer) is
</span><span class="cm">     *    if ((base != top) and
</span><span class="cm">     *        (the task at base slot is not null) and
</span><span class="cm">     *        (base has not changed) and
</span><span class="cm">     *        (CAS slot to null))
</span><span class="cm">     *           increment base and return task;
</span><span class="cm">     *
</span><span class="cm">     * Because we rely on CASes of references, we do not need tag bits
</span><span class="cm">     * on base or top.  They are simple ints as used in any circular
</span><span class="cm">     * array-based queue (see for example ArrayDeque).  Updates to the
</span><span class="cm">     * indices guarantee that top == base means the queue is empty,
</span><span class="cm">     * but otherwise may err on the side of possibly making the queue
</span><span class="cm">     * appear nonempty when a push, pop, or poll have not fully
</span><span class="cm">     * committed. (Method isEmpty() checks the case of a partially
</span><span class="cm">     * completed removal of the last element.)  Because of this, the
</span><span class="cm">     * poll operation, considered individually, is not wait-free. One
</span><span class="cm">     * thief cannot successfully continue until another in-progress
</span><span class="cm">     * one (or, if previously empty, a push) completes.  However, in
</span><span class="cm">     * the aggregate, we ensure at least probabilistic
</span><span class="cm">     * non-blockingness.  If an attempted steal fails, a thief always
</span><span class="cm">     * chooses a different random victim target to try next. So, in
</span><span class="cm">     * order for one thief to progress, it suffices for any
</span><span class="cm">     * in-progress poll or new push on any empty queue to
</span><span class="cm">     * complete. (This is why we normally use method pollAt and its
</span><span class="cm">     * variants that try once at the apparent base index, else
</span><span class="cm">     * consider alternative actions, rather than method poll, which
</span><span class="cm">     * retries.)
</span><span class="cm">     * 
</span><span class="cm">     * 因为我们依赖引用的CASes，所以我们不需要在底部或顶部标记位。它们是用于任何基于循环数组的队列中的简单整数（参见例如ArrayDeque）。
</span><span class="cm">     * 对索引的更新保证top == base意味着队列是空的，但是否则可能会在push，pop或poll未完全提交时可能使队列显示为非空。 
</span><span class="cm">     * （方法isEmpty（）检查部分完成删除最后一个元素的情况。）因此，单独考虑的poll操作不是等待的。
</span><span class="cm">     * 一个小偷不能成功地继续下去，直到另一个小偷（或者，如果先前是空的，推）完成。但总的来说，我们至少保证概率性的非阻塞性。
</span><span class="cm">     * 如果一次偷窃失败，一个小偷总是选择一个不同的随机受害者目标来尝试下一个。
</span><span class="cm">     * 所以，为了让一个小偷进步，只要有任何进行中的poll或者任何空队列的新push就足够了。 
</span><span class="cm">     * （这就是为什么我们通常使用方法pollAt及其在变量基础上尝试一次的方法，否则考虑替代操作，而不是方法poll，重试。)
</span><span class="cm">     *
</span><span class="cm">     * This approach also enables support of a user mode in which
</span><span class="cm">     * local task processing is in FIFO, not LIFO order, simply by
</span><span class="cm">     * using poll rather than pop.  This can be useful in
</span><span class="cm">     * message-passing frameworks in which tasks are never joined.
</span><span class="cm">     * However neither mode considers affinities, loads, cache
</span><span class="cm">     * localities, etc, so rarely provide the best possible
</span><span class="cm">     * performance on a given machine, but portably provide good
</span><span class="cm">     * throughput by averaging over these factors.  Further, even if
</span><span class="cm">     * we did try to use such information, we do not usually have a
</span><span class="cm">     * basis for exploiting it.  For example, some sets of tasks
</span><span class="cm">     * profit from cache affinities, but others are harmed by cache
</span><span class="cm">     * pollution effects. Additionally, even though it requires
</span><span class="cm">     * scanning, long-term throughput is often best using random
</span><span class="cm">     * selection rather than directed selection policies, so cheap
</span><span class="cm">     * randomization of sufficient quality is used whenever
</span><span class="cm">     * applicable.  Various Marsaglia XorShifts (some with different
</span><span class="cm">     * shift constants) are inlined at use points.
</span><span class="cm">     * 这种方法还支持用本地任务处理在FIFO中而不是LIFO顺序的用户模式，只需使用poll而不是pop。
</span><span class="cm">     * 这在消息传递框架中是非常有用的，在这个框架中任务永远不会被加入。
</span><span class="cm">     * 然而，这两种模式都不考虑亲和性，负载，缓存区域等，因此很少在给定的机器上提供最好的性能，
</span><span class="cm">     * 但是通过对这些因素进行平均，可移植性提供了良好的吞吐量。
</span><span class="cm">     * 此外，即使我们试图使用这些信息，我们通常也没有发现它的依据。
</span><span class="cm">     * 例如，一些任务集合从缓存关系中获益，而另外一些则受到缓存污染影响的伤害。
</span><span class="cm">     * 另外，即使需要扫描，长期吞吐量通常也是使用随机选择而不是定向选择策略的最佳选择，
</span><span class="cm">     * 所以在适用的情况下使用足够质量的廉价随机化。各种Marsaglia XorShifts（一些具有不同的移位常数）在使用点内联。
</span><span class="cm">     *
</span><span class="cm">     * WorkQueues are also used in a similar way for tasks submitted
</span><span class="cm">     * to the pool. We cannot mix these tasks in the same queues used
</span><span class="cm">     * by workers. Instead, we randomly associate submission queues
</span><span class="cm">     * with submitting threads, using a form of hashing.  The
</span><span class="cm">     * ThreadLocalRandom probe value serves as a hash code for
</span><span class="cm">     * choosing existing queues, and may be randomly repositioned upon
</span><span class="cm">     * contention with other submitters.  In essence, submitters act
</span><span class="cm">     * like workers except that they are restricted to executing local
</span><span class="cm">     * tasks that they submitted (or in the case of CountedCompleters,
</span><span class="cm">     * others with the same root task).  Insertion of tasks in shared
</span><span class="cm">     * mode requires a lock (mainly to protect in the case of
</span><span class="cm">     * resizing) but we use only a simple spinlock (using field
</span><span class="cm">     * qlock), because submitters encountering a busy queue move on to
</span><span class="cm">     * try or create other queues -- they block only when creating and
</span><span class="cm">     * registering new queues. Additionally, &#34;qlock&#34; saturates to an
</span><span class="cm">     * unlockable value (-1) at shutdown. Unlocking still can be and
</span><span class="cm">     * is performed by cheaper ordered writes of &#34;qlock&#34; in successful
</span><span class="cm">     * cases, but uses CAS in unsuccessful cases.
</span><span class="cm">     * 
</span><span class="cm">     * WorkQueues也以类似的方式用于提交给池的任务。我们不能把这些任务混合在工人使用的同一个队列中。
</span><span class="cm">     * 相反，我们使用散列形式将提交队列与提交线程随机关联。
</span><span class="cm">      * ThreadLocalRandom探测值用作选择现有队列的哈希代码，并且可以在与其他提交者竞争时随机地重新定位。
</span><span class="cm">      * 实质上，提交者的行为与工作者相似，只是他们被限制为执行他们提交的本地任务（或者在CountedCompleters的情况下，其他人则具有相同的根任务）。
</span><span class="cm">      * 在共享模式下插入任务需要一个锁（主要是为了保护在调整大小的情况下），
</span><span class="cm">      * 但是我们只使用一个简单的自旋锁（使用字段qlock），因为提交者遇到一个忙碌的队列后继续尝试或创建其他队列 - 只有在创建和注册新的队列时
</span><span class="cm">      * 。此外，&#34;qlock&#34;在关机时饱和到一个不可解锁的值（-1）。解锁仍然可以和成功的情况下执行更便宜的有序的&#34;qlock&#34;写入，但使用CAS不成功的情况下。
</span><span class="cm">     *
</span><span class="cm">     * Management 管理
</span><span class="cm">     * ==========
</span><span class="cm">     *
</span><span class="cm">     * The main throughput advantages of work-stealing stem from
</span><span class="cm">     * decentralized control -- workers mostly take tasks from
</span><span class="cm">     * themselves or each other, at rates that can exceed a billion
</span><span class="cm">     * per second.  The pool itself creates, activates (enables
</span><span class="cm">     * scanning for and running tasks), deactivates, blocks, and
</span><span class="cm">     * terminates threads, all with minimal central information.
</span><span class="cm">     * There are only a few properties that we can globally track or
</span><span class="cm">     * maintain, so we pack them into a small number of variables,
</span><span class="cm">     * often maintaining atomicity without blocking or locking.
</span><span class="cm">     * Nearly all essentially atomic control state is held in two
</span><span class="cm">     * volatile variables that are by far most often read (not
</span><span class="cm">     * written) as status and consistency checks. (Also, field
</span><span class="cm">     * &#34;config&#34; holds unchanging configuration state.)
</span><span class="cm">     * 
</span><span class="cm">     * 偷窃工作的主要优势在于分散控制 - 工人们大多是从自己或彼此的任务中，以每秒超过10亿的速度进行工作。
</span><span class="cm">     * 池本身创建，激活（启用扫描和运行任务），停用，阻塞和终止线程，所有这些都以最少的中央信息。
</span><span class="cm">     * 我们可以全局跟踪或维护的属性只有少数，所以我们将它们打包成少量的变量，通常保持原子性而不会阻塞或锁定。
</span><span class="cm">     * 几乎所有本质上的原子控制状态都被保存在两个非常常被读取（不被写入）的易失变量中作为状态和一致性检查。 （另外，&#34;config&#34;字段保持不变的配置状态。）
</span><span class="cm">
</span><span class="cm">     * 
</span><span class="cm">     *
</span><span class="cm">     * Field &#34;ctl&#34; contains 64 bits holding information needed to
</span><span class="cm">     * atomically decide to add, inactivate, enqueue (on an event
</span><span class="cm">     * queue), dequeue, and/or re-activate workers.  To enable this
</span><span class="cm">     * packing, we restrict maximum parallelism to (1&lt;&lt;15)-1 (which is
</span><span class="cm">     * far in excess of normal operating range) to allow ids, counts,
</span><span class="cm">     * and their negations (used for thresholding) to fit into 16bit
</span><span class="cm">     * subfields.
</span><span class="cm">     * 
</span><span class="cm">     * 字段&#34;ctl&#34;包含64位，用于存储原子级决定添加，禁用，入队（在事件队列上），出队和/或重新激活工作人员所需的信息。
</span><span class="cm">     * 为了实现这种打包，我们限制最大平行度为（1 &lt;&lt; 15）-1（远远超过正常工作范围），以允许ID，计数和它们的否定（用于阈值处理）适合16位子域。
</span><span class="cm">     *
</span><span class="cm">     * Field &#34;runState&#34; holds lockable state bits (STARTED, STOP, etc)
</span><span class="cm">     * also protecting updates to the workQueues array.  When used as
</span><span class="cm">     * a lock, it is normally held only for a few instructions (the
</span><span class="cm">     * only exceptions are one-time array initialization and uncommon
</span><span class="cm">     * resizing), so is nearly always available after at most a brief
</span><span class="cm">     * spin. But to be extra-cautious, after spinning, method
</span><span class="cm">     * awaitRunStateLock (called only if an initial CAS fails), uses a
</span><span class="cm">     * wait/notify mechanics on a builtin monitor to block when
</span><span class="cm">     * (rarely) needed. This would be a terrible idea for a highly
</span><span class="cm">     * contended lock, but most pools run without the lock ever
</span><span class="cm">     * contending after the spin limit, so this works fine as a more
</span><span class="cm">     * conservative alternative. Because we don&#39;t otherwise have an
</span><span class="cm">     * internal Object to use as a monitor, the &#34;stealCounter&#34; (an
</span><span class="cm">     * AtomicLong) is used when available (it too must be lazily
</span><span class="cm">     * initialized; see externalSubmit).
</span><span class="cm">     * 
</span><span class="cm">     * 字段&#34;runState&#34;保存可锁定状态位（STARTED，STOP等），同时保护对workQueues数组的更新。
</span><span class="cm">     * 当作为锁使用时，通常只保留几条指令（唯一的例外是一次性数组初始化和不常见的调整大小），
</span><span class="cm">     * 所以在最多短暂旋转后几乎总是可用的。但要谨慎，在旋转之后，方法awaitRunStateLock（仅在初始CAS失败时调用）
</span><span class="cm">     * 在内置监视器上使用等待/通知机制来阻止何时（很少）需要。这对于高度锁定来说是一个可怕的想法，
</span><span class="cm">     * 但是大多数游戏池在没有锁定的情况下仍然在旋转限制之后竞争，所以这可以作为更保守的选择。
</span><span class="cm">     * 因为我们没有其他内部对象用作监视器，所以在可用时使用&#34;stealCounter&#34;（AtomicLong）（它也必须被懒惰地初始化;参见externalSubmit）
</span><span class="cm">     *
</span><span class="cm">     * Usages of &#34;runState&#34; vs &#34;ctl&#34; interact in only one case:
</span><span class="cm">     * deciding to add a worker thread (see tryAddWorker), in which
</span><span class="cm">     * case the ctl CAS is performed while the lock is held.
</span><span class="cm">     * “runState”vs“ctl”的用法仅在一个例子中进行交互:决定添加一个工作线程(请参阅“添加工作人员”)，在这种情况下，在锁定锁的情况下执行ctl cas。
</span><span class="cm">     *
</span><span class="cm">     * Recording WorkQueues.  WorkQueues are recorded in the
</span><span class="cm">     * &#34;workQueues&#34; array. The array is created upon first use (see
</span><span class="cm">     * externalSubmit) and expanded if necessary.  Updates to the
</span><span class="cm">     * array while recording new workers and unrecording terminated
</span><span class="cm">     * ones are protected from each other by the runState lock, but
</span><span class="cm">     * the array is otherwise concurrently readable, and accessed
</span><span class="cm">     * directly. We also ensure that reads of the array reference
</span><span class="cm">     * itself never become too stale. To simplify index-based
</span><span class="cm">     * operations, the array size is always a power of two, and all
</span><span class="cm">     * readers must tolerate null slots. Worker queues are at odd
</span><span class="cm">     * indices. Shared (submission) queues are at even indices, up to
</span><span class="cm">     * a maximum of 64 slots, to limit growth even if array needs to
</span><span class="cm">     * expand to add more workers. Grouping them together in this way
</span><span class="cm">     * simplifies and speeds up task scanning.
</span><span class="cm">     * 
</span><span class="cm">     * 录制工作流程WorkQueues被记录在&#34;workQueues&#34;数组中。该数组在首次使用时创建（请参阅externalSubmit）并在必要时展开。
</span><span class="cm">     * 录制新工作人员和不录制已终止人员时对阵列的更新通过runState锁相互隔离，但数组可以同时读取并直接访问。我们还确保读取数组引用本身不会变得过时。
</span><span class="cm">     * 为了简化基于索引的操作，数组大小始终是2的乘方，所有读者都必须容忍空位。工人队列在奇数指数。共享（提交）队列处于偶数索引，最多可达64个时隙，
</span><span class="cm">     * 即使数组需要扩展以添加更多工作人员，也会限制增长。以这种方式将它们分组在一起简化和加快了任务扫描。
</span><span class="cm">     *
</span><span class="cm">     * All worker thread creation is on-demand, triggered by task
</span><span class="cm">     * submissions, replacement of terminated workers, and/or
</span><span class="cm">     * compensation for blocked workers. However, all other support
</span><span class="cm">     * code is set up to work with other policies.  To ensure that we
</span><span class="cm">     * do not hold on to worker references that would prevent GC, All
</span><span class="cm">     * accesses to workQueues are via indices into the workQueues
</span><span class="cm">     * array (which is one source of some of the messy code
</span><span class="cm">     * constructions here). In essence, the workQueues array serves as
</span><span class="cm">     * a weak reference mechanism. Thus for example the stack top
</span><span class="cm">     * subfield of ctl stores indices, not references.
</span><span class="cm">     * 
</span><span class="cm">     * 所有工作线程的创建都是按需提供的，由任务提交，更换终止的工作人员和/或对被阻止的工作人员进行补偿。
</span><span class="cm">     * 但是，所有其他支持代码都已设置为与其他策略配合使用。为了确保我们不要拘泥于可能阻止GC的工作者引用，
</span><span class="cm">     * 所有对workQueues的访问都是通过指向workQueues数组（这是这里一些混乱的代码构造的一个来源）的索引。
</span><span class="cm">     * 本质上，workQueues数组是一个弱引用机制。因此，例如，ctl的堆栈顶部子字段存储索引，而不是引用。
</span><span class="cm">     *
</span><span class="cm">     * Queuing Idle Workers. Unlike HPC work-stealing frameworks, we
</span><span class="cm">     * cannot let workers spin indefinitely scanning for tasks when
</span><span class="cm">     * none can be found immediately, and we cannot start/resume
</span><span class="cm">     * workers unless there appear to be tasks available.  On the
</span><span class="cm">     * other hand, we must quickly prod them into action when new
</span><span class="cm">     * tasks are submitted or generated. In many usages, ramp-up time
</span><span class="cm">     * to activate workers is the main limiting factor in overall
</span><span class="cm">     * performance, which is compounded at program start-up by JIT
</span><span class="cm">     * compilation and allocation. So we streamline this as much as
</span><span class="cm">     * possible.
</span><span class="cm">     * 
</span><span class="cm">     * 排队空闲的工人。不像高性能计算机窃取工作的框架，我们不能让工作人员无限期地扫描任务，
</span><span class="cm">     * 而不能立即找到任何工作，除非看起来有任务可用，否则我们不能启动/恢复工人。
</span><span class="cm">     * 另一方面，当新任务提交或产生时，我们必须迅速采取行动。在许多用法中，启动员工的加速时间是整体绩效的主要限制因素，
</span><span class="cm">     * 在程序启动时通过JIT汇编和分配加剧。所以我们尽可能简化它。
</span><span class="cm">     *
</span><span class="cm">     * The &#34;ctl&#34; field atomically maintains active and total worker
</span><span class="cm">     * counts as well as a queue to place waiting threads so they can
</span><span class="cm">     * be located for signalling. Active counts also play the role of
</span><span class="cm">     * quiescence indicators, so are decremented when workers believe
</span><span class="cm">     * that there are no more tasks to execute. The &#34;queue&#34; is
</span><span class="cm">     * actually a form of Treiber stack.  A stack is ideal for
</span><span class="cm">     * activating threads in most-recently used order. This improves
</span><span class="cm">     * performance and locality, outweighing the disadvantages of
</span><span class="cm">     * being prone to contention and inability to release a worker
</span><span class="cm">     * unless it is topmost on stack.  We park/unpark workers after
</span><span class="cm">     * pushing on the idle worker stack (represented by the lower
</span><span class="cm">     * 32bit subfield of ctl) when they cannot find work.  The top
</span><span class="cm">     * stack state holds the value of the &#34;scanState&#34; field of the
</span><span class="cm">     * worker: its index and status, plus a version counter that, in
</span><span class="cm">     * addition to the count subfields (also serving as version
</span><span class="cm">     * stamps) provide protection against Treiber stack ABA effects.
</span><span class="cm">     * 
</span><span class="cm">     * &#34;ctl&#34;字段自动维护活动和总工人数以及放置等待线程的队列，以便它们可以定位用于信令。
</span><span class="cm">     * 积极的计数也起到静止指标的作用，所以当工人认为没有更多的任务要执行时，积分计数就会减少。 
</span><span class="cm">     * &#34;队列&#34;实际上是一个Treiber栈的形式。堆栈非常适合以最近使用的顺序激活线程。
</span><span class="cm">     * 这提高了性能和局部性，超过了容易发生争用和无法释放工人的缺点，除非它是最上面的堆栈。
</span><span class="cm">     * 我们在闲置的工作人员堆栈（由ctl的低32位子域表示）找不到工作时，将工人停放/停放。
</span><span class="cm">     * 顶层堆栈状态保存worker的&#34;scanState&#34;字段的值：索引和状态，以及版本计数器，除了计数子字段（也用作版本标记）之外，
</span><span class="cm">     * 还提供针对Treiber堆栈ABA效果的保护。
</span><span class="cm">     *
</span><span class="cm">     * Field scanState is used by both workers and the pool to manage
</span><span class="cm">     * and track whether a worker is INACTIVE (possibly blocked
</span><span class="cm">     * waiting for a signal), or SCANNING for tasks (when neither hold
</span><span class="cm">     * it is busy running tasks).  When a worker is inactivated, its
</span><span class="cm">     * scanState field is set, and is prevented from executing tasks,
</span><span class="cm">     * even though it must scan once for them to avoid queuing
</span><span class="cm">     * races. Note that scanState updates lag queue CAS releases so
</span><span class="cm">     * usage requires care. When queued, the lower 16 bits of
</span><span class="cm">     * scanState must hold its pool index. So we place the index there
</span><span class="cm">     * upon initialization (see registerWorker) and otherwise keep it
</span><span class="cm">     * there or restore it when necessary.
</span><span class="cm">     * 
</span><span class="cm">     * 现场scanState由worker和pool用来管理和跟踪worker是否处于INACTIVE状态（可能被阻塞在等待信号），
</span><span class="cm">     * 或者SCANNING用于任务（当两个任务都没有忙于运行任务时）。当工作人员被禁用时，它的scanState字段被设置，
</span><span class="cm">     * 并且被阻止执行任务，即使它必须扫描一次以避免排队竞争。请注意，scanState更新滞后队列CAS版本，因此使用需要谨慎。
</span><span class="cm">     * 排队时，scanState的低16位必须保存其索引。所以我们在初始化时将索引放在那里（请参阅registerWorker），否则将它保留在那里或在必要时恢复。
</span><span class="cm">     *
</span><span class="cm">     * Memory ordering.  See &#34;Correct and Efficient Work-Stealing for
</span><span class="cm">     * Weak Memory Models&#34; by Le, Pop, Cohen, and Nardelli, PPoPP 2013
</span><span class="cm">     * (http://www.di.ens.fr/~zappa/readings/ppopp13.pdf) for an
</span><span class="cm">     * analysis of memory ordering requirements in work-stealing
</span><span class="cm">     * algorithms similar to the one used here.  We usually need
</span><span class="cm">     * stronger than minimal ordering because we must sometimes signal
</span><span class="cm">     * workers, requiring Dekker-like full-fences to avoid lost
</span><span class="cm">     * signals.  Arranging for enough ordering without expensive
</span><span class="cm">     * over-fencing requires tradeoffs among the supported means of
</span><span class="cm">     * expressing access constraints. The most central operations,
</span><span class="cm">     * taking from queues and updating ctl state, require full-fence
</span><span class="cm">     * CAS.  Array slots are read using the emulation of volatiles
</span><span class="cm">     * provided by Unsafe.  Access from other threads to WorkQueue
</span><span class="cm">     * base, top, and array requires a volatile load of the first of
</span><span class="cm">     * any of these read.  We use the convention of declaring the
</span><span class="cm">     * &#34;base&#34; index volatile, and always read it before other fields.
</span><span class="cm">     * The owner thread must ensure ordered updates, so writes use
</span><span class="cm">     * ordered intrinsics unless they can piggyback on those for other
</span><span class="cm">     * writes.  Similar conventions and rationales hold for other
</span><span class="cm">     * WorkQueue fields (such as &#34;currentSteal&#34;) that are only written
</span><span class="cm">     * by owners but observed by others.
</span><span class="cm">     * 
</span><span class="cm">     * 内存排序。 
</span><span class="cm">     * Le，Pop，Cohen和Nardelli在PPoPP 2013（http://www.di.ens.fr/~zappa/readings/ppopp13.pdf）上的
</span><span class="cm">     * &#34;正确和高效的偷窃工作&#34;的工作窃取算法中的内存排序要求类似于这里使用的。我们通常需要比最低限度的排序更有力，
</span><span class="cm">     * 因为我们有时必须向工人发出信号，要求像德克一样的全面防护，以避免丢失信号。在没有昂贵的过度围栏的情况下进行足够的
</span><span class="cm">     * 排序需要在表达访问约束的支持手段之间权衡。最重要的操作是从队列中取出并更新ctl状态，这需要全面的CAS。使用不安全提
</span><span class="cm">     * 供的挥发物模拟来读取阵列插槽。从其他线程访问WorkQueue base，top和array需要对这些读取中的第一个进行非易失性加载。
</span><span class="cm">     * 我们使用声明&#34;base&#34;索引的惯例volatile，并且总是在其他字段之前读取它。所有者线程必须确保有序更新，因此写入使用有序
</span><span class="cm">     * 的内在函数，除非它们可以搭载在其他写入的那些函数上。其他WorkQueue字段（如&#34;currentSteal&#34;）的其他WorkQueue字段也有
</span><span class="cm">     * 类似的约定和理由，这些字段只能由所有者书写，但是由其他人观察。
</span><span class="cm">     *
</span><span class="cm">     * Creating workers. To create a worker, we pre-increment total
</span><span class="cm">     * count (serving as a reservation), and attempt to construct a
</span><span class="cm">     * ForkJoinWorkerThread via its factory. Upon construction, the
</span><span class="cm">     * new thread invokes registerWorker, where it constructs a
</span><span class="cm">     * WorkQueue and is assigned an index in the workQueues array
</span><span class="cm">     * (expanding the array if necessary). The thread is then
</span><span class="cm">     * started. Upon any exception across these steps, or null return
</span><span class="cm">     * from factory, deregisterWorker adjusts counts and records
</span><span class="cm">     * accordingly.  If a null return, the pool continues running with
</span><span class="cm">     * fewer than the target number workers. If exceptional, the
</span><span class="cm">     * exception is propagated, generally to some external caller.
</span><span class="cm">     * Worker index assignment avoids the bias in scanning that would
</span><span class="cm">     * occur if entries were sequentially packed starting at the front
</span><span class="cm">     * of the workQueues array. We treat the array as a simple
</span><span class="cm">     * power-of-two hash table, expanding as needed. The seedIndex
</span><span class="cm">     * increment ensures no collisions until a resize is needed or a
</span><span class="cm">     * worker is deregistered and replaced, and thereafter keeps
</span><span class="cm">     * probability of collision low. We cannot use
</span><span class="cm">     * ThreadLocalRandom.getProbe() for similar purposes here because
</span><span class="cm">     * the thread has not started yet, but do so for creating
</span><span class="cm">     * submission queues for existing external threads.
</span><span class="cm">     * 
</span><span class="cm">     * 创建工作。为了创建一个工人，我们预先增加总数（作为保留），并尝试通过其工厂构建一个ForkJoinWorkerThread。在构建时，新的线程调用registerWorker，
</span><span class="cm">     * 在那里构造一个WorkQueue，并在workQueues数组中分配一个索引（如果需要，扩展数组）。线程然后启动。如果在这些步骤中发生任何异常，
</span><span class="cm">     * 或者从工厂返回null，则deregisterWorker会相应地调整计数和记录。如果返回空值，那么池将继续运行，而目标编号的工人数少于此值。如果例外，
</span><span class="cm">     * 则将异常传播给一些外部呼叫者。工作者索引分配避免了在从workQueues数组开始的顺序打包条目时发生的扫描偏差。我们把这个数组视为一个简单的二元哈希表，
</span><span class="cm">     * 根据需要进行扩展。 seedIndex增量确保不会发生冲突，直到需要调整大小或者取消注册和替换工作人员，并且此后保持低冲突概率。
</span><span class="cm">     * 我们不能在这里使用ThreadLocalRandom.getProbe（）来达到类似的目的，因为线程还没有启动，但是为了创建现有外部线程的提交队列。
</span><span class="cm">     *
</span><span class="cm">     * Deactivation and waiting. Queuing encounters several intrinsic
</span><span class="cm">     * races; most notably that a task-producing thread can miss
</span><span class="cm">     * seeing (and signalling) another thread that gave up looking for
</span><span class="cm">     * work but has not yet entered the wait queue.  When a worker
</span><span class="cm">     * cannot find a task to steal, it deactivates and enqueues. Very
</span><span class="cm">     * often, the lack of tasks is transient due to GC or OS
</span><span class="cm">     * scheduling. To reduce false-alarm deactivation, scanners
</span><span class="cm">     * compute checksums of queue states during sweeps.  (The
</span><span class="cm">     * stability checks used here and elsewhere are probabilistic
</span><span class="cm">     * variants of snapshot techniques -- see Herlihy &amp; Shavit.)
</span><span class="cm">     * Workers give up and try to deactivate only after the sum is
</span><span class="cm">     * stable across scans. Further, to avoid missed signals, they
</span><span class="cm">     * repeat this scanning process after successful enqueuing until
</span><span class="cm">     * again stable.  In this state, the worker cannot take/run a task
</span><span class="cm">     * it sees until it is released from the queue, so the worker
</span><span class="cm">     * itself eventually tries to release itself or any successor (see
</span><span class="cm">     * tryRelease).  Otherwise, upon an empty scan, a deactivated
</span><span class="cm">     * worker uses an adaptive local spin construction (see awaitWork)
</span><span class="cm">     * before blocking (via park). Note the unusual conventions about
</span><span class="cm">     * Thread.interrupts surrounding parking and other blocking:
</span><span class="cm">     * Because interrupts are used solely to alert threads to check
</span><span class="cm">     * termination, which is checked anyway upon blocking, we clear
</span><span class="cm">     * status (using Thread.interrupted) before any call to park, so
</span><span class="cm">     * that park does not immediately return due to status being set
</span><span class="cm">     * via some other unrelated call to interrupt in user code.
</span><span class="cm">     * 
</span><span class="cm">     * 取消激活并等待。排队遇到几个固有的种族;最值得注意的是，一个任务生成线程可能会错过看到（和发信号）另一个线程，
</span><span class="cm">     * 放弃寻找工作，但还没有进入等待队列。当一个工作人员找不到任务要偷取时，就会停用并排队。很多时候，由于GC或OS调度，
</span><span class="cm">     * 缺乏任务是短暂的。为了减少错误警报停用，扫描器在扫描期间计算队列状态的校验和。 
</span><span class="cm">     * （在这里和其他地方使用的稳定性检查是快照技术的概率变体 - 参见Herlihy＆Shavit。）工人放弃并且在整个扫描期间总和
</span><span class="cm">     * 稳定后才尝试去激活。此外，为了避免错过信号，他们在成功排队之后重复这个扫描过程直到再次稳定。在这种状态下，工作者
</span><span class="cm">     * 不能接受/运行它所看到的任务，直到它从队列中释放出来，所以工作者本身最终试图释放自己或任何后继者（参见tryRelease）。
</span><span class="cm">     * 否则，在空的扫描中，停用的工人在阻塞（通过停车）之前使用自适应本地旋转构造（参见awaitWork）。注意关于围绕停车和其
</span><span class="cm">     * 他阻塞的Thread.interrupts的不寻常约定：因为中断仅用于提醒线程检查终止，无论如何，在阻塞之后检查终止，所以我们在任何
</span><span class="cm">     * 呼叫停放之前清除状态（使用Thread.interrupted）由于通过其他不相关的呼叫来设置状态，用户代码中断将不会立即返回。
</span><span class="cm">     *
</span><span class="cm">     * Signalling and activation.  Workers are created or activated
</span><span class="cm">     * only when there appears to be at least one task they might be
</span><span class="cm">     * able to find and execute.  Upon push (either by a worker or an
</span><span class="cm">     * external submission) to a previously (possibly) empty queue,
</span><span class="cm">     * workers are signalled if idle, or created if fewer exist than
</span><span class="cm">     * the given parallelism level.  These primary signals are
</span><span class="cm">     * buttressed by others whenever other threads remove a task from
</span><span class="cm">     * a queue and notice that there are other tasks there as well.
</span><span class="cm">     * On most platforms, signalling (unpark) overhead time is
</span><span class="cm">     * noticeably long, and the time between signalling a thread and
</span><span class="cm">     * it actually making progress can be very noticeably long, so it
</span><span class="cm">     * is worth offloading these delays from critical paths as much as
</span><span class="cm">     * possible. Also, because inactive workers are often rescanning
</span><span class="cm">     * or spinning rather than blocking, we set and clear the &#34;parker&#34;
</span><span class="cm">     * field of WorkQueues to reduce unnecessary calls to unpark.
</span><span class="cm">     * (This requires a secondary recheck to avoid missed signals.)
</span><span class="cm">     * 
</span><span class="cm">     * 信令和激活。只有在看起来至少有一项他们可能能够找到并执行的任务时，才会创建或激活工人。
</span><span class="cm">     * 一旦（通过工作人员或外部提交）推送（先前（可能）空队列），工作人员在空闲时发信号通知，
</span><span class="cm">     * 或者如果存在比给定的并行性级别更少的信号，则发出信号。当其他线程从队列中删除一个任务时，
</span><span class="cm">     * 这些主要信号由其他线程支持，并注意到这里还有其他的任务。在大多数平台上，信令（unpark）的开销时间明显较长，
</span><span class="cm">     * 从一个线程到实际进展的时间可能会非常长，所以尽可能地将这些延迟从关键路径上卸载。另外，
</span><span class="cm">     * 由于不活跃的工作人员经常重新扫描或旋转，而不是阻止，我们设置并清除WorkQueues的&#34;parker&#34;字段，以减少不必要的停靠站点。 
</span><span class="cm">     * （这需要二次重新检查以避免错过信号。）
</span><span class="cm">     *
</span><span class="cm">     * Trimming workers. To release resources after periods of lack of
</span><span class="cm">     * use, a worker starting to wait when the pool is quiescent will
</span><span class="cm">     * time out and terminate (see awaitWork) if the pool has remained
</span><span class="cm">     * quiescent for period IDLE_TIMEOUT, increasing the period as the
</span><span class="cm">     * number of threads decreases, eventually removing all workers.
</span><span class="cm">     * Also, when more than two spare threads exist, excess threads
</span><span class="cm">     * are immediately terminated at the next quiescent point.
</span><span class="cm">     * (Padding by two avoids hysteresis.)
</span><span class="cm">     * 
</span><span class="cm">     * 整理工人。为了在不使用期间释放资源，当池静止时开始等待的工作者将超时并终止（参见awaitWork）如果池保持静止持续期间IDLE_TIMEOUT，
</span><span class="cm">     * 则最终随着线程数量的减少而增加删除所有的工人。另外，当存在两个以上的备用线程时，多余的线程立即在下一个静止点终止。 （填充两个避免迟滞。）
</span><span class="cm">     *
</span><span class="cm">     * Shutdown and Termination. A call to shutdownNow invokes
</span><span class="cm">     * tryTerminate to atomically set a runState bit. The calling
</span><span class="cm">     * thread, as well as every other worker thereafter terminating,
</span><span class="cm">     * helps terminate others by setting their (qlock) status,
</span><span class="cm">     * cancelling their unprocessed tasks, and waking them up, doing
</span><span class="cm">     * so repeatedly until stable (but with a loop bounded by the
</span><span class="cm">     * number of workers).  Calls to non-abrupt shutdown() preface
</span><span class="cm">     * this by checking whether termination should commence. This
</span><span class="cm">     * relies primarily on the active count bits of &#34;ctl&#34; maintaining
</span><span class="cm">     * consensus -- tryTerminate is called from awaitWork whenever
</span><span class="cm">     * quiescent. However, external submitters do not take part in
</span><span class="cm">     * this consensus.  So, tryTerminate sweeps through queues (until
</span><span class="cm">     * stable) to ensure lack of in-flight submissions and workers
</span><span class="cm">     * about to process them before triggering the &#34;STOP&#34; phase of
</span><span class="cm">     * termination. (Note: there is an intrinsic conflict if
</span><span class="cm">     * helpQuiescePool is called when shutdown is enabled. Both wait
</span><span class="cm">     * for quiescence, but tryTerminate is biased to not trigger until
</span><span class="cm">     * helpQuiescePool completes.)
</span><span class="cm">     * 
</span><span class="cm">     * 关机和终止。对shutdownNow的调用调用tryTerminate来自动设置一个runState位。调用线程以及之后的其他每个工作者终止，
</span><span class="cm">     * 通过设置（qlock）状态，取消未处理的任务并唤醒它们来帮助终止其他人，重复这样做直到稳定（但是由工人数量限制的循环）。
</span><span class="cm">     * 调用非突发关机（）通过检查终止是否应该开始。这主要依赖于保持一致的&#34;ctl&#34;的活动计数位 - 每当静止时，tryTerminate就从await工作中调用。
</span><span class="cm">     * 但是，外部提交者不参与这个共识。因此，尝试终止扫描队列（直到稳定），以确保在触发终止的&#34;停止&#34;阶段之前缺少空中提交和工作人员处理它们。 
</span><span class="cm">     * （注意：如果在启用shutdown的情况下调用helpQuiescePool，则存在内部冲突，两者都等待静止，但tryTerminate有偏见，直到helpQuiescePool完成时才触发。
</span><span class="cm">     *
</span><span class="cm">     *
</span><span class="cm">     * Joining Tasks 加入任务
</span><span class="cm">     * =============
</span><span class="cm">     *
</span><span class="cm">     * Any of several actions may be taken when one worker is waiting
</span><span class="cm">     * to join a task stolen (or always held) by another.  Because we
</span><span class="cm">     * are multiplexing many tasks on to a pool of workers, we can&#39;t
</span><span class="cm">     * just let them block (as in Thread.join).  We also cannot just
</span><span class="cm">     * reassign the joiner&#39;s run-time stack with another and replace
</span><span class="cm">     * it later, which would be a form of &#34;continuation&#34;, that even if
</span><span class="cm">     * possible is not necessarily a good idea since we may need both
</span><span class="cm">     * an unblocked task and its continuation to progress.  Instead we
</span><span class="cm">     * combine two tactics:
</span><span class="cm">     * 当一名工作人员正在等待加入被他人盗取（或总是被盗）的任务时，可能会采取任何一种行动。
</span><span class="cm">     * 因为我们将许多任务复用到工作池中，所以我们不能让它们阻塞（如在Thread.join中）。我们也不能仅仅把joiner的运行时间栈重新分配给另一个栈，
</span><span class="cm">     * 并且稍后将其替换，这将是一种&#34;延续&#34;形式，即使可能也不一定是一个好主意，因为我们可能需要一个畅通无阻的任务，进展。相反，
</span><span class="cm">     * 我们结合了两种策略：
</span><span class="cm">     *
</span><span class="cm">     *   Helping: Arranging for the joiner to execute some task that it
</span><span class="cm">     *      would be running if the steal had not occurred.  帮助:安排joiner执行一些任务，如果没有发生，它将运行。
</span><span class="cm">     *
</span><span class="cm">     *   Compensating: Unless there are already enough live threads,
</span><span class="cm">     *      method tryCompensate() may create or re-activate a spare
</span><span class="cm">     *      thread to compensate for blocked joiners until they unblock. 
</span><span class="cm">     *      补偿:除非已经有足够的活线程，方法尝试补偿()可以创建或重新激活一个备用线程来补偿阻塞的连接，直到它们解除阻塞为止。
</span><span class="cm">     *
</span><span class="cm">     * A third form (implemented in tryRemoveAndExec) amounts to
</span><span class="cm">     * helping a hypothetical compensator: If we can readily tell that
</span><span class="cm">     * a possible action of a compensator is to steal and execute the
</span><span class="cm">     * task being joined, the joining thread can do so directly,
</span><span class="cm">     * without the need for a compensation thread (although at the
</span><span class="cm">     * expense of larger run-time stacks, but the tradeoff is
</span><span class="cm">     * typically worthwhile).
</span><span class="cm">     * 
</span><span class="cm">     * 第三种形式（在tryRemoveAndExec中实现）相当于帮助一个假设的补偿器：如果我们可以很容易地告诉补偿器的一个可能的动作是窃取和执行被加入的任务，
</span><span class="cm">     * 那么加入的线程可以直接完成，而不需要补偿线程（尽管以较大的运行时间堆栈为代价，但折衷通常是值得的）。
</span><span class="cm">     *
</span><span class="cm">     * The ManagedBlocker extension API can&#39;t use helping so relies
</span><span class="cm">     * only on compensation in method awaitBlocker.
</span><span class="cm">     * 管理的拦截器扩展API不能使用帮助，因此只依赖于方法中的补偿等待拦截器。
</span><span class="cm">     *
</span><span class="cm">     * The algorithm in helpStealer entails a form of &#34;linear
</span><span class="cm">     * helping&#34;.  Each worker records (in field currentSteal) the most
</span><span class="cm">     * recent task it stole from some other worker (or a submission).
</span><span class="cm">     * It also records (in field currentJoin) the task it is currently
</span><span class="cm">     * actively joining. Method helpStealer uses these markers to try
</span><span class="cm">     * to find a worker to help (i.e., steal back a task from and
</span><span class="cm">     * execute it) that could hasten completion of the actively joined
</span><span class="cm">     * task.  Thus, the joiner executes a task that would be on its
</span><span class="cm">     * own local deque had the to-be-joined task not been stolen. This
</span><span class="cm">     * is a conservative variant of the approach described in Wagner &amp;
</span><span class="cm">     * Calder &#34;Leapfrogging: a portable technique for implementing
</span><span class="cm">     * efficient futures&#34; SIGPLAN Notices, 1993
</span><span class="cm">     * (http://portal.acm.org/citation.cfm?id=155354). It differs in
</span><span class="cm">     * that: (1) We only maintain dependency links across workers upon
</span><span class="cm">     * steals, rather than use per-task bookkeeping.  This sometimes
</span><span class="cm">     * requires a linear scan of workQueues array to locate stealers,
</span><span class="cm">     * but often doesn&#39;t because stealers leave hints (that may become
</span><span class="cm">     * stale/wrong) of where to locate them.  It is only a hint
</span><span class="cm">     * because a worker might have had multiple steals and the hint
</span><span class="cm">     * records only one of them (usually the most current).  Hinting
</span><span class="cm">     * isolates cost to when it is needed, rather than adding to
</span><span class="cm">     * per-task overhead.  (2) It is &#34;shallow&#34;, ignoring nesting and
</span><span class="cm">     * potentially cyclic mutual steals.  (3) It is intentionally
</span><span class="cm">     * racy: field currentJoin is updated only while actively joining,
</span><span class="cm">     * which means that we miss links in the chain during long-lived
</span><span class="cm">     * tasks, GC stalls etc (which is OK since blocking in such cases
</span><span class="cm">     * is usually a good idea).  (4) We bound the number of attempts
</span><span class="cm">     * to find work using checksums and fall back to suspending the
</span><span class="cm">     * worker and if necessary replacing it with another.
</span><span class="cm">     * 
</span><span class="cm">     * helpStealer中的算法需要一种&#34;线性帮助&#34;的形式。
</span><span class="cm">     * 每个工作人员记录（在currentSteal字段中）从其他工作人员（或提交）偷取的最近任务。它还记录（在currentJoin字段中）当前正在加入的任务。
</span><span class="cm">     * 方法helpStealer使用这些标记来试图找到一个工作人员来帮助（即，从任务中取回并执行任务），这可以加快主动联合任务的完成。
</span><span class="cm">     * 因此，加盟者执行一项任务，如果被加入的任务没有被盗，那么这个任务本身就是本地的。
</span><span class="cm">     * 这是Wagner＆Calder在&#34;跳跃：一种实现高效期货的便携式技术&#34;（SIGPLAN Notices，1993）（http://portal.acm.org/citation.cfm?id=155354）
</span><span class="cm">     * 中描述的方法的保守变体。它的不同之处在于：
</span><span class="cm">     * （1）我们只保留偷工作中的工人之间的依赖关系，而不是使用按任务记账。这有时需要对workQueues数组进行线性扫描来定位窃听器，
</span><span class="cm">     * 但通常不会因为窃听者留下提示（可能变得陈旧/错误）而将其定位到何处。这只是一个暗示，因为工人可能有多次抢断，
</span><span class="cm">     * 而提示只记录其中的一次（通常是最新的）。暗示隔离成本需要时，而不是增加到每个任务的开销。 
</span><span class="cm">     * （2）&#34;浅&#34;，忽略嵌套和潜在的循环互抢。 
</span><span class="cm">     * （3）故意激活：字段currentJoin只在主动加入时更新，这意味着我们在长期任务，GC停顿等期间错过了链中的链接（这是可以的，因为
</span><span class="cm">     * 在这种情况下阻塞通常是个好主意） 。 
</span><span class="cm">     * （4）我们限制了使用校验和的尝试次数，并回退到暂停工作，必要时替换为另一次。
</span><span class="cm">     *
</span><span class="cm">     * Helping actions for CountedCompleters do not require tracking
</span><span class="cm">     * currentJoins: Method helpComplete takes and executes any task
</span><span class="cm">     * with the same root as the task being waited on (preferring
</span><span class="cm">     * local pops to non-local polls). However, this still entails
</span><span class="cm">     * some traversal of completer chains, so is less efficient than
</span><span class="cm">     * using CountedCompleters without explicit joins.
</span><span class="cm">     * 
</span><span class="cm">     * 对计数完成者的帮助操作不需要跟踪当前的联接：方法帮助完成占用和执行任何具有与正在等待的任务相同的根目录的任务
</span><span class="cm">     * （首选本地弹出到非本地轮询）。然而，这仍然需要一些完成链的遍历，所以比没有显式连接的使用计数完成者效率低。
</span><span class="cm">     *
</span><span class="cm">     * Compensation does not aim to keep exactly the target
</span><span class="cm">     * parallelism number of unblocked threads running at any given
</span><span class="cm">     * time. Some previous versions of this class employed immediate
</span><span class="cm">     * compensations for any blocked join. However, in practice, the
</span><span class="cm">     * vast majority of blockages are transient byproducts of GC and
</span><span class="cm">     * other JVM or OS activities that are made worse by replacement.
</span><span class="cm">     * Currently, compensation is attempted only after validating that
</span><span class="cm">     * all purportedly active threads are processing tasks by checking
</span><span class="cm">     * field WorkQueue.scanState, which eliminates most false
</span><span class="cm">     * positives.  Also, compensation is bypassed (tolerating fewer
</span><span class="cm">     * threads) in the most common case in which it is rarely
</span><span class="cm">     * beneficial: when a worker with an empty queue (thus no
</span><span class="cm">     * continuation tasks) blocks on a join and there still remain
</span><span class="cm">     * enough threads to ensure liveness.
</span><span class="cm">     * 
</span><span class="cm">     * 补偿并不是要确保在任何给定的时间保持未被阻塞的线程的目标并行数量。这个类的一些以前的版本采用立即补偿任何封锁的连接。
</span><span class="cm">     * 但实际上，绝大多数堵塞是GC和其他JVM或OS活动的暂时性副产品，通过替换而变得更糟。
</span><span class="cm">     * 目前，只有在通过检查字段&#34;工作队列&#34;来验证所有据称活动的线程正在处理任务之后，才会尝试进行补偿。扫描状态，
</span><span class="cm">     * 从而消除了大多数误报。而且，在最不常见的情况下，
</span><span class="cm">     * 补偿会被绕过（容忍的线程更少）：当队列空闲的工作人员（因此没有连续任务）阻塞连接时，仍然有足够的线程来保证活跃性。
</span><span class="cm">     *
</span><span class="cm">     * The compensation mechanism may be bounded.  Bounds for the
</span><span class="cm">     * commonPool (see commonMaxSpares) better enable JVMs to cope
</span><span class="cm">     * with programming errors and abuse before running out of
</span><span class="cm">     * resources to do so. In other cases, users may supply factories
</span><span class="cm">     * that limit thread construction. The effects of bounding in this
</span><span class="cm">     * pool (like all others) is imprecise.  Total worker counts are
</span><span class="cm">     * decremented when threads deregister, not when they exit and
</span><span class="cm">     * resources are reclaimed by the JVM and OS. So the number of
</span><span class="cm">     * simultaneously live threads may transiently exceed bounds.
</span><span class="cm">     * 
</span><span class="cm">     * 补偿机制可能是有限的。 commonPool的界限（请参阅commonMaxSpares）更好地使JVM能够在耗尽资源之前处理编程错误和滥用。
</span><span class="cm">     * 在其他情况下，用户可能会提供限制螺纹结构的工厂。在这个池中的边界的影响（像所有其他）是不精确的。
</span><span class="cm">     * 当线程取消注册时，总工作人员计数递减，而不是退出并且JVM和OS回收资源。所以同时活动的线程数量可能暂时超过界限。
</span><span class="cm">     *
</span><span class="cm">     * Common Pool
</span><span class="cm">     * ===========
</span><span class="cm">     *
</span><span class="cm">     * The static common pool always exists after static
</span><span class="cm">     * initialization.  Since it (or any other created pool) need
</span><span class="cm">     * never be used, we minimize initial construction overhead and
</span><span class="cm">     * footprint to the setup of about a dozen fields, with no nested
</span><span class="cm">     * allocation. Most bootstrapping occurs within method
</span><span class="cm">     * externalSubmit during the first submission to the pool.
</span><span class="cm">     * 静态初始化后，静态公共池始终存在。由于它（或任何其他创建的池）不需要被使用，
</span><span class="cm">     * 所以我们将最初的构建开销和占用空间最小化到大约十几个字段的设置，没有嵌套的分配。大多数引导在第一次提交到池时在externalSubmit方法中发生。
</span><span class="cm">     *
</span><span class="cm">     * When external threads submit to the common pool, they can
</span><span class="cm">     * perform subtask processing (see externalHelpComplete and
</span><span class="cm">     * related methods) upon joins.  This caller-helps policy makes it
</span><span class="cm">     * sensible to set common pool parallelism level to one (or more)
</span><span class="cm">     * less than the total number of available cores, or even zero for
</span><span class="cm">     * pure caller-runs.  We do not need to record whether external
</span><span class="cm">     * submissions are to the common pool -- if not, external help
</span><span class="cm">     * methods return quickly. These submitters would otherwise be
</span><span class="cm">     * blocked waiting for completion, so the extra effort (with
</span><span class="cm">     * liberally sprinkled task status checks) in inapplicable cases
</span><span class="cm">     * amounts to an odd form of limited spin-wait before blocking in
</span><span class="cm">     * ForkJoinTask.join.
</span><span class="cm">     * 
</span><span class="cm">     * 当外部线程提交到公共池时，他们可以在连接时执行子任务处理（请参阅externalHelpComplete和相关方法）。
</span><span class="cm">     * 这个调用者帮助策略使得将公共池并行性级别设置为小于可用内核总数的一个（或更多），
</span><span class="cm">     * 或者对于纯粹的调用者运行甚至为零是明智的。我们不需要记录外部提交是否属于公共池，
</span><span class="cm">     * 否则外部帮助方法会很快返回。否则这些提交者将被阻塞等待完成，所以在不适用的情况下额外的工作量（大量的任务状态检查）
</span><span class="cm">     * 相当于在ForkJoinTask.join阻塞之前的一个奇怪形式的有限旋转等待。
</span><span class="cm">     *
</span><span class="cm">     * As a more appropriate default in managed environments, unless
</span><span class="cm">     * overridden by system properties, we use workers of subclass
</span><span class="cm">     * InnocuousForkJoinWorkerThread when there is a SecurityManager
</span><span class="cm">     * present. These workers have no permissions set, do not belong
</span><span class="cm">     * to any user-defined ThreadGroup, and erase all ThreadLocals
</span><span class="cm">     * after executing any top-level task (see WorkQueue.runTask).
</span><span class="cm">     * The associated mechanics (mainly in ForkJoinWorkerThread) may
</span><span class="cm">     * be JVM-dependent and must access particular Thread class fields
</span><span class="cm">     * to achieve this effect.
</span><span class="cm">     * 
</span><span class="cm">     * 作为托管环境中更合适的缺省值，除非被系统属性覆盖，否则当存在SecurityManager时，我们使用子类InnocuousForkJoinWorkerThread的工作者。
</span><span class="cm">     * 这些工作人员没有权限设置，不属于任何用户定义的ThreadGroup，并在执行任何顶级任务（请参见WorkQueue.runTask）后清除所有ThreadLocals。
</span><span class="cm">     * 相关的机制（主要在ForkJoinWorkerThread中）可能依赖于JVM，并且必须访问特定的Thread类字段才能达到这个效果。
</span><span class="cm">     *
</span><span class="cm">     * Style notes  样式笔记
</span><span class="cm">     * ===========
</span><span class="cm">     *
</span><span class="cm">     * Memory ordering relies mainly on Unsafe intrinsics that carry
</span><span class="cm">     * the further responsibility of explicitly performing null- and
</span><span class="cm">     * bounds- checks otherwise carried out implicitly by JVMs.  This
</span><span class="cm">     * can be awkward and ugly, but also reflects the need to control
</span><span class="cm">     * outcomes across the unusual cases that arise in very racy code
</span><span class="cm">     * with very few invariants. So these explicit checks would exist
</span><span class="cm">     * in some form anyway.  All fields are read into locals before
</span><span class="cm">     * use, and null-checked if they are references.  This is usually
</span><span class="cm">     * done in a &#34;C&#34;-like style of listing declarations at the heads
</span><span class="cm">     * of methods or blocks, and using inline assignments on first
</span><span class="cm">     * encounter.  Array bounds-checks are usually performed by
</span><span class="cm">     * masking with array.length-1, which relies on the invariant that
</span><span class="cm">     * these arrays are created with positive lengths, which is itself
</span><span class="cm">     * paranoically checked. Nearly all explicit checks lead to
</span><span class="cm">     * bypass/return, not exception throws, because they may
</span><span class="cm">     * legitimately arise due to cancellation/revocation during
</span><span class="cm">     * shutdown.
</span><span class="cm">     * 
</span><span class="cm">     * 内存排序主要依赖于不安全的内部函数，这些内部函数承担进一步明确执行空白和边界检查的责任，否则由JVM隐式执行。
</span><span class="cm">     * 这可能是尴尬和丑陋的，但也反映了需要控制的结果在非常激烈的代码中出现的不寻常的情况下，
</span><span class="cm">     * 几乎不变的。所以这些明确的检查将以某种形式存在。所有的字段在使用之前都会被读入本地，如果它们是引用，
</span><span class="cm">     * 则会进行空值检查。这通常在方法或块的头部以&#34;C&#34;类型的列表声明的方式完成，并且在首次遇到时使用内联分配。
</span><span class="cm">     * 数组边界检查通常是通过使用array.length-1进行掩码来实现的，该数组依赖于这些数组以正长度创建的不变量，这本身是经过偏执检查的。
</span><span class="cm">     * 几乎所有显式检查都会导致绕过/返回，而不是异常抛出，因为它们可能会因停机期间的取消/撤销而合法产生。
</span><span class="cm">     *
</span><span class="cm">     * There is a lot of representation-level coupling among classes
</span><span class="cm">     * ForkJoinPool, ForkJoinWorkerThread, and ForkJoinTask.  The
</span><span class="cm">     * fields of WorkQueue maintain data structures managed by
</span><span class="cm">     * ForkJoinPool, so are directly accessed.  There is little point
</span><span class="cm">     * trying to reduce this, since any associated future changes in
</span><span class="cm">     * representations will need to be accompanied by algorithmic
</span><span class="cm">     * changes anyway. Several methods intrinsically sprawl because
</span><span class="cm">     * they must accumulate sets of consistent reads of fields held in
</span><span class="cm">     * local variables.  There are also other coding oddities
</span><span class="cm">     * (including several unnecessary-looking hoisted null checks)
</span><span class="cm">     * that help some methods perform reasonably even when interpreted
</span><span class="cm">     * (not compiled).
</span><span class="cm">     * 
</span><span class="cm">     * 在类ForkJoinPool，ForkJoinWorkerThread和ForkJoinTask之间有很多表示级耦合。 WorkQueue的字段维护由ForkJoinPool管理的数据结构，
</span><span class="cm">     * 因此可以直接访问。试图减少这一点是没有意义的，因为任何关联的未来表示变化都需要伴随着算法变化。有几种方法本质上是蔓延性的，
</span><span class="cm">     * 因为它们必须累积本地变量中保持的字段的一致读取。还有其他的编码怪异（包括几个不必要的提升空检查），
</span><span class="cm">     * 即使在解释（不编译）时也可以帮助某些方法合理地执行。
</span><span class="cm">     *
</span><span class="cm">     * The order of declarations in this file is (with a few exceptions): 这个文件中的声明的顺序是（有一些例外）：
</span><span class="cm">     * (1) Static utility functions 静态的效用函数
</span><span class="cm">     * (2) Nested (static) classes  嵌套(静态)类
</span><span class="cm">     * (3) Static fields            静态字段
</span><span class="cm">     * (4) Fields, along with constants used when unpacking some of them 字段，以及在拆包时使用的常量
</span><span class="cm">     * (5) Internal control methods  内部控制的方法
</span><span class="cm">     * (6) Callbacks and other support for ForkJoinTask methods  回调和对ForkJoinTask方法的其他支持
</span><span class="cm">     * (7) Exported methods  导出的方法
</span><span class="cm">     * (8) Static block initializing statics in minimally dependent order  在最小依赖顺序中，静态块初始化静态块
</span><span class="cm">     */</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="二workqueue分析">二、WorkQueue分析</h2>
<h3 id="1workqueue构造">1.WorkQueue构造</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="cm">/**
</span><span class="cm">     * Queues supporting work-stealing as well as external task
</span><span class="cm">     * submission. See above for descriptions and algorithms.
</span><span class="cm">     * Performance on most platforms is very sensitive to placement of
</span><span class="cm">     * instances of both WorkQueues and their arrays -- we absolutely
</span><span class="cm">     * do not want multiple WorkQueue instances or multiple queue
</span><span class="cm">     * arrays sharing cache lines. The @Contended annotation alerts
</span><span class="cm">     * JVMs to try to keep instances apart.
</span><span class="cm">     * 队列支持工作-窃取和外部任务提交。请参阅上面的描述和算法。大多数平台上的性能对工作队列和
</span><span class="cm">     * 数组的实例放置非常敏感——我们绝对不希望多个工作队列实例或多个队列数组共享缓存线。@ Contended注释警告JVMs试图将实例分开。
</span><span class="cm">     */</span>
    <span class="nd">@sun.misc.Contended</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WorkQueue</span> <span class="o">{</span>

        <span class="cm">/**
</span><span class="cm">         * Capacity of work-stealing queue array upon initialization.
</span><span class="cm">         * Must be a power of two; at least 4, but should be larger to
</span><span class="cm">         * reduce or eliminate cacheline sharing among queues.
</span><span class="cm">         * Currently, it is much larger, as a partial workaround for
</span><span class="cm">         * the fact that JVMs often place arrays in locations that
</span><span class="cm">         * share GC bookkeeping (especially cardmarks) such that
</span><span class="cm">         * per-write accesses encounter serious memory contention.
</span><span class="cm">         */</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">INITIAL_QUEUE_CAPACITY</span> <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">13</span><span class="o">;</span>

        <span class="cm">/**
</span><span class="cm">         * Maximum size for queue arrays. Must be a power of two less
</span><span class="cm">         * than or equal to 1 &lt;&lt; (31 - width of array entry) to ensure
</span><span class="cm">         * lack of wraparound of index calculations, but defined to a
</span><span class="cm">         * value a bit less than this to help users trap runaway
</span><span class="cm">         * programs before saturating systems.
</span><span class="cm">         */</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAXIMUM_QUEUE_CAPACITY</span> <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">26</span><span class="o">;</span> <span class="c1">// 64M
</span><span class="c1"></span>
        <span class="c1">// Instance fields
</span><span class="c1"></span>        <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">scanState</span><span class="o">;</span>    <span class="c1">// versioned, &lt;0: inactive; odd:scanning
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">stackPred</span><span class="o">;</span>             <span class="c1">// pool stack (ctl) predecessor
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">nsteals</span><span class="o">;</span>               <span class="c1">// number of steals
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">hint</span><span class="o">;</span>                  <span class="c1">// randomization and stealer index hint
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">config</span><span class="o">;</span>                <span class="c1">// pool index and mode
</span><span class="c1"></span>        <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">qlock</span><span class="o">;</span>        <span class="c1">// 1: locked, &lt; 0: terminate; else 0
</span><span class="c1"></span>        <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">base</span><span class="o">;</span>         <span class="c1">// index of next slot for poll
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">top</span><span class="o">;</span>                   <span class="c1">// index of next slot for push
</span><span class="c1"></span>        <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">array</span><span class="o">;</span>   <span class="c1">// the elements (initially unallocated)
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">ForkJoinPool</span> <span class="n">pool</span><span class="o">;</span>   <span class="c1">// the containing pool (may be null)
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">ForkJoinWorkerThread</span> <span class="n">owner</span><span class="o">;</span> <span class="c1">// owning thread or null if shared
</span><span class="c1"></span>        <span class="kd">volatile</span> <span class="n">Thread</span> <span class="n">parker</span><span class="o">;</span>    <span class="c1">// == owner during call to park; else null
</span><span class="c1"></span>        <span class="kd">volatile</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">currentJoin</span><span class="o">;</span>  <span class="c1">// task being joined in awaitJoin
</span><span class="c1"></span>        <span class="kd">volatile</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">currentSteal</span><span class="o">;</span> <span class="c1">// mainly used by helpStealer
</span><span class="c1"></span>
        <span class="n">WorkQueue</span><span class="o">(</span><span class="n">ForkJoinPool</span> <span class="n">pool</span><span class="o">,</span> <span class="n">ForkJoinWorkerThread</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="o">;</span>
            <span class="c1">// Place indices in the center of array (that is not yet allocated)
</span><span class="c1"></span>            <span class="n">base</span> <span class="o">=</span> <span class="n">top</span> <span class="o">=</span> <span class="n">INITIAL_QUEUE_CAPACITY</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">1</span><span class="o">;</span>
        <span class="o">}</span>
<span class="o">}</span>       
</code></pre></td></tr></table>
</div>
</div><ul>
<li>WorkQueue类@sun.misc.Contended注解，控制缓存行处理</li>
</ul>
<h3 id="2push-添加任务">2.push 添加任务</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">      <span class="cm">/**
</span><span class="cm">       * Pushes a task. Call only by owner in unshared queues.  (The
</span><span class="cm">       * shared-queue version is embedded in method externalPush.)
</span><span class="cm">       *
</span><span class="cm">       * @param task the task. Caller must ensure non-null.
</span><span class="cm">       * @throws RejectedExecutionException if array cannot be resized
</span><span class="cm">       */</span>
      <span class="kd">final</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span><span class="o">;</span> <span class="n">ForkJoinPool</span> <span class="n">p</span><span class="o">;</span>
          <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="o">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">top</span><span class="o">,</span> <span class="n">n</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// ignore if queue removed
</span><span class="c1"></span>              <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>     <span class="c1">// fenced write for task visibility
</span><span class="c1"></span>              <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="o">((</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
              <span class="n">U</span><span class="o">.</span><span class="na">putOrderedInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">QTOP</span><span class="o">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">b</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">//任务数组内容小于1就唤醒或者创建线程
</span><span class="c1"></span>                  <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                      <span class="n">p</span><span class="o">.</span><span class="na">signalWork</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">workQueues</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">m</span><span class="o">)</span>
                  <span class="n">growArray</span><span class="o">();</span> <span class="c1">//扩容
</span><span class="c1"></span>          <span class="o">}</span>
      <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="3growarray-扩容">3.growArray 扩容</h3>
<p>按2倍扩容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">       <span class="cm">/**
</span><span class="cm">        * Initializes or doubles the capacity of array. Call either
</span><span class="cm">        * by owner or with lock held -- it is OK for base, but not
</span><span class="cm">        * top, to move while resizings are in progress.
</span><span class="cm">        */</span>
       <span class="kd">final</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">growArray</span><span class="o">()</span> <span class="o">{</span>
           <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">oldA</span> <span class="o">=</span> <span class="n">array</span><span class="o">;</span>
           <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">oldA</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">oldA</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;&lt;</span> <span class="n">1</span> <span class="o">:</span> <span class="n">INITIAL_QUEUE_CAPACITY</span><span class="o">;</span> <span class="c1">// 2倍扩容
</span><span class="c1"></span>           <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAXIMUM_QUEUE_CAPACITY</span><span class="o">)</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">RejectedExecutionException</span><span class="o">(</span><span class="s">&#34;Queue capacity exceeded&#34;</span><span class="o">);</span>
           <span class="kt">int</span> <span class="n">oldMask</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="n">b</span><span class="o">;</span>
           <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[</span><span class="n">size</span><span class="o">];</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">oldA</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">oldMask</span> <span class="o">=</span> <span class="n">oldA</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
               <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">top</span><span class="o">)</span> <span class="o">-</span> <span class="o">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
               <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
               <span class="k">do</span> <span class="o">{</span> <span class="c1">// emulate poll from old array, push to new array
</span><span class="c1"></span>                   <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">x</span><span class="o">;</span>
                   <span class="kt">int</span> <span class="n">oldj</span> <span class="o">=</span> <span class="o">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">oldMask</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
                   <span class="kt">int</span> <span class="n">j</span>    <span class="o">=</span> <span class="o">((</span><span class="n">b</span> <span class="o">&amp;</span>    <span class="n">mask</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
                   <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;)</span><span class="n">U</span><span class="o">.</span><span class="na">getObjectVolatile</span><span class="o">(</span><span class="n">oldA</span><span class="o">,</span> <span class="n">oldj</span><span class="o">);</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                       <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">oldA</span><span class="o">,</span> <span class="n">oldj</span><span class="o">,</span> <span class="n">x</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span>
                       <span class="n">U</span><span class="o">.</span><span class="na">putObjectVolatile</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">x</span><span class="o">);</span>
               <span class="o">}</span> <span class="k">while</span> <span class="o">(++</span><span class="n">b</span> <span class="o">!=</span> <span class="n">t</span><span class="o">);</span>
           <span class="o">}</span>
           <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
       <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="4pop-lifo">4.pop LIFO</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="cm">/**
</span><span class="cm">         * Takes next task, if one exists, in LIFO order.  Call only
</span><span class="cm">         * by owner in unshared queues.
</span><span class="cm">         */</span>
        <span class="kd">final</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">pop</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span><span class="o">;</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">;</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">-</span> <span class="n">base</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;)</span> <span class="o">{</span>
                    <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="o">((</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;)</span><span class="n">U</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">U</span><span class="o">.</span><span class="na">putOrderedInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">QTOP</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
         <span class="cm">/**
</span><span class="cm">          * Takes a task in FIFO order if b is base of queue and a task
</span><span class="cm">          * can be claimed without contention. Specialized versions
</span><span class="cm">          * appear in ForkJoinPool methods scan and helpStealer.
</span><span class="cm">          */</span>
         <span class="kd">final</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">pollAt</span><span class="o">(</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span><span class="o">;</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span><span class="o">;</span>
             <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="o">(((</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">b</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
                 <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;)</span><span class="n">U</span><span class="o">.</span><span class="na">getObjectVolatile</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                     <span class="n">base</span> <span class="o">==</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                     <span class="n">base</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
                     <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
                 <span class="o">}</span>
             <span class="o">}</span>
             <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
         <span class="o">}</span>       
</code></pre></td></tr></table>
</div>
</div><h3 id="5poll-fifo">5.poll FIFO</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">       <span class="cm">/**
</span><span class="cm">        * Takes next task, if one exists, in FIFO order.
</span><span class="cm">        */</span>
       <span class="kd">final</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">poll</span><span class="o">()</span> <span class="o">{</span>
           <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span><span class="o">;</span> <span class="kt">int</span> <span class="n">b</span><span class="o">;</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span><span class="o">;</span>
           <span class="k">while</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="o">)</span> <span class="o">-</span> <span class="n">top</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="o">(((</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">b</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
               <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;)</span><span class="n">U</span><span class="o">.</span><span class="na">getObjectVolatile</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">base</span> <span class="o">==</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                       <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                           <span class="n">base</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
                           <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
                       <span class="o">}</span>
                   <span class="o">}</span>
                   <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">1</span> <span class="o">==</span> <span class="n">top</span><span class="o">)</span> <span class="c1">// now empty
</span><span class="c1"></span>                       <span class="k">break</span><span class="o">;</span>
               <span class="o">}</span>
           <span class="o">}</span>
           <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
       <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="6runtask-执行窃取任务在执行本地线程中任务">6.runTask 执行窃取任务，在执行本地线程中任务</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="cm">/**
</span><span class="cm">         * Executes the given task and any remaining local tasks.
</span><span class="cm">         */</span>
        <span class="kd">final</span> <span class="kt">void</span> <span class="nf">runTask</span><span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">scanState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCANNING</span><span class="o">;</span> <span class="c1">// mark as busy
</span><span class="c1"></span>                <span class="o">(</span><span class="n">currentSteal</span> <span class="o">=</span> <span class="n">task</span><span class="o">).</span><span class="na">doExec</span><span class="o">();</span> <span class="c1">// 执行窃取任务
</span><span class="c1"></span>                <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">QCURRENTSTEAL</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span> <span class="c1">// release for GC
</span><span class="c1"></span>                <span class="n">execLocalTasks</span><span class="o">();</span>  <span class="c1">//执行本地线程中任务
</span><span class="c1"></span>                <span class="n">ForkJoinWorkerThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">owner</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(++</span><span class="n">nsteals</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>      <span class="c1">// collect on overflow
</span><span class="c1"></span>                    <span class="n">transferStealCount</span><span class="o">(</span><span class="n">pool</span><span class="o">);</span>
                <span class="n">scanState</span> <span class="o">|=</span> <span class="n">SCANNING</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">thread</span><span class="o">.</span><span class="na">afterTopLevelExec</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
 
        <span class="cm">/**
</span><span class="cm">          * Polls and runs tasks until empty.
</span><span class="cm">          */</span>
         <span class="kd">final</span> <span class="kt">void</span> <span class="nf">pollAndExecAll</span><span class="o">()</span> <span class="o">{</span>
             <span class="k">for</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span><span class="o">;</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">poll</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;)</span>
                 <span class="n">t</span><span class="o">.</span><span class="na">doExec</span><span class="o">();</span>
         <span class="o">}</span>
 
         <span class="cm">/**
</span><span class="cm">          * Removes and executes all local tasks. If LIFO, invokes
</span><span class="cm">          * pollAndExecAll. Otherwise implements a specialized pop loop
</span><span class="cm">          * to exec until empty.
</span><span class="cm">          */</span>
         <span class="kd">final</span> <span class="kt">void</span> <span class="nf">execLocalTasks</span><span class="o">()</span> <span class="o">{</span>
             <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">s</span><span class="o">;</span>
             <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">;</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">-</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                 <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">if</span> <span class="o">((</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">FIFO_QUEUE</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                     <span class="k">for</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span><span class="o">;;)</span> <span class="o">{</span>
                         <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;)</span><span class="n">U</span><span class="o">.</span><span class="na">getAndSetObject</span>
                              <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="o">((</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                             <span class="k">break</span><span class="o">;</span>
                         <span class="n">U</span><span class="o">.</span><span class="na">putOrderedInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">QTOP</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
                         <span class="n">t</span><span class="o">.</span><span class="na">doExec</span><span class="o">();</span>
                         <span class="k">if</span> <span class="o">(</span><span class="n">base</span> <span class="o">-</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span>
                             <span class="k">break</span><span class="o">;</span>
                     <span class="o">}</span>
                 <span class="o">}</span>
                 <span class="k">else</span>
                     <span class="n">pollAndExecAll</span><span class="o">();</span>
             <span class="o">}</span>
         <span class="o">}</span>       
        
        <span class="cm">/**
</span><span class="cm">         * Adds steal count to pool stealCounter if it exists, and resets.
</span><span class="cm">         */</span>
        <span class="kd">final</span> <span class="kt">void</span> <span class="nf">transferStealCount</span><span class="o">(</span><span class="n">ForkJoinPool</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">AtomicLong</span> <span class="n">sc</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">sc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">stealCounter</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">nsteals</span><span class="o">;</span>
                <span class="n">nsteals</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>            <span class="c1">// if negative, correct for overflow
</span><span class="c1"></span>                <span class="n">sc</span><span class="o">.</span><span class="na">getAndAdd</span><span class="o">((</span><span class="kt">long</span><span class="o">)(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">:</span> <span class="n">s</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>        
</code></pre></td></tr></table>
</div>
</div><h3 id="7tryremoveandexec">7.tryRemoveAndExec</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">     <span class="cm">/**
</span><span class="cm">        * If present, removes from queue and executes the given task,
</span><span class="cm">        * or any other cancelled task. Used only by awaitJoin.
</span><span class="cm">        * 如果存在，则从队列中删除并执行给定任务，或任何其他已取消的任务。, 仅由awaitJoin使用。
</span><span class="cm">        *
</span><span class="cm">        * @return true if queue empty and task not known to be done
</span><span class="cm">        */</span>
       <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryRemoveAndExec</span><span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">n</span><span class="o">;</span>
           <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
               <span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">while</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">top</span><span class="o">)</span> <span class="o">-</span> <span class="o">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="o">))</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                   <span class="k">for</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span><span class="o">;;)</span> <span class="o">{</span>      <span class="c1">// traverse from s to b
</span><span class="c1"></span>                       <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="o">((--</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
                       <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;)</span><span class="n">U</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                           <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">1</span> <span class="o">==</span> <span class="n">top</span><span class="o">;</span>     <span class="c1">// shorter than expected
</span><span class="c1"></span>                       <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>                                  <span class="c1">//查询相应task
</span><span class="c1"></span>                           <span class="kt">boolean</span> <span class="n">removed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                           <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">1</span> <span class="o">==</span> <span class="n">top</span><span class="o">)</span> <span class="o">{</span>      <span class="c1">// pop                            //最后一个task任务队列；删除该任务，执行任务
</span><span class="c1"></span>                               <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">task</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                                   <span class="n">U</span><span class="o">.</span><span class="na">putOrderedInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">QTOP</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
                                   <span class="n">removed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                               <span class="o">}</span>
                           <span class="o">}</span>
                           <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">base</span> <span class="o">==</span> <span class="n">b</span><span class="o">)</span>      <span class="c1">// replace with proxy           //任务替换成EmptyTask，执行任务
</span><span class="c1"></span>                               <span class="n">removed</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span>
                                   <span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">task</span><span class="o">,</span> <span class="k">new</span> <span class="n">EmptyTask</span><span class="o">());</span>
                           <span class="k">if</span> <span class="o">(</span><span class="n">removed</span><span class="o">)</span>
                               <span class="n">task</span><span class="o">.</span><span class="na">doExec</span><span class="o">();</span>
                           <span class="k">break</span><span class="o">;</span>
                       <span class="o">}</span>
                       <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">status</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">1</span> <span class="o">==</span> <span class="n">top</span><span class="o">)</span> <span class="o">{</span>                 <span class="c1">//最后任务已执行；删除该任务，
</span><span class="c1"></span>                           <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span>
                               <span class="n">U</span><span class="o">.</span><span class="na">putOrderedInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">QTOP</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
                           <span class="k">break</span><span class="o">;</span>                  <span class="c1">// was cancelled
</span><span class="c1"></span>                       <span class="o">}</span>
                       <span class="k">if</span> <span class="o">(--</span><span class="n">n</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>                                         <span class="c1">//没找到该任务直接返回false
</span><span class="c1"></span>                           <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                   <span class="o">}</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">status</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>                                    <span class="c1">//查找任务已执行；返回false
</span><span class="c1"></span>                       <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
               <span class="o">}</span>
           <span class="o">}</span>
           <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
       <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="三forkjoinpool">三、ForkJoinPool</h2>
<h3 id="1forkjoinpoolsh构造">1.ForkJoinPoolsh构造</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">

    <span class="c1">// Lower and upper word masks
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">SP_MASK</span>    <span class="o">=</span> <span class="n">0xffffffffL</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">UC_MASK</span>    <span class="o">=</span> <span class="o">~</span><span class="n">SP_MASK</span><span class="o">;</span>

    <span class="c1">// Active counts
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="n">AC_SHIFT</span>   <span class="o">=</span> <span class="n">48</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">AC_UNIT</span>    <span class="o">=</span> <span class="n">0x0001L</span> <span class="o">&lt;&lt;</span> <span class="n">AC_SHIFT</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">AC_MASK</span>    <span class="o">=</span> <span class="n">0xffffL</span> <span class="o">&lt;&lt;</span> <span class="n">AC_SHIFT</span><span class="o">;</span>

    <span class="c1">// Total counts
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="n">TC_SHIFT</span>   <span class="o">=</span> <span class="n">32</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">TC_UNIT</span>    <span class="o">=</span> <span class="n">0x0001L</span> <span class="o">&lt;&lt;</span> <span class="n">TC_SHIFT</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">TC_MASK</span>    <span class="o">=</span> <span class="n">0xffffL</span> <span class="o">&lt;&lt;</span> <span class="n">TC_SHIFT</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">ADD_WORKER</span> <span class="o">=</span> <span class="n">0x0001L</span> <span class="o">&lt;&lt;</span> <span class="o">(</span><span class="n">TC_SHIFT</span> <span class="o">+</span> <span class="n">15</span><span class="o">);</span> <span class="c1">// sign
</span><span class="c1"></span>
    <span class="c1">// runState bits: SHUTDOWN must be negative, others arbitrary powers of two
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="n">RSLOCK</span>     <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="n">RSIGNAL</span>    <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="n">STARTED</span>    <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="n">STOP</span>       <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">29</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="n">TERMINATED</span> <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">30</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="n">SHUTDOWN</span>   <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">31</span><span class="o">;</span>

    <span class="c1">// Instance fields
</span><span class="c1"></span>    <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">ctl</span><span class="o">;</span>                   <span class="c1">// main pool control
</span><span class="c1"></span>    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">runState</span><span class="o">;</span>               <span class="c1">// lockable status
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">config</span><span class="o">;</span>                    <span class="c1">// parallelism, mode
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">indexSeed</span><span class="o">;</span>                       <span class="c1">// to generate worker index
</span><span class="c1"></span>    <span class="kd">volatile</span> <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">workQueues</span><span class="o">;</span>     <span class="c1">// main registry
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">ForkJoinWorkerThreadFactory</span> <span class="n">factory</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">UncaughtExceptionHandler</span> <span class="n">ueh</span><span class="o">;</span>  <span class="c1">// per-worker UEH
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">String</span> <span class="n">workerNamePrefix</span><span class="o">;</span>       <span class="c1">// to create worker name string
</span><span class="c1"></span>    <span class="kd">volatile</span> <span class="n">AtomicLong</span> <span class="n">stealCounter</span><span class="o">;</span>  
    
   <span class="cm">/**
</span><span class="cm">    * Creates a {@code ForkJoinPool} with the given parameters, without
</span><span class="cm">    * any security checks or parameter validation.  Invoked directly by
</span><span class="cm">    * makeCommonPool.
</span><span class="cm">    */</span>
   <span class="kd">private</span> <span class="nf">ForkJoinPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">parallelism</span><span class="o">,</span>
                        <span class="n">ForkJoinWorkerThreadFactory</span> <span class="n">factory</span><span class="o">,</span>
                        <span class="n">UncaughtExceptionHandler</span> <span class="n">handler</span><span class="o">,</span>
                        <span class="kt">int</span> <span class="n">mode</span><span class="o">,</span>
                        <span class="n">String</span> <span class="n">workerNamePrefix</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">this</span><span class="o">.</span><span class="na">workerNamePrefix</span> <span class="o">=</span> <span class="n">workerNamePrefix</span><span class="o">;</span>
       <span class="k">this</span><span class="o">.</span><span class="na">factory</span> <span class="o">=</span> <span class="n">factory</span><span class="o">;</span>
       <span class="k">this</span><span class="o">.</span><span class="na">ueh</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
       <span class="k">this</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="o">(</span><span class="n">parallelism</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">)</span> <span class="o">|</span> <span class="n">mode</span><span class="o">;</span>
       <span class="kt">long</span> <span class="n">np</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)(-</span><span class="n">parallelism</span><span class="o">);</span> <span class="c1">// offset ctl counts
</span><span class="c1"></span>       <span class="k">this</span><span class="o">.</span><span class="na">ctl</span> <span class="o">=</span> <span class="o">((</span><span class="n">np</span> <span class="o">&lt;&lt;</span> <span class="n">AC_SHIFT</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">AC_MASK</span><span class="o">)</span> <span class="o">|</span> <span class="o">((</span><span class="n">np</span> <span class="o">&lt;&lt;</span> <span class="n">TC_SHIFT</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">TC_MASK</span><span class="o">);</span>
   <span class="o">}</span>     
</code></pre></td></tr></table>
</div>
</div><h3 id="2runstate">2.runState</h3>
<h4 id="1lockrunstate-获取锁">(1).lockRunState 获取锁</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Acquires the runState lock; returns current (locked) runState.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">lockRunState</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">rs</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">((((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">runState</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">RSLOCK</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">||</span>
                 <span class="o">!</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">RUNSTATE</span><span class="o">,</span> <span class="n">rs</span><span class="o">,</span> <span class="n">rs</span> <span class="o">|=</span> <span class="n">RSLOCK</span><span class="o">))</span> <span class="o">?</span>
                <span class="n">awaitRunStateLock</span><span class="o">()</span> <span class="o">:</span> <span class="n">rs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Spins and/or blocks until runstate lock is available.  See
</span><span class="cm">     * above for explanation.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">awaitRunStateLock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Object</span> <span class="n">lock</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">wasInterrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">spins</span> <span class="o">=</span> <span class="n">SPINS</span><span class="o">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">rs</span><span class="o">,</span> <span class="n">ns</span><span class="o">;;)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">runState</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">RSLOCK</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">RUNSTATE</span><span class="o">,</span> <span class="n">rs</span><span class="o">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">|</span> <span class="n">RSLOCK</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">wasInterrupted</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SecurityException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">return</span> <span class="n">ns</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">nextSecondarySeed</span><span class="o">();</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">6</span><span class="o">;</span> <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">21</span><span class="o">;</span> <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">7</span><span class="o">;</span> <span class="c1">// xorshift
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span>
                    <span class="o">--</span><span class="n">spins</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">&amp;</span> <span class="n">STARTED</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">||</span> <span class="o">(</span><span class="n">lock</span> <span class="o">=</span> <span class="n">stealCounter</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>   <span class="c1">// initialization race
</span><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">RUNSTATE</span><span class="o">,</span> <span class="n">rs</span><span class="o">,</span> <span class="n">rs</span> <span class="o">|</span> <span class="n">RSIGNAL</span><span class="o">))</span> <span class="o">{</span>  <span class="c1">//锁等待
</span><span class="c1"></span>                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">runState</span> <span class="o">&amp;</span> <span class="n">RSIGNAL</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(!(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="k">instanceof</span>
                                  <span class="n">ForkJoinWorkerThread</span><span class="o">))</span>
                                <span class="n">wasInterrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">else</span>
                        <span class="n">lock</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="2unlockrunstate-解锁">(2).unlockRunState 解锁</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">      <span class="cm">/**
</span><span class="cm">       * Unlocks and sets runState to newRunState.
</span><span class="cm">       *
</span><span class="cm">       * @param oldRunState a value returned from lockRunState
</span><span class="cm">       * @param newRunState the next value (must have lock bit clear).
</span><span class="cm">       */</span>
      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unlockRunState</span><span class="o">(</span><span class="kt">int</span> <span class="n">oldRunState</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newRunState</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">RUNSTATE</span><span class="o">,</span> <span class="n">oldRunState</span><span class="o">,</span> <span class="n">newRunState</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stealCounter</span><span class="o">;</span>
              <span class="n">runState</span> <span class="o">=</span> <span class="n">newRunState</span><span class="o">;</span>              <span class="c1">// clears RSIGNAL bit
</span><span class="c1"></span>              <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                  <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span> <span class="n">lock</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span> <span class="o">}</span>
          <span class="o">}</span>
      <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="3submit-提交任务">3.submit 提交任务</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Submits a ForkJoinTask for execution.
</span><span class="cm">     *
</span><span class="cm">     * @param task the task to submit
</span><span class="cm">     * @param &lt;T&gt; the type of the task&#39;s result
</span><span class="cm">     * @return the task
</span><span class="cm">     * @throws NullPointerException if the task is null
</span><span class="cm">     * @throws RejectedExecutionException if the task cannot be
</span><span class="cm">     *         scheduled for execution
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ForkJoinTask</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
        <span class="n">externalPush</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">task</span><span class="o">;</span>
    <span class="o">}</span>

   <span class="cm">/**
</span><span class="cm">    * Tries to add the given task to a submission queue at
</span><span class="cm">    * submitter&#39;s current queue. Only the (vastly) most common path
</span><span class="cm">    * is directly handled in this method, while screening for need
</span><span class="cm">    * for externalSubmit.
</span><span class="cm">    *
</span><span class="cm">    * @param task the task. Caller must ensure non-null.
</span><span class="cm">    */</span>
   <span class="kd">final</span> <span class="kt">void</span> <span class="nf">externalPush</span><span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="n">WorkQueue</span> <span class="n">q</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">;</span>
       <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">getProbe</span><span class="o">();</span> <span class="c1">//xorshift
</span><span class="c1"></span>       <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">runState</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">((</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">))</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
           <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="n">SQMASK</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
           <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">QLOCK</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">))</span> <span class="o">{</span>  <span class="c1">//   m &amp; r &amp; SQMASK 查找index为偶数
</span><span class="c1"></span>           <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span><span class="o">;</span> <span class="kt">int</span> <span class="n">am</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">s</span><span class="o">;</span>
           <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">array</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
               <span class="o">(</span><span class="n">am</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">top</span><span class="o">)</span> <span class="o">-</span> <span class="n">q</span><span class="o">.</span><span class="na">base</span><span class="o">))</span> <span class="o">{</span>
               <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="o">((</span><span class="n">am</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
               <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
               <span class="n">U</span><span class="o">.</span><span class="na">putOrderedInt</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">QTOP</span><span class="o">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
               <span class="n">U</span><span class="o">.</span><span class="na">putIntVolatile</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">QLOCK</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">1</span><span class="o">)</span>                   
                   <span class="n">signalWork</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="n">q</span><span class="o">);</span>
               <span class="k">return</span><span class="o">;</span>
           <span class="o">}</span>
           <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">QLOCK</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
       <span class="o">}</span>
       <span class="n">externalSubmit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="cm">/**
</span><span class="cm">    * Full version of externalPush, handling uncommon cases, as well
</span><span class="cm">    * as performing secondary initialization upon the first
</span><span class="cm">    * submission of the first task to the pool.  It also detects
</span><span class="cm">    * first submission by an external thread and creates a new shared
</span><span class="cm">    * queue if the one at index if empty or contended.
</span><span class="cm">    *
</span><span class="cm">    * @param task the task. Caller must ensure non-null.
</span><span class="cm">    */</span>
   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">externalSubmit</span><span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
       <span class="kt">int</span> <span class="n">r</span><span class="o">;</span>                                    <span class="c1">// initialize caller&#39;s probe
</span><span class="c1"></span>       <span class="k">if</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">getProbe</span><span class="o">())</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">localInit</span><span class="o">();</span>
           <span class="n">r</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">getProbe</span><span class="o">();</span>
       <span class="o">}</span>
       <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
           <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="n">WorkQueue</span> <span class="n">q</span><span class="o">;</span> <span class="kt">int</span> <span class="n">rs</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">k</span><span class="o">;</span>
           <span class="kt">boolean</span> <span class="n">move</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
           <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">runState</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">tryTerminate</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>     <span class="c1">// help terminate
</span><span class="c1"></span>               <span class="k">throw</span> <span class="k">new</span> <span class="n">RejectedExecutionException</span><span class="o">();</span>
           <span class="o">}</span>
           <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">&amp;</span> <span class="n">STARTED</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">||</span>     <span class="c1">// initialize        //初始化过程
</span><span class="c1"></span>                    <span class="o">((</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">))</span> <span class="o">{</span>
               <span class="kt">int</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
               <span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">();</span>
               <span class="k">try</span> <span class="o">{</span>
                   <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">&amp;</span> <span class="n">STARTED</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                       <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STEALCOUNTER</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                                              <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">());</span>
                       <span class="c1">// create workQueues array with size a power of two
</span><span class="c1"></span>                       <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">config</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">;</span> <span class="c1">// ensure at least 2 slots
</span><span class="c1"></span>                       <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">?</span> <span class="n">p</span> <span class="o">-</span> <span class="n">1</span> <span class="o">:</span> <span class="n">1</span><span class="o">;</span>
                       <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">1</span><span class="o">;</span> <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">2</span><span class="o">;</span>  <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">4</span><span class="o">;</span>
                       <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">8</span><span class="o">;</span> <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">16</span><span class="o">;</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">;</span>
                       <span class="n">workQueues</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WorkQueue</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
                       <span class="n">ns</span> <span class="o">=</span> <span class="n">STARTED</span><span class="o">;</span>
                   <span class="o">}</span>
               <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                   <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">)</span> <span class="o">|</span> <span class="n">ns</span><span class="o">);</span>
               <span class="o">}</span>
           <span class="o">}</span>
           <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">q</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[</span><span class="n">k</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="n">SQMASK</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">qlock</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">QLOCK</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">))</span> <span class="o">{</span> <span class="c1">//往WorkQueue添加任务
</span><span class="c1"></span>                   <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">array</span><span class="o">;</span>
                   <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">top</span><span class="o">;</span>
                   <span class="kt">boolean</span> <span class="n">submitted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// initial submission or resizing
</span><span class="c1"></span>                   <span class="k">try</span> <span class="o">{</span>                      <span class="c1">// locked version of push
</span><span class="c1"></span>                       <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">1</span> <span class="o">-</span> <span class="n">q</span><span class="o">.</span><span class="na">base</span><span class="o">)</span> <span class="o">||</span>
                           <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">growArray</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                           <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="o">(((</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
                           <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
                           <span class="n">U</span><span class="o">.</span><span class="na">putOrderedInt</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">QTOP</span><span class="o">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
                           <span class="n">submitted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                       <span class="o">}</span>
                   <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                       <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">QLOCK</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
                   <span class="o">}</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">submitted</span><span class="o">)</span> <span class="o">{</span>
                       <span class="n">signalWork</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="n">q</span><span class="o">);</span>
                       <span class="k">return</span><span class="o">;</span>
                   <span class="o">}</span>
               <span class="o">}</span>
               <span class="n">move</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>                   <span class="c1">// move on failure  重新生成r
</span><span class="c1"></span>           <span class="o">}</span>
           <span class="k">else</span> <span class="k">if</span> <span class="o">(((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">runState</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">RSLOCK</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// create new queue 重新创建WorkQueue
</span><span class="c1"></span>               <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WorkQueue</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
               <span class="n">q</span><span class="o">.</span><span class="na">hint</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
               <span class="n">q</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="n">k</span> <span class="o">|</span> <span class="n">SHARED_QUEUE</span><span class="o">;</span>
               <span class="n">q</span><span class="o">.</span><span class="na">scanState</span> <span class="o">=</span> <span class="n">INACTIVE</span><span class="o">;</span>
               <span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">();</span>           <span class="c1">// publish index
</span><span class="c1"></span>               <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>  <span class="o">(</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                   <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="n">ws</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                   <span class="n">ws</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">q</span><span class="o">;</span>                 <span class="c1">// else terminated
</span><span class="c1"></span>               <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">);</span>
           <span class="o">}</span>
           <span class="k">else</span>
               <span class="n">move</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>                   <span class="c1">// move if busy
</span><span class="c1"></span>           <span class="k">if</span> <span class="o">(</span><span class="n">move</span><span class="o">)</span>
               <span class="n">r</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">advanceProbe</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
       <span class="o">}</span>
   <span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><h3 id="4signalwork-唤醒工作线程">4.signalWork 唤醒工作线程</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
   <span class="cm">/**
</span><span class="cm">    * Tries to create or activate a worker if too few are active.
</span><span class="cm">    *
</span><span class="cm">    * @param ws the worker array to use to find signallees
</span><span class="cm">    * @param q a WorkQueue --if non-null, don&#39;t retry if now empty
</span><span class="cm">    */</span>
   <span class="kd">final</span> <span class="kt">void</span> <span class="nf">signalWork</span><span class="o">(</span><span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">,</span> <span class="n">WorkQueue</span> <span class="n">q</span><span class="o">)</span> <span class="o">{</span>
       <span class="kt">long</span> <span class="n">c</span><span class="o">;</span> <span class="kt">int</span> <span class="n">sp</span><span class="o">,</span> <span class="n">i</span><span class="o">;</span> <span class="n">WorkQueue</span> <span class="n">v</span><span class="o">;</span> <span class="n">Thread</span> <span class="n">p</span><span class="o">;</span>
       <span class="k">while</span> <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0L</span><span class="o">)</span> <span class="o">{</span>                       <span class="c1">// too few active
</span><span class="c1"></span>           <span class="k">if</span> <span class="o">((</span><span class="n">sp</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">c</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>                  <span class="c1">// no idle workers 没有空闲线程
</span><span class="c1"></span>               <span class="k">if</span> <span class="o">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">ADD_WORKER</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0L</span><span class="o">)</span>            <span class="c1">// too few workers  ADD_WORKER=1 &lt;&lt; 47 总启动线程数量最高一位；控制启动最多线程
</span><span class="c1"></span>                   <span class="n">tryAddWorker</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
               <span class="k">break</span><span class="o">;</span>
           <span class="o">}</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>                            <span class="c1">// unstarted/terminated
</span><span class="c1"></span>               <span class="k">break</span><span class="o">;</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;=</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sp</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">))</span>         <span class="c1">// terminated
</span><span class="c1"></span>               <span class="k">break</span><span class="o">;</span>
           <span class="k">if</span> <span class="o">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>                   <span class="c1">// terminating
</span><span class="c1"></span>               <span class="k">break</span><span class="o">;</span>
           <span class="kt">int</span> <span class="n">vs</span> <span class="o">=</span> <span class="o">(</span><span class="n">sp</span> <span class="o">+</span> <span class="n">SS_SEQ</span><span class="o">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INACTIVE</span><span class="o">;</span>        <span class="c1">// next scanState
</span><span class="c1"></span>           <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">sp</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="na">scanState</span><span class="o">;</span>                  <span class="c1">// screen CAS
</span><span class="c1"></span>           <span class="kt">long</span> <span class="n">nc</span> <span class="o">=</span> <span class="o">(</span><span class="n">UC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">AC_UNIT</span><span class="o">))</span> <span class="o">|</span> <span class="o">(</span><span class="n">SP_MASK</span> <span class="o">&amp;</span> <span class="n">v</span><span class="o">.</span><span class="na">stackPred</span><span class="o">);</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">nc</span><span class="o">))</span> <span class="o">{</span>  <span class="c1">//修改ctl 唤醒线程
</span><span class="c1"></span>               <span class="n">v</span><span class="o">.</span><span class="na">scanState</span> <span class="o">=</span> <span class="n">vs</span><span class="o">;</span>                      <span class="c1">// activate v
</span><span class="c1"></span>               <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">parker</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                   <span class="n">U</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
               <span class="k">break</span><span class="o">;</span>
           <span class="o">}</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">.</span><span class="na">base</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="na">top</span><span class="o">)</span>          <span class="c1">// no more work
</span><span class="c1"></span>               <span class="k">break</span><span class="o">;</span>
       <span class="o">}</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="5tryaddworker-创建工作线程">5.tryAddWorker 创建工作线程</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
  <span class="cm">/**
</span><span class="cm">   * Tries to add one worker, incrementing ctl counts before doing
</span><span class="cm">   * so, relying on createWorker to back out on failure.
</span><span class="cm">   *
</span><span class="cm">   * @param c incoming ctl value, with total count negative and no
</span><span class="cm">   * idle workers.  On CAS failure, c is refreshed and retried if
</span><span class="cm">   * this holds (otherwise, a new worker is not needed).
</span><span class="cm">   */</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">tryAddWorker</span><span class="o">(</span><span class="kt">long</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">boolean</span> <span class="n">add</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">do</span> <span class="o">{</span>
          <span class="kt">long</span> <span class="n">nc</span> <span class="o">=</span> <span class="o">((</span><span class="n">AC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">AC_UNIT</span><span class="o">))</span> <span class="o">|</span>
                     <span class="o">(</span><span class="n">TC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">TC_UNIT</span><span class="o">)));</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
              <span class="kt">int</span> <span class="n">rs</span><span class="o">,</span> <span class="n">stop</span><span class="o">;</span>                 <span class="c1">// check if terminating
</span><span class="c1"></span>              <span class="k">if</span> <span class="o">((</span><span class="n">stop</span> <span class="o">=</span> <span class="o">(</span><span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">())</span> <span class="o">&amp;</span> <span class="n">STOP</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
                  <span class="n">add</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">nc</span><span class="o">);</span>
              <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">stop</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
                  <span class="k">break</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">add</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">createWorker</span><span class="o">();</span>
                  <span class="k">break</span><span class="o">;</span>
              <span class="o">}</span>
          <span class="o">}</span>
      <span class="o">}</span> <span class="k">while</span> <span class="o">(((</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">ADD_WORKER</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0L</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">);</span>
  <span class="o">}</span>
  
      <span class="cm">/**
</span><span class="cm">       * Tries to construct and start one worker. Assumes that total
</span><span class="cm">       * count has already been incremented as a reservation.  Invokes
</span><span class="cm">       * deregisterWorker on any failure.
</span><span class="cm">       *
</span><span class="cm">       * @return true if successful
</span><span class="cm">       */</span>
      <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">createWorker</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">ForkJoinWorkerThreadFactory</span> <span class="n">fac</span> <span class="o">=</span> <span class="n">factory</span><span class="o">;</span>
          <span class="n">Throwable</span> <span class="n">ex</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="n">ForkJoinWorkerThread</span> <span class="n">wt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">fac</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">wt</span> <span class="o">=</span> <span class="n">fac</span><span class="o">.</span><span class="na">newThread</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">wt</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
                  <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">rex</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">ex</span> <span class="o">=</span> <span class="n">rex</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">deregisterWorker</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
          <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span>



</code></pre></td></tr></table>
</div>
</div><h3 id="6deregisterworker-注销workqueue数组">6.deregisterWorker 注销WorkQueue数组</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
  <span class="cm">/**
</span><span class="cm">   * Final callback from terminating worker, as well as upon failure
</span><span class="cm">   * to construct or start a worker.  Removes record of worker from
</span><span class="cm">   * array, and adjusts counts. If pool is shutting down, tries to
</span><span class="cm">   * complete termination.
</span><span class="cm">   *
</span><span class="cm">   * @param wt the worker thread, or null if construction failed
</span><span class="cm">   * @param ex the exception causing failure, or null if none
</span><span class="cm">   */</span>
  <span class="kd">final</span> <span class="kt">void</span> <span class="nf">deregisterWorker</span><span class="o">(</span><span class="n">ForkJoinWorkerThread</span> <span class="n">wt</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">WorkQueue</span> <span class="n">w</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">wt</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">wt</span><span class="o">.</span><span class="na">workQueue</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span>                           <span class="c1">// remove index from array
</span><span class="c1"></span>          <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">config</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">;</span>
          <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">((</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">idx</span> <span class="o">&amp;&amp;</span> <span class="n">ws</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span> <span class="o">==</span> <span class="n">w</span><span class="o">)</span>
              <span class="n">ws</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="kt">long</span> <span class="n">c</span><span class="o">;</span>                                       <span class="c1">// decrement counts
</span><span class="c1"></span>      <span class="k">do</span> <span class="o">{}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span>
                   <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">,</span> <span class="o">((</span><span class="n">AC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">AC_UNIT</span><span class="o">))</span> <span class="o">|</span>
                                         <span class="o">(</span><span class="n">TC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">TC_UNIT</span><span class="o">))</span> <span class="o">|</span>
                                         <span class="o">(</span><span class="n">SP_MASK</span> <span class="o">&amp;</span> <span class="n">c</span><span class="o">))));</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">w</span><span class="o">.</span><span class="na">qlock</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>                             <span class="c1">// ensure set
</span><span class="c1"></span>          <span class="n">w</span><span class="o">.</span><span class="na">transferStealCount</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
          <span class="n">w</span><span class="o">.</span><span class="na">cancelAll</span><span class="o">();</span>                            <span class="c1">// cancel remaining tasks
</span><span class="c1"></span>      <span class="o">}</span>
      <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>                                    <span class="c1">// possibly replace
</span><span class="c1"></span>          <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">sp</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">tryTerminate</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span> <span class="o">||</span> <span class="n">w</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">w</span><span class="o">.</span><span class="na">array</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
              <span class="o">(</span><span class="n">runState</span> <span class="o">&amp;</span> <span class="n">STOP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">||</span> <span class="o">(</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
              <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>              <span class="c1">// already terminating
</span><span class="c1"></span>              <span class="k">break</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">((</span><span class="n">sp</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>         <span class="c1">// wake up replacement
</span><span class="c1"></span>              <span class="k">if</span> <span class="o">(</span><span class="n">tryRelease</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">ws</span><span class="o">[</span><span class="n">sp</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">],</span> <span class="n">AC_UNIT</span><span class="o">))</span>
                  <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">ADD_WORKER</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0L</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">tryAddWorker</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>                      <span class="c1">// create replacement
</span><span class="c1"></span>              <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">else</span>                                      <span class="c1">// don&#39;t need replacement
</span><span class="c1"></span>              <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>                               <span class="c1">// help clean on way out
</span><span class="c1"></span>          <span class="n">ForkJoinTask</span><span class="o">.</span><span class="na">helpExpungeStaleExceptions</span><span class="o">();</span>
      <span class="k">else</span>                                          <span class="c1">// rethrow
</span><span class="c1"></span>          <span class="n">ForkJoinTask</span><span class="o">.</span><span class="na">rethrow</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="7registerworker-注册workqueue数组">7.registerWorker 注册WorkQueue数组</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="cm">/**
</span><span class="cm">    * Callback from ForkJoinWorkerThread constructor to establish and
</span><span class="cm">    * record its WorkQueue.
</span><span class="cm">    *
</span><span class="cm">    * @param wt the worker thread
</span><span class="cm">    * @return the worker&#39;s queue
</span><span class="cm">    */</span>
   <span class="kd">final</span> <span class="n">WorkQueue</span> <span class="nf">registerWorker</span><span class="o">(</span><span class="n">ForkJoinWorkerThread</span> <span class="n">wt</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">UncaughtExceptionHandler</span> <span class="n">handler</span><span class="o">;</span>
       <span class="n">wt</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>                           <span class="c1">// configure thread
</span><span class="c1"></span>       <span class="k">if</span> <span class="o">((</span><span class="n">handler</span> <span class="o">=</span> <span class="n">ueh</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
           <span class="n">wt</span><span class="o">.</span><span class="na">setUncaughtExceptionHandler</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
       <span class="n">WorkQueue</span> <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WorkQueue</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">wt</span><span class="o">);</span>
       <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>                                    <span class="c1">// assign a pool index
</span><span class="c1"></span>       <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">config</span> <span class="o">&amp;</span> <span class="n">MODE_MASK</span><span class="o">;</span>
       <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">();</span>
       <span class="k">try</span> <span class="o">{</span>
           <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>                    <span class="c1">// skip if no array
</span><span class="c1"></span>           <span class="k">if</span> <span class="o">((</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
               <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">indexSeed</span> <span class="o">+=</span> <span class="n">SEED_INCREMENT</span><span class="o">;</span>  <span class="c1">// unlikely to collide  SEED_INCREMENT 在11.ThreadLocal源码分析.md具体说明 哈希码能均匀的分布在2的N次方的数组里
</span><span class="c1"></span>               <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
               <span class="n">i</span> <span class="o">=</span> <span class="o">((</span><span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">|</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">;</span>               <span class="c1">// odd-numbered indices  奇数
</span><span class="c1"></span>               <span class="k">if</span> <span class="o">(</span><span class="n">ws</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>                  <span class="c1">// collision
</span><span class="c1"></span>                   <span class="kt">int</span> <span class="n">probes</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>                   <span class="c1">// step by approx half n   大约一半
</span><span class="c1"></span>                   <span class="kt">int</span> <span class="n">step</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">4</span><span class="o">)</span> <span class="o">?</span> <span class="n">2</span> <span class="o">:</span> <span class="o">((</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">EVENMASK</span><span class="o">)</span> <span class="o">+</span> <span class="n">2</span><span class="o">;</span>
                   <span class="k">while</span> <span class="o">(</span><span class="n">ws</span><span class="o">[</span><span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">step</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                       <span class="k">if</span> <span class="o">(++</span><span class="n">probes</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>                   <span class="c1">//扩容
</span><span class="c1"></span>                           <span class="n">workQueues</span> <span class="o">=</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="n">n</span> <span class="o">&lt;&lt;=</span> <span class="n">1</span><span class="o">);</span>
                           <span class="n">m</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
                           <span class="n">probes</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                       <span class="o">}</span>
                   <span class="o">}</span>
               <span class="o">}</span>
               <span class="n">w</span><span class="o">.</span><span class="na">hint</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>                           <span class="c1">// use as random seed
</span><span class="c1"></span>               <span class="n">w</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="n">i</span> <span class="o">|</span> <span class="n">mode</span><span class="o">;</span>
               <span class="n">w</span><span class="o">.</span><span class="na">scanState</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>                      <span class="c1">// publication fence
</span><span class="c1"></span>               <span class="n">ws</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">;</span>
           <span class="o">}</span>
       <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
           <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">);</span>
       <span class="o">}</span>
       <span class="n">wt</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">workerNamePrefix</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">i</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">1</span><span class="o">)));</span>
       <span class="k">return</span> <span class="n">w</span><span class="o">;</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="8runworker-执行工作线程">8.runWorker 执行工作线程</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">   <span class="cm">/**
</span><span class="cm">    * Top-level runloop for workers, called by ForkJoinWorkerThread.run.
</span><span class="cm">    */</span>
   <span class="kd">final</span> <span class="kt">void</span> <span class="nf">runWorker</span><span class="o">(</span><span class="n">WorkQueue</span> <span class="n">w</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">w</span><span class="o">.</span><span class="na">growArray</span><span class="o">();</span>                   <span class="c1">// allocate queue
</span><span class="c1"></span>       <span class="kt">int</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">hint</span><span class="o">;</span>               <span class="c1">// initially holds randomization hint
</span><span class="c1"></span>       <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">seed</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">1</span> <span class="o">:</span> <span class="n">seed</span><span class="o">;</span>  <span class="c1">// avoid 0 for xorShift
</span><span class="c1"></span>       <span class="k">for</span> <span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span><span class="o">;;)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">scan</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">r</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
               <span class="n">w</span><span class="o">.</span><span class="na">runTask</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
           <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">awaitWork</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">r</span><span class="o">))</span>
               <span class="k">break</span><span class="o">;</span>
           <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">13</span><span class="o">;</span> <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">17</span><span class="o">;</span> <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">5</span><span class="o">;</span> <span class="c1">// xorshift
</span><span class="c1"></span>       <span class="o">}</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="9scan-扫描任务">9.scan 扫描任务</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Scans for and tries to steal a top-level task. Scans start at a
</span><span class="cm">     * random location, randomly moving on apparent contention,
</span><span class="cm">     * otherwise continuing linearly until reaching two consecutive
</span><span class="cm">     * empty passes over all queues with the same checksum (summing
</span><span class="cm">     * each base index of each queue, that moves on each steal), at
</span><span class="cm">     * which point the worker tries to inactivate and then re-scans,
</span><span class="cm">     * attempting to re-activate (itself or some other worker) if
</span><span class="cm">     * finding a task; otherwise returning null to await work.  Scans
</span><span class="cm">     * otherwise touch as little memory as possible, to reduce
</span><span class="cm">     * disruption on other scanning threads.
</span><span class="cm">     *
</span><span class="cm">     * @param w the worker (via its WorkQueue)
</span><span class="cm">     * @param r a random seed
</span><span class="cm">     * @return a task, or null if none found
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">scan</span><span class="o">(</span><span class="n">WorkQueue</span> <span class="n">w</span><span class="o">,</span> <span class="kt">int</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">w</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">scanState</span><span class="o">;</span>                     <span class="c1">// initially non-negative
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">origin</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">origin</span><span class="o">,</span> <span class="n">oldSum</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">checkSum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;;)</span> <span class="o">{</span>
                <span class="n">WorkQueue</span> <span class="n">q</span><span class="o">;</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span><span class="o">;</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="n">n</span><span class="o">;</span> <span class="kt">long</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">q</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[</span><span class="n">k</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">base</span><span class="o">)</span> <span class="o">-</span> <span class="n">q</span><span class="o">.</span><span class="na">top</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">array</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>      <span class="c1">// non-empty
</span><span class="c1"></span>                        <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(((</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">b</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="o">((</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;)</span>
                                  <span class="n">U</span><span class="o">.</span><span class="na">getObjectVolatile</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">i</span><span class="o">)))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                            <span class="n">q</span><span class="o">.</span><span class="na">base</span> <span class="o">==</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">ss</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                                    <span class="n">q</span><span class="o">.</span><span class="na">base</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span>       <span class="c1">// signal others
</span><span class="c1"></span>                                        <span class="n">signalWork</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="n">q</span><span class="o">);</span>
                                    <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">oldSum</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>   <span class="c1">// try to activate
</span><span class="c1"></span>                                     <span class="n">w</span><span class="o">.</span><span class="na">scanState</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
                                <span class="n">tryRelease</span><span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">,</span> <span class="n">ws</span><span class="o">[</span><span class="n">m</span> <span class="o">&amp;</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">c</span><span class="o">],</span> <span class="n">AC_UNIT</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">ss</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>                   <span class="c1">// refresh
</span><span class="c1"></span>                            <span class="n">ss</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">scanState</span><span class="o">;</span>
                        <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">;</span> <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">3</span><span class="o">;</span> <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">10</span><span class="o">;</span>
                        <span class="n">origin</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">;</span>           <span class="c1">// move and rescan
</span><span class="c1"></span>                        <span class="n">oldSum</span> <span class="o">=</span> <span class="n">checkSum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">checkSum</span> <span class="o">+=</span> <span class="n">b</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">)</span> <span class="o">==</span> <span class="n">origin</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// continue until stable
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">((</span><span class="n">ss</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">||</span> <span class="o">(</span><span class="n">ss</span> <span class="o">==</span> <span class="o">(</span><span class="n">ss</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">scanState</span><span class="o">)))</span> <span class="o">&amp;&amp;</span>
                        <span class="n">oldSum</span> <span class="o">==</span> <span class="o">(</span><span class="n">oldSum</span> <span class="o">=</span> <span class="n">checkSum</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">ss</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">w</span><span class="o">.</span><span class="na">qlock</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>    <span class="c1">// already inactive
</span><span class="c1"></span>                            <span class="k">break</span><span class="o">;</span>
                        <span class="kt">int</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">ss</span> <span class="o">|</span> <span class="n">INACTIVE</span><span class="o">;</span>       <span class="c1">// try to inactivate
</span><span class="c1"></span>                        <span class="kt">long</span> <span class="n">nc</span> <span class="o">=</span> <span class="o">((</span><span class="n">SP_MASK</span> <span class="o">&amp;</span> <span class="n">ns</span><span class="o">)</span> <span class="o">|</span>
                                   <span class="o">(</span><span class="n">UC_MASK</span> <span class="o">&amp;</span> <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">)</span> <span class="o">-</span> <span class="n">AC_UNIT</span><span class="o">)));</span>
                        <span class="n">w</span><span class="o">.</span><span class="na">stackPred</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">c</span><span class="o">;</span>         <span class="c1">// hold prev stack top
</span><span class="c1"></span>                        <span class="n">U</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">QSCANSTATE</span><span class="o">,</span> <span class="n">ns</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">nc</span><span class="o">))</span>
                            <span class="n">ss</span> <span class="o">=</span> <span class="n">ns</span><span class="o">;</span>
                        <span class="k">else</span>
                            <span class="n">w</span><span class="o">.</span><span class="na">scanState</span> <span class="o">=</span> <span class="n">ss</span><span class="o">;</span>         <span class="c1">// back out
</span><span class="c1"></span>                    <span class="o">}</span>
                    <span class="n">checkSum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
   <span class="cm">/**
</span><span class="cm">    * Signals and releases worker v if it is top of idle worker
</span><span class="cm">    * stack.  This performs a one-shot version of signalWork only if
</span><span class="cm">    * there is (apparently) at least one idle worker.
</span><span class="cm">    *
</span><span class="cm">    * @param c incoming ctl value
</span><span class="cm">    * @param v if non-null, a worker
</span><span class="cm">    * @param inc the increment to active count (zero when compensating)
</span><span class="cm">    * @return true if successful
</span><span class="cm">    */</span>
   <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">tryRelease</span><span class="o">(</span><span class="kt">long</span> <span class="n">c</span><span class="o">,</span> <span class="n">WorkQueue</span> <span class="n">v</span><span class="o">,</span> <span class="kt">long</span> <span class="n">inc</span><span class="o">)</span> <span class="o">{</span>
       <span class="kt">int</span> <span class="n">sp</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">c</span><span class="o">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="o">(</span><span class="n">sp</span> <span class="o">+</span> <span class="n">SS_SEQ</span><span class="o">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INACTIVE</span><span class="o">;</span> <span class="n">Thread</span> <span class="n">p</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">v</span><span class="o">.</span><span class="na">scanState</span> <span class="o">==</span> <span class="n">sp</span><span class="o">)</span> <span class="o">{</span>          <span class="c1">// v is at top of stack
</span><span class="c1"></span>           <span class="kt">long</span> <span class="n">nc</span> <span class="o">=</span> <span class="o">(</span><span class="n">UC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">inc</span><span class="o">))</span> <span class="o">|</span> <span class="o">(</span><span class="n">SP_MASK</span> <span class="o">&amp;</span> <span class="n">v</span><span class="o">.</span><span class="na">stackPred</span><span class="o">);</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">nc</span><span class="o">))</span> <span class="o">{</span>
               <span class="n">v</span><span class="o">.</span><span class="na">scanState</span> <span class="o">=</span> <span class="n">vs</span><span class="o">;</span>
               <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">parker</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                   <span class="n">U</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
               <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
           <span class="o">}</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
   <span class="o">}</span>     
</code></pre></td></tr></table>
</div>
</div><h3 id="10awaitwork-无任务等待">10.awaitWork 无任务等待</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> 
    <span class="cm">/**
</span><span class="cm">     * Possibly blocks worker w waiting for a task to steal, or
</span><span class="cm">     * returns false if the worker should terminate.  If inactivating
</span><span class="cm">     * w has caused the pool to become quiescent, checks for pool
</span><span class="cm">     * termination, and, so long as this is not the only worker, waits
</span><span class="cm">     * for up to a given duration.  On timeout, if ctl has not
</span><span class="cm">     * changed, terminates the worker, which will in turn wake up
</span><span class="cm">     * another worker to possibly repeat this process.
</span><span class="cm">     *
</span><span class="cm">     * @param w the calling worker
</span><span class="cm">     * @param r a random seed (for spins)
</span><span class="cm">     * @return false if the worker should terminate
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">awaitWork</span><span class="o">(</span><span class="n">WorkQueue</span> <span class="n">w</span><span class="o">,</span> <span class="kt">int</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">w</span><span class="o">.</span><span class="na">qlock</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>                 <span class="c1">// w is terminating
</span><span class="c1"></span>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">stackPred</span><span class="o">,</span> <span class="n">spins</span> <span class="o">=</span> <span class="n">SPINS</span><span class="o">,</span> <span class="n">ss</span><span class="o">;;)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">ss</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">scanState</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">6</span><span class="o">;</span> <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">21</span><span class="o">;</span> <span class="n">r</span> <span class="o">^=</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">7</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">spins</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>         <span class="c1">// randomize spins 随机旋转,判断stackPred(前等待线程scanState)该等待线程的为空，在重新自选
</span><span class="c1"></span>                    <span class="n">WorkQueue</span> <span class="n">v</span><span class="o">;</span> <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="kt">int</span> <span class="n">s</span><span class="o">,</span> <span class="n">j</span><span class="o">;</span> <span class="n">AtomicLong</span> <span class="n">sc</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[</span><span class="n">j</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>        <span class="c1">// see if pred parking
</span><span class="c1"></span>                        <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">parker</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">v</span><span class="o">.</span><span class="na">scanState</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">))</span>
                        <span class="n">spins</span> <span class="o">=</span> <span class="n">SPINS</span><span class="o">;</span>                <span class="c1">// continue spinning
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">qlock</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>                     <span class="c1">// recheck after spins
</span><span class="c1"></span>                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">c</span><span class="o">,</span> <span class="n">prevctl</span><span class="o">,</span> <span class="n">parkTime</span><span class="o">,</span> <span class="n">deadline</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">ac</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)((</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="n">AC_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">ac</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">tryTerminate</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">||</span>
                    <span class="o">(</span><span class="n">runState</span> <span class="o">&amp;</span> <span class="n">STOP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>           <span class="c1">// pool terminating
</span><span class="c1"></span>                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ac</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">ss</span> <span class="o">==</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">c</span><span class="o">)</span> <span class="o">{</span>        <span class="c1">// is last waiter
</span><span class="c1"></span>                    <span class="n">prevctl</span> <span class="o">=</span> <span class="o">(</span><span class="n">UC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">AC_UNIT</span><span class="o">))</span> <span class="o">|</span> <span class="o">(</span><span class="n">SP_MASK</span> <span class="o">&amp;</span> <span class="n">pred</span><span class="o">);</span>
                    <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)(</span><span class="n">c</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">TC_SHIFT</span><span class="o">);</span>  <span class="c1">// shrink excess spares
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">2</span> <span class="o">&amp;&amp;</span> <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">prevctl</span><span class="o">))</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>                 <span class="c1">// else use timed wait
</span><span class="c1"></span>                    <span class="n">parkTime</span> <span class="o">=</span> <span class="n">IDLE_TIMEOUT</span> <span class="o">*</span> <span class="o">((</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">1</span> <span class="o">:</span> <span class="n">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">);</span>
                    <span class="n">deadline</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">parkTime</span> <span class="o">-</span> <span class="n">TIMEOUT_SLOP</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">else</span>
                    <span class="n">prevctl</span> <span class="o">=</span> <span class="n">parkTime</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
                <span class="n">Thread</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                <span class="n">U</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">PARKBLOCKER</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>   <span class="c1">// emulate LockSupport
</span><span class="c1"></span>                <span class="n">w</span><span class="o">.</span><span class="na">parker</span> <span class="o">=</span> <span class="n">wt</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">scanState</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">ctl</span> <span class="o">==</span> <span class="n">c</span><span class="o">)</span>      <span class="c1">// recheck before park
</span><span class="c1"></span>                    <span class="n">U</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">parkTime</span><span class="o">);</span>
                <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">QPARKER</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="n">U</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">PARKBLOCKER</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">scanState</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">parkTime</span> <span class="o">!=</span> <span class="n">0L</span> <span class="o">&amp;&amp;</span> <span class="n">ctl</span> <span class="o">==</span> <span class="n">c</span> <span class="o">&amp;&amp;</span>
                    <span class="n">deadline</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">0L</span> <span class="o">&amp;&amp;</span>
                    <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">prevctl</span><span class="o">))</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>                     <span class="c1">// shrink pool
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="11awaitjoin-join操作">11.awaitJoin join操作</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
  <span class="cm">/**
</span><span class="cm">   * Helps and/or blocks until the given task is done or timeout.
</span><span class="cm">   *
</span><span class="cm">   * @param w caller
</span><span class="cm">   * @param task the task
</span><span class="cm">   * @param deadline for timed waits, if nonzero
</span><span class="cm">   * @return task status on exit
</span><span class="cm">   */</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="nf">awaitJoin</span><span class="o">(</span><span class="n">WorkQueue</span> <span class="n">w</span><span class="o">,</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">,</span> <span class="kt">long</span> <span class="n">deadline</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">w</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">prevJoin</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">currentJoin</span><span class="o">;</span>
          <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">QCURRENTJOIN</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
          <span class="n">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">cc</span> <span class="o">=</span> <span class="o">(</span><span class="n">task</span> <span class="k">instanceof</span> <span class="n">CountedCompleter</span><span class="o">)</span> <span class="o">?</span>
              <span class="o">(</span><span class="n">CountedCompleter</span><span class="o">&lt;?&gt;)</span><span class="n">task</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
          <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="na">status</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
                  <span class="k">break</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                  <span class="n">helpComplete</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">cc</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
              <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">base</span> <span class="o">==</span> <span class="n">w</span><span class="o">.</span><span class="na">top</span> <span class="o">||</span> <span class="n">w</span><span class="o">.</span><span class="na">tryRemoveAndExec</span><span class="o">(</span><span class="n">task</span><span class="o">))</span>
                  <span class="n">helpStealer</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="na">status</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
                  <span class="k">break</span><span class="o">;</span>
              <span class="kt">long</span> <span class="n">ms</span><span class="o">,</span> <span class="n">ns</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">deadline</span> <span class="o">==</span> <span class="n">0L</span><span class="o">)</span>
                  <span class="n">ms</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
              <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">ns</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">())</span> <span class="o">&lt;=</span> <span class="n">0L</span><span class="o">)</span>
                  <span class="k">break</span><span class="o">;</span>
              <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">ms</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">ns</span><span class="o">))</span> <span class="o">&lt;=</span> <span class="n">0L</span><span class="o">)</span>
                  <span class="n">ms</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">tryCompensate</span><span class="o">(</span><span class="n">w</span><span class="o">))</span> <span class="o">{</span>
                  <span class="n">task</span><span class="o">.</span><span class="na">internalWait</span><span class="o">(</span><span class="n">ms</span><span class="o">);</span>
                  <span class="n">U</span><span class="o">.</span><span class="na">getAndAddLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">AC_UNIT</span><span class="o">);</span>
              <span class="o">}</span>
          <span class="o">}</span>
          <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">QCURRENTJOIN</span><span class="o">,</span> <span class="n">prevJoin</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
  <span class="o">}</span>
 <span class="cm">/**
</span><span class="cm">   * Tries to decrement active count (sometimes implicitly) and
</span><span class="cm">   * possibly release or create a compensating worker in preparation
</span><span class="cm">   * for blocking. Returns false (retryable by caller), on
</span><span class="cm">   * contention, detected staleness, instability, or termination.
</span><span class="cm">   *
</span><span class="cm">   * @param w caller
</span><span class="cm">   */</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">tryCompensate</span><span class="o">(</span><span class="n">WorkQueue</span> <span class="n">w</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">boolean</span> <span class="n">canBlock</span><span class="o">;</span>
      <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="kt">long</span> <span class="n">c</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span> <span class="n">sp</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">w</span><span class="o">.</span><span class="na">qlock</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>           <span class="c1">// caller terminating
</span><span class="c1"></span>          <span class="o">(</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">||</span>
          <span class="o">(</span><span class="n">pc</span> <span class="o">=</span> <span class="n">config</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>           <span class="c1">// parallelism disabled
</span><span class="c1"></span>          <span class="n">canBlock</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">sp</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>      <span class="c1">// release idle worker
</span><span class="c1"></span>          <span class="n">canBlock</span> <span class="o">=</span> <span class="n">tryRelease</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">ws</span><span class="o">[</span><span class="n">sp</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">],</span> <span class="n">0L</span><span class="o">);</span>
      <span class="k">else</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">ac</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="n">AC_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">pc</span><span class="o">;</span>
          <span class="kt">int</span> <span class="n">tc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="n">TC_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">pc</span><span class="o">;</span>
          <span class="kt">int</span> <span class="n">nbusy</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>                        <span class="c1">// validate saturation
</span><span class="c1"></span>          <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>        <span class="c1">// two passes of odd indices
</span><span class="c1"></span>              <span class="n">WorkQueue</span> <span class="n">v</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[((</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">|</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">((</span><span class="n">v</span><span class="o">.</span><span class="na">scanState</span> <span class="o">&amp;</span> <span class="n">SCANNING</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
                      <span class="k">break</span><span class="o">;</span>
                  <span class="o">++</span><span class="n">nbusy</span><span class="o">;</span>
              <span class="o">}</span>
          <span class="o">}</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">nbusy</span> <span class="o">!=</span> <span class="o">(</span><span class="n">tc</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">||</span> <span class="n">ctl</span> <span class="o">!=</span> <span class="n">c</span><span class="o">)</span>
              <span class="n">canBlock</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                 <span class="c1">// unstable or stale
</span><span class="c1"></span>          <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tc</span> <span class="o">&gt;=</span> <span class="n">pc</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span> <span class="o">&gt;</span> <span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
              <span class="kt">long</span> <span class="n">nc</span> <span class="o">=</span> <span class="o">((</span><span class="n">AC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">AC_UNIT</span><span class="o">))</span> <span class="o">|</span>
                         <span class="o">(~</span><span class="n">AC_MASK</span> <span class="o">&amp;</span> <span class="n">c</span><span class="o">));</span>       <span class="c1">// uncompensated
</span><span class="c1"></span>              <span class="n">canBlock</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">nc</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tc</span> <span class="o">&gt;=</span> <span class="n">MAX_CAP</span> <span class="o">||</span>
                   <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">common</span> <span class="o">&amp;&amp;</span> <span class="n">tc</span> <span class="o">&gt;=</span> <span class="n">pc</span> <span class="o">+</span> <span class="n">commonMaxSpares</span><span class="o">))</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="n">RejectedExecutionException</span><span class="o">(</span>
                  <span class="s">&#34;Thread limit exceeded replacing blocked worker&#34;</span><span class="o">);</span>
          <span class="k">else</span> <span class="o">{</span>                                <span class="c1">// similar to tryAddWorker
</span><span class="c1"></span>              <span class="kt">boolean</span> <span class="n">add</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="kt">int</span> <span class="n">rs</span><span class="o">;</span>      <span class="c1">// CAS within lock
</span><span class="c1"></span>              <span class="kt">long</span> <span class="n">nc</span> <span class="o">=</span> <span class="o">((</span><span class="n">AC_MASK</span> <span class="o">&amp;</span> <span class="n">c</span><span class="o">)</span> <span class="o">|</span>
                         <span class="o">(</span><span class="n">TC_MASK</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">TC_UNIT</span><span class="o">)));</span>
              <span class="k">if</span> <span class="o">(((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">())</span> <span class="o">&amp;</span> <span class="n">STOP</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
                  <span class="n">add</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">CTL</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">nc</span><span class="o">);</span>
              <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">);</span>
              <span class="n">canBlock</span> <span class="o">=</span> <span class="n">add</span> <span class="o">&amp;&amp;</span> <span class="n">createWorker</span><span class="o">();</span> <span class="c1">// throws on exception
</span><span class="c1"></span>          <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">canBlock</span><span class="o">;</span>
  <span class="o">}</span>
  
 <span class="cm">/**
</span><span class="cm">   * Tries to locate and execute tasks for a stealer of the given
</span><span class="cm">   * task, or in turn one of its stealers, Traces currentSteal -&gt;
</span><span class="cm">   * currentJoin links looking for a thread working on a descendant
</span><span class="cm">   * of the given task and with a non-empty queue to steal back and
</span><span class="cm">   * execute tasks from. The first call to this method upon a
</span><span class="cm">   * waiting join will often entail scanning/search, (which is OK
</span><span class="cm">   * because the joiner has nothing better to do), but this method
</span><span class="cm">   * leaves hints in workers to speed up subsequent calls.
</span><span class="cm">   *
</span><span class="cm">   * @param w caller
</span><span class="cm">   * @param task the task to join
</span><span class="cm">   */</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">helpStealer</span><span class="o">(</span><span class="n">WorkQueue</span> <span class="n">w</span><span class="o">,</span> <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">;</span>
      <span class="kt">int</span> <span class="n">oldSum</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">checkSum</span><span class="o">,</span> <span class="n">m</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">w</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
          <span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">do</span> <span class="o">{</span>                                       <span class="c1">// restart point
</span><span class="c1"></span>              <span class="n">checkSum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>                          <span class="c1">// for stability check
</span><span class="c1"></span>              <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">subtask</span><span class="o">;</span>
              <span class="n">WorkQueue</span> <span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">,</span> <span class="n">v</span><span class="o">;</span>                    <span class="c1">// v is subtask stealer
</span><span class="c1"></span>              <span class="n">descent</span><span class="o">:</span> <span class="k">for</span> <span class="o">(</span><span class="n">subtask</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span> <span class="n">subtask</span><span class="o">.</span><span class="na">status</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="na">hint</span> <span class="o">|</span> <span class="n">1</span><span class="o">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">i</span><span class="o">;</span> <span class="o">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span>                     <span class="c1">// can&#39;t find stealer
</span><span class="c1"></span>                          <span class="k">break</span> <span class="n">descent</span><span class="o">;</span>
                      <span class="k">if</span> <span class="o">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[</span><span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">k</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                          <span class="k">if</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">currentSteal</span> <span class="o">==</span> <span class="n">subtask</span><span class="o">)</span> <span class="o">{</span>
                              <span class="n">j</span><span class="o">.</span><span class="na">hint</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
                              <span class="k">break</span><span class="o">;</span>
                          <span class="o">}</span>
                          <span class="n">checkSum</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="na">base</span><span class="o">;</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
                  <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>                         <span class="c1">// help v or descend
</span><span class="c1"></span>                      <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;[]</span> <span class="n">a</span><span class="o">;</span> <span class="kt">int</span> <span class="n">b</span><span class="o">;</span>
                      <span class="n">checkSum</span> <span class="o">+=</span> <span class="o">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">base</span><span class="o">);</span>
                      <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">currentJoin</span><span class="o">;</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">subtask</span><span class="o">.</span><span class="na">status</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">j</span><span class="o">.</span><span class="na">currentJoin</span> <span class="o">!=</span> <span class="n">subtask</span> <span class="o">||</span>
                          <span class="n">v</span><span class="o">.</span><span class="na">currentSteal</span> <span class="o">!=</span> <span class="n">subtask</span><span class="o">)</span> <span class="c1">// stale
</span><span class="c1"></span>                          <span class="k">break</span> <span class="n">descent</span><span class="o">;</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="na">top</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">||</span> <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">array</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                          <span class="k">if</span> <span class="o">((</span><span class="n">subtask</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                              <span class="k">break</span> <span class="n">descent</span><span class="o">;</span>
                          <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
                          <span class="k">break</span><span class="o">;</span>
                      <span class="o">}</span>
                      <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(((</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">b</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="n">ABASE</span><span class="o">;</span>
                      <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">((</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;)</span>
                                           <span class="n">U</span><span class="o">.</span><span class="na">getObjectVolatile</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">i</span><span class="o">));</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">base</span> <span class="o">==</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                          <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>             <span class="c1">// stale
</span><span class="c1"></span>                              <span class="k">break</span> <span class="n">descent</span><span class="o">;</span>
                          <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                              <span class="n">v</span><span class="o">.</span><span class="na">base</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
                              <span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">currentSteal</span><span class="o">;</span>
                              <span class="kt">int</span> <span class="n">top</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">top</span><span class="o">;</span>
                              <span class="k">do</span> <span class="o">{</span>
                                  <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">QCURRENTSTEAL</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
                                  <span class="n">t</span><span class="o">.</span><span class="na">doExec</span><span class="o">();</span>        <span class="c1">// clear local tasks too
</span><span class="c1"></span>                              <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">status</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
                                       <span class="n">w</span><span class="o">.</span><span class="na">top</span> <span class="o">!=</span> <span class="n">top</span> <span class="o">&amp;&amp;</span>
                                       <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">pop</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
                              <span class="n">U</span><span class="o">.</span><span class="na">putOrderedObject</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">QCURRENTSTEAL</span><span class="o">,</span> <span class="n">ps</span><span class="o">);</span>
                              <span class="k">if</span> <span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">base</span> <span class="o">!=</span> <span class="n">w</span><span class="o">.</span><span class="na">top</span><span class="o">)</span>
                                  <span class="k">return</span><span class="o">;</span>            <span class="c1">// can&#39;t further help
</span><span class="c1"></span>                          <span class="o">}</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">status</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">oldSum</span> <span class="o">!=</span> <span class="o">(</span><span class="n">oldSum</span> <span class="o">=</span> <span class="n">checkSum</span><span class="o">));</span>
      <span class="o">}</span>
  <span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><h3 id="12shutdown">12.shutdown</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
    <span class="cm">/**
</span><span class="cm">     * Possibly initiates an orderly shutdown in which previously
</span><span class="cm">     * submitted tasks are executed, but no new tasks will be
</span><span class="cm">     * accepted. Invocation has no effect on execution state if this
</span><span class="cm">     * is the {@link #commonPool()}, and no additional effect if
</span><span class="cm">     * already shut down.  Tasks that are in the process of being
</span><span class="cm">     * submitted concurrently during the course of this method may or
</span><span class="cm">     * may not be rejected.
</span><span class="cm">     *
</span><span class="cm">     * @throws SecurityException if a security manager exists and
</span><span class="cm">     *         the caller is not permitted to modify threads
</span><span class="cm">     *         because it does not hold {@link
</span><span class="cm">     *         java.lang.RuntimePermission}{@code (&#34;modifyThread&#34;)}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">checkPermission</span><span class="o">();</span>
        <span class="n">tryTerminate</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
   <span class="cm">/**
</span><span class="cm">     * Possibly initiates and/or completes termination.
</span><span class="cm">     *
</span><span class="cm">     * @param now if true, unconditionally terminate, else only
</span><span class="cm">     * if no work and no active workers
</span><span class="cm">     * @param enable if true, enable shutdown when next possible
</span><span class="cm">     * @return true if now terminating or terminated
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">tryTerminate</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">now</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">enable</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">rs</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">common</span><span class="o">)</span>                       <span class="c1">// cannot shut down
</span><span class="c1"></span>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">runState</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">enable</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">();</span>                  <span class="c1">// enter SHUTDOWN phase
</span><span class="c1"></span>            <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">)</span> <span class="o">|</span> <span class="n">SHUTDOWN</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">&amp;</span> <span class="n">STOP</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">now</span><span class="o">)</span> <span class="o">{</span>                           <span class="c1">// check quiescence
</span><span class="c1"></span>                <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">oldSum</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;;)</span> <span class="o">{</span>        <span class="c1">// repeat until stable
</span><span class="c1"></span>                    <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="n">WorkQueue</span> <span class="n">w</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">b</span><span class="o">;</span> <span class="kt">long</span> <span class="n">c</span><span class="o">;</span>
                    <span class="kt">long</span> <span class="n">checkSum</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="kt">int</span><span class="o">)(</span><span class="n">checkSum</span> <span class="o">&gt;&gt;</span> <span class="n">AC_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>             <span class="c1">// still active workers
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">((</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                        <span class="k">break</span><span class="o">;</span>                    <span class="c1">// check queues
</span><span class="c1"></span>                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">w</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">base</span><span class="o">)</span> <span class="o">!=</span> <span class="n">w</span><span class="o">.</span><span class="na">top</span> <span class="o">||</span> <span class="n">w</span><span class="o">.</span><span class="na">scanState</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">||</span>
                                <span class="n">w</span><span class="o">.</span><span class="na">currentSteal</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">tryRelease</span><span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">,</span> <span class="n">ws</span><span class="o">[</span><span class="n">m</span> <span class="o">&amp;</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">c</span><span class="o">],</span> <span class="n">AC_UNIT</span><span class="o">);</span>
                                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>     <span class="c1">// arrange for recheck
</span><span class="c1"></span>                            <span class="o">}</span>
                            <span class="n">checkSum</span> <span class="o">+=</span> <span class="n">b</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">1</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
                                <span class="n">w</span><span class="o">.</span><span class="na">qlock</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>     <span class="c1">// try to disable external
</span><span class="c1"></span>                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">oldSum</span> <span class="o">==</span> <span class="o">(</span><span class="n">oldSum</span> <span class="o">=</span> <span class="n">checkSum</span><span class="o">))</span>
                        <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">runState</span> <span class="o">&amp;</span> <span class="n">STOP</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">();</span>              <span class="c1">// enter STOP phase
</span><span class="c1"></span>                <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">)</span> <span class="o">|</span> <span class="n">STOP</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">pass</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>                             <span class="c1">// 3 passes to help terminate
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">oldSum</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;;)</span> <span class="o">{</span>                <span class="c1">// or until done or stable
</span><span class="c1"></span>            <span class="n">WorkQueue</span><span class="o">[]</span> <span class="n">ws</span><span class="o">;</span> <span class="n">WorkQueue</span> <span class="n">w</span><span class="o">;</span> <span class="n">ForkJoinWorkerThread</span> <span class="n">wt</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">checkSum</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="kt">short</span><span class="o">)(</span><span class="n">checkSum</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">TC_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">SMASK</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">||</span>
                <span class="o">(</span><span class="n">ws</span> <span class="o">=</span> <span class="n">workQueues</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">runState</span> <span class="o">&amp;</span> <span class="n">TERMINATED</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">rs</span> <span class="o">=</span> <span class="n">lockRunState</span><span class="o">();</span>          <span class="c1">// done
</span><span class="c1"></span>                    <span class="n">unlockRunState</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RSLOCK</span><span class="o">)</span> <span class="o">|</span> <span class="n">TERMINATED</span><span class="o">);</span>
                    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span> <span class="n">notifyAll</span><span class="o">();</span> <span class="o">}</span> <span class="c1">// for awaitTermination
</span><span class="c1"></span>                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">w</span> <span class="o">=</span> <span class="n">ws</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">checkSum</span> <span class="o">+=</span> <span class="n">w</span><span class="o">.</span><span class="na">base</span><span class="o">;</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">qlock</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>                 <span class="c1">// try to disable
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">pass</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">w</span><span class="o">.</span><span class="na">cancelAll</span><span class="o">();</span>            <span class="c1">// clear queue
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">pass</span> <span class="o">&gt;</span> <span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">wt</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">owner</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(!</span><span class="n">wt</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                                <span class="k">try</span> <span class="o">{</span>             <span class="c1">// unblock join
</span><span class="c1"></span>                                    <span class="n">wt</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
                                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">scanState</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
                                <span class="n">U</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">wt</span><span class="o">);</span>     <span class="c1">// wake up
</span><span class="c1"></span>                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">checkSum</span> <span class="o">!=</span> <span class="n">oldSum</span><span class="o">)</span> <span class="o">{</span>             <span class="c1">// unstable
</span><span class="c1"></span>                <span class="n">oldSum</span> <span class="o">=</span> <span class="n">checkSum</span><span class="o">;</span>
                <span class="n">pass</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pass</span> <span class="o">&gt;</span> <span class="n">3</span> <span class="o">&amp;&amp;</span> <span class="n">pass</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span>        <span class="c1">// can&#39;t further help
</span><span class="c1"></span>                <span class="k">break</span><span class="o">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(++</span><span class="n">pass</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">// try to dequeue
</span><span class="c1"></span>                <span class="kt">long</span> <span class="n">c</span><span class="o">;</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">sp</span><span class="o">;</span>            <span class="c1">// bound attempts
</span><span class="c1"></span>                <span class="k">while</span> <span class="o">(</span><span class="n">j</span><span class="o">++</span> <span class="o">&lt;=</span> <span class="n">m</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">sp</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
                    <span class="n">tryRelease</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">ws</span><span class="o">[</span><span class="n">sp</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">],</span> <span class="n">AC_UNIT</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="四forkjoinworkerthread线程">四、ForkJoinWorkerThread线程</h2>
<h3 id="1构造">1.构造</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> 
   <span class="kd">final</span> <span class="n">ForkJoinPool</span> <span class="n">pool</span><span class="o">;</span>                <span class="c1">// the pool this thread works in
</span><span class="c1"></span>   <span class="kd">final</span> <span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">WorkQueue</span> <span class="n">workQueue</span><span class="o">;</span> <span class="c1">// work-stealing mechanics
</span><span class="c1"></span>
   <span class="cm">/**
</span><span class="cm">    * Creates a ForkJoinWorkerThread operating in the given pool.
</span><span class="cm">    *
</span><span class="cm">    * @param pool the pool this thread works in
</span><span class="cm">    * @throws NullPointerException if pool is null
</span><span class="cm">    */</span>
   <span class="kd">protected</span> <span class="nf">ForkJoinWorkerThread</span><span class="o">(</span><span class="n">ForkJoinPool</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
       <span class="c1">// Use a placeholder until a useful name can be set in registerWorker
</span><span class="c1"></span>       <span class="kd">super</span><span class="o">(</span><span class="s">&#34;aForkJoinWorkerThread&#34;</span><span class="o">);</span>
       <span class="k">this</span><span class="o">.</span><span class="na">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="o">;</span>
       <span class="k">this</span><span class="o">.</span><span class="na">workQueue</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">registerWorker</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="2run">2.run</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
   <span class="cm">/**
</span><span class="cm">    * This method is required to be public, but should never be
</span><span class="cm">    * called explicitly. It performs the main run loop to execute
</span><span class="cm">    * {@link ForkJoinTask}s.
</span><span class="cm">    */</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">workQueue</span><span class="o">.</span><span class="na">array</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// only run once
</span><span class="c1"></span>           <span class="n">Throwable</span> <span class="n">exception</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
           <span class="k">try</span> <span class="o">{</span>
               <span class="n">onStart</span><span class="o">();</span>
               <span class="n">pool</span><span class="o">.</span><span class="na">runWorker</span><span class="o">(</span><span class="n">workQueue</span><span class="o">);</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">exception</span> <span class="o">=</span> <span class="n">ex</span><span class="o">;</span>
           <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
               <span class="k">try</span> <span class="o">{</span>
                   <span class="n">onTermination</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
               <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                       <span class="n">exception</span> <span class="o">=</span> <span class="n">ex</span><span class="o">;</span>
               <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                   <span class="n">pool</span><span class="o">.</span><span class="na">deregisterWorker</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
               <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="五forkjointask源码分析">五、ForkJoinTask源码分析</h2>
<p>ForkJoinTask抽象类实现Future接口</p>
<p><img src="/concurrent//FutrureMethod.png" alt=""></p>
<h3 id="1forkjointask构造">1.ForkJoinTask构造</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ForkJoinTask</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;,</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="cm">/*
</span><span class="cm">     * See the internal documentation of class ForkJoinPool for a
</span><span class="cm">     * general implementation overview.  ForkJoinTasks are mainly
</span><span class="cm">     * responsible for maintaining their &#34;status&#34; field amidst relays
</span><span class="cm">     * to methods in ForkJoinWorkerThread and ForkJoinPool.
</span><span class="cm">     * 
</span><span class="cm">     * 请参阅ForkJoinPool类的内部文档以获取常规实施概述。 
</span><span class="cm">     * ForkJoinTasks主要负责在中继到ForkJoinWorkerThread和ForkJoinPool中的方法中维护其&#34;status&#34;字段。
</span><span class="cm">     * 
</span><span class="cm">     * 
</span><span class="cm">     *
</span><span class="cm">     * The methods of this class are more-or-less layered into
</span><span class="cm">     * 这个类的方法或多或少分层
</span><span class="cm">     * (1) basic status maintenance  基本的状态维护
</span><span class="cm">     * (2) execution and awaiting completion  执行和等待完成
</span><span class="cm">     * (3) user-level methods that additionally report results. 用户级别的方法，另外报告结果。
</span><span class="cm">     * This is sometimes hard to see because this file orders exported
</span><span class="cm">     * methods in a way that flows well in javadocs.
</span><span class="cm">     * 有时候很难看到这个文件，因为这个文件在javadoc中以一种流畅的方式命令导出的方法。
</span><span class="cm">     */</span>

    <span class="cm">/*
</span><span class="cm">     * The status field holds run control status bits packed into a
</span><span class="cm">     * single int to minimize footprint and to ensure atomicity (via
</span><span class="cm">     * CAS).  Status is initially zero, and takes on nonnegative
</span><span class="cm">     * values until completed, upon which status (anded with
</span><span class="cm">     * DONE_MASK) holds value NORMAL, CANCELLED, or EXCEPTIONAL. Tasks
</span><span class="cm">     * undergoing blocking waits by other threads have the SIGNAL bit
</span><span class="cm">     * set.  Completion of a stolen task with SIGNAL set awakens any
</span><span class="cm">     * waiters via notifyAll. Even though suboptimal for some
</span><span class="cm">     * purposes, we use basic builtin wait/notify to take advantage of
</span><span class="cm">     * &#34;monitor inflation&#34; in JVMs that we would otherwise need to
</span><span class="cm">     * emulate to avoid adding further per-task bookkeeping overhead.
</span><span class="cm">     * We want these monitors to be &#34;fat&#34;, i.e., not use biasing or
</span><span class="cm">     * thin-lock techniques, so use some odd coding idioms that tend
</span><span class="cm">     * to avoid them, mainly by arranging that every synchronized
</span><span class="cm">     * block performs a wait, notifyAll or both.
</span><span class="cm">     * 
</span><span class="cm">     * status字段将运行控制状态位保存在一个int中，以最小化占用空间并确保原子性（通过CAS）。status初始为零，并且在完成之前呈现非负值，
</span><span class="cm">     * 在此status（用DONE_MASK结束）保持NORMAL（正常），CANCELLED（取消）或EXCEPTIONAL（异常）值。
</span><span class="cm">     * 由其他线程阻塞等待的任务将设置SIGNAL位。通过SIGNAL设置完成被盗任务，通过notifyAll唤醒任何waiters。尽管对于某些目的而言不是最理想的，
</span><span class="cm">     * 但我们使用基本的内建wait/notify来利用JVM中的&#34;monitor inflation&#34;，否则我们需要模拟这些优先级以避免增加每个任务的簿记开销。
</span><span class="cm">     * 我们希望这些监视器是&#34;fat&#34;的，即不使用偏置或薄锁技术，所以使用一些奇怪的编码习惯用法来避免它们，主要是通过安排每个同步块执行等待，notifyAll或两者。
</span><span class="cm">     *
</span><span class="cm">     * These control bits occupy only (some of) the upper half (16
</span><span class="cm">     * bits) of status field. The lower bits are used for user-defined
</span><span class="cm">     * tags.
</span><span class="cm">     * 这些控制位仅占用状态字段的上半部分（16位）（部分）。低位用于用户定义的标签。
</span><span class="cm">     */</span>

    <span class="cm">/** The run status of this task */</span>
    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">status</span><span class="o">;</span> <span class="c1">// accessed directly by pool and workers
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DONE_MASK</span>   <span class="o">=</span> <span class="n">0xf0000000</span><span class="o">;</span>  <span class="c1">// mask out non-completion bits 1111 0000 0000 0000 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NORMAL</span>      <span class="o">=</span> <span class="n">0xf0000000</span><span class="o">;</span>  <span class="c1">// must be negative             1111 0000 0000 0000 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CANCELLED</span>   <span class="o">=</span> <span class="n">0xc0000000</span><span class="o">;</span>  <span class="c1">// must be &lt; NORMAL             1100 0000 0000 0000 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">EXCEPTIONAL</span> <span class="o">=</span> <span class="n">0x80000000</span><span class="o">;</span>  <span class="c1">// must be &lt; CANCELLED          1000 0000 0000 0000 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SIGNAL</span>      <span class="o">=</span> <span class="n">0x00010000</span><span class="o">;</span>  <span class="c1">// must be &gt;= 1 &lt;&lt; 16           0000 0000 0000 0001 0000 0000 0000 0000
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SMASK</span>       <span class="o">=</span> <span class="n">0x0000ffff</span><span class="o">;</span>  <span class="c1">// short bits for tags          0000 0000 0000 0000 1111 1111 1111 1111
</span><span class="c1"></span>    
    
    <span class="cm">/**
</span><span class="cm">     * Table of exceptions thrown by tasks, to enable reporting by
</span><span class="cm">     * callers. Because exceptions are rare, we don&#39;t directly keep
</span><span class="cm">     * them with task objects, but instead use a weak ref table.  Note
</span><span class="cm">     * that cancellation exceptions don&#39;t appear in the table, but are
</span><span class="cm">     * instead recorded as status values.
</span><span class="cm">     * 由任务引发的异常表，以使调用者能够进行报告。由于异常很少，我们不直接使用任务对象，而是使用弱引用表。
</span><span class="cm">     * 请注意，取消异常不会出现在表格中，而是记录为状态值。
</span><span class="cm">     *
</span><span class="cm">     * Note: These statics are initialized below in static block. 注意:这些静态块在静态块中被初始化。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ExceptionNode</span><span class="o">[]</span> <span class="n">exceptionTable</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">exceptionTableLock</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ReferenceQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">exceptionTableRefQueue</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Fixed capacity for exceptionTable. 固定的异常表容量。
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">EXCEPTION_MAP_CAPACITY</span> <span class="o">=</span> <span class="n">32</span><span class="o">;</span>    
    
 <span class="o">}</span>   
    
    
</code></pre></td></tr></table>
</div>
</div><h3 id="2-exceptionnode-异常节点">2. ExceptionNode 异常节点</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Key-value nodes for exception table.  The chained hash table
</span><span class="cm">     * uses identity comparisons, full locking, and weak references
</span><span class="cm">     * for keys. The table has a fixed capacity because it only
</span><span class="cm">     * maintains task exceptions long enough for joiners to access
</span><span class="cm">     * them, so should never become very large for sustained
</span><span class="cm">     * periods. However, since we do not know when the last joiner
</span><span class="cm">     * completes, we must use weak references and expunge them. We do
</span><span class="cm">     * so on each operation (hence full locking). Also, some thread in
</span><span class="cm">     * any ForkJoinPool will call helpExpungeStaleExceptions when its
</span><span class="cm">     * pool becomes isQuiescent.
</span><span class="cm">     * 异常表的键值节点。链式哈希表使用标识比较，完全锁定和对引用的弱引用。
</span><span class="cm">     * 该表具有固定的容量，因为它只保留足够长的任务异常来访问它们，所以永远不会变得非常大。
</span><span class="cm">     * 但是，由于我们不知道最后一个细木工何时完成，所以我们必须使用弱引用并将其删除。我们这样做每个操作（因此完全锁定）。
</span><span class="cm">     * 而且，任何ForkJoinPool中的某个线程在其池变为isQuiescent时将调用helpExpungeStaleExceptions。
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ExceptionNode</span> <span class="kd">extends</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Throwable</span> <span class="n">ex</span><span class="o">;</span>
        <span class="n">ExceptionNode</span> <span class="n">next</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">thrower</span><span class="o">;</span>  <span class="c1">// use id not ref to avoid weak cycles 使用id不能避免弱循环
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">hashCode</span><span class="o">;</span>  <span class="c1">// store task hashCode before weak ref disappears 在弱ref消失之前存储任务哈希代码
</span><span class="c1"></span>        <span class="n">ExceptionNode</span><span class="o">(</span><span class="n">ForkJoinTask</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">ex</span><span class="o">,</span> <span class="n">ExceptionNode</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">exceptionTableRefQueue</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">ex</span> <span class="o">=</span> <span class="n">ex</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">thrower</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">();</span>
            <span class="k">this</span><span class="o">.</span><span class="na">hashCode</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="3-doexec-执行">3. doExec 执行</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Primary execution method for stolen tasks. Unless done, calls
</span><span class="cm">     * exec and records status if completed, but doesn&#39;t wait for
</span><span class="cm">     * completion otherwise.
</span><span class="cm">     *
</span><span class="cm">     * @return status on exit from this method
</span><span class="cm">     */</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="nf">doExec</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">s</span><span class="o">;</span> <span class="kt">boolean</span> <span class="n">completed</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">status</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">completed</span> <span class="o">=</span> <span class="n">exec</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">rex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">setExceptionalCompletion</span><span class="o">(</span><span class="n">rex</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">completed</span><span class="o">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">setCompletion</span><span class="o">(</span><span class="n">NORMAL</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
    
  <span class="cm">/**
</span><span class="cm">   * Marks completion and wakes up threads waiting to join this
</span><span class="cm">   * task.
</span><span class="cm">   *
</span><span class="cm">   * @param completion one of NORMAL, CANCELLED, EXCEPTIONAL
</span><span class="cm">   * @return completion status on exit
</span><span class="cm">   */</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="nf">setCompletion</span><span class="o">(</span><span class="kt">int</span> <span class="n">completion</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">;;)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">status</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
              <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATUS</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">s</span> <span class="o">|</span> <span class="n">completion</span><span class="o">))</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">16</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
                  <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span> <span class="n">notifyAll</span><span class="o">();</span> <span class="o">}</span>
              <span class="k">return</span> <span class="n">completion</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
  



  
</code></pre></td></tr></table>
</div>
</div><h3 id="4-setexceptionalcompletion-异常处理">4. setExceptionalCompletion 异常处理</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">   <span class="cm">/**
</span><span class="cm">    * Records exception and possibly propagates.
</span><span class="cm">    *
</span><span class="cm">    * @return status on exit
</span><span class="cm">    */</span>
   <span class="kd">private</span> <span class="kt">int</span> <span class="nf">setExceptionalCompletion</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
       <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">recordExceptionalCompletion</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
       <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DONE_MASK</span><span class="o">)</span> <span class="o">==</span> <span class="n">EXCEPTIONAL</span><span class="o">)</span>
           <span class="n">internalPropagateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
       <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
   <span class="o">}</span>
   
<span class="cm">/**
</span><span class="cm">     * Records exception and sets status.
</span><span class="cm">     *
</span><span class="cm">     * @return status on exit
</span><span class="cm">     */</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="nf">recordExceptionalCompletion</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">status</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">exceptionTableLock</span><span class="o">;</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">expungeStaleExceptions</span><span class="o">();</span>
                <span class="n">ExceptionNode</span><span class="o">[]</span> <span class="n">t</span> <span class="o">=</span> <span class="n">exceptionTable</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">ExceptionNode</span> <span class="n">e</span> <span class="o">=</span> <span class="n">t</span><span class="o">[</span><span class="n">i</span><span class="o">];</span> <span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExceptionNode</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">t</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="c1">// already present
</span><span class="c1"></span>                        <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">setCompletion</span><span class="o">(</span><span class="n">EXCEPTIONAL</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
    
   <span class="cm">/**
</span><span class="cm">    * Poll stale refs and remove them. Call only while holding lock.
</span><span class="cm">    */</span>
   <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">expungeStaleExceptions</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">x</span><span class="o">;</span> <span class="o">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">exceptionTableRefQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="k">instanceof</span> <span class="n">ExceptionNode</span><span class="o">)</span> <span class="o">{</span>
               <span class="kt">int</span> <span class="n">hashCode</span> <span class="o">=</span> <span class="o">((</span><span class="n">ExceptionNode</span><span class="o">)</span><span class="n">x</span><span class="o">).</span><span class="na">hashCode</span><span class="o">;</span>
               <span class="n">ExceptionNode</span><span class="o">[]</span> <span class="n">t</span> <span class="o">=</span> <span class="n">exceptionTable</span><span class="o">;</span>
               <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">hashCode</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">);</span>
               <span class="n">ExceptionNode</span> <span class="n">e</span> <span class="o">=</span> <span class="n">t</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
               <span class="n">ExceptionNode</span> <span class="n">pred</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
               <span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">ExceptionNode</span> <span class="n">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                       <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                           <span class="n">t</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                       <span class="k">else</span>
                           <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                       <span class="k">break</span><span class="o">;</span>
                   <span class="o">}</span>
                   <span class="n">pred</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                   <span class="n">e</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
               <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">}</span>     
</code></pre></td></tr></table>
</div>
</div><h3 id="5-fork">5. fork</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Arranges to asynchronously execute this task in the pool the
</span><span class="cm">     * current task is running in, if applicable, or using the {@link
</span><span class="cm">     * ForkJoinPool#commonPool()} if not {@link #inForkJoinPool}.  While
</span><span class="cm">     * it is not necessarily enforced, it is a usage error to fork a
</span><span class="cm">     * task more than once unless it has completed and been
</span><span class="cm">     * reinitialized.  Subsequent modifications to the state of this
</span><span class="cm">     * task or any data it operates on are not necessarily
</span><span class="cm">     * consistently observable by any thread other than the one
</span><span class="cm">     * executing it unless preceded by a call to {@link #join} or
</span><span class="cm">     * related methods, or a call to {@link #isDone} returning {@code
</span><span class="cm">     * true}.
</span><span class="cm">     *
</span><span class="cm">     * @return {@code this}, to simplify usage
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ForkJoinTask</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">fork</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Thread</span> <span class="n">t</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">())</span> <span class="k">instanceof</span> <span class="n">ForkJoinWorkerThread</span><span class="o">)</span>
            <span class="o">((</span><span class="n">ForkJoinWorkerThread</span><span class="o">)</span><span class="n">t</span><span class="o">).</span><span class="na">workQueue</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">externalPush</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="6-join">6. join</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Returns the result of the computation when it {@link #isDone is
</span><span class="cm">     * done}.  This method differs from {@link #get()} in that
</span><span class="cm">     * abnormal completion results in {@code RuntimeException} or
</span><span class="cm">     * {@code Error}, not {@code ExecutionException}, and that
</span><span class="cm">     * interrupts of the calling thread do &lt;em&gt;not&lt;/em&gt; cause the
</span><span class="cm">     * method to abruptly return by throwing {@code
</span><span class="cm">     * InterruptedException}.
</span><span class="cm">     *
</span><span class="cm">     * @return the computed result
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">V</span> <span class="nf">join</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">doJoin</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">DONE_MASK</span><span class="o">)</span> <span class="o">!=</span> <span class="n">NORMAL</span><span class="o">)</span>
            <span class="n">reportException</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">getRawResult</span><span class="o">();</span>
    <span class="o">}</span>
    
  <span class="cm">/**
</span><span class="cm">   * Implementation for join, get, quietlyJoin. Directly handles
</span><span class="cm">   * only cases of already-completed, external wait, and
</span><span class="cm">   * unfork+exec.  Others are relayed to ForkJoinPool.awaitJoin.
</span><span class="cm">   *
</span><span class="cm">   * @return status upon completion
</span><span class="cm">   */</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="nf">doJoin</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">s</span><span class="o">;</span> <span class="n">Thread</span> <span class="n">t</span><span class="o">;</span> <span class="n">ForkJoinWorkerThread</span> <span class="n">wt</span><span class="o">;</span> <span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">WorkQueue</span> <span class="n">w</span><span class="o">;</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">status</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">s</span> <span class="o">:</span>
          <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">())</span> <span class="k">instanceof</span> <span class="n">ForkJoinWorkerThread</span><span class="o">)</span> <span class="o">?</span>
          <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="o">(</span><span class="n">wt</span> <span class="o">=</span> <span class="o">(</span><span class="n">ForkJoinWorkerThread</span><span class="o">)</span><span class="n">t</span><span class="o">).</span><span class="na">workQueue</span><span class="o">).</span>
          <span class="n">tryUnpush</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">doExec</span><span class="o">())</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">s</span> <span class="o">:</span>
          <span class="n">wt</span><span class="o">.</span><span class="na">pool</span><span class="o">.</span><span class="na">awaitJoin</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">0L</span><span class="o">)</span> <span class="o">:</span>
          <span class="n">externalAwaitDone</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="cm">/**
</span><span class="cm">   * Blocks a non-worker-thread until completion.
</span><span class="cm">   * @return status upon completion
</span><span class="cm">   */</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="nf">externalAwaitDone</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="o">((</span><span class="k">this</span> <span class="k">instanceof</span> <span class="n">CountedCompleter</span><span class="o">)</span> <span class="o">?</span> <span class="c1">// try helping
</span><span class="c1"></span>               <span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">externalHelpComplete</span><span class="o">(</span>
                   <span class="o">(</span><span class="n">CountedCompleter</span><span class="o">&lt;?&gt;)</span><span class="k">this</span><span class="o">,</span> <span class="n">0</span><span class="o">)</span> <span class="o">:</span>
               <span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">tryExternalUnpush</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">?</span> <span class="n">doExec</span><span class="o">()</span> <span class="o">:</span> <span class="n">0</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">status</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
          <span class="k">do</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATUS</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">s</span> <span class="o">|</span> <span class="n">SIGNAL</span><span class="o">))</span> <span class="o">{</span>
                  <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                          <span class="k">try</span> <span class="o">{</span>
                              <span class="n">wait</span><span class="o">(</span><span class="n">0L</span><span class="o">);</span>
                          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span>
                              <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                          <span class="o">}</span>
                      <span class="o">}</span>
                      <span class="k">else</span>
                          <span class="n">notifyAll</span><span class="o">();</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">status</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span>
              <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
  <span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div>
  </div>

  <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">BirdGod</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2018-08-20 18:18
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/birdgodtech/blog/master/LICENSE">MIT</a></span>
  </p>
</div>
<footer class="post-footer">
    <div class="post-tags">
      <a href="/tags/disruptor/">disruptor</a>
      </div>
    <nav class="post-nav" style="height: 27px">
      <a class="prev" href="/post/concurrent/striped64/Striped64%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Striped64</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
      <a class="next" href="/post/concurrent/disruptor/%E7%BC%93%E5%AD%98%E8%A1%8C%E5%A1%AB%E5%85%85cache-line-padding/">
        <span class="next-text nav-default">神奇的缓存行填充</span>
        <span class="next-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav>
  </footer>
  <script src="https://utteranc.es/client.js"
          repo="birdgodtech/birdgodtech.github.io"
          issue-term="pathname"
          theme="github-light"
          crossorigin="anonymous"
          async>
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterance.</a></noscript>
</article>
            </div>
            

        </div>
    </main>

    <footer id="footer" class="footer">
        <div class="social-links">
  <a href="mailto:birdgodtech@163.com" class="iconfont icon-email" title="email" rel="noopener" target="_blank" data-title="email"> </a>
  <a href="https://github.com/birdgodtech" class="iconfont icon-github" title="github" rel="noopener" target="_blank" data-title="github"> </a>
  <a href="https://birdgodtech.github.io/index.xml" type="application/rss+xml" rel="noopener" target="_blank" class="iconfont icon-rss" title="rss"></a>


</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy;
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">BirdGod</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.47f727f4.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-84813914-2', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
